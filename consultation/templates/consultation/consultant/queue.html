{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="col-12">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-person-badge"></i>
                Dr. {{ consultant.staff|title }} - Queue Management
            </h5>
            <div>
                <span class="badge bg-info text-white me-2">{{ consultant.specialization.name|title }}</span>
                <a href="{% url 'consultant_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>

        <div class="card-body">
            {% include 'admin_site/partials/error.html' %}

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>{{ queue_list|length }}</h4>
                            <p class="mb-0">Active Patients</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>{{ available_doctors|length }}</h4>
                            <p class="mb-0">Available Doctors</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>{% if consultant.assigned_room %}{{ consultant.assigned_room }}{% else %}N/A{% endif %}</h4>
                            <p class="mb-0">Assigned Room</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            {% if queue_list %}
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <input type="checkbox" id="selectAll" class="form-check-input me-2">
                        <label for="selectAll" class="form-check-label">Select All</label>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-warning" id="bulkTransferBtn" disabled>
                            <i class="bi bi-arrow-repeat"></i> Transfer Selected
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Queue Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAllHeader" class="form-check-input">
                            </th>
                            <th>Patient</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Joined Queue</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for queue in queue_list %}
                        <tr class="{% if queue.priority_level > 0 %}table-warning{% endif %}">
                            <td>
                                <input type="checkbox" class="form-check-input patient-checkbox" value="{{ queue.id }}">
                            </td>
                            <td>
                                <div>
                                    <strong>{{ queue.patient|title }}</strong>
                                    <small class="text-muted d-block">ID: {{ queue.patient.card_number }}</small>
                                </div>
                            </td>
                            <td>
                                {% if queue.status == 'waiting_vitals' %}
                                    <span class="badge bg-warning">Awaiting Vitals</span>
                                {% elif queue.status == 'vitals_done' %}
                                    <span class="badge bg-info">Ready for Doctor</span>
                                {% elif queue.status == 'with_doctor' %}
                                    <span class="badge bg-success">With Doctor</span>
                                {% elif queue.status == 'consultation_paused' %}
                                    <span class="badge bg-secondary">Paused</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if queue.priority_level == 0 %}
                                    <span class="badge bg-light text-dark">Normal</span>
                                {% elif queue.priority_level == 1 %}
                                    <span class="badge bg-warning">High</span>
                                {% elif queue.priority_level == 2 %}
                                    <span class="badge bg-danger">Emergency</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ queue.joined_queue_at|date:"M d, H:i" }}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary transfer-patient-btn" 
                                        data-queue-id="{{ queue.id }}"
                                        data-patient-name="{{ queue.patient|title }}"
                                        title="Transfer Patient">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <h5 class="text-muted">No Active Patients</h5>
                                <p class="text-muted">Dr. {{ consultant.staff|title }} currently has no patients in queue.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Patient Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">Transfer Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Transfer <strong id="transfer-patient-name"></strong> to:</p>
                <div class="mb-3">
                    <label class="form-label">Select Doctor</label>
                    <select class="form-control" id="targetDoctorSelect" required>
                        <option value="">Choose a doctor...</option>
                        {% for doctor in available_doctors %}
                        <option value="{{ doctor.id }}">
                            Dr. {{ doctor.staff|title }} ({{ doctor.specialization.name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if not available_doctors %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    No other available doctors in {{ consultant.specialization.name }} specialization.
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmTransferBtn" {% if not available_doctors %}disabled{% endif %}>
                    Transfer Patient
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Transfer Modal -->
<div class="modal fade" id="bulkTransferModal" tabindex="-1" aria-labelledby="bulkTransferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkTransferModalLabel">Bulk Transfer Patients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Transfer <strong id="bulk-patient-count"></strong> selected patients to the following doctors:</p>
                
                {% if available_doctors %}
                <div class="mb-3">
                    <label class="form-label">Select Target Doctors (patients will be distributed evenly)</label>
                    {% for doctor in available_doctors %}
                    <div class="form-check">
                        <input class="form-check-input bulk-doctor-checkbox" type="checkbox" 
                               value="{{ doctor.id }}" id="bulk_doctor_{{ doctor.id }}" checked>
                        <label class="form-check-label" for="bulk_doctor_{{ doctor.id }}">
                            <strong>Dr. {{ doctor.staff|title }}</strong>
                            <small class="text-muted d-block">{{ doctor.specialization.name }}</small>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllBulkDoctors(true)">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllBulkDoctors(false)">Select None</button>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    No other available doctors in {{ consultant.specialization.name }} specialization.
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBulkTransferBtn" {% if not available_doctors %}disabled{% endif %}>
                    Transfer All Selected
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQueueId = null;
let selectedPatients = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize checkbox functionality
    initializeCheckboxes();
    
    // Initialize transfer buttons
    initializeTransferButtons();
});

function initializeCheckboxes() {
    const selectAllCheckboxes = document.querySelectorAll('#selectAll, #selectAllHeader');
    const patientCheckboxes = document.querySelectorAll('.patient-checkbox');
    const bulkTransferBtn = document.getElementById('bulkTransferBtn');

    selectAllCheckboxes.forEach(selectAll => {
        selectAll.addEventListener('change', function() {
            patientCheckboxes.forEach(cb => cb.checked = this.checked);
            updateBulkTransferButton();
        });
    });

    patientCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateSelectAllState();
            updateBulkTransferButton();
        });
    });

    function updateSelectAllState() {
        const allChecked = Array.from(patientCheckboxes).every(cb => cb.checked);
        const noneChecked = Array.from(patientCheckboxes).every(cb => !cb.checked);
        
        selectAllCheckboxes.forEach(selectAll => {
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && !noneChecked;
        });
    }

    function updateBulkTransferButton() {
        const checkedCount = Array.from(patientCheckboxes).filter(cb => cb.checked).length;
        bulkTransferBtn.disabled = checkedCount === 0;
    }
}

function initializeTransferButtons() {
    // Individual transfer buttons
    document.querySelectorAll('.transfer-patient-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentQueueId = this.dataset.queueId;
            const patientName = this.dataset.patientName;
            
            document.getElementById('transfer-patient-name').textContent = patientName;
            new bootstrap.Modal(document.getElementById('transferModal')).show();
        });
    });

    // Bulk transfer button
    document.getElementById('bulkTransferBtn').addEventListener('click', function() {
        selectedPatients = Array.from(document.querySelectorAll('.patient-checkbox:checked')).map(cb => cb.value);
        document.getElementById('bulk-patient-count').textContent = selectedPatients.length;
        new bootstrap.Modal(document.getElementById('bulkTransferModal')).show();
    });

    // Confirm individual transfer
    document.getElementById('confirmTransferBtn').addEventListener('click', function() {
        const targetDoctorId = document.getElementById('targetDoctorSelect').value;
        if (!targetDoctorId) {
            showAlert('Please select a target doctor', 'warning');
            return;
        }
        
        transferPatient(currentQueueId, targetDoctorId);
    });

    // Confirm bulk transfer
    document.getElementById('confirmBulkTransferBtn').addEventListener('click', function() {
        const selectedDoctors = Array.from(document.querySelectorAll('.bulk-doctor-checkbox:checked')).map(cb => cb.value);
        if (selectedDoctors.length === 0) {
            showAlert('Please select at least one target doctor', 'warning');
            return;
        }
        
        bulkTransferPatients(selectedPatients, selectedDoctors);
    });
}

function transferPatient(queueId, targetDoctorId) {
    const btn = document.getElementById('confirmTransferBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Transferring...';
    btn.disabled = true;

    fetch(`/portal/consultation/ajax/transfer-patient/${queueId}/${targetDoctorId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Transfer failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Transfer failed: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

function bulkTransferPatients(queueIds, targetDoctorIds) {
    const btn = document.getElementById('confirmBulkTransferBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Transferring...';
    btn.disabled = true;

    const formData = new FormData();
    queueIds.forEach(id => formData.append('queue_ids[]', id));
    targetDoctorIds.forEach(id => formData.append('target_doctors[]', id));

    fetch('/portal/consultation/ajax/bulk-transfer-patients/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('bulkTransferModal')).hide();
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Bulk transfer failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Bulk transfer failed: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

function selectAllBulkDoctors(selectAll) {
    document.querySelectorAll('.bulk-doctor-checkbox').forEach(cb => cb.checked = selectAll);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const cardBody = document.querySelector('.card-body');
    cardBody.insertBefore(alertDiv, cardBody.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}