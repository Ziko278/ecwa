{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Edit Consultant: Dr. {{ consultant.staff|title }}</h4>
            <p class="card-description">
                Use the form below to update the consultant's details.
            </p>

            <form class="forms-sample" method="post" action="">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="staff-search-input">Search Staff <span style="color:red"><b>*</b></span></label>
                            <input type="text" id="staff-search-input" class="form-control" placeholder="Type to search for a staff member..." autocomplete="off">
                            <small class="text-muted">Start typing a name or ID to filter the list.</small>
                        </div>
                        <div class="form-group mb-3">
                            <label for="id_staff" class="d-block">Select Staff</label>
                            <!-- The select element for display and form submission -->
                            <select name="staff" id="id_staff" class="form-control" required>
                                <!-- Options will be dynamically managed by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_specialization">Specialization <span style="color:red"><b>*</b></span></label>
                            {{ form.specialization }}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.default_consultation_duration }}
                            <label for="floatingDuration">Default Consultation Duration (Minutes) <span style="color:red"><b>*</b></span></label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.max_daily_patients }}
                            <label for="floatingMaxPatients">Maximum Daily Patients <span style="color:red"><b>*</b></span></label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.consultation_start_time }}
                            <label for="floatingStartTime">Consultation Start Time</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.consultation_end_time }}
                            <label for="floatingEndTime">Consultation End Time</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-floating mb-3">
                            {{ form.consultation_days }}
                            <label for="floatingDays">Consultation Days (e.g., mon,tue,fri)</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            {{ form.is_available_for_consultation }}
                            <label class="form-check-label" for="flexSwitchCheckChecked">Available for Consultation</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.assigned_room }}
                            <label for="floatingRoom">Assigned Room (Optional)</label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary me-2">Save Changes</button>
                    <a href="{% url 'consultant_list' %}" class="btn btn-light">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('staff-search-input');
    const selectElement = document.getElementById('id_staff');
    
    // Store all original staff data to filter from
    const allStaffData = [];
    {% for staff in staff_list %}
        allStaffData.push({
            pk: "{{ staff.pk }}",
            fullName: "{{ staff.first_name|title }} {% if staff.middle_name %}{{ staff.middle_name|title }} {% endif %}{{ staff.last_name|title }}",
            staffId: "{{ staff.staff_id }}",
            mobile: "{{ staff.mobile|default:'N/A' }}"
        });
    {% endfor %}

    // Get the currently selected staff PK from the Django context for pre-selection
    const currentStaffPk = "{{ consultant.staff.pk|default:'' }}"; 

    // Function to render options based on filtered data
    function renderStaffOptions(filteredData, selectedPk = null) {
        selectElement.innerHTML = ''; // Clear existing options

        // Add a default blank option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- Select a staff member ---';
        selectElement.appendChild(defaultOption);

        if (filteredData.length === 0) {
            const noResultsOption = document.createElement('option');
            noResultsOption.value = '';
            noResultsOption.textContent = 'No staff found';
            noResultsOption.disabled = true;
            selectElement.appendChild(noResultsOption);
            return;
        }
        
        filteredData.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.pk;
            option.textContent = `${staff.fullName} (ID: ${staff.staffId}, Phone: ${staff.mobile})`;
            option.dataset.staffId = staff.staffId;
            option.dataset.mobile = staff.mobile;
            
            // Set the option as selected if its PK matches the current consultant's staff PK
            if (selectedPk && String(staff.pk) === String(selectedPk)) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    // Initial render: show all staff, with the current consultant's staff pre-selected
    renderStaffOptions(allStaffData, currentStaffPk);

    searchInput.addEventListener('input', function (event) {
        const searchText = event.target.value.toLowerCase();
        
        const filteredStaff = allStaffData.filter(staff => {
            const fullName = staff.fullName.toLowerCase();
            const staffId = staff.staffId.toLowerCase();
            const mobile = staff.mobile.toLowerCase();

            return fullName.includes(searchText) || staffId.includes(searchText) || mobile.includes(searchText);
        });
        
        // Re-render, keeping the current consultant's staff selected if still in filtered list
        renderStaffOptions(filteredStaff, currentStaffPk);
    });
});
</script>

{% endblock %}
