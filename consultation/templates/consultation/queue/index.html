{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<!-- Collapsible Statistics Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="accordion" id="statsAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="statsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#statsCollapse" aria-expanded="false" aria-controls="statsCollapse">
                        <i class="bi bi-bar-chart-line me-2"></i> Queue Statistics & Available Consultants
                    </button>
                </h2>
                <div id="statsCollapse" class="accordion-collapse collapse" aria-labelledby="statsHeading" data-bs-parent="#statsAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <!-- Today's Statistics -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">Today's Statistics</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="card text-center bg-light">
                                            <div class="card-body py-2">
                                                <h6 class="text-primary">{{ queue_stats.total|default:0 }}</h6>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center bg-warning">
                                            <div class="card-body py-2">
                                                <h6 class="text-white">{{ queue_stats.waiting_vitals|default:0 }}</h6>
                                                <small class="text-white">Awaiting Vitals</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div class="card text-center bg-info">
                                            <div class="card-body py-2">
                                                <h6 class="text-white">{{ queue_stats.vitals_done|default:0 }}</h6>
                                                <small class="text-white">Need Doctor</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center bg-success">
                                            <div class="card-body py-2">
                                                <h6 class="text-white">{{ queue_stats.completed|default:0 }}</h6>
                                                <small class="text-white">Completed</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Available Consultants -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">Available Consultants</h6>
                                {% if consultants_status %}
                                    <div class="list-group">
                                        {% for consultant in consultants_status %}
                                          <div class="list-group-item d-flex justify-content-between align-items-center"
                                               data-consultant-id="{{ consultant.id }}"
                                               data-specialization-id="{{ consultant.specialization.id }}"
                                               data-consultant-name="{{ consultant.staff|escapejs }}"
                                               data-queue-count="{{ consultant.queue_count }}">
                                            <div>
                                              <strong>Dr. {{ consultant.staff|title }}</strong>
                                              <small class="text-muted d-block">{{ consultant.specialization.name|title }}</small>
                                              <small class="text-muted">Room: {{ consultant.assigned_room|default:"Not Assigned" }}</small>
                                            </div>
                                            <div class="text-end">
                                              <span class="badge {% if consultant.queue_count > 5 %}bg-danger{% elif consultant.queue_count > 2 %}bg-warning{% else %}bg-success{% endif %} rounded-pill">
                                                {{ consultant.queue_count }}
                                              </span>
                                            </div>
                                          </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted">No active consultants available.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Queue Management -->
<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Patient Queue Management
                    <div class="float-end">
                        <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#quickActionsModal">
                            <i class="bi bi-lightning"></i> Quick Actions
                        </button>

                        <a title="Refresh Queue" href="{% url 'patient_queue_index' %}" class="btn btn-sm btn-info text-white">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </a>
                    </div>
                </h4>

                {% include 'admin_site/partials/error.html' %}
                <div class="my-3">
                    <input type="text" id="patientSearchInput" class="form-control" placeholder="🔍 Search by patient name or card number...">
                </div>

                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>Patient</th>
                                <th>Consultant</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for queue in queue_list %}
                            <tr data-queue-id="{{ queue.id }}" class="queue-row {% if queue.priority_level > 0 %}table-warning{% endif %}">
                                <td>
                                    <input type="checkbox" class="form-check-input queue-checkbox" value="{{ queue.id }}">
                                </td>

                                <td>
                                    <div>
                                        <strong>{{ queue.patient|title }}</strong>
                                        <small class="text-muted d-block">ID: {{ queue.patient.card_number }}</small>
                                        {% if queue.priority_level > 0 %}
                                            <span class="badge bg-warning text-dark">HIGH PRIORITY</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted d-block">{{ queue.specialization|title }}</small>

                                    {% if queue.consultant %}

                                        <div>
                                            <strong>Dr. {{ queue.consultant.staff|title }}</strong>
                                          </div>
                                    {% else %}
                                        <span class="text-warning">Not Assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if queue.status == 'waiting_vitals' %}
                                        <span class="badge bg-warning">Awaiting Vitals</span>
                                    {% elif queue.status == 'vitals_done' %}
                                        <span class="badge bg-info">Ready for Doctor</span>
                                    {% elif queue.status == 'with_doctor' %}
                                        <span class="badge bg-secondary">With Doctor</span>
                                    {% elif queue.status == 'consultation_paused' %}
                                        <span class="badge bg-dark">Paused</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-sm" role="group">
                                        {% if queue.status == 'waiting_vitals' %}
                                            <button class="btn btn-sm btn-success" onclick="startVitals({{ queue.id }})">
                                                <i class="bi bi-heart-pulse"></i> Start Vitals
                                            </button>
                                        {% elif queue.status == 'vitals_done' and not queue.consultant %}
                                        <button class="btn btn-sm btn-primary" onclick="assignDoctor({{ queue.id }}, '{{ queue.specialization.id }}')">
                                                <i class="bi bi-person-plus"></i> Assign Doctor
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <h5 class="text-muted">No Patients in Queue Today</h5>
                                    <p class="text-muted">The queue is empty. New patients will appear here once they join.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1" style="font-family: sans-serif;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Actions <small>(Select patient checkbox first)</small></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Patient</label>
                    <select class="form-control" id="quickActionPatient" onchange="loadQuickActions()">
                        <option value="">Select a patient...</option>
                        {% for queue in queue_list %}
                            <option value="{{ queue.id }}" data-status="{{ queue.status }}" data-specialization="{{ queue.payment.fee_structure.specialization.id }}">
                                {{ queue.patient|title }} - {{ queue.get_status_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="quickActionsContainer" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <select class="form-control" id="quickAction" onchange="toggleActionInputs()">
                            <option value="">Select Action...</option>
                            <option value="update_vitals">Update Vitals</option>
                            <option value="change_doctor">Change Doctor</option>
                        </select>
                    </div>

                    <!-- Change Doctor Section -->
                    <div id="changeDoctorSection" style="display: none;" class="mb-3">
                        <label class="form-label">New Doctor</label>
                        <select class="form-control" id="newDoctorSelect">
                            <option value="">Select new doctor...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeQuickAction()">Execute Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Vitals Modal -->
<div class="modal fade" id="vitalsModal" tabindex="-1" style="font-family: sans-serif;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Patient Vitals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="vitalsForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Basic Vitals</h6>
                            <div class="mb-3">
                                <label class="form-label">Temperature (°C)</label>
                                <input type="number" class="form-control" name="temperature" step="0.1" placeholder="36.5">
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">BP Systolic<span style="color:red">*</span></label>
                                    <input type="number" class="form-control"  name="blood_pressure_systolic" placeholder="120">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">BP Diastolic<span style="color:red">*</span></label>
                                    <input type="number" class="form-control" name="blood_pressure_diastolic" placeholder="80">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Pulse Rate (BPM)</label>
                                <input type="number" class="form-control" name="pulse_rate" placeholder="72">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Respiratory Rate</label>
                                <input type="number" class="form-control" name="respiratory_rate" placeholder="16">
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Oxygen Saturation (%)</label>
                                <input type="number" class="form-control" name="oxygen_saturation" placeholder="98">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Physical Measurements</h6>
                            <div class="mb-3">
                                <label class="form-label">Height (cm)</label>
                                <input type="number" class="form-control" name="height" step="0.1" placeholder="170">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" name="weight" step="0.1" placeholder="70">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">General Appearance</label>
                                <textarea class="form-control" name="general_appearance" rows="3" placeholder="Patient appears well, alert and oriented..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chief Complaint</label>
                                <textarea class="form-control" name="chief_complaint" rows="3" placeholder="What is the patient complaining of?"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="extra_note" rows="2" placeholder="Additional observations..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Vitals & Complete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Doctor Assignment Modal -->
<div class="modal fade" id="doctorAssignModal" tabindex="-1" style="font-family: sans-serif;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Doctor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="doctorAssignForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Available Doctors</label>
                        <select class="form-control" name="consultant_id" id="consultantSelect" required>
                            <option value="">Select a Doctor...</option>
                        </select>
                        <small class="text-muted">Only doctors from the patient's specialization are shown</small>
                    </div>
                    <input type="hidden" id="assign_queue_id" name="queue_id" value="">

                    <div class="mb-3">
                        <label class="form-label">Priority Level</label>
                        <select class="form-control" name="priority_level">
                            <option value="0">Normal</option>
                            <option value="1">High Priority</option>
                            <option value="2">Emergency</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Any special instructions for the doctor..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Doctor</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let currentQueueId = null;
let currentSpecializationId = null;
let hasVital = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCheckboxes();
    scrollToFirstActionablePatient();
     document.getElementById('patientSearchInput').addEventListener('input', filterPatientTable);

});

// Checkbox handling
function initializeCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.queue-checkbox');

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            const noneChecked = Array.from(checkboxes).every(checkbox => !checkbox.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && !noneChecked;
        });
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('click', function() {
            // If checkbox is checked, auto-select this patient in quick actions
            if (this.checked) {
                // Uncheck other checkboxes to ensure only one is selected for quick actions
                checkboxes.forEach(otherCb => {
                    if (otherCb !== this) otherCb.checked = false;
                });

                // Set the patient in quick actions modal
                const queueId = this.value;
                const quickActionPatient = document.getElementById('quickActionPatient');
                quickActionPatient.value = queueId;

                // Trigger the loadQuickActions function to populate available actions
                loadQuickActions();
            }

            // Update select all checkbox state
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            const noneChecked = Array.from(checkboxes).every(checkbox => !checkbox.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && !noneChecked;
        });
    });
}

// Quick Actions Functions
function loadQuickActions() {
    const patientSelect = document.getElementById('quickActionPatient');
    const selectedOption = patientSelect.options[patientSelect.selectedIndex];
    const container = document.getElementById('quickActionsContainer');
    const actionSelect = document.getElementById('quickAction');

    if (patientSelect.value) {
        const status = selectedOption.getAttribute('data-status');
        container.style.display = 'block';

        // Clear previous options
        actionSelect.innerHTML = '<option value="">Select Action...</option>';

        // Add available actions based on status
        if (status === 'waiting_vitals' || status === 'vitals_done' || status === 'with_doctor' || status === 'consultation_paused') {
            actionSelect.innerHTML += '<option value="update_vitals">Update Vitals</option>';
        }
        if (status === 'vitals_done' || status === 'consultation_paused') {
            actionSelect.innerHTML += '<option value="change_doctor">Change Doctor</option>';
        }
    } else {
        container.style.display = 'none';
    }
}

function toggleActionInputs() {
    const action = document.getElementById('quickAction').value;
    const changeDoctorSection = document.getElementById('changeDoctorSection');

    if (action === 'change_doctor') {
        changeDoctorSection.style.display = 'block';
        loadDoctorsForChange();
    } else {
        changeDoctorSection.style.display = 'none';
    }
}

function loadDoctorsForChange() {
    const patientSelect = document.getElementById('quickActionPatient');
    const selectedOption = patientSelect.options[patientSelect.selectedIndex];
    const specializationId = selectedOption.getAttribute('data-specialization');

    const doctorSelect = document.getElementById('newDoctorSelect');
    doctorSelect.innerHTML = '<option value="">Select new doctor...</option>';

    // Load available doctors for this specialization
    const listItems = document.querySelectorAll('.list-group .list-group-item[data-specialization-id]');

    listItems.forEach(item => {
        const specId = item.getAttribute('data-specialization-id');
        if (String(specId) === String(specializationId)) {
            const id = item.getAttribute('data-consultant-id');
            const name = item.getAttribute('data-consultant-name') || item.querySelector('strong')?.textContent || 'Unknown';
            const queueCount = parseInt(item.getAttribute('data-queue-count') || '0', 10);

            const option = document.createElement('option');
            option.value = id;
            option.textContent = `Dr. ${name} (Queue: ${queueCount || 0})`;
            if (queueCount >= 10) {
                option.disabled = true;
                option.textContent += ' - BUSY';
            }
            doctorSelect.appendChild(option);
        }
    });
}

function executeQuickAction() {
    const patientId = document.getElementById('quickActionPatient').value;
    const action = document.getElementById('quickAction').value;

    if (!patientId || !action) {
        showAlert('Please select a patient and action', 'warning');
        return;
    }

    if (action === 'update_vitals') {
        // Close quick actions modal and open vitals modal
        bootstrap.Modal.getInstance(document.getElementById('quickActionsModal')).hide();
        startVitals(patientId);
    } else if (action === 'change_doctor') {
        const newDoctorId = document.getElementById('newDoctorSelect').value;
        if (!newDoctorId) {
            showAlert('Please select a new doctor', 'warning');
            return;
        }
        changeDoctorForPatient(patientId, newDoctorId);
    }
}

// This is the new function to find and scroll to the patient
function scrollToFirstActionablePatient() {
    // Find the first patient row that contains a button in its action cell.
    // The :has() pseudo-class is perfect for this.
    const firstActionableRow = document.querySelector('tr.queue-row:has(button)');

    if (firstActionableRow) {
        // Scroll that row into the middle of the viewport smoothly.
        firstActionableRow.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // (Optional) Add a temporary highlight to the row for better visibility.
        firstActionableRow.classList.add('table-info'); // A temporary Bootstrap highlight class
        setTimeout(() => {
            firstActionableRow.classList.remove('table-info');
        }, 3000); // Remove the highlight after 3 seconds
    }
}

// New function to handle the live search
function filterPatientTable() {
    const filter = document.getElementById('patientSearchInput').value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr.queue-row');
    let visibleRows = 0;

    tableRows.forEach(row => {
        // The second cell (index 1) contains the patient's name and card number
        const patientCell = row.cells[1];
        if (patientCell) {
            const cellText = patientCell.textContent || patientCell.innerText;

            if (cellText.toLowerCase().includes(filter)) {
                row.style.display = ""; // Show the row
                visibleRows++;
            } else {
                row.style.display = "none"; // Hide the row
            }
        }
    });

    // Optional: Show a "No Results" message
    const tbody = document.querySelector('.table tbody');
    let noResultsRow = tbody.querySelector('.no-results');

    // Remove existing "no results" message if any
    if (noResultsRow) {
        noResultsRow.remove();
    }

    // Add a "no results" message if no rows are visible and the table is not empty
    if (visibleRows === 0 && tableRows.length > 0) {
        noResultsRow = tbody.insertRow();
        noResultsRow.className = 'no-results';
        const cell = noResultsRow.insertCell();
        cell.colSpan = 5; // Match the number of columns
        cell.className = 'text-center text-muted py-4';
        cell.textContent = 'No matching patients found.';
    }
}

function changeDoctorForPatient(queueId, newDoctorId) {
    const formData = new FormData();
    formData.append('consultant_id', newDoctorId);

    fetch(`/portal/consultation/ajax/assign-consultant/${queueId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('quickActionsModal')).hide();
            showAlert('Doctor changed successfully!', 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (data.error || 'Failed to change doctor'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    });
}

// Start Vitals Function
function startVitals(queueId) {
    currentQueueId = queueId;

    // If vitals exist, load them first
    fetch(`/portal/consultation/ajax/patient-vitals/${queueId}/`)
    .then(response => response.json())
    .then(data => {
        const form = document.getElementById('vitalsForm');
        if (data.has_vitals) {
            // Populate form with existing vitals
            hasVital = true
            form.querySelector('[name="temperature"]').value = data.temperature || '';
            form.querySelector('[name="blood_pressure_systolic"]').value = data.blood_pressure ? data.blood_pressure.split('/')[0] : '';
            form.querySelector('[name="blood_pressure_diastolic"]').value = data.blood_pressure ? data.blood_pressure.split('/')[1] : '';
            form.querySelector('[name="pulse_rate"]').value = data.pulse_rate || '';
            form.querySelector('[name="respiratory_rate"]').value = data.respiratory_rate || '';
            form.querySelector('[name="oxygen_saturation"]').value = data.oxygen_saturation || '';
            form.querySelector('[name="height"]').value = data.height || '';
            form.querySelector('[name="weight"]').value = data.weight || '';
            form.querySelector('[name="general_appearance"]').value = data.general_appearance || '';
            form.querySelector('[name="chief_complaint"]').value = data.chief_complaint || '';
            form.querySelector('[name="extra_note"]').value = data.extra_note || '';
        } else {
            form.reset();
        }
    })
    .catch(error => {
        console.log('No existing vitals found, starting fresh');
        document.getElementById('vitalsForm').reset();
    })
    .finally(() => {
        const modal = new bootstrap.Modal(document.getElementById('vitalsModal'));
        modal.show();
    });
}

// Handle vitals form submission
document.getElementById('vitalsForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    // Determine if this is an update or create operation
    const isUpdate = window.isVitalsUpdate || false;
    let url;

    if (hasVital) {
        // Use update URL
        const updateUrlBase = "{% url 'update_patient_vitals_ajax' 0 %}";
        url = updateUrlBase.replace('0', currentQueueId);
    } else {
        // Use create URL
        const createUrlBase = "{% url 'create_patient_vitals_ajax' 0 %}";
        url = createUrlBase.replace('0', currentQueueId);
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('vitalsModal')).hide();
            const message = isUpdate ? 'Vitals updated successfully!' : 'Vitals recorded successfully!';
            showAlert(message, 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (data.error || 'Failed to save vitals'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + error.message, 'danger');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Assign Doctor Function
function assignDoctor(queueId, specializationId) {
    currentQueueId = queueId;
    currentSpecializationId = specializationId;

    loadAvailableDoctors(specializationId);

    const modal = new bootstrap.Modal(document.getElementById('doctorAssignModal'));
    modal.show();
}

function loadAvailableDoctors(specializationId) {
    const listItems = document.querySelectorAll('.list-group .list-group-item[data-specialization-id]');
    const select = document.getElementById('consultantSelect');
    select.innerHTML = '<option value="">Select a Doctor...</option>';

    let found = false;
    listItems.forEach(item => {
        const specId = item.getAttribute('data-specialization-id');
        if (String(specId) === String(specializationId)) {
            found = true;
            const id = item.getAttribute('data-consultant-id');
            const name = item.getAttribute('data-consultant-name') || item.querySelector('strong')?.textContent || 'Unknown';
            const queueCount = parseInt(item.getAttribute('data-queue-count') || '0', 10);

            const option = document.createElement('option');
            option.value = id;
            option.textContent = `Dr. ${name} (Queue: ${queueCount || 0})`;
            if (queueCount >= 10) {
                option.disabled = true;
                option.textContent += ' - BUSY';
            }
            select.appendChild(option);
        }
    });
}

// Handle doctor assignment
document.getElementById('doctorAssignForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    if (!currentQueueId) {
        showAlert('Missing queue id. Re-open the assign modal and try again.', 'danger');
        return;
    }

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Assigning...';
    submitBtn.disabled = true;

    const url = `/portal/consultation/ajax/assign-consultant/${currentQueueId}/`;

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json().catch(() => ({ success: false, error: 'Invalid JSON response from server' })))
    .then(data => {
        if (data.success) {
            const modalEl = document.getElementById('doctorAssignModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.hide();

            showAlert(data.message || 'Doctor assigned successfully!', 'success');
            location.reload();
        } else {
            showAlert('Error: ' + (data.error || 'Failed to assign doctor'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error: ' + (error.message || 'Network error'), 'danger');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const main = document.querySelector('.card-body');
    main.insertBefore(alertDiv, main.firstChild);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-refresh every 60 seconds
setInterval(() => {
    if (!document.querySelector('.modal.show')) {
        location.reload();
    }
}, 60000);
</script>
{% endblock %}