{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Process Consultation Payment</h4>
            <p class="card-description">
                Verify patient and process their consultation payment or add them to the queue.
            </p>

            <form class="forms-sample" method="post" action="{% url 'consultation_payment_create' %}" id="payment-form">
                {% csrf_token %}

                <div class="card mb-4">
                    <div class="card-header"><h5 class="mb-0">Step 1: Patient Verification</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="card-number-input">Patient Card Number <span style="color:red"><b>*</b></span></label>
                                    <div class="input-group">
                                        <input type="text" id="card-number-input" class="form-control" placeholder="Enter patient card number..." autocomplete="off" required>
                                        <button type="button" id="verify-patient-btn" class="btn btn-primary"><i class="mdi mdi-account-search me-1"></i>Verify</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="patient-details-section" class="mt-3" style="display: none;">
                            <div class="alert alert-success" role="alert">
                                <h6><i class="mdi mdi-check-circle me-2"></i>Patient Verified</h6>
                                <div id="patient-info"></div><br>
                                <h6><i class="mdi mdi-wallet me-2"></i>Wallet Information</h6>
                                <div id="wallet-info"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="consultation-section" style="display: none;">
                    <div class="card-header"><h5 class="mb-0">Step 2: Select Consultation</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="specialization-select">Specialization <span style="color:red"><b>*</b></span></label>
                                    <select id="specialization-select" class="form-control" required>
                                        <option value="">--- Select Specialization ---</option>
                                        {% for spec in specializations %}
                                            <option value="{{ spec.id }}">{{ spec.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="action-section" style="display: none;">
                    <div class="card-header"><h5 class="mb-0">Step 3: Confirmation</h5></div>
                    <div class="card-body">
                        <div id="action-summary"></div>
                        <input type="hidden" id="patient-id-field" name="patient">
                        <input type="hidden" id="fee-structure-field" name="fee_structure">

                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" id="action-btn" class="btn btn-success me-2" disabled>
                                <i class="mdi mdi-credit-card-check me-2"></i>Process
                            </button>
                            <a href="{% url 'consultation_payment_create' %}" class="btn btn-light">Cancel</a>
                        </div>
                    </div>
                </div>

                <div id="message-container" style="display: none;">
                <div id="message-box" class="alert d-flex align-items-center" role="alert">
                    <i id="message-icon" class="mdi me-2"></i>
                    <span id="message-text"></span>
                    <button type="button" class="btn-close ms-auto" onclick="hideMessage()"></button>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // DOM Elements
    const cardNumberInput = document.getElementById('card-number-input');
    const verifyPatientBtn = document.getElementById('verify-patient-btn');
    const specializationSelect = document.getElementById('specialization-select');
    const patientDetailsSection = document.getElementById('patient-details-section');
    const consultationSection = document.getElementById('consultation-section');
    const actionSection = document.getElementById('action-section');
    const actionBtn = document.getElementById('action-btn');
    const messageContainer = document.getElementById('message-container');
    const messageBox = document.getElementById('message-box');
    const messageIcon = document.getElementById('message-icon');
    const messageText = document.getElementById('message-text');

    // Hidden Form Fields
    const patientIdField = document.getElementById('patient-id-field');
    const feeStructureField = document.getElementById('fee-structure-field');
    const paymentForm = document.getElementById('payment-form');

    // Global State
    let currentPatient = null;
    let walletBalance = 0;
    let actionType = null; // 'new_payment' or 'reuse_payment'
    let existingPaymentId = null;
    let currentFee = null;

    // --- Message/Error Handling ---
    function showMessage(message, type = 'danger') {
        const iconClass = type === 'danger' ? 'mdi-alert-circle' : (type === 'success' ? 'mdi-check-circle' : 'mdi-information');
        messageBox.className = `alert alert-${type} d-flex align-items-center`;
        messageIcon.className = `mdi ${iconClass} me-2`;
        messageText.innerHTML = `<strong>${message}</strong>`;
        messageContainer.style.display = 'block';
        messageContainer.scrollIntoView({ behavior: 'smooth' });
    }
    window.hideMessage = () => { messageContainer.style.display = 'none'; };

    // --- State Reset Functions ---
    function resetActionState() {
        actionSection.style.display = 'none';
        actionBtn.disabled = true;
        actionType = null;
        existingPaymentId = null;
        currentFee = null;
    }

    // --- Event Listeners ---
    verifyPatientBtn.addEventListener('click', function() {
        const cardNumber = cardNumberInput.value.trim();
        if (!cardNumber) return showMessage('Please enter a patient card number.');

        verifyPatientBtn.disabled = true;
        verifyPatientBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Verifying...';

        fetch(`{% url 'verify_patient_ajax' %}?card_number=${encodeURIComponent(cardNumber)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);

                hideMessage();
                currentPatient = data.patient;
                walletBalance = data.wallet.balance;
                patientIdField.value = currentPatient.id;

                document.getElementById('patient-info').innerHTML = `<strong>${data.patient.full_name}</strong> (ID: ${data.patient.patient_id})`;
                document.getElementById('wallet-info').innerHTML = `<span class="${data.wallet.balance > 0 ? 'text-success' : 'text-danger'}">${data.wallet.formatted_balance}</span>`;

                patientDetailsSection.style.display = 'block';
                consultationSection.style.display = 'block';
                cardNumberInput.disabled = true;
            })
            .catch(err => showMessage(err.message))
            .finally(() => {
                verifyPatientBtn.disabled = false;
                verifyPatientBtn.innerHTML = '<i class="mdi mdi-account-search me-1"></i>Verify';
            });
    });

    specializationSelect.addEventListener('change', function() {
        const specializationId = this.value;
        resetActionState();
        if (!specializationId) return;

        // The new powerful AJAX call
        fetch(`{% url 'get_consultation_status_ajax' %}?patient_id=${currentPatient.id}&specialization_id=${specializationId}`)
            .then(response => response.json())
            .then(data => {
                actionType = data.status;

                if (actionType === 'block') {
                    throw new Error(data.message);
                }

                if (actionType === 'reuse_payment') {
                    existingPaymentId = data.payment_id;
                    updateActionSectionForReuse(data.message);
                } else if (actionType === 'new_payment') {
                    currentFee = data.fee;
                    feeStructureField.value = currentFee.id;
                    updateActionSectionForNewPayment();
                }
            })
            .catch(err => showMessage(err.message));
    });

    actionBtn.addEventListener('click', function() {
        actionBtn.disabled = true;
        actionBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Processing...';

        if (actionType === 'new_payment') {
            paymentForm.submit();
        } else if (actionType === 'reuse_payment') {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('patient_id', currentPatient.id);
            formData.append('payment_id', existingPaymentId);
            formData.append('specialization_id', specializationSelect.value);

            fetch(`{% url 'create_queue_from_payment_ajax' %}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(() => window.location.href = data.redirect_url, 2000);
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(err => {
                showMessage(err.message);
                actionBtn.disabled = false;
                actionBtn.innerHTML = '<i class="mdi mdi-account-plus me-1"></i> Join Queue';
            });
        }
    });

    // --- UI Update Functions ---
    function updateActionSectionForReuse(message) {
        document.getElementById('action-summary').innerHTML = `
            <div class="alert alert-info">
                <i class="mdi mdi-information me-2"></i> ${message}
            </div>
        `;
        actionBtn.innerHTML = '<i class="mdi mdi-account-plus me-1"></i> Join Queue';
        actionBtn.disabled = false;
        actionSection.style.display = 'block';
    }

    function updateActionSectionForNewPayment() {
        const canPay = walletBalance >= currentFee.amount;
        let summaryHTML = `
            <p class="mb-1">Consultation Fee: <strong>${currentFee.formatted_amount}</strong></p>
            <p>Wallet Balance: <strong class="${canPay ? 'text-success' : 'text-danger'}">${walletBalance.toLocaleString('en-US', {minimumFractionDigits: 2, style: 'currency', currency: 'NGN'})}</strong></p>
        `;

        if (canPay) {
            summaryHTML += `<div class="alert alert-success"><i class="mdi mdi-check-circle me-2"></i>Wallet has sufficient balance.</div>`;
            actionBtn.innerHTML = '<i class="mdi mdi-credit-card-check me-1"></i> Process Payment';
            actionBtn.disabled = false;
        } else {
            const shortfall = currentFee.amount - walletBalance;
            summaryHTML += `<div class="alert alert-warning"><i class="mdi mdi-alert me-2"></i>Insufficient balance. Needs an additional ${shortfall.toLocaleString('en-US', {minimumFractionDigits: 2, style: 'currency', currency: 'NGN'})}.</div>`;
            actionBtn.innerHTML = '<i class="mdi mdi-wallet-plus me-1"></i> Fund Wallet First';
            actionBtn.disabled = true; // Button remains disabled, user must fund wallet
        }

        document.getElementById('action-summary').innerHTML = summaryHTML;
        actionSection.style.display = 'block';
    }
});
</script>
{% endblock %}