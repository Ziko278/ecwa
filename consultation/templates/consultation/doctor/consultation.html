{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
<style>
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
}

.mini-toast {
    min-width: 250px;
    margin-bottom: 10px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.mini-toast.hiding {
    animation: slideOut 0.3s ease-out forwards;
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}
</style>

<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">
                    Consultation: {{ consultation.queue_entry.patient|title }}
                    <span class="badge bg-info ms-2">{{ consultation.queue_entry.queue_number }}</span>
                    <div class="float-end">
                        <a href="{% url 'doctor_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Queue
                        </a>
                        <button class="btn btn-sm btn-warning" onclick="pauseConsultation()" id="pauseBtn">
                            <i class="bi bi-pause"></i> Pause
                        </button>
                        <button class="btn btn-sm btn-success" onclick="completeConsultation()" id="completeBtn">
                            <i class="bi bi-check"></i> Complete
                        </button>
                    </div>
                </h4>
                <p class="card-description">
                    Patient: {{ consultation.queue_entry.patient.card_number|upper }} |
                    {{ consultation.queue_entry.patient.age }} yrs, {{ consultation.queue_entry.patient.gender|title }} |
                    Started: {{ consultation.created_at|date:"M d, H:i" }}
                </p>

                {% with allergy_profile=consultation.queue_entry.patient.allergy_profile %}
                    <div id="allergy-display-container"
                         class="d-flex justify-content-between align-items-center p-2 mt-2 rounded"
                         style="background-color: #dc3545; color: white;"
                         {% if allergy_profile and allergy_profile.updated_by %}
                           title="Last updated by {{ allergy_profile.updated_by.get_full_name|default:allergy_profile.updated_by.username }} at {{ allergy_profile.updated_at|date:'M d, Y, P' }}"
                         {% endif %}>

                        <strong id="allergy-text" data-raw-details="{{ allergy_profile.details|default:'' }}">
                            {% if allergy_profile and allergy_profile.details %}
                                {{ allergy_profile.details }}
                            {% else %}
                                No allergies set for this patient.
                            {% endif %}
                        </strong>

                        <button id="allergy-action-btn" class="btn btn-sm btn-light" onclick="openAllergyModal()">
                            {% if allergy_profile %}Update{% else %}Set{% endif %}
                        </button>
                    </div>
                    {% endwith %}

                {% include 'admin_site/partials/error.html' %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Sidebar: Patient Info & Quick Actions -->
    <div class="col-lg-3">
        <!-- Vitals -->
        {% if consultation.queue_entry.vitals %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Current Vitals</h6>
            </div>
            <div class="card-body">
    <div class="row">
        <div class="col-6">
            <small class="text-muted">BP:</small><br>
            <strong>{{ consultation.queue_entry.vitals.blood_pressure }}</strong>
        </div>
        <div class="col-6">
            <small class="text-muted">Pulse:</small><br>
            <strong>{{ consultation.queue_entry.vitals.pulse_rate|default:"--" }}</strong>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-6">
            <small class="text-muted">Temp:</small><br>
            <strong>{{ consultation.queue_entry.vitals.temperature|default:"--" }}Â°C</strong>
        </div>
        <div class="col-6">
            <small class="text-muted">SpO2:</small><br>
            <strong>{{ consultation.queue_entry.vitals.oxygen_saturation|default:"--" }}%</strong>
        </div>
    </div>
    <!-- NEW: Weight Row -->
    <div class="row mt-2">
        <div class="col-6">
            <small class="text-muted">Weight:</small><br>
            <strong>{{ consultation.queue_entry.vitals.weight|default:"--" }} kg</strong>
        </div>
        {% if consultation.queue_entry.vitals.height %}
        <div class="col-6">
            <small class="text-muted">Height:</small><br>
            <strong>{{ consultation.queue_entry.vitals.height }} cm</strong>
        </div>
        {% endif %}

        <!-- Show other non-blank fields -->
        {% if consultation.queue_entry.vitals.respiratory_rate %}

        <div class="col-6">
            <small class="text-muted">Resp. Rate:</small><br>
            <strong>{{ consultation.queue_entry.vitals.respiratory_rate }}/min</strong>
        </div>
        {% endif %}

        {% if consultation.queue_entry.vitals.bmi %}
        <div class="col-6">
            <small class="text-muted">BMI:</small><br>
            <strong>{{ consultation.queue_entry.vitals.bmi }}</strong>
        </div>
        {% endif %}
    </div>

    {% if consultation.queue_entry.vitals.chief_complaint %}
    <div class="mt-2 col-12">
        <small class="text-muted">Chief Complaint:</small><br>
        <small>{{ consultation.queue_entry.vitals.chief_complaint }}</small>
    </div>
    {% endif %}
</div>

        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#verticalycentered">
                        <i class="bi bi-file"></i> Documents
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="prescribeDrug()">
                        <i class="bi bi-prescription2"></i> Prescribe Drug
                    </button>
                    <button class="btn btn-sm btn-info" onclick="orderLabTest()">
                        <i class="bi bi-clipboard2-pulse"></i> Order Lab Test
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="orderScan()">
                        <i class="bi bi-camera"></i> order Image
                    </button>
                    <!-- NEW: Service/Item Quick Actions -->
                    <button class="btn btn-sm btn-success" onclick="orderService()">
                        <i class="bi bi-journal-check"></i> Order Service
                    </button>
                    <button class="btn btn-sm btn-dark" onclick="orderItem()">
                        <i class="bi bi-box-seam"></i> Order Item
                    </button>
                    <!-- End New -->
                    <a href="{% url 'patient_history_view' patient_id=consultation.queue_entry.patient.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> View Patient History
                    </a>
                </div>
            </div>
        </div>

        <div class="modal fade" id="verticalycentered" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title card-title"><b>Old Consultation Documents</b></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        {% if consultation.queue_entry.patient.consultation_documents.all %}

                        <div class="list-group">
                            {% for patient_doc in consultation.queue_entry.patient.consultation_documents.all %}
                            <a href="{{ patient_doc.document.url }}" target="_blank" class="list-group-item list-group-item-action">
                                {% if patient_doc.title %}
                                    {{ patient_doc.title|title }}
                                {% else %}
                                    {{ patient_doc|title }}
                                {% endif %}
                            </a>
                            {% endfor %}
                        </div>
                                                {% else %}
                            <h3>No Past Document was uploaded for the patient</h3>
                        {% endif %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Quick View -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Recent History</h6>
            </div>
            <div class="card-body">
                {% if recent_consultations %}
                    {% for prev in recent_consultations|slice:":3" %}
                    <a href="{% url 'view_consultation_detail' prev.id %}">
                    <div class="border-bottom pb-2 mb-2">
                        <small class="text-muted">{{ prev.created_at|date:"M d" }}</small><br>
                        <small>{{ prev.diagnosis|truncatechars:40|default:"No diagnosis" }}</small>
                    </div></a>
                    {% endfor %}
                {% else %}
                    <small class="text-muted">No previous consultations</small>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content: Consultation Form -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="consultationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="consultation-tab" data-bs-toggle="tab" data-bs-target="#consultation-pane" type="button" role="tab">
                            <i class="bi bi-file-medical"></i> Consultation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="prescriptions-tab" data-bs-toggle="tab" data-bs-target="#prescriptions-pane" type="button" role="tab">
                            <i class="bi bi-prescription2"></i> Prescriptions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests-pane" type="button" role="tab">
                            <i class="bi bi-clipboard2-pulse"></i> Tests & Scans
                        </button>
                    </li>
                    <!-- NEW: Services & Items Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab">
                            <i class="bi bi-journal-check"></i> Services & Items
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="consultationTabContent">
                    <!-- Consultation Tab -->
                    <div class="tab-pane fade show active" id="consultation-pane" role="tabpanel">
                        <form id="consultationForm">
                            {% csrf_token %}
                            <input type="hidden" name="consultation_id" value="{{ consultation.id }}">

                            <div class="row">
                                <div class="col-md-12">
                                    <h6 class="text-primary mb-3">History & Examination</h6>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">Chief Complaint</label>
                                                <textarea class="form-control" name="chief_complaint" rows="2" placeholder="What is the patient complaining of?">{{ consultation.chief_complaint }}</textarea>
                                            </div>
                                        </div>

                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">Diagnosis</label>

                                                <!-- Selected Diagnoses Display -->
                                                <div id="selected-diagnoses-container" class="mb-2">
                                                    <!-- Primary diagnosis will show here -->
                                                    {% if consultation.primary_diagnosis %}
                                                    <span class="badge bg-primary me-2 mb-2 diagnosis-badge" data-diagnosis-id="{{ consultation.primary_diagnosis.id }}" data-type="primary">
                                                        <strong>Primary:</strong> {{ consultation.primary_diagnosis.name }}
                                                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removeDiagnosis('primary', {{ consultation.primary_diagnosis.id }})"></button>
                                                    </span>
                                                    {% endif %}

                                                    <!-- Secondary diagnoses will show here -->
                                                    {% for diag in consultation.secondary_diagnoses.all %}
                                                    <span class="badge bg-warning text-dark me-2 mb-2 diagnosis-badge" data-diagnosis-id="{{ diag.id }}" data-type="secondary">
                                                        <strong>Secondary:</strong> {{ diag.name }}
                                                        <button type="button" class="btn-close ms-2" style="font-size: 0.7rem;" onclick="removeDiagnosis('secondary', {{ diag.id }})"></button>
                                                    </span>
                                                    {% endfor %}
                                                </div>

                                                <!-- Search Input -->
                                                <div class="position-relative">
                                                    <input
                                                        type="text"
                                                        class="form-control"
                                                        id="diagnosis-search-input"
                                                        name="diagnosis_search_text"
                                                        placeholder="{% if consultation.primary_diagnosis %}Search for secondary diagnosis...{% else %}Search for primary diagnosis first...{% endif %}"
                                                        autocomplete="off"
                                                    />
                                                    <div id="diagnosis-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                                                </div>

                                                <!-- Hidden fields for form submission -->
                                                <input type="hidden" name="primary_diagnosis_id" id="primary-diagnosis-id" value="{{ consultation.primary_diagnosis.id|default:'' }}">
                                                <input type="hidden" name="secondary_diagnosis_ids" id="secondary-diagnosis-ids" value="{% for diag in consultation.secondary_diagnoses.all %}{{ diag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">

                                                <!-- Fallback text field (old diagnosis field) -->
                                                <input type="hidden" name="diagnosis" id="diagnosis-text-fallback" value="{{ consultation.diagnosis }}">

                                                <small class="text-muted">Type to search diagnoses. First selection = Primary, subsequent = Secondary.</small>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="col-md-12">

                                    <div class="mb-3">
                                        <label class="form-label">Clinical Assessment and Record</label>
                                        <textarea class="form-control" name="assessment" rows="3" placeholder="">{{ consultation.assessment }}</textarea>
                                    </div>


                                </div>
                            </div>

                            <div class="d-flex justify-content-between">

                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check"></i> Save & Continue
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Prescriptions Tab -->
                    <div class="tab-pane fade" id="prescriptions-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Prescribed Medications</h6>
                            <button class="btn btn-sm btn-primary" id="add-drug-in-tab-btn">
                                <i class="bi bi-plus"></i> Add Drug
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="prescriptionsTable">
                                <thead>
                                    <tr>
                                        <th>Drug</th>
                                        <th>Dosage</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prescription in prescriptions %}
                                    <tr data-prescription-id="{{ prescription.id }}" data-type="internal">
                                        <td>
                                            <strong>{{ prescription.drug.brand_name|default:prescription.drug.generic_name }}</strong>
                                            <small class="text-muted d-block">{{ prescription.drug.formulation }}</small>
                                        </td>
                                        <td>{{ prescription.dosage_instructions|truncatechars:30 }}</td>
                                        <td>{{ prescription.duration }}</td>
                                        <td>
                                            <span class="badge bg-{{ prescription.status|yesno:'success,warning' }}">
                                                {{ prescription.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" onclick="editDrugPrescription({{ prescription.id }}, {{ prescription.drug.id }}, '{{ prescription.dosage_instructions|escapejs }}', '{{ prescription.duration|escapejs }}', {{ prescription.quantity_ordered }}, '{{ prescription.notes|escapejs }}')" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDrugPrescription({{ prescription.id }})" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3">
                                            No medications prescribed yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if external_prescriptions %}
                            <h6 class="mt-4 mb-3">Unavailable / External Prescriptions</h6>
                            <div class="list-group">
                                {% for rx in external_prescriptions %}
                                <div class="list-group-item" data-external-id="{{ rx.id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1">{{ rx.drug_name|title }}</h5>
                                            <p class="mb-1">
                                                {% if rx.dosage_instructions %}
                                                    <strong>Dosage:</strong> {{ rx.dosage_instructions }}
                                                {% endif %}
                                                {% if rx.duration %}
                                                    <span class="ms-2"><strong>Duration:</strong> {{ rx.duration }}</span>
                                                {% endif %}
                                            </p>
                                            <small class="text-muted"><strong>Quantity:</strong> {{ rx.quantity }}</small>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-warning" onclick="editExternalPrescription({{ rx.id }}, '{{ rx.drug_name|escapejs }}', '{{ rx.dosage_instructions|escapejs }}', '{{ rx.duration|escapejs }}', '{{ rx.quantity|escapejs }}', '{{ rx.notes|escapejs }}')" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteExternalPrescription({{ rx.id }})" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                    </div>

                    <!-- Tests & Scans Tab -->
                    <div class="tab-pane fade" id="tests-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Lab Tests Ordered</h6>
                                    <button class="btn btn-sm btn-info" id="order-test-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Lab Test
                                    </button>
                                </div>

                                <!-- INTERNAL LAB TESTS -->
                                <div class="list-group" id="internal-lab-test-list">
                                    {% for test in lab_tests %}
                                    <div class="list-group-item" data-lab-id="{{ test.id }}" data-type="internal">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ test.template.name }}</strong>
                                                <small class="text-muted d-block">{{ test.order_number }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-xs btn-warning" onclick="editLabTest({{ test.id }}, {{ test.template.id }}, '{{ test.template.name|escapejs }}', '{{ test.special_instructions|escapejs }}')" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteLabTest({{ test.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between align-items-center">
                                            <span class="badge bg-secondary">{{ test.get_status_display }}</span>

                                            {% if test.status == 'completed' %}
                                                {% if test.result and test.result.is_verified %}
                                                    <button class="btn btn-xs btn-outline-primary" onclick="viewTestResult({{ test.id }})">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <span class="badge bg-warning">Awaiting Verification</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="list-group-item text-center text-muted" id="no-internal-lab-tests">
                                        No internal lab tests ordered
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- EXTERNAL LAB TESTS SECTION -->
                                {% if external_lab_tests %}
                                <h6 class="mt-4 mb-3">External Lab Tests</h6>
                                <div class="list-group" id="external-lab-test-list">
                                    {% for test in external_lab_tests %}
                                    <div class="list-group-item" data-external-lab-id="{{ test.id }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ test.test_name }}</strong>
                                                <span class="badge bg-warning text-dark ms-2">External</span>
                                                <small class="text-muted d-block">{{ test.order_number }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-xs btn-warning" onclick="editExternalLabTest({{ test.id }}, '{{ test.test_name|escapejs }}', '{{ test.special_instructions|escapejs }}')" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteExternalLabTest({{ test.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% if test.has_result %}
                                                    <a href="{{ test.result_file.url }}" target="_blank" class="btn btn-xs btn-outline-primary">
                                                        <i class="bi bi-file-earmark-pdf"></i> View Result
                                                    </a>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Result Not Available</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}


                            </div>

                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Scans Ordered</h6>
                                    <button class="btn btn-sm btn-warning" id="order-scan-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Image
                                    </button>
                                </div>

                                <!-- INTERNAL SCANS -->
                                <div class="list-group" id="internal-scan-list">
                                    {% for scan in scans %}
                                    <div class="list-group-item" data-scan-id="{{ scan.id }}" data-type="internal">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ scan.template.name }}</strong>
                                                <small class="text-muted d-block">{{ scan.order_number }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-xs btn-warning" onclick="editScan({{ scan.id }}, {{ scan.template.id }}, '{{ scan.template.name|escapejs }}', '{{ scan.clinical_indication|escapejs }}')" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteScan({{ scan.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between align-items-center">
                                            <span class="badge bg-secondary">{{ scan.get_status_display }}</span>

                                            {% if scan.status == 'completed' %}
                                                <button class="btn btn-xs btn-outline-primary" onclick="viewScanResult({{ scan.id }})">
                                                    View Result
                                                </button>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="list-group-item text-center text-muted" id="no-internal-scans">
                                        No internal scans ordered
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- EXTERNAL SCANS SECTION -->
                                {% if external_scans %}
                                <h6 class="mt-4 mb-3">External Scans</h6>
                                <div class="list-group" id="external-scan-list">
                                    {% for scan in external_scans %}
                                    <div class="list-group-item" data-external-scan-id="{{ scan.id }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ scan.scan_name }}</strong>
                                                <span class="badge bg-warning text-dark ms-2">External</span>
                                                <small class="text-muted d-block">{{ scan.order_number }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-xs btn-warning" onclick="editExternalScan({{ scan.id }}, '{{ scan.scan_name|escapejs }}', '{{ scan.clinical_indication|escapejs }}')" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteExternalScan({{ scan.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% if scan.has_result %}
                                                    <a href="{{ scan.result_file.url }}" target="_blank" class="btn btn-xs btn-outline-primary">
                                                        <i class="bi bi-file-earmark-pdf"></i> View Result
                                                    </a>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Result Not Available</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Services & Items Tab Pane -->
                    <div class="tab-pane fade" id="services-pane" role="tabpanel">
                        <div class="row">
                            <!-- Services Column -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Services Ordered</h6>
                                    <button class="btn btn-sm btn-success" id="order-service-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Service
                                    </button>
                                </div>
                                <div class="list-group" id="service-order-list">
                                    {% for tx in service_transactions|dictsortreversed:"created_at" %}
                                    {% if tx.service %}
                                    <div class="list-group-item" data-service-order-id="{{ tx.id }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ tx.service.name }}</strong> (x{{ tx.quantity }})
                                                <small class="text-muted d-block">{{ tx.get_status_display }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <!-- Add Edit button if needed -->
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteServiceOrder({{ tx.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% if tx.service.has_results %}
                                        <div class="mt-2 d-flex justify-content-between align-items-center">
                                            {% if tx.result and tx.result.is_verified %}
                                                <span class="badge bg-success">Result Available</span>
                                                <button class="btn btn-xs btn-outline-primary" onclick="viewServiceResult({{ tx.result.id }})">
                                                    View Result
                                                </button>
                                            {% elif tx.result %}
                                                <span class="badge bg-warning">Awaiting Verification</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {% if not service_transactions %}
                                    <div class="list-group-item text-center text-muted" id="no-service-orders">
                                        No services ordered yet
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Items Column -->
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Items Ordered</h6>
                                    <button class="btn btn-sm btn-dark" id="order-item-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Item
                                    </button>
                                </div>
                                <div class="list-group" id="item-order-list">
                                    {% for tx in service_transactions|dictsortreversed:"created_at" %}
                                    {% if tx.service_item %}
                                    <div class="list-group-item" data-item-order-id="{{ tx.id }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ tx.service_item.name }}</strong> (x{{ tx.quantity }})
                                                <small class="text-muted d-block">{{ tx.get_status_display }}</small>
                                            </div>
                                            <div class="btn-group">
                                                <!-- Add Edit button if needed -->
                                                <button class="btn btn-xs btn-outline-danger" onclick="deleteServiceOrder({{ tx.id }})" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}

                                    {% if not service_transactions %}
                                    <div class="list-group-item text-center text-muted" id="no-item-orders">
                                        No items ordered yet
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END: Services & Items Tab Pane -->

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drug Prescription Modal -->
<div class="modal fade" id="drugPrescriptionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prescribe Medications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="prescription-list">
                    </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-drug-btn">
                        <i class="bi bi-plus-circle"></i> Add Drug from Inventory
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="add-external-drug-btn">
                        <i class="bi bi-journal-plus"></i> Add Unavailable Drug
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-prescriptions-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Save Prescriptions
                </button>
            </div>
        </div>
    </div>
</div>

<template id="available-drug-template">
    <div class="card prescription-row mb-3" data-type="available">
        <div class="card-body">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>

            <div class="row g-2 mb-2">
                <div class="col-md-12 position-relative">
                    <label class="form-label">Search Drug</label>
                    <input type="text" class="form-control drug-search-input" placeholder="Start typing drug name..." required>
                    <input type="hidden" class="drug-id-input" name="drug_id">
                    <input type="hidden" class="drug-pack-size-input" name="pack_size">
                    <input type="hidden" class="drug-unit-input" name="unit">
                    <div class="search-results list-group position-absolute w-100" style="z-index: 1050;"></div>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-md-5">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 2 tablets twice daily, 1 tab b.d, ii tabs tds" required>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 7 days or 1 week">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Total Quantity</label>
                    <div class="input-group">
                        <input type="number" class="form-control quantity-input" name="quantity" placeholder="Auto" min="1" required>
                        <input type="text" class="form-control quantity-display" readonly style="max-width: 150px; font-size: 0.875rem;">
                    </div>
                </div>
            </div>
             <div class="row g-2 mt-2">
                <div class="col-md-12">
                     <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="Additional instructions...">
                </div>
            </div>
        </div>
    </div>
</template>

<template id="external-drug-template">
    <div class="card prescription-row mb-3" data-type="external">
        <div class="card-body bg-light">
             <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Drug Name</label>
                    <input type="text" class="form-control drug-name-input" name="drug_name" placeholder="Enter drug name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 1 tablet once daily" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 10 days">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantity</label>
                    <input type="text" class="form-control quantity-input" name="quantity" placeholder="e.g., 1 Card" required>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-12">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="e.g., Purchase from external pharmacy">
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Lab Test Modal -->
<div class="modal fade" id="labTestModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Lab Tests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="testCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in lab_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="lab-test-list">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-lab-test-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Test
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="submit-lab-orders-btn">Order Tests</button>
            </div>
        </div>
    </div>
</div>

<!-- Scan Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Imaging</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="imagingCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in scan_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="imaging-list">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-warning mt-2" id="add-imaging-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Image Request
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submit-imaging-orders-btn">Order Imaging</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Service Order Modal -->
<div class="modal fade" id="serviceOrderModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="serviceCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in service_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="service-order-form-list">
                    <!-- Service rows will be injected here -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-service-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Service
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submit-service-orders-btn">Order Services</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Item Order Modal -->
<div class="modal fade" id="itemOrderModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="itemCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in item_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="item-order-form-list">
                    <!-- Item rows will be injected here -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-dark mt-2" id="add-item-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Item
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dark" id="submit-item-orders-btn">Order Items</button>
            </div>
        </div>
    </div>
</div>


<!-- TEMPLATES -->
<template id="lab-test-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for a lab test...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control instructions-input" name="special_instructions" placeholder="Clinical indication / Instructions (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<template id="imaging-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for an imaging request...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control indication-input" name="clinical_indication" placeholder="Clinical indication (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<!-- NEW: Service Row Template -->
<template id="service-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-5 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for a service...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control quantity-input" name="quantity" value="1" min="1">
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control notes-input" name="notes" placeholder="Notes (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<!-- NEW: Item Row Template -->
<template id="item-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-5 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for an item...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control quantity-input" name="quantity" value="1" min="1">
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control notes-input" name="notes" placeholder="Notes (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>


<!-- SCRIPT -->
<script>
const consultationId = {{ consultation.id }};
const patientId = {{ consultation.queue_entry.patient.id }};
let autoSaveTimer;

// Modal variables
let confirmationModal, messageModal, dosageWarningModal, duplicateModal;
let labTestModal, scanModal, serviceOrderModal, itemOrderModal, drugPrescriptionModal;
let allergyModal;

let confirmCallback = () => {};
let pendingPrescriptionData = null; // Store data for force save

// Central function to show confirmation modal (BUG FIX #3)
function showConfirmationModal(message, callback) {
    document.getElementById('confirmationModalBody').textContent = message;
    const confirmBtn = document.getElementById('confirmButton');

    // Replace the button to remove old listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.disabled = false;
    newConfirmBtn.innerHTML = 'Confirm';
    document.getElementById('confirmationModalLabel').textContent = "Confirm Action";

    newConfirmBtn.addEventListener('click', function() {
        // Disable button on click
        newConfirmBtn.disabled = true;
        newConfirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        document.getElementById('confirmationModalLabel').textContent = "Processing...";

        if (typeof callback === 'function') {
            callback();
        }
    });
    confirmationModal.show();
}

// Function to reset the confirmation modal button (called on modal hide or error)
function resetConfirmModal() {
    const confirmBtn = document.getElementById('confirmButton');
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = 'Confirm';
    document.getElementById('confirmationModalLabel').textContent = "Confirm Action";
}


document.addEventListener('DOMContentLoaded', function() {
    // Initialize TinyMCE
    if (typeof tinymce !== 'undefined') {
        tinymce.init({
            selector: 'textarea[name="assessment"], textarea[name="treatment_plan"]',
            height: 250,
             plugins: ['lists', 'table', 'link', 'image'],
            toolbar: 'undo redo | styles | bold italic underline | bullist numlist | link | table',
            menubar: false
        });
    }

    // Initialize all modals
    confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    dosageWarningModal = new bootstrap.Modal(document.getElementById('dosageWarningModal'));
    duplicateModal = new bootstrap.Modal(document.getElementById('duplicateConfirmModal'));
    allergyModal = new bootstrap.Modal(document.getElementById('allergyModal'));
    labTestModal = new bootstrap.Modal(document.getElementById('labTestModal'));
    scanModal = new bootstrap.Modal(document.getElementById('scanModal'));
    drugPrescriptionModal = new bootstrap.Modal(document.getElementById('drugPrescriptionModal'));

    // NEW Modals
    serviceOrderModal = new bootstrap.Modal(document.getElementById('serviceOrderModal'));
    itemOrderModal = new bootstrap.Modal(document.getElementById('itemOrderModal'));

    // Initialize modal workflows
    initializePrescriptionModal();
    initializeOrderModals();
    initializeServiceItemOrderModals(); // NEW

    // Format allergy text
    const allergyTextElem = document.getElementById('allergy-text');
    const rawDetails = allergyTextElem.getAttribute('data-raw-details');
    if (rawDetails && rawDetails.trim() !== '') {
        const formattedDetails = rawDetails.trim().replace(/(\r\n|\n|\r)+/g, ', ');
        allergyTextElem.innerHTML = `<strong>Allergies:</strong> ${formattedDetails}`;
    } else {
        allergyTextElem.textContent = 'No allergies set for this patient.';
    }

    // Auto-save
    autoSaveTimer = setInterval(saveDraft, 30000);

    // Modal Listeners
    document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', resetConfirmModal);

    // BUG FIX #4: Fix "Add Anyway" buttons
    document.getElementById('confirmDosageBtn').addEventListener('click', function() {
        dosageWarningModal.hide();
        if (pendingPrescriptionData) {
            submitPrescriptions(true); // Call with forceSave = true
        }
    });
    document.getElementById('forceSaveBtn').addEventListener('click', function() {
        duplicateModal.hide();
        if (pendingPrescriptionData) {
            submitPrescriptions(true); // Call with forceSave = true
        }
    });

    // Reset modal submit buttons when modals are hidden
    document.getElementById('drugPrescriptionModal').addEventListener('hidden.bs.modal', function() {
        const submitBtn = document.getElementById('submit-prescriptions-btn');
        submitBtn.textContent = 'Save Prescriptions';
        submitBtn.onclick = () => submitPrescriptions(false);
    });

    document.getElementById('labTestModal').addEventListener('hidden.bs.modal', function() {
        const submitBtn = document.getElementById('submit-lab-orders-btn');
        submitBtn.textContent = 'Order Tests';
        submitBtn.onclick = () => submitOrders('lab');
    });

    document.getElementById('scanModal').addEventListener('hidden.bs.modal', function() {
        const submitBtn = document.getElementById('submit-imaging-orders-btn');
        submitBtn.textContent = 'Order Imaging';
        submitBtn.onclick = () => submitOrders('imaging');
    });

    // NEW: Reset Service/Item Modals
    document.getElementById('serviceOrderModal').addEventListener('hidden.bs.modal', function() {
        const submitBtn = document.getElementById('submit-service-orders-btn');
        submitBtn.textContent = 'Order Services';
        submitBtn.onclick = () => submitServiceItemOrders('service');
    });
    document.getElementById('itemOrderModal').addEventListener('hidden.bs.modal', function() {
        const submitBtn = document.getElementById('submit-item-orders-btn');
        submitBtn.textContent = 'Order Items';
        submitBtn.onclick = () => submitServiceItemOrders('item');
    });

    // BUG FIX #7: Switch to tab on reload
    const tabToShow = sessionStorage.getItem('showTab');
    if (tabToShow) {
        switchToTab(tabToShow);
        sessionStorage.removeItem('showTab');
    }
});

// Consultation form submission
document.getElementById('consultationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (typeof tinymce !== 'undefined') tinymce.triggerSave();

    const formData = new FormData(this);

    // PATCH: Capture unsaved diagnosis text as fallback
    const searchInput = document.getElementById('diagnosis-search-input');
    const unsavedText = searchInput.value.trim();
    if (unsavedText && !hasPrimaryDiagnosis) {
        formData.set('diagnosis', unsavedText);
        document.getElementById('diagnosis-text-fallback').value = unsavedText;
    }

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    fetch(`/portal/consultation/ajax/save-consultation/${consultationId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Consultation notes saved successfully', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to save'), 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'))
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

function openAllergyModal() {
    const rawDetails = document.getElementById('allergy-text').getAttribute('data-raw-details');
    document.getElementById('allergyDetailsText').value = rawDetails;
    allergyModal.show();
}

function saveAllergy() {
    const allergyDetails = document.getElementById('allergyDetailsText').value;
    const csrfToken = getCookie('csrftoken');

    const formData = new FormData();
    formData.append('details', allergyDetails);

    fetch(`/portal/consultation/ajax/update-allergy/${patientId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            allergyModal.hide();
            showAlert('Allergies updated successfully!', 'success');

            const allergyTextElem = document.getElementById('allergy-text');
            const allergyContainer = document.getElementById('allergy-display-container');
            const allergyBtn = document.getElementById('allergy-action-btn');

            if (data.details && data.details.trim() !== '') {
                const formattedDetails = data.details.trim().replace(/(\r\n|\n|\r)+/g, ', ');
                allergyTextElem.innerHTML = `<strong>Allergies:</strong> ${formattedDetails}`;
                allergyTextElem.setAttribute('data-raw-details', data.details);
            } else {
                allergyTextElem.textContent = 'No allergies set for this patient.';
                allergyTextElem.setAttribute('data-raw-details', '');
            }

            const newTitle = `Last updated by ${data.updated_by} at ${data.updated_at}`;
            allergyContainer.setAttribute('title', newTitle);
            allergyBtn.textContent = 'Update';

        } else {
            showAlert('Error: Could not save allergies.', 'danger');
        }
    })
    .catch(error => {
        showAlert('An unexpected network error occurred.', 'danger');
    });
}

// Silent auto-save
function saveDraft() {
    if (typeof tinymce !== 'undefined') tinymce.triggerSave();
    const form = document.getElementById('consultationForm');
    const formData = new FormData(form);

    fetch(`/portal/consultation/ajax/save-consultation/${consultationId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) console.error('Auto-save failed:', data.error);
    })
    .catch(error => console.error('Auto-save failed:', error));
}

// MODIFIED: Pause consultation (BUG FIX #3)
function pauseConsultation() {
    const message = 'Are you sure you want to pause this consultation?';
    showConfirmationModal(message, () => {
        const pauseBtn = document.getElementById('pauseBtn');
        pauseBtn.disabled = true; // Disable original button too

        fetch(`/portal/consultation/ajax/pause-consultation/${consultationId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showAlert('Consultation paused. Redirecting...', 'info');
                setTimeout(() => {
                    window.location.href = '{% url "doctor_dashboard" %}';
                }, 1500);
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to pause', 'danger');
            }
        })
        .catch(error => {
            confirmationModal.hide();
            showAlert('An unexpected error occurred.', 'danger');
        })
        .finally(() => {
            pauseBtn.disabled = false; // Re-enable original button
            resetConfirmModal(); // Reset modal button
        });
    });
}

// MODIFIED: Complete consultation (BUG FIX #3)
function completeConsultation() {
    const message = 'Are you sure you want to complete this consultation?';
    showConfirmationModal(message, () => {
        const completeBtn = document.getElementById('completeBtn');
        completeBtn.disabled = true;

        saveDraft();

        setTimeout(() => {
            fetch(`/portal/consultation/ajax/complete-consultation/${consultationId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    confirmationModal.hide();
                    showAlert('Consultation completed successfully', 'success');
                    clearInterval(autoSaveTimer);
                    setTimeout(() => {
                        window.location.href = '{% url "doctor_dashboard" %}';
                    }, 1500);
                } else {
                    confirmationModal.hide();
                    showAlert(data.error || 'Failed to complete', 'danger');
                }
            })
            .catch(error => {
                confirmationModal.hide();
                showAlert('An unexpected error occurred.', 'danger');
            })
            .finally(() => {
                completeBtn.disabled = false;
                resetConfirmModal();
            });
        }, 500);
    });
}


// --- Prescription Functions ---

function initializePrescriptionModal() {
    const openModalAction = (e) => {
        e.preventDefault();
        document.getElementById('prescription-list').innerHTML = '';
        addDrugForm();
        drugPrescriptionModal.show();
    };

    document.querySelector('button[onclick="prescribeDrug()"]').addEventListener('click', openModalAction);
    document.getElementById('add-drug-in-tab-btn').addEventListener('click', openModalAction);

    document.getElementById('add-drug-btn').addEventListener('click', addDrugForm);
    document.getElementById('add-external-drug-btn').addEventListener('click', addExternalDrugForm);
    document.getElementById('submit-prescriptions-btn').addEventListener('click', () => submitPrescriptions(false));
}

function addDrugForm() {
    const template = document.getElementById('available-drug-template');
    const clone = template.content.cloneNode(true);
    const formRow = clone.querySelector('.prescription-row');
    document.getElementById('prescription-list').appendChild(clone);

    const searchInput = formRow.querySelector('.drug-search-input');
    const dosageInput = formRow.querySelector('.dosage-input');
    const durationInput = formRow.querySelector('.duration-input');
    const quantityInput = formRow.querySelector('.quantity-input');

    searchInput.addEventListener('input', () => handleDrugSearch(searchInput));
    dosageInput.addEventListener('input', () => calculateQuantity(formRow));
    durationInput.addEventListener('input', () => calculateQuantity(formRow));
    quantityInput.addEventListener('input', () => {
        const packSize = parseInt(formRow.querySelector('.drug-pack-size-input')?.value || '1') || 1;
        const unitType = formRow.querySelector('.drug-unit-input')?.value || 'tablet';
        const quantityDisplay = formRow.querySelector('.quantity-display');
        const totalUnits = parseInt(quantityInput.value) || 0;
        updateQuantityDisplay(totalUnits, packSize, unitType, quantityDisplay);
    });
}

function addExternalDrugForm() {
    const template = document.getElementById('external-drug-template');
    const clone = template.content.cloneNode(true);
    document.getElementById('prescription-list').appendChild(clone);
}

function removeDrugForm(buttonEl) {
    buttonEl.closest('.prescription-row').remove();
}

function handleDrugSearch(inputEl) {
    const query = inputEl.value;
    const resultsContainer = inputEl.parentElement.querySelector('.search-results');
    const formRow = inputEl.closest('.prescription-row');

    formRow.querySelector('.drug-id-input').value = '';
    formRow.querySelector('.drug-pack-size-input').value = '';
    formRow.querySelector('.drug-unit-input').value = '';

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`/portal/consultation/ajax/search-drugs/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.drugs.length > 0) {
                data.drugs.forEach(drug => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${drug.brand_name || drug.generic_name} (${drug.formulation}) - Stock: ${drug.pharmacy_quantity}`;

                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        formRow.querySelector('.drug-search-input').value = item.textContent;
                        formRow.querySelector('.drug-id-input').value = drug.id;
                        formRow.querySelector('.drug-pack-size-input').value = drug.pack_size || 1;
                        formRow.querySelector('.drug-unit-input').value = drug.unit || 'tablet';
                        resultsContainer.innerHTML = '';
                        calculateQuantity(formRow);
                    });
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<span class="list-group-item">No drugs found</span>';
            }
        });
}

// MODIFIED: calculateQuantity (BUG FIX #6 - Roman Numerals)
function calculateQuantity(formRowEl) {
    const dosageText = formRowEl.querySelector('.dosage-input').value;
    const cleanedDosage = dosageText.replace(/\./g, '').toLowerCase();
    const durationText = formRowEl.querySelector('.duration-input').value.toLowerCase();
    const packSize = parseInt(formRowEl.querySelector('.drug-pack-size-input')?.value || '1') || 1;
    let unitType = (formRowEl.querySelector('.drug-unit-input')?.value || 'tablet').toLowerCase();
    const quantityInput = formRowEl.querySelector('.quantity-input');
    const quantityDisplay = formRowEl.querySelector('.quantity-display');

    if (!quantityInput) return;

    // PATCH: Handle cream, ointment, syrup, drops - always 1
    const alwaysOneTypes = ['cream', 'ointment', 'syrup', 'drop', 'drops'];
    if (alwaysOneTypes.includes(unitType)) {
        quantityInput.value = 1;
        quantityInput.readOnly = false; // Allow override
        updateQuantityDisplay(1, packSize, unitType, quantityDisplay);
        return;
    }

    let durationDays = 0;
    const durationMatch = durationText.match(/^(\d+)/);
    if (durationMatch) {
        const num = parseInt(durationMatch[1]);
        if (durationText.includes('week') || durationText.includes('w')) durationDays = num * 7;
        else if (durationText.includes('month') || durationText.includes('m')) durationDays = num * 30;
        else durationDays = num;
    }

    // PATCH: Handle injection/drip - 1 Ã duration
    if (unitType === 'injection' || unitType === 'drip') {
        if (durationDays > 0) {
            const totalUnits = 1 * durationDays;
            quantityInput.value = totalUnits;
            quantityInput.readOnly = false; // Allow override
            updateQuantityDisplay(totalUnits, packSize, unitType, quantityDisplay);
        } else {
            quantityInput.value = 1; // Default to 1 if no duration
            quantityInput.readOnly = false;
            updateQuantityDisplay(1, packSize, unitType, quantityDisplay);
        }
        return;
    }

    // Rest of your existing calculation logic for tablets/capsules...
    let dailyDose = 0;
    let dose = 0;
    const doseMatch = cleanedDosage.match(/^(\d+(\.\d+)?)/);

    if (doseMatch) {
        dose = parseFloat(doseMatch[1]);
    } else {
        // Check for roman numerals
        if (cleanedDosage.startsWith('iii')) dose = 3;
        else if (cleanedDosage.startsWith('ii')) dose = 2;
        else if (cleanedDosage.startsWith('iv')) dose = 4;
        else if (cleanedDosage.startsWith('v')) dose = 5;
        else if (cleanedDosage.startsWith('i')) dose = 1;
    }

    if (dose > 0) {
        let frequency = 1;
        if (/\b(bd|bid|twice|q12h)\b/.test(cleanedDosage)) frequency = 2;
        else if (/\b(tds|tid|thrice|q8h)\b/.test(cleanedDosage)) frequency = 3;
        else if (/\b(qds|qid|four times|q6h)\b/.test(cleanedDosage)) frequency = 4;
        else if (/\b(q4h)\b/.test(cleanedDosage)) frequency = 6;
        else if (/\b(od|daily|once)\b/.test(cleanedDosage)) frequency = 1;

        const timesMatch = cleanedDosage.match(/(\d+)\s*time/);
        if (timesMatch) frequency = parseInt(timesMatch[1]);

        const slashMatch = dosageText.match(/\//g);
        if (slashMatch) frequency = slashMatch.length + 1;

        dailyDose = dose * frequency;
    }

    if (dailyDose > 0 && durationDays > 0) {
        const totalUnits = Math.ceil(dailyDose * durationDays);
        quantityInput.value = totalUnits;
        quantityInput.readOnly = false; // Allow override
        updateQuantityDisplay(totalUnits, packSize, unitType, quantityDisplay);
    } else {
        quantityInput.value = '';
        quantityInput.readOnly = false;
        updateQuantityDisplay(0, packSize, unitType, quantityDisplay);
    }
}

function getPackageTerminology(unitType) {
    const terminology = {
        'tablet': ['card', 'cards'],
        'capsule': ['card', 'cards'],
        'injection': ['pack', 'packs'],
        'syrup': ['bottle', 'bottles'],
        'cream': ['tube', 'tubes'],
        'ointment': ['tube', 'tubes'],
        'drop': ['bottle', 'bottles'],
        'drops': ['bottle', 'bottles']
    };
    return terminology[unitType] || ['pack', 'packs'];
}

function updateQuantityDisplay(totalUnits, packSize, unitType, displayElement) {
    if (!displayElement) return;

    if (!totalUnits || totalUnits === 0) {
        displayElement.value = '';
        return;
    }

    if (packSize === 1 || totalUnits < packSize) {
        displayElement.value = `${totalUnits} ${totalUnits === 1 ? unitType : unitType + 's'}`;
        return;
    }

    const fullPacks = Math.floor(totalUnits / packSize);
    const remainingUnits = totalUnits % packSize;
    const [singularTerm, pluralTerm] = getPackageTerminology(unitType);
    const packTerm = fullPacks === 1 ? singularTerm : pluralTerm;

    if (remainingUnits === 0) {
        displayElement.value = `${fullPacks} ${packTerm}`;
    } else {
        displayElement.value = `${fullPacks} ${packTerm} ${remainingUnits} ${remainingUnits === 1 ? unitType : unitType + 's'}`;
    }
}

// MODIFIED: submitPrescriptions (BUG FIX #4, #5)
function submitPrescriptions(forceSave = false) {
    const submitBtn = document.getElementById('submit-prescriptions-btn');
    const spinner = submitBtn.querySelector('.spinner-border');

    let payload;

    if (forceSave && pendingPrescriptionData) {
        // This is a force-save call, use the stored payload
        payload = pendingPrescriptionData;
        payload.force_save = true;
        pendingPrescriptionData = null; // Clear it after use
    } else {
        // This is a new submission, build the payload
        pendingPrescriptionData = null; // Clear any old data
        payload = {
            patient_id: patientId,
            consultation_id: consultationId,
            available_drugs: [],
            external_drugs: [],
            force_save: false
        };

        const forms = document.querySelectorAll('.prescription-row');
        let isValid = true;
        let seenDrugs = {};
        let duplicateError = null;
        let highDosageWarning = false;
        let highDosageDrugs = [];
        const nonWarningTypes = ['cream', 'ointment', 'drop', 'syrup', 'injection', 'drip'];

        forms.forEach(form => {
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

            const type = form.dataset.type;
            const dosage = form.querySelector('.dosage-input').value;
            const cleanedDosage = dosage.trim().toLowerCase();
            const quantity = form.querySelector('.quantity-input').value; // BUG FIX #5

            // BUG FIX #5: Check for quantity
            if (!quantity) {
                isValid = false;
                form.querySelector('.quantity-input').classList.add('is-invalid');
            }
             // BUG FIX #5: Check for dosage
            if (!dosage) {
                isValid = false;
                form.querySelector('.dosage-input').classList.add('is-invalid');
            }


            if (type === 'available') {
                const drugId = form.querySelector('.drug-id-input').value;
                const unitType = (form.querySelector('.drug-unit-input')?.value || 'tablet').toLowerCase();

                if (!drugId) {
                    isValid = false;
                    form.querySelector('.drug-search-input').classList.add('is-invalid');
                }

                const key = `${drugId}-${cleanedDosage}`;
                if (seenDrugs[key]) {
                    isValid = false;
                    form.querySelector('.drug-search-input').classList.add('is-invalid');
                    form.querySelector('.dosage-input').classList.add('is-invalid');
                    duplicateError = 'You have added the same drug with the exact same dosage multiple times. Please remove the duplicate entry.';
                } else {
                    seenDrugs[key] = true;
                }

                const doseMatch = cleanedDosage.match(/^(iii|ii|iv|v|i|\d+(\.\d+)?)/); // Check roman first
                if (doseMatch) {
                    let dose = 0;
                    if (doseMatch[1] === 'iii') dose = 3;
                    else if (doseMatch[1] === 'ii') dose = 2;
                    else if (doseMatch[1] === 'iv') dose = 4;
                    else if (doseMatch[1] === 'v') dose = 5;
                    else if (doseMatch[1] === 'i') dose = 1;
                    else dose = parseFloat(doseMatch[1]);

                    if (dose > 12 && !nonWarningTypes.includes(unitType)) {
                        highDosageWarning = true;
                        highDosageDrugs.push(form.querySelector('.drug-search-input').value.split(' (')[0] || 'Unknown Drug');
                    }
                }

                payload.available_drugs.push({
                    drug_id: drugId,
                    dosage: dosage,
                    duration: form.querySelector('.duration-input').value,
                    quantity: quantity,
                    notes: form.querySelector('.notes-input').value
                });

            } else if (type === 'external') {
                const drugName = form.querySelector('.drug-name-input').value;
                if (!drugName) {
                    isValid = false;
                    form.querySelector('.drug-name-input').classList.add('is-invalid');
                }

                // BUG FIX #5: Check quantity for external drugs
                const externalQuantity = form.querySelector('.quantity-input').value;
                if (!externalQuantity) {
                    isValid = false;
                    form.querySelector('.quantity-input').classList.add('is-invalid');
                }

                const key = `${drugName.trim().toLowerCase()}-${cleanedDosage}`;
                 if (seenDrugs[key]) {
                    isValid = false;
                    form.querySelector('.drug-name-input').classList.add('is-invalid');
                    form.querySelector('.dosage-input').classList.add('is-invalid');
                    duplicateError = 'You have added the same drug with the exact same dosage multiple times. Please remove the duplicate entry.';
                } else {
                    seenDrugs[key] = true;
                }

                const doseMatch = cleanedDosage.match(/^(iii|ii|iv|v|i|\d+(\.\d+)?)/);
                if (doseMatch) {
                    let dose = 0;
                    if (doseMatch[1] === 'iii') dose = 3;
                    else if (doseMatch[1] === 'ii') dose = 2;
                    else if (doseMatch[1] === 'iv') dose = 4;
                    else if (doseMatch[1] === 'v') dose = 5;
                    else if (doseMatch[1] === 'i') dose = 1;
                    else dose = parseFloat(doseMatch[1]);

                    if (dose > 12) {
                        highDosageWarning = true;
                        highDosageDrugs.push(drugName || 'Unknown External Drug');
                    }
                }

                payload.external_drugs.push({
                    drug_name: drugName,
                    dosage: dosage,
                    duration: form.querySelector('.duration-input').value,
                    quantity: externalQuantity,
                    notes: form.querySelector('.notes-input').value
                });
            }
        });

        if (duplicateError) {
            showAlert(duplicateError, 'danger');
            return;
        }

        if (!isValid) {
            showAlert('Please complete all required fields (Drug, Dosage, Quantity, etc.).', 'warning');
            return;
        }
        if (payload.available_drugs.length === 0 && payload.external_drugs.length === 0) {
            showAlert('Please add at least one medication.', 'info');
            return;
        }

        if (highDosageWarning && !forceSave) {
            pendingPrescriptionData = payload; // Store data
            const modalBody = document.getElementById('dosageWarningModalBody');
            modalBody.innerHTML = `
                <p>The following drugs have a dosage value higher than 12:</p>
                <ul>
                    ${[...new Set(highDosageDrugs)].map(drug => `<li><strong>${drug}</strong></li>`).join('')}
                </ul>
                <p>Are you sure this is correct?</p>
            `;
            dosageWarningModal.show();
            return; // Stop submission
        }
    }

    // --- Start of AJAX call (common to both paths) ---
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');

    fetch("{% url 'prescribe_multiple' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            drugPrescriptionModal.hide();
            showAlert(data.message, 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'prescriptions-pane');
                window.location.reload();
            }, 1500);
        } else if (data.duplicate) {
            pendingPrescriptionData = payload; // Store payload for re-submission
            const modalBody = document.getElementById('duplicateModalBody');
            modalBody.innerHTML = `
                <p>${data.message}:</p>
                <ul>
                    ${data.drugs.map(drug => `<li><strong>${drug}</strong></li>`).join('')}
                </ul>
                <p>Do you want to prescribe anyway?</p>
            `;
            duplicateModal.show();
        } else {
            showAlert(data.error || 'An error occurred.', 'danger');
        }
    })
    .catch(error => showAlert('A network error occurred.', 'danger'))
    .finally(() => {
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    });
}


// --- Lab/Scan Order Functions ---

function initializeOrderModals() {
    // Lab Test
    const openLabModalAction = (e) => {
        e.preventDefault();
        document.getElementById('lab-test-list').innerHTML = '';
        addOrderForm('lab');
        labTestModal.show();
    };
    document.querySelector('button[onclick="orderLabTest()"]').addEventListener('click', openLabModalAction);
    document.getElementById('order-test-in-tab-btn').addEventListener('click', openLabModalAction);
    document.getElementById('add-lab-test-btn').addEventListener('click', () => addOrderForm('lab'));
    document.getElementById('submit-lab-orders-btn').addEventListener('click', () => submitOrders('lab'));

    // Scan
    const openScanModalAction = (e) => {
        e.preventDefault();
        document.getElementById('imaging-list').innerHTML = '';
        addOrderForm('imaging');
        scanModal.show();
    };
    document.querySelector('button[onclick="orderScan()"]').addEventListener('click', openScanModalAction);
    document.getElementById('order-scan-in-tab-btn').addEventListener('click', openScanModalAction);
    document.getElementById('add-imaging-btn').addEventListener('click', () => addOrderForm('imaging'));
    document.getElementById('submit-imaging-orders-btn').addEventListener('click', () => submitOrders('imaging'));
}

function addOrderForm(type) {
    const isLab = type === 'lab';
    const templateId = isLab ? 'lab-test-row-template' : 'imaging-row-template';
    const listId = isLab ? 'lab-test-list' : 'imaging-list';
    const clone = document.getElementById(templateId).content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    document.getElementById(listId).appendChild(clone);
    const searchInput = formRow.querySelector('.search-input');
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, type));
}

function handleOrderSearch(inputEl, type) {
    const isLab = type === 'lab';
    const query = inputEl.value;
    const categoryId = document.getElementById(isLab ? 'testCategoryFilter' : 'imagingCategoryFilter').value;
    const resultsContainer = inputEl.parentElement.querySelector('.search-results');
    const searchUrl = isLab ? "{% url 'ajax_lab_templates_search' %}" : "{% url 'ajax_imaging_templates_search' %}";

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`${searchUrl}?q=${encodeURIComponent(query)}&category_id=${categoryId}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.templates.length > 0) {
                data.templates.forEach(template => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    if (template.is_active) {
                        item.innerHTML = `${template.name} - â¦${template.price}`;
                    } else {
                        item.innerHTML = `${template.name} <span class="badge bg-warning text-dark ms-2">External</span>`;
                    }
                    item.addEventListener('click', e => {
                        e.preventDefault();
                        const formRow = inputEl.closest('.order-row');
                        formRow.querySelector('.search-input').value = template.name;
                        formRow.querySelector('.template-id-input').value = template.id;
                        resultsContainer.innerHTML = '';
                    });
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<span class="list-group-item">No results found</span>';
            }
        });
}

function submitOrders(type) {
    const isLab = type === 'lab';
    const modal = isLab ? labTestModal : scanModal;
    const listId = isLab ? 'lab-test-list' : 'imaging-list';
    const submitUrl = isLab ? "{% url 'order_multiple_lab_tests' %}" : "{% url 'order_multiple_imaging' %}";
    const submitBtn = document.getElementById(isLab ? 'submit-lab-orders-btn' : 'submit-imaging-orders-btn');

    const payload = {
        patient_id: patientId,
        consultation_id: consultationId,
        orders: []
    };

    let isValid = true;
    document.getElementById(listId).querySelectorAll('.order-row').forEach(row => {
        row.querySelector('.search-input').classList.remove('is-invalid');
        const templateId = row.querySelector('.template-id-input').value;
        if (!templateId) {
            isValid = false;
            row.querySelector('.search-input').classList.add('is-invalid');
            return;
        }
        const orderData = { template_id: templateId };
        if (isLab) {
            orderData.instructions = row.querySelector('.instructions-input').value;
        } else {
            orderData.indication = row.querySelector('.indication-input').value;
        }
        payload.orders.push(orderData);
    });

    if (!isValid) {
        showAlert('Please select a valid test/image for all rows.', 'warning');
        return;
    }
    if (payload.orders.length === 0) {
        showAlert(`Please add at least one ${isLab ? 'test' : 'image request'}.`, 'info');
        return;
    }

    submitBtn.disabled = true;

    fetch(submitUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            modal.hide();
            showAlert(data.message, 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'tests-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'An unknown error occurred.', 'danger');
        }
    })
    .catch(error => showAlert('A network error occurred. Please try again.', 'danger'))
    .finally(() => {
        submitBtn.disabled = false;
    });
}

// --- NEW: Service/Item Order Functions ---

function initializeServiceItemOrderModals() {
    // Service
    const openServiceModalAction = (e) => {
        e.preventDefault();
        document.getElementById('service-order-form-list').innerHTML = '';
        addServiceItemOrderForm('service');
        serviceOrderModal.show();
    };
    document.querySelector('button[onclick="orderService()"]').addEventListener('click', openServiceModalAction);
    document.getElementById('order-service-in-tab-btn').addEventListener('click', openServiceModalAction);
    document.getElementById('add-service-btn').addEventListener('click', () => addServiceItemOrderForm('service'));
    document.getElementById('submit-service-orders-btn').addEventListener('click', () => submitServiceItemOrders('service'));

    // Item
    const openItemModalAction = (e) => {
        e.preventDefault();
        document.getElementById('item-order-form-list').innerHTML = '';
        addServiceItemOrderForm('item');
        itemOrderModal.show();
    };
    document.querySelector('button[onclick="orderItem()"]').addEventListener('click', openItemModalAction);
    document.getElementById('order-item-in-tab-btn').addEventListener('click', openItemModalAction);
    document.getElementById('add-item-btn').addEventListener('click', () => addServiceItemOrderForm('item'));
    document.getElementById('submit-item-orders-btn').addEventListener('click', () => submitServiceItemOrders('item'));
}

function addServiceItemOrderForm(type) {
    const isService = type === 'service';
    const templateId = isService ? 'service-row-template' : 'item-row-template';
    const listId = isService ? 'service-order-form-list' : 'item-order-form-list';
    const clone = document.getElementById(templateId).content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    document.getElementById(listId).appendChild(clone);
    const searchInput = formRow.querySelector('.search-input');
    searchInput.addEventListener('input', () => handleServiceItemSearch(searchInput, type));
}

function handleServiceItemSearch(inputEl, type) {
    const isService = type === 'service';
    const query = inputEl.value;
    const categoryId = document.getElementById(isService ? 'serviceCategoryFilter' : 'itemCategoryFilter').value;
    const resultsContainer = inputEl.parentElement.querySelector('.search-results');
    const searchUrl = isService ? "{% url 'ajax_search_services' %}" : "{% url 'ajax_search_service_items' %}";

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`${searchUrl}?q=${encodeURIComponent(query)}&category_id=${categoryId}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.templates.length > 0) { // Changed from data.services/data.items
                data.templates.forEach(template => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `${template.name} - â¦${template.price}`; // Name now contains stock/etc

                    item.addEventListener('click', e => {
                        e.preventDefault();
                        const formRow = inputEl.closest('.order-row');
                        formRow.querySelector('.search-input').value = template.name;
                        formRow.querySelector('.template-id-input').value = template.id;
                        resultsContainer.innerHTML = '';
                    });
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<span class="list-group-item">No results found</span>';
            }
        });
}

function submitServiceItemOrders(type) {
    const isService = type === 'service';
    const modal = isService ? serviceOrderModal : itemOrderModal;
    const listId = isService ? 'service-order-form-list' : 'item-order-form-list';
    const submitUrl = "{% url 'order_multiple_services_or_items' %}";
    const submitBtn = document.getElementById(isService ? 'submit-service-orders-btn' : 'submit-item-orders-btn');

    const payload = {
        patient_id: patientId,
        consultation_id: consultationId,
        orders: [],
        order_type: type // 'service' or 'item'
    };

    let isValid = true;
    document.getElementById(listId).querySelectorAll('.order-row').forEach(row => {
        row.querySelector('.search-input').classList.remove('is-invalid');
        const templateId = row.querySelector('.template-id-input').value;
        if (!templateId) {
            isValid = false;
            row.querySelector('.search-input').classList.add('is-invalid');
            return;
        }
        payload.orders.push({
            template_id: templateId,
            quantity: row.querySelector('.quantity-input').value,
            notes: row.querySelector('.notes-input').value
        });
    });

    if (!isValid) {
        showAlert(`Please select a valid ${type} for all rows.`, 'warning');
        return;
    }
    if (payload.orders.length === 0) {
        showAlert(`Please add at least one ${type}.`, 'info');
        return;
    }

    submitBtn.disabled = true;

    fetch(submitUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            modal.hide();
            showAlert(data.message, 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'services-pane'); // Show new tab
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'An unknown error occurred.', 'danger');
        }
    })
    .catch(error => showAlert('A network error occurred. Please try again.', 'danger'))
    .finally(() => {
        submitBtn.disabled = false;
    });
}


// --- Edit/Delete Functions ---

// MODIFIED: deleteLabTest (BUG FIX #2, #3, #7)
function deleteLabTest(orderId) {
    showConfirmationModal('Delete this lab test order?', () => {
        fetch(`/portal/consultation/ajax/delete-lab-test/${orderId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('Lab test deleted', 'success');
                document.querySelector(`div[data-lab-id="${orderId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// MODIFIED: deleteScan (BUG FIX #2, #3, #7)
function deleteScan(orderId) {
    showConfirmationModal('Delete this scan order?', () => {
        fetch(`/portal/consultation/ajax/delete-scan/${orderId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('Scan deleted', 'success');
                document.querySelector(`div[data-scan-id="${orderId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// MODIFIED: deleteDrugPrescription (BUG FIX #2, #3, #7)
function deleteDrugPrescription(prescriptionId) {
    showConfirmationModal('Delete this prescription?', () => {
        fetch(`/portal/consultation/ajax/delete-drug/${prescriptionId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('Prescription deleted', 'success');
                document.querySelector(`tr[data-prescription-id="${prescriptionId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// MODIFIED: deleteExternalPrescription (BUG FIX #2, #3, #7)
function deleteExternalPrescription(prescriptionId) {
    showConfirmationModal('Delete this external prescription?', () => {
        fetch(`/portal/consultation/ajax/delete-external-drug/${prescriptionId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('External prescription deleted', 'success');
                document.querySelector(`div[data-external-id="${prescriptionId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// MODIFIED: deleteExternalLabTest (BUG FIX #2, #3, #7)
function deleteExternalLabTest(orderId) {
    showConfirmationModal('Delete this external lab test?', () => {
        fetch(`/portal/consultation/ajax/delete-external-lab/${orderId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('External lab test deleted', 'success');
                document.querySelector(`div[data-external-lab-id="${orderId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// MODIFIED: deleteExternalScan (BUG FIX #2, #3, #7)
function deleteExternalScan(orderId) {
    showConfirmationModal('Delete this external scan?', () => {
        fetch(`/portal/consultation/ajax/delete-external-scan/${orderId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('External scan deleted', 'success');
                document.querySelector(`div[data-external-scan-id="${orderId}"]`).remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}

// NEW: deleteServiceOrder (BUG FIX #2, #3, #7)
function deleteServiceOrder(orderId) {
    showConfirmationModal('Delete this order? It can only be deleted if not yet paid.', () => {
        fetch(`/portal/consultation/ajax/delete-service-order/${orderId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                confirmationModal.hide();
                showMiniToast('Order deleted', 'success');
                const serviceEl = document.querySelector(`div[data-service-order-id="${orderId}"]`);
                if (serviceEl) serviceEl.remove();
                const itemEl = document.querySelector(`div[data-item-order-id="${orderId}"]`);
                if (itemEl) itemEl.remove();
            } else {
                confirmationModal.hide();
                showAlert(data.error || 'Failed to delete', 'danger');
            }
        })
        .catch(() => {
            confirmationModal.hide();
            showAlert('Network error', 'danger');
        })
        .finally(() => resetConfirmModal());
    });
}


// --- Edit Functions (Modified for BUG FIX #2) ---

function editLabTest(orderId, templateId, templateName, instructions) {
    document.getElementById('lab-test-list').innerHTML = '';
    const clone = document.getElementById('lab-test-row-template').content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    formRow.dataset.editId = orderId;
    document.getElementById('lab-test-list').appendChild(clone);

    formRow.querySelector('.search-input').value = templateName;
    formRow.querySelector('.template-id-input').value = templateId;
    formRow.querySelector('.instructions-input').value = instructions;
    const searchInput = formRow.querySelector('.search-input'); // Define searchInput
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, 'lab')); // Use it

    const submitBtn = document.getElementById('submit-lab-orders-btn');
    submitBtn.textContent = 'Update Test';
    submitBtn.onclick = () => saveEditedLabTest(orderId);
    labTestModal.show();
}


function saveEditedLabTest(orderId) {
    const formRow = document.querySelector('#lab-test-list .order-row[data-edit-id]');
    const payload = {
        template_id: formRow.querySelector('.template-id-input').value,
        instructions: formRow.querySelector('.instructions-input').value
    };
    fetch(`/portal/consultation/ajax/edit-lab-test/${orderId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            labTestModal.hide();
            showMiniToast('Lab test updated successfully', 'success'); // Only mini-toast
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'tests-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger'); // Show big modal on error
        }
    })
    .catch(() => showAlert('Network error', 'danger'));
}

function editScan(orderId, templateId, templateName, indication) {
    document.getElementById('imaging-list').innerHTML = '';
    const clone = document.getElementById('imaging-row-template').content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    formRow.dataset.editId = orderId;
    document.getElementById('imaging-list').appendChild(clone);

    formRow.querySelector('.search-input').value = templateName;
    formRow.querySelector('.template-id-input').value = templateId;
    formRow.querySelector('.indication-input').value = indication;
    const searchInput = formRow.querySelector('.search-input'); // Define searchInput
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, 'imaging')); // Use it

    const submitBtn = document.getElementById('submit-imaging-orders-btn');
    submitBtn.textContent = 'Update Scan';
    submitBtn.onclick = () => saveEditedScan(orderId);
    scanModal.show();
}

function saveEditedScan(orderId) {
    const formRow = document.querySelector('#imaging-list .order-row[data-edit-id]');
    const payload = {
        template_id: formRow.querySelector('.template-id-input').value,
        indication: formRow.querySelector('.indication-input').value
    };
    fetch(`/portal/consultation/ajax/edit-scan/${orderId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            scanModal.hide();
            showMiniToast('Scan updated successfully', 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'tests-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger');
        }
    })
    .catch(() => showAlert('Network error', 'danger'));
}

function editDrugPrescription(prescriptionId, drugId, dosage, duration, quantity, notes) {
    document.getElementById('prescription-list').innerHTML = '';
    const clone = document.getElementById('available-drug-template').content.cloneNode(true);
    const formRow = clone.querySelector('.prescription-row');
    formRow.dataset.editId = prescriptionId;
    document.getElementById('prescription-list').appendChild(clone);

    fetch(`/portal/consultation/ajax/search-drugs-consult/?id=${drugId}`)
        .then(response => response.json())
        .then(data => {
            if (data.drug) {
                const drug = data.drug;
                formRow.querySelector('.drug-search-input').value = `${drug.brand_name || drug.generic_name} (${drug.formulation})`;
                formRow.querySelector('.drug-id-input').value = drug.id;
                formRow.querySelector('.drug-pack-size-input').value = drug.pack_size || 1;
                formRow.querySelector('.drug-unit-input').value = drug.unit || 'tablet';
                updateQuantityDisplay(quantity, drug.pack_size || 1, drug.unit || 'tablet', formRow.querySelector('.quantity-display'));
            }
        });

    formRow.querySelector('.dosage-input').value = dosage;
    formRow.querySelector('.duration-input').value = duration;
    formRow.querySelector('.quantity-input').value = quantity;
    formRow.querySelector('.notes-input').value = notes;

    const searchInput = formRow.querySelector('.drug-search-input');
    const dosageInput = formRow.querySelector('.dosage-input');
    const durationInput = formRow.querySelector('.duration-input');
    searchInput.addEventListener('input', () => handleDrugSearch(searchInput));
    dosageInput.addEventListener('input', () => calculateQuantity(formRow));
    durationInput.addEventListener('input', () => calculateQuantity(formRow));

    const submitBtn = document.getElementById('submit-prescriptions-btn');
    submitBtn.textContent = 'Update Prescription';
    submitBtn.onclick = () => saveEditedDrugPrescription(prescriptionId);
    drugPrescriptionModal.show();
}

function saveEditedDrugPrescription(prescriptionId) {
    const formRow = document.querySelector('.prescription-row[data-edit-id]');
    const payload = {
        drug_id: formRow.querySelector('.drug-id-input').value,
        dosage: formRow.querySelector('.dosage-input').value,
        duration: formRow.querySelector('.duration-input').value,
        quantity: formRow.querySelector('.quantity-input').value,
        notes: formRow.querySelector('.notes-input').value
    };

    fetch(`/portal/consultation/ajax/edit-drug/${prescriptionId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            drugPrescriptionModal.hide();
            showMiniToast('Prescription updated successfully', 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'prescriptions-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger');
        }
    })
    .catch(() => showAlert('Network error occurred', 'danger'));
}

function editExternalPrescription(prescriptionId, drugName, dosage, duration, quantity, notes) {
    document.getElementById('prescription-list').innerHTML = '';
    const clone = document.getElementById('external-drug-template').content.cloneNode(true);
    const formRow = clone.querySelector('.prescription-row');
    formRow.dataset.editId = prescriptionId;
    document.getElementById('prescription-list').appendChild(clone);

    formRow.querySelector('.drug-name-input').value = drugName;
    formRow.querySelector('.dosage-input').value = dosage;
    formRow.querySelector('.duration-input').value = duration;
    formRow.querySelector('.quantity-input').value = quantity;
    formRow.querySelector('.notes-input').value = notes;

    const submitBtn = document.getElementById('submit-prescriptions-btn');
    submitBtn.textContent = 'Update Prescription';
    submitBtn.onclick = () => saveEditedExternalPrescription(prescriptionId);
    drugPrescriptionModal.show();
}

function saveEditedExternalPrescription(prescriptionId) {
    const formRow = document.querySelector('.prescription-row[data-edit-id]');
    const payload = {
        drug_name: formRow.querySelector('.drug-name-input').value,
        dosage: formRow.querySelector('.dosage-input').value,
        duration: formRow.querySelector('.duration-input').value,
        quantity: formRow.querySelector('.quantity-input').value,
        notes: formRow.querySelector('.notes-input').value
    };

    fetch(`/portal/consultation/ajax/edit-external-drug/${prescriptionId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            drugPrescriptionModal.hide();
            showMiniToast('External prescription updated', 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'prescriptions-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger');
        }
    })
    .catch(() => showAlert('Network error', 'danger'));
}

function editExternalLabTest(orderId, testName, instructions) {
    document.getElementById('lab-test-list').innerHTML = '';
    const clone = document.getElementById('lab-test-row-template').content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    formRow.dataset.editId = orderId;
    formRow.dataset.isExternal = 'true';
    document.getElementById('lab-test-list').appendChild(clone);

    formRow.querySelector('.search-input').value = testName;
    formRow.querySelector('.instructions-input').value = instructions;
    const searchInput = formRow.querySelector('.search-input');
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, 'lab'));

    const submitBtn = document.getElementById('submit-lab-orders-btn');
    submitBtn.textContent = 'Update External Test';
    submitBtn.onclick = () => saveEditedExternalLabTest(orderId);
    labTestModal.show();
}

function saveEditedExternalLabTest(orderId) {
    const formRow = document.querySelector('#lab-test-list .order-row[data-edit-id]');
    const payload = {
        template_id: formRow.querySelector('.template-id-input').value, // May be empty if they didn't change it
        test_name: formRow.querySelector('.search-input').value, // Send the name
        instructions: formRow.querySelector('.instructions-input').value
    };
    fetch(`/portal/consultation/ajax/edit-external-lab/${orderId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            labTestModal.hide();
            showMiniToast('External lab test updated', 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'tests-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger');
        }
    })
    .catch(() => showAlert('Network error', 'danger'));
}

function editExternalScan(orderId, scanName, indication) {
    document.getElementById('imaging-list').innerHTML = '';
    const clone = document.getElementById('imaging-row-template').content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    formRow.dataset.editId = orderId;
    formRow.dataset.isExternal = 'true';
    document.getElementById('imaging-list').appendChild(clone);

    formRow.querySelector('.search-input').value = scanName;
    formRow.querySelector('.indication-input').value = indication;
    const searchInput = formRow.querySelector('.search-input');
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, 'imaging'));

    const submitBtn = document.getElementById('submit-imaging-orders-btn');
    submitBtn.textContent = 'Update External Scan';
    submitBtn.onclick = () => saveEditedExternalScan(orderId);
    scanModal.show();
}

function saveEditedExternalScan(orderId) {
    const formRow = document.querySelector('#imaging-list .order-row[data-edit-id]');
    const payload = {
        template_id: formRow.querySelector('.template-id-input').value, // May be empty
        scan_name: formRow.querySelector('.search-input').value, // Send the name
        indication: formRow.querySelector('.indication-input').value
    };
    fetch(`/portal/consultation/ajax/edit-external-scan/${orderId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            scanModal.hide();
            showMiniToast('External scan updated', 'success');
            setTimeout(() => {
                sessionStorage.setItem('showTab', 'tests-pane');
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to update', 'danger');
        }
    })
    .catch(() => showAlert('Network error', 'danger'));
}


// --- Utility Functions ---

function viewPatientHistory() {
    window.open(`/portal/consultation/patient/${patientId}/history/`, '_blank');
}

function viewTestResult(testId) {
    window.open(`/portal/consultation/lab-test/${testId}/result/`, '_blank');
}

function viewScanResult(scanId) {
    window.open(`/portal/consultation/scan/${scanId}/result/`, '_blank');
}

// NEW: View Service Result
function viewServiceResult(resultId) {
    // This URL must exist in your urls.py
    window.open(`/portal/consultation/service-result/${resultId}/view/`, '_blank');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// MODIFIED: showAlert now uses the central modal
function showAlert(message, type) {
    const modalHeader = document.getElementById('messageModalHeader');
    const modalTitle = document.getElementById('messageModalLabel');
    document.getElementById('messageModalBody').textContent = message;

    modalHeader.className = 'modal-header text-white'; // Reset class
    switch (type) {
        case 'success':
            modalTitle.textContent = 'Success';
            modalHeader.classList.add('bg-success');
            break;
        case 'danger':
            modalTitle.textContent = 'Error';
            modalHeader.classList.add('bg-danger');
            break;
        case 'warning':
            modalTitle.textContent = 'Warning';
            modalHeader.classList.add('bg-warning');
            break;
        default:
            modalTitle.textContent = 'Information';
            modalHeader.classList.add('bg-info');
            break;
    }
    messageModal.show();
}

// Toast notification system
function showMiniToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    const toastId = 'toast-' + Date.now();
    const bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'bi-check-circle' : 'bi-x-circle';
    const toastHTML = `
        <div class="alert alert-dismissible fade show mini-toast ${bgColor} text-white" role="alert" id="${toastId}">
            <i class="bi ${icon} me-2"></i>${message}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
        </div>
    `;
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    setTimeout(() => {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }
    }, 3000);
}

// Switch to a specific tab
function switchToTab(tabId) {
    const tabButton = document.querySelector(`button[data-bs-target="#${tabId}"]`);
    if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoSaveTimer) clearInterval(autoSaveTimer);
});
</script>

<script>
    // --- Diagnosis Search Functionality ---
    let hasPrimaryDiagnosis = {{ consultation.primary_diagnosis.id|default:'null' }} !== null;
    let secondaryDiagnosisIds = [{% for diag in consultation.secondary_diagnoses.all %}{{ diag.id }}{% if not forloop.last %},{% endif %}{% endfor %}];
    const specializationId = {{ consultation.queue_entry.specialization.id|default:'null' }};

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('diagnosis-search-input');
        const resultsContainer = document.getElementById('diagnosis-search-results');
        const selectedContainer = document.getElementById('selected-diagnoses-container');

        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                searchDiagnoses(query);
            }, 300);
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });
    });

    function searchDiagnoses(query) {
        const resultsContainer = document.getElementById('diagnosis-search-results');

        let url = `/portal/consultation/ajax/search-diagnoses/?q=${encodeURIComponent(query)}`;
        if (specializationId) {
            url += `&specialization_id=${specializationId}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';

                if (data.diagnoses && data.diagnoses.length > 0) {
                    data.diagnoses.forEach(diag => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${diag.name}</strong>`;
                        if (diag.icd_code) {
                            item.innerHTML += ` <small class="text-muted">(${diag.icd_code})</small>`;
                        }

                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectDiagnosis(diag.id, diag.name, diag.icd_code);
                        });

                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<span class="list-group-item">No diagnoses found</span>';
                    resultsContainer.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Diagnosis search error:', error);
                resultsContainer.style.display = 'none';
            });
    }

    function selectDiagnosis(diagnosisId, diagnosisName, icdCode) {
        const searchInput = document.getElementById('diagnosis-search-input');
        const resultsContainer = document.getElementById('diagnosis-search-results');
        const selectedContainer = document.getElementById('selected-diagnoses-container');

        const isPrimary = !hasPrimaryDiagnosis;

        if (isPrimary) {
            // Set as primary
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-2 mb-2 diagnosis-badge';
            badge.dataset.diagnosisId = diagnosisId;
            badge.dataset.type = 'primary';
            badge.innerHTML = `<strong>Primary:</strong> ${diagnosisName} <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removeDiagnosis('primary', ${diagnosisId})"></button>`;

            selectedContainer.insertBefore(badge, selectedContainer.firstChild);

            document.getElementById('primary-diagnosis-id').value = diagnosisId;
            hasPrimaryDiagnosis = true;

            // Update placeholder
            searchInput.placeholder = 'Search for secondary diagnosis...';

            // Save to backend
            saveDiagnosisToBackend('primary', diagnosisId);

        } else {
            // Check if already added as secondary
            if (secondaryDiagnosisIds.includes(diagnosisId)) {
                showMiniToast('This diagnosis is already added as secondary', 'warning');
                searchInput.value = '';
                resultsContainer.style.display = 'none';
                return;
            }

            // Add as secondary
            const badge = document.createElement('span');
            badge.className = 'badge bg-warning text-dark me-2 mb-2 diagnosis-badge';
            badge.dataset.diagnosisId = diagnosisId;
            badge.dataset.type = 'secondary';
            badge.innerHTML = `<strong>Secondary:</strong> ${diagnosisName} <button type="button" class="btn-close ms-2" style="font-size: 0.7rem;" onclick="removeDiagnosis('secondary', ${diagnosisId})"></button>`;

            selectedContainer.appendChild(badge);

            secondaryDiagnosisIds.push(diagnosisId);
            document.getElementById('secondary-diagnosis-ids').value = secondaryDiagnosisIds.join(',');

            // Save to backend
            saveDiagnosisToBackend('secondary', diagnosisId);
        }

        // Clear search
        searchInput.value = '';
        resultsContainer.style.display = 'none';
    }

    function removeDiagnosis(type, diagnosisId) {
        const badge = document.querySelector(`.diagnosis-badge[data-diagnosis-id="${diagnosisId}"][data-type="${type}"]`);
        if (badge) {
            badge.remove();
        }

        if (type === 'primary') {
            document.getElementById('primary-diagnosis-id').value = '';
            hasPrimaryDiagnosis = false;
            document.getElementById('diagnosis-search-input').placeholder = 'Search for primary diagnosis first...';

            // Also clear all secondary diagnoses
            document.querySelectorAll('.diagnosis-badge[data-type="secondary"]').forEach(b => b.remove());
            secondaryDiagnosisIds = [];
            document.getElementById('secondary-diagnosis-ids').value = '';

        } else {
            secondaryDiagnosisIds = secondaryDiagnosisIds.filter(id => id !== diagnosisId);
            document.getElementById('secondary-diagnosis-ids').value = secondaryDiagnosisIds.join(',');
        }

        // Save to backend
        saveDiagnosisToBackend(type, null, diagnosisId);
    }

    function saveDiagnosisToBackend(type, diagnosisId, removedId = null) {
        const payload = {
            consultation_id: consultationId,
            type: type,
            diagnosis_id: diagnosisId,
            removed_id: removedId
        };

        fetch('/portal/consultation/ajax/save-diagnosis/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMiniToast(data.message, 'success');
            } else {
                showAlert(data.error || 'Failed to save diagnosis', 'danger');
            }
        })
        .catch(error => {
            console.error('Save diagnosis error:', error);
            showAlert('Network error while saving diagnosis', 'danger');
        });
    }
</script>

<!-- MODALS (Confirmation, Message, Allergy) -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmationModalBody">
        Are you sure you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white" id="messageModalHeader">
        <h5 class="modal-title" id="messageModalLabel">Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="allergyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set/Update Patient Allergies</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="allergyForm">
                    <p class="text-muted">List all known allergies, each on a new line. If none, leave it blank.</p>
                    <textarea id="allergyDetailsText" name="details" class="form-control" rows="5"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAllergy()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Mini Notifications -->
<div class="toast-container"></div>

<!-- Duplicate Confirmation Modal -->
<div class="modal fade" id="duplicateConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Duplicate Detected
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="duplicateModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="forceSaveBtn">Continue Anyway</button>
            </div>
        </div>
    </div>
</div>

<!-- Dosage Warning Modal -->
<div class="modal fade" id="dosageWarningModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> High Dosage Warning
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dosageWarningModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmDosageBtn">Prescribe Anyway</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

