{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">
                    Consultation: {{ consultation.queue_entry.patient|title }}
                    <span class="badge bg-info ms-2">{{ consultation.queue_entry.queue_number }}</span>
                    <div class="float-end">
                        <a href="{% url 'doctor_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Queue
                        </a>
                        <button class="btn btn-sm btn-warning" onclick="pauseConsultation()" id="pauseBtn">
                            <i class="bi bi-pause"></i> Pause
                        </button>
                        <button class="btn btn-sm btn-success" onclick="completeConsultation()" id="completeBtn">
                            <i class="bi bi-check"></i> Complete
                        </button>
                    </div>
                </h4>
                <p class="card-description">
                    Patient: {{ consultation.queue_entry.patient.card_number|upper }} |
                    {{ consultation.queue_entry.patient.age }} yrs, {{ consultation.queue_entry.patient.gender|title }} |
                    Started: {{ consultation.created_at|date:"M d, H:i" }}
                </p>

                {% with allergy_profile=consultation.queue_entry.patient.allergy_profile %}
                    <div id="allergy-display-container"
                         class="d-flex justify-content-between align-items-center p-2 mt-2 rounded"
                         style="background-color: #dc3545; color: white;"
                         {% if allergy_profile and allergy_profile.updated_by %}
                           title="Last updated by {{ allergy_profile.updated_by.get_full_name|default:allergy_profile.updated_by.username }} at {{ allergy_profile.updated_at|date:'M d, Y, P' }}"
                         {% endif %}>

                        <strong id="allergy-text" data-raw-details="{{ allergy_profile.details|default:'' }}">
                            {% if allergy_profile and allergy_profile.details %}
                                {{ allergy_profile.details }}
                            {% else %}
                                No allergies set for this patient.
                            {% endif %}
                        </strong>

                        <button id="allergy-action-btn" class="btn btn-sm btn-light" onclick="openAllergyModal()">
                            {% if allergy_profile %}Update{% else %}Set{% endif %}
                        </button>
                    </div>
                    {% endwith %}

                {% include 'admin_site/partials/error.html' %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Sidebar: Patient Info & Quick Actions -->
    <div class="col-lg-3">
        <!-- Patient Information -->


        <!-- Vitals -->
        {% if consultation.queue_entry.vitals %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Current Vitals</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">BP:</small><br>
                        <strong>{{ consultation.queue_entry.vitals.blood_pressure }}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Pulse:</small><br>
                        <strong>{{ consultation.queue_entry.vitals.pulse_rate|default:"--" }}</strong>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Temp:</small><br>
                        <strong>{{ consultation.queue_entry.vitals.temperature|default:"--" }}Â°C</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">SpO2:</small><br>
                        <strong>{{ consultation.queue_entry.vitals.oxygen_saturation|default:"--" }}%</strong>
                    </div>
                </div>
                {% if consultation.queue_entry.vitals.chief_complaint %}
                <div class="mt-2">
                    <small class="text-muted">Chief Complaint:</small><br>
                    <small>{{ consultation.queue_entry.vitals.chief_complaint }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#verticalycentered">
                        <i class="bi bi-file"></i> Documents
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="prescribeDrug()">
                        <i class="bi bi-prescription2"></i> Prescribe Drug
                    </button>
                    <button class="btn btn-sm btn-info" onclick="orderLabTest()">
                        <i class="bi bi-clipboard2-pulse"></i> Order Lab Test
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="orderScan()">
                        <i class="bi bi-camera"></i> order Image
                    </button>
                    <a href="{% url 'patient_history_view' patient_id=consultation.queue_entry.patient.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> View Patient History
                    </a>
<!--                    <button class="btn btn-sm btn-success" onclick="viewPatientHistory()">-->
<!--                        <i class="bi bi-clock-history"></i> Patient History-->
<!--                    </button>-->
                </div>
            </div>
        </div>

        <div class="modal fade" id="verticalycentered" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title card-title"><b>Old Consultation Documents</b></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        {% if consultation.queue_entry.patient.consultation_documents.all %}

                        <div class="list-group">
                            {% for patient_doc in consultation.queue_entry.patient.consultation_documents.all %}
                            <a href="{{ patient_doc.document.url }}" target="_blank" class="list-group-item list-group-item-action">
                                {% if patient_doc.title %}
                                    {{ patient_doc.title|title }}
                                {% else %}
                                    {{ patient_doc|title }}
                                {% endif %}
                            </a>
                            {% endfor %}
                        </div>
                                                {% else %}
                            <h3>No Past Document was uploaded for the patient</h3>
                        {% endif %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Quick View -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Recent History</h6>
            </div>
            <div class="card-body">
                {% if recent_consultations %}
                    {% for prev in recent_consultations|slice:":3" %}
                    <a href="{% url 'view_consultation_detail' prev.id %}">
                    <div class="border-bottom pb-2 mb-2">
                        <small class="text-muted">{{ prev.created_at|date:"M d" }}</small><br>
                        <small>{{ prev.diagnosis|truncatechars:40|default:"No diagnosis" }}</small>
                    </div></a>
                    {% endfor %}
                {% else %}
                    <small class="text-muted">No previous consultations</small>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content: Consultation Form -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="consultationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="consultation-tab" data-bs-toggle="tab" data-bs-target="#consultation-pane" type="button" role="tab">
                            <i class="bi bi-file-medical"></i> Consultation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="prescriptions-tab" data-bs-toggle="tab" data-bs-target="#prescriptions-pane" type="button" role="tab">
                            <i class="bi bi-prescription2"></i> Prescriptions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests-pane" type="button" role="tab">
                            <i class="bi bi-clipboard2-pulse"></i> Tests & Scans
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="consultationTabContent">
                    <!-- Consultation Tab -->
                    <div class="tab-pane fade show active" id="consultation-pane" role="tabpanel">
                        <form id="consultationForm">
                            {% csrf_token %}
                            <input type="hidden" name="consultation_id" value="{{ consultation.id }}">

                            <div class="row">
                                <div class="col-md-12">
                                    <h6 class="text-primary mb-3">History & Examination</h6>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Chief Complaint</label>
                                                <textarea class="form-control" name="chief_complaint" rows="2" placeholder="What is the patient complaining of?">{{ consultation.chief_complaint }}</textarea>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Diagnosis</label>
                                                <textarea class="form-control" name="diagnosis" rows="2" placeholder="Primary and secondary diagnoses...">{{ consultation.diagnosis }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="col-md-12">

                                    <div class="mb-3">
                                        <label class="form-label">Clinical Assessment and Record</label>
                                        <textarea class="form-control" name="assessment" rows="3" placeholder="">{{ consultation.assessment }}</textarea>
                                    </div>


                                </div>
                            </div>

                            <div class="d-flex justify-content-between">

                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check"></i> Save & Continue
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Prescriptions Tab -->
                    <div class="tab-pane fade" id="prescriptions-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Prescribed Medications</h6>
                            <button class="btn btn-sm btn-primary" id="add-drug-in-tab-btn">
                                <i class="bi bi-plus"></i> Add Drug
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="prescriptionsTable">
                                <thead>
                                    <tr>
                                        <th>Drug</th>
                                        <th>Dosage</th>
                                        <th>Duration</th>
                                        <th>Status</th>
<!--                                        <th>Actions</th>-->
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prescription in prescriptions %}
                                    <tr>
                                        <td>
                                            <strong>{{ prescription.drug.brand_name|default:prescription.drug.generic_name }}</strong>
                                            <small class="text-muted d-block">{{ prescription.drug.formulation }}</small>
                                        </td>
                                        <td>{{ prescription.dosage_instructions|truncatechars:30 }}</td>
                                        <td>{{ prescription.duration }}</td>
                                        <td>
                                            <span class="badge bg-{{ prescription.status|yesno:'success,warning' }}">
                                                {{ prescription.get_status_display }}
                                            </span>
                                        </td>
                                        <td>

<!--                                            <button class="btn btn-sm btn-outline-danger" onclick="cancelPrescription({{ prescription.id }})">-->
<!--                                                <i class="bi bi-x"></i>-->
<!--                                            </button>-->
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3">
                                            No medications prescribed yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if external_prescriptions %}
                            <h6 class="mt-4 mb-3">Unavailable / External Prescriptions</h6>
                            <div class="list-group">
                                {% for rx in external_prescriptions %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ rx.drug_name|title }}</h5>
                                        <small class="text-muted">{{ rx.ordered_at|date:"M d, Y" }}</small>
                                    </div>
                                    <p class="mb-1">
                                        {% if rx.dosage_instructions %}
                                            <strong>Dosage:</strong> {{ rx.dosage_instructions }}
                                        {% endif %}
                                        {% if rx.duration %}
                                            <span class="ms-2"><strong>Duration:</strong> {{ rx.duration }}</span>
                                        {% endif %}
                                    </p>
                                    <small class="text-muted"><strong>Quantity:</strong> {{ rx.quantity }}</small>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                    </div>

                    <!-- Tests & Scans Tab -->
                    <div class="tab-pane fade" id="tests-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Lab Tests Ordered</h6>
                                    <button class="btn btn-sm btn-info" id="order-test-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Lab Test
                                    </button>
                                </div>

                                <!-- INTERNAL LAB TESTS -->
                                <div class="list-group">
                                    {% for test in lab_tests %}
                                    <div class="list-group-item">
                                        <div>
                                            <strong>{{ test.template.name }}</strong>
                                            <small class="text-muted d-block">{{ test.order_number }}</small>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between align-items-center">
                                            <span class="badge bg-secondary">{{ test.get_status_display }}</span>

                                            {% if test.status == 'completed' %}
                                                {% if test.result and test.result.is_verified %}
                                                    <button class="btn btn-xs btn-outline-primary" onclick="viewTestResult({{ test.id }})">
                                                        View Result
                                                    </button>
                                                {% else %}
                                                    <span class="badge bg-warning">Awaiting Verification</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="list-group-item text-center text-muted">
                                        No internal lab tests ordered
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- NEW: EXTERNAL LAB TESTS SECTION -->
                                {% if external_lab_tests %}
                                <h6 class="mt-4 mb-3">External Lab Tests</h6>
                                <div class="list-group">
                                    {% for test in external_lab_tests %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ test.test_name }}</strong>
                                                <span class="badge bg-warning text-dark ms-2">External</span>
                                                <small class="text-muted d-block">{{ test.order_number }}</small>
                                            </div>
                                            {% if test.has_result %}
                                                <a href="{{ test.result_file.url }}" target="_blank" class="btn btn-xs btn-outline-primary">
                                                    <i class="bi bi-file-earmark-pdf"></i> View Result
                                                </a>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                            </div>

                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Scans Ordered</h6>
                                    <button class="btn btn-sm btn-warning" id="order-scan-in-tab-btn">
                                        <i class="bi bi-plus"></i> Order Image
                                    </button>
                                </div>

                                <!-- INTERNAL SCANS -->
                                <div class="list-group">
                                    {% for scan in scans %}
                                    <div class="list-group-item">
                                        <div>
                                            <strong>{{ scan.template.name }}</strong>
                                            <small class="text-muted d-block">{{ scan.order_number }}</small>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between align-items-center">
                                            <span class="badge bg-secondary">{{ scan.get_status_display }}</span>

                                            {% if scan.status == 'completed' %}
                                                <button class="btn btn-xs btn-outline-primary" onclick="viewScanResult({{ scan.id }})">
                                                    View Result
                                                </button>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="list-group-item text-center text-muted">
                                        No internal scans ordered
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- NEW: EXTERNAL SCANS SECTION -->
                                {% if external_scans %}
                                <h6 class="mt-4 mb-3">External Scans</h6>
                                <div class="list-group">
                                    {% for scan in external_scans %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ scan.scan_name }}</strong>
                                                <span class="badge bg-warning text-dark ms-2">External</span>
                                                <small class="text-muted d-block">{{ scan.order_number }}</small>
                                            </div>
                                            {% if scan.has_result %}
                                                <a href="{{ scan.result_file.url }}" target="_blank" class="btn btn-xs btn-outline-primary">
                                                    <i class="bi bi-file-earmark-pdf"></i> View Result
                                                </a>
                                            {% else %}
                                                <span class="badge bg-light text-dark">Result Not Available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drug Prescription Modal -->
<div class="modal fade" id="drugPrescriptionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prescribe Medications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="prescription-list">
                    </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-drug-btn">
                        <i class="bi bi-plus-circle"></i> Add Drug from Inventory
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="add-external-drug-btn">
                        <i class="bi bi-journal-plus"></i> Add Unavailable Drug
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-prescriptions-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Save Prescriptions
                </button>
            </div>
        </div>
    </div>
</div>

<template id="available-drug-template">
    <div class="card prescription-row mb-3" data-type="available">
        <div class="card-body">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>

            <div class="row g-2 mb-2">
                <div class="col-md-12 position-relative">
                    <label class="form-label">Search Drug</label>
                    <input type="text" class="form-control drug-search-input" placeholder="Start typing drug name..." required>
                    <input type="hidden" class="drug-id-input" name="drug_id">
                    <input type="hidden" class="drug-pack-size-input" name="pack_size">
                    <input type="hidden" class="drug-unit-input" name="unit">
                    <div class="search-results list-group position-absolute w-100" style="z-index: 1050;"></div>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-md-5">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 2 tablets twice daily" required>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 7 days or 1 week">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Total Quantity</label>
                    <div class="input-group">
                        <input type="number" class="form-control quantity-input" name="quantity" placeholder="Auto" min="1" required>
                        <input type="text" class="form-control quantity-display" readonly style="max-width: 150px; font-size: 0.875rem;">
                    </div>
                </div>
            </div>
             <div class="row g-2 mt-2">
                <div class="col-md-12">
                     <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="Additional instructions...">
                </div>
            </div>
        </div>
    </div>
</template>

<template id="external-drug-template">
    <div class="card prescription-row mb-3" data-type="external">
        <div class="card-body bg-light">
             <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Drug Name</label>
                    <input type="text" class="form-control drug-name-input" name="drug_name" placeholder="Enter drug name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 1 tablet once daily">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 10 days">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantity</label>
                    <input type="text" class="form-control quantity-input" name="quantity" placeholder="e.g., 1 Card" required>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-12">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="e.g., Purchase from external pharmacy">
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Lab Test Modal -->
<div class="modal fade" id="labTestModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Lab Tests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="testCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in lab_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="lab-test-list">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-lab-test-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Test
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="submit-lab-orders-btn">Order Tests</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Imaging</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="imagingCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in scan_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="imaging-list">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-warning mt-2" id="add-imaging-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Image Request
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submit-imaging-orders-btn">Order Imaging</button>
            </div>
        </div>
    </div>
</div>

<template id="lab-test-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for a lab test...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control instructions-input" name="special_instructions" placeholder="Clinical indication / Instructions (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<template id="imaging-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for an imaging request...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control indication-input" name="clinical_indication" placeholder="Clinical indication (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<script>
const consultationId = {{ consultation.id }};
let autoSaveTimer;

// NEW: Variables for modal control
let confirmationModal, messageModal;
let confirmCallback = () => {};

// NEW: Function to show the confirmation modal
function showConfirmationModal(message, callback) {
    document.getElementById('confirmationModalBody').textContent = message;
    confirmCallback = callback;
    confirmationModal.show();
}

let allergyModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize TinyMCE for text areas if available
    if (typeof tinymce !== 'undefined') {
        tinymce.init({
            selector: 'textarea[name="assessment"], textarea[name="treatment_plan"]',
            height: 250,
             plugins: [
            'lists',    // Keep existing list plugin
            'table',    // Adds table creation features
            'link',     // Adds ability to insert links
            'image'     // Adds image upload/insert features
        ],
            toolbar: 'undo redo | styles | bold italic underline | bullist numlist | link | table',
        menubar: false

        });
    }

    initializePrescriptionModal()
    initializeOrderModals();

   allergyModal = new bootstrap.Modal(document.getElementById('allergyModal')); // This was the missing line

    // Setup for confirmation modal button
    document.getElementById('confirmButton').addEventListener('click', function() {
        if (typeof confirmCallback === 'function') {
            confirmCallback();
        }
        confirmationModal.hide();
    });

    // Format the initial allergy text on page load
    const allergyTextElem = document.getElementById('allergy-text');
    const rawDetails = allergyTextElem.getAttribute('data-raw-details');

    if (rawDetails && rawDetails.trim() !== '') {
        const formattedDetails = rawDetails.trim().replace(/(\r\n|\n|\r)+/g, ', ');
        allergyTextElem.innerHTML = `<strong>Allergies:</strong> ${formattedDetails}`;
    } else {
        allergyTextElem.textContent = 'No allergies set for this patient.';
    }

    // Auto-save every 30 seconds
    autoSaveTimer = setInterval(saveDraft, 30000);

    // MODIFIED: Added modal initialization
    confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    messageModal = new bootstrap.Modal(document.getElementById('messageModal'));

    document.getElementById('confirmButton').addEventListener('click', function() {
        if (typeof confirmCallback === 'function') {
            confirmCallback();
        }
        confirmationModal.hide();
    });
});

// Consultation form submission
document.getElementById('consultationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (typeof tinymce !== 'undefined') tinymce.triggerSave();

    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    fetch(`/portal/consultation/ajax/save-consultation/${consultationId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Consultation notes saved successfully', 'success');
        } else {
            showAlert('Error: ' + (data.error || 'Failed to save'), 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'))
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

function openAllergyModal() {
    // Get the RAW, unformatted allergy details from the data attribute
    const rawDetails = document.getElementById('allergy-text').getAttribute('data-raw-details');
    const allergyTextarea = document.getElementById('allergyDetailsText');

    // Populate the textarea with the raw details for editing
    allergyTextarea.value = rawDetails;

    allergyModal.show();
}

function saveAllergy() {
    const patientId = {{ consultation.queue_entry.patient.id }};
    const allergyDetails = document.getElementById('allergyDetailsText').value;
    const csrfToken = getCookie('csrftoken'); // Assumes you have this function

    const formData = new FormData();
    formData.append('details', allergyDetails);

    fetch(`/portal/consultation/ajax/update-allergy/${patientId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            allergyModal.hide();
            showAlert('Allergies updated successfully!', 'success');

            // Update the display on the page dynamically
            const allergyTextElem = document.getElementById('allergy-text');
            const allergyContainer = document.getElementById('allergy-display-container');
            const allergyBtn = document.getElementById('allergy-action-btn');

            // --- START: MODIFIED LOGIC ---
            if (data.details && data.details.trim() !== '') {
                // Replace newlines with a comma and space for a single-line display
                const formattedDetails = data.details.trim().replace(/(\r\n|\n|\r)+/g, ', ');
                allergyTextElem.innerHTML = `<strong>Allergies:</strong> ${formattedDetails}`;
            } else {
                allergyTextElem.textContent = 'No allergies set for this patient.';
            }
            // --- END: MODIFIED LOGIC ---

            const newTitle = `Last updated by ${data.updated_by} at ${data.updated_at}`;
            allergyContainer.setAttribute('title', newTitle);
            allergyBtn.textContent = 'Update';

        } else {
            showAlert('Error: Could not save allergies.', 'danger');
        }
    })
    .catch(error => {
        showAlert('An unexpected network error occurred.', 'danger');
        console.error('Allergy save error:', error);
    });
}

// MODIFIED: Save draft function is now silent
function saveDraft() {
    if (typeof tinymce !== 'undefined') tinymce.triggerSave();
    const form = document.getElementById('consultationForm');
    const formData = new FormData(form);

    fetch(`/portal/consultation/ajax/save-consultation/${consultationId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Auto-save failed:', data.error);
        }
        // Success alert removed as requested
    })
    .catch(error => {
        console.error('Auto-save failed:', error);
    });
}

// MODIFIED: Pause consultation now uses a modal
function pauseConsultation() {
    const message = 'Are you sure you want to pause this consultation?';
    showConfirmationModal(message, () => {
        fetch(`/portal/consultation/ajax/pause-consultation/${consultationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Consultation paused. Redirecting...', 'info');
                setTimeout(() => {
                    window.location.href = '{% url "doctor_dashboard" %}';
                }, 1500);
            } else {
                showAlert(data.error || 'Failed to pause', 'danger');
            }
        })
        .catch(error => showAlert('An unexpected error occurred.', 'danger'));
    });
}

// MODIFIED: Complete consultation now uses a modal
function completeConsultation() {
    const message = 'Are you sure you want to complete this consultation?';
    showConfirmationModal(message, () => {
        // First save current form data
        saveDraft();

        setTimeout(() => {
            fetch(`/portal/consultation/ajax/complete-consultation/${consultationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Consultation completed successfully', 'success');
                    clearInterval(autoSaveTimer); // Stop auto-saving
                    setTimeout(() => {
                        window.location.href = '{% url "doctor_dashboard" %}';
                    }, 1500);
                } else {
                    showAlert(data.error || 'Failed to complete', 'danger');
                }
            })
            .catch(error => showAlert('An unexpected error occurred.', 'danger'));
        }, 500);
    });
}

// Drug prescription functions
function prescribeDrug() {
    const modal = new bootstrap.Modal(document.getElementById('drugPrescriptionModal'));
    document.getElementById('drugPrescriptionForm').reset();
    modal.show();
}

document.getElementById('drugSearch').addEventListener('input', function() {
    const query = this.value;
    if (query.length >= 2) {
        fetch(`/portal/consultation/ajax/search-drugs/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('drugSelect');
            select.innerHTML = '<option value="">Select a drug...</option>';
            data.drugs.forEach(drug => {
                const option = document.createElement('option');
                option.value = drug.id;
                option.textContent = `${drug.brand_name || drug.generic_name} - ${drug.formulation}`;
                select.appendChild(option);
            });
        });
    }
});

document.getElementById('drugPrescriptionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('patient_id', {{ consultation.queue_entry.patient.id }});
    formData.append('consultation_id', consultationId);

    fetch('/portal/consultation/ajax/prescribe-drug/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('drugPrescriptionModal')).hide();
            showAlert('Drug prescribed successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to prescribe', 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
});

// Lab test functions



document.getElementById('labTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('patient_id', {{ consultation.queue_entry.patient.id }});
    formData.append('consultation_id', consultationId);

    fetch('/portal/consultation/ajax/order-lab-test/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('labTestModal')).hide();
            showAlert('Lab test ordered successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to order test', 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
});



document.getElementById('scanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('patient_id', {{ consultation.queue_entry.patient.id }});
    formData.append('consultation_id', consultationId);

    fetch('/portal/consultation/ajax/order-scan/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('scanModal')).hide();
            showAlert('Scan ordered successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to order Image', 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
});

// View functions
function viewPatientHistory() {
    window.open(`/portal/consultation/patient/${{ consultation.queue_entry.patient.id }}/history/`, '_blank');
}

function viewTestResult(testId) {
    window.open(`/portal/consultation/lab-test/${testId}/result/`, '_blank');
}

function viewScanResult(scanId) {
    window.open(`/portal/consultation/scan/${scanId}/result/`, '_blank');
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// --- NEW COMPREHENSIVE SCRIPT FOR LAB & IMAGING ORDERS ---

function initializeOrderModals() {
    // --- Lab Test Modal Setup ---
    const labModalEl = document.getElementById('labTestModal');
    const labQuickActionButton = document.querySelector('button[onclick="orderLabTest()"]');
    const labTabButton = document.getElementById('order-test-in-tab-btn');

    const openLabModalAction = (e) => {
        e.preventDefault();
        document.getElementById('lab-test-list').innerHTML = ''; // Clear previous
        addOrderForm('lab');
        new bootstrap.Modal(labModalEl).show();
    };

    if (labQuickActionButton) labQuickActionButton.addEventListener('click', openLabModalAction);
    if (labTabButton) labTabButton.addEventListener('click', openLabModalAction);

    document.getElementById('add-lab-test-btn').addEventListener('click', () => addOrderForm('lab'));
    document.getElementById('submit-lab-orders-btn').addEventListener('click', () => submitOrders('lab'));
    document.getElementById('testCategoryFilter').addEventListener('change', () => {
        labModalEl.querySelectorAll('.search-input').forEach(input => {
            if(input.value) input.dispatchEvent(new Event('input'));
        });
    });

    // --- Imaging Modal Setup ---
    const scanModalEl = document.getElementById('scanModal');
    const scanQuickActionButton = document.querySelector('button[onclick="orderScan()"]');
    const scanTabButton = document.getElementById('order-scan-in-tab-btn');

    const openScanModalAction = (e) => {
        e.preventDefault();
        document.getElementById('imaging-list').innerHTML = ''; // Clear previous
        addOrderForm('imaging');
        new bootstrap.Modal(scanModalEl).show();
    };

    if (scanQuickActionButton) scanQuickActionButton.addEventListener('click', openScanModalAction);
    if (scanTabButton) scanTabButton.addEventListener('click', openScanModalAction);

    document.getElementById('add-imaging-btn').addEventListener('click', () => addOrderForm('imaging'));
    document.getElementById('submit-imaging-orders-btn').addEventListener('click', () => submitOrders('imaging'));
    document.getElementById('imagingCategoryFilter').addEventListener('change', () => {
        scanModalEl.querySelectorAll('.search-input').forEach(input => {
            if(input.value) input.dispatchEvent(new Event('input'));
        });
    });
}

function addOrderForm(type) {
    const isLab = type === 'lab';
    const templateId = isLab ? 'lab-test-row-template' : 'imaging-row-template';
    const listId = isLab ? 'lab-test-list' : 'imaging-list';

    const template = document.getElementById(templateId);
    const clone = template.content.cloneNode(true);
    const formRow = clone.querySelector('.order-row');
    document.getElementById(listId).appendChild(clone);

    const searchInput = formRow.querySelector('.search-input');
    searchInput.addEventListener('input', () => handleOrderSearch(searchInput, type));
}

function handleOrderSearch(inputEl, type) {
    const isLab = type === 'lab';
    const query = inputEl.value;
    const categoryId = document.getElementById(isLab ? 'testCategoryFilter' : 'imagingCategoryFilter').value;
    const resultsContainer = inputEl.parentElement.querySelector('.search-results');
    const searchUrl = isLab ? "{% url 'ajax_lab_templates_search' %}" : "{% url 'ajax_imaging_templates_search' %}";

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`${searchUrl}?q=${encodeURIComponent(query)}&category_id=${categoryId}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.templates.length > 0) {
                data.templates.forEach(template => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';

                    // UPDATED: Show price only for internal, badge for external
                    if (template.is_active) {
                        item.innerHTML = `${template.name} - â¦${template.price}`;
                    } else {
                        item.innerHTML = `${template.name} <span class="badge bg-warning text-dark ms-2">External</span>`;
                    }

                    item.addEventListener('click', e => {
                        e.preventDefault();
                        const formRow = inputEl.closest('.order-row');
                        formRow.querySelector('.search-input').value = template.name;
                        formRow.querySelector('.template-id-input').value = template.id;
                        resultsContainer.innerHTML = '';
                    });
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<span class="list-group-item">No results found</span>';
            }
        });
}

function submitOrders(type) {
    const isLab = type === 'lab';
    const modalId = isLab ? 'labTestModal' : 'scanModal';
    const listId = isLab ? 'lab-test-list' : 'imaging-list';
    const submitUrl = isLab ? "{% url 'order_multiple_lab_tests' %}" : "{% url 'order_multiple_imaging' %}";

    const payload = {
        patient_id: {{ consultation.queue_entry.patient.id }},
        consultation_id: {{ consultation.id }},
        orders: []
    };

    let isValid = true;
    document.getElementById(listId).querySelectorAll('.order-row').forEach(row => {
        const templateId = row.querySelector('.template-id-input').value;
        if (!templateId) {
            isValid = false;
            row.querySelector('.search-input').classList.add('is-invalid');
            return;
        }

        const orderData = { template_id: templateId };
        if (isLab) {
            orderData.instructions = row.querySelector('.instructions-input').value;
        } else {
            orderData.indication = row.querySelector('.indication-input').value;
        }
        payload.orders.push(orderData);
    });

    if (!isValid) {
        showAlert('Please select a valid test/image for all rows.', 'warning');
        return;
    }
    if (payload.orders.length === 0) {
        showAlert(`Please add at least one ${isLab ? 'test' : 'image request'}.`, 'info');
        return;
    }

    fetch(submitUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
            showAlert(data.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(data.error || 'An unknown error occurred.', 'danger');
        }
    })
    .catch(error => showAlert('A network error occurred. Please try again.', 'danger'));
}


// --- NEW COMPREHENSIVE PRESCRIPTION SCRIPT ---

// Call this function from your main DOMContentLoaded listener
function initializePrescriptionModal() {
    // Find both "Add Drug" buttons (from Quick Actions and the Prescriptions Tab)
    const quickActionButton = document.querySelector('button[onclick="prescribeDrug()"]');
    const tabButton = document.getElementById('add-drug-in-tab-btn');

    const openModalAction = (e) => {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('drugPrescriptionModal'));

        // Clear any previous forms
        document.getElementById('prescription-list').innerHTML = '';
        addDrugForm(); // Add one empty form to start

        modal.show();
    };

    // Attach the event listener to both buttons if they exist
    if (quickActionButton) {
        quickActionButton.addEventListener('click', openModalAction);
    }
    if (tabButton) {
        tabButton.addEventListener('click', openModalAction);
    }

    // Button listeners within the modal
    document.getElementById('add-drug-btn').addEventListener('click', addDrugForm);
    document.getElementById('add-external-drug-btn').addEventListener('click', addExternalDrugForm);
    document.getElementById('submit-prescriptions-btn').addEventListener('click', submitPrescriptions);
}

function addDrugForm() {
    const template = document.getElementById('available-drug-template');
    const clone = template.content.cloneNode(true);
    const formRow = clone.querySelector('.prescription-row');
    document.getElementById('prescription-list').appendChild(clone);

    // Attach event listeners to the new row
    const searchInput = formRow.querySelector('.drug-search-input');
    const dosageInput = formRow.querySelector('.dosage-input');
    const durationInput = formRow.querySelector('.duration-input');

    searchInput.addEventListener('input', () => handleDrugSearch(searchInput));
    dosageInput.addEventListener('input', () => calculateQuantity(formRow));
    durationInput.addEventListener('input', () => calculateQuantity(formRow));
    const quantityInput = formRow.querySelector('.quantity-input');
    quantityInput.addEventListener('input', () => {
    const packSize = parseInt(formRow.querySelector('.drug-pack-size-input')?.value || '1') || 1;
    const unitType = formRow.querySelector('.drug-unit-input')?.value || 'tablet';
    const quantityDisplay = formRow.querySelector('.quantity-display');
    const totalUnits = parseInt(quantityInput.value) || 0;
    updateQuantityDisplay(totalUnits, packSize, unitType, quantityDisplay);
});
}

function addExternalDrugForm() {
    const template = document.getElementById('external-drug-template');
    const clone = template.content.cloneNode(true);
    document.getElementById('prescription-list').appendChild(clone);
}

function removeDrugForm(buttonEl) {
    buttonEl.closest('.prescription-row').remove();
}

function handleDrugSearch(inputEl) {
    const query = inputEl.value;
    const resultsContainer = inputEl.parentElement.querySelector('.search-results');

    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    fetch(`/portal/consultation/ajax/search-drugs/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.drugs.length > 0) {
                data.drugs.forEach(drug => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${drug.brand_name || drug.generic_name} (${drug.formulation}) - Stock: ${drug.pharmacy_quantity}`;

                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const formRow = inputEl.closest('.prescription-row');
                        formRow.querySelector('.drug-search-input').value = item.textContent;
                        formRow.querySelector('.drug-id-input').value = drug.id;
                        formRow.querySelector('.drug-pack-size-input').value = drug.pack_size || 1;
                        formRow.querySelector('.drug-unit-input').value = drug.unit || 'tablet';
                        resultsContainer.innerHTML = '';
                        calculateQuantity(formRow); // Recalculate if needed
                    });
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<span class="list-group-item">No drugs found</span>';
            }
        });
}

function calculateQuantity(formRowEl) {
    const dosageText = formRowEl.querySelector('.dosage-input').value.toLowerCase();
    const durationText = formRowEl.querySelector('.duration-input').value.toLowerCase();
    const packSize = parseInt(formRowEl.querySelector('.drug-pack-size-input')?.value || '1') || 1;
    const unitType = formRowEl.querySelector('.drug-unit-input')?.value || 'tablet';
    const quantityInput = formRowEl.querySelector('.quantity-input');
    const quantityDisplay = formRowEl.querySelector('.quantity-display');

    if (!quantityInput) return; // Only applies to available drugs with this input

    let dailyDose = 0;
    let durationDays = 0;

    // 1. Parse Dosage
    const doseMatch = dosageText.match(/^(\d+(\.\d+)?)/); // "2 tablets..." -> 2
    if (doseMatch) {
        const dose = parseFloat(doseMatch[1]);
        let frequency = 1; // Default to once daily
        if (dosageText.includes('twice') || dosageText.includes('bd')) frequency = 2;
        else if (dosageText.includes('thrice') || dosageText.includes('tds')) frequency = 3;
        else if (dosageText.includes('four times')) frequency = 4;

        // Handle "x times daily"
        const timesMatch = dosageText.match(/(\d+)\s*time/);
        if (timesMatch) frequency = parseInt(timesMatch[1]);

        // Handle "x/x/x" format
        const slashMatch = dosageText.match(/\//g);
        if (slashMatch) frequency = slashMatch.length + 1;

        dailyDose = dose * frequency;
    }

    // 2. Parse Duration
    const durationMatch = durationText.match(/^(\d+)/); // "7 days" -> 7
    if (durationMatch) {
        const num = parseInt(durationMatch[1]);
        if (durationText.includes('week') || durationText.includes('w')) {
            durationDays = num * 7;
        } else if (durationText.includes('month') || durationText.includes('m')) {
            durationDays = num * 30;
        } else {
            durationDays = num; // Assume days
        }
    }

    // 3. Calculate and set quantity (total units)
    if (dailyDose > 0 && durationDays > 0) {
        const totalUnits = dailyDose * durationDays;
        quantityInput.value = totalUnits;
        updateQuantityDisplay(totalUnits, packSize, unitType, quantityDisplay);
    }
}

function getPackageTerminology(unitType) {
    // Returns [singular, plural] forms
    const terminology = {
        'tablet': ['card', 'cards'],
        'capsule': ['card', 'cards'],
        'injection': ['pack', 'packs'],
        'syrup': ['bottle', 'bottles'],
        'cream': ['tube', 'tubes'],
        'drops': ['bottle', 'bottles']
    };
    return terminology[unitType] || ['pack', 'packs'];
}

function updateQuantityDisplay(totalUnits, packSize, unitType, displayElement) {
    if (!displayElement || !totalUnits) {
        if (displayElement) displayElement.value = '';
        return;
    }

    // If pack size is 1 or total is less than pack size, show units only
    if (packSize === 1 || totalUnits < packSize) {
        displayElement.value = `${totalUnits} units`;
        return;
    }

    // Calculate packs and remaining units
    const fullPacks = Math.floor(totalUnits / packSize);
    const remainingUnits = totalUnits % packSize;

    // Get appropriate terminology
    const [singularTerm, pluralTerm] = getPackageTerminology(unitType);
    const packTerm = fullPacks === 1 ? singularTerm : pluralTerm;

    // Build display string
    if (remainingUnits === 0) {
        displayElement.value = `${fullPacks} ${packTerm}`;
    } else {
        displayElement.value = `${fullPacks} ${packTerm} ${remainingUnits} units`;
    }
}

function submitPrescriptions() {
    const submitBtn = document.getElementById('submit-prescriptions-btn');
    const spinner = submitBtn.querySelector('.spinner-border');

    const payload = {
        patient_id: {{ consultation.queue_entry.patient.id }},
        consultation_id: {{ consultation.id }},
        available_drugs: [],
        external_drugs: []
    };

    const forms = document.querySelectorAll('.prescription-row');
    let isValid = true;

    forms.forEach(form => {
        const type = form.dataset.type;
        if (type === 'available') {
            const drugId = form.querySelector('.drug-id-input').value;
            if (!drugId) {
                isValid = false;
                form.querySelector('.drug-search-input').classList.add('is-invalid');
                return;
            }
            payload.available_drugs.push({
                drug_id: drugId,
                dosage: form.querySelector('.dosage-input').value,
                duration: form.querySelector('.duration-input').value,
                quantity: form.querySelector('.quantity-input').value,
                notes: form.querySelector('.notes-input').value
            });
        } else if (type === 'external') {
             const drugName = form.querySelector('.drug-name-input').value;
             if (!drugName) {
                isValid = false;
                form.querySelector('.drug-name-input').classList.add('is-invalid');
                return;
             }
             payload.external_drugs.push({
                drug_name: drugName,
                dosage: form.querySelector('.dosage-input').value,
                duration: form.querySelector('.duration-input').value,
                quantity: form.querySelector('.quantity-input').value,
                notes: form.querySelector('.notes-input').value
             });
        }
    });

    if (!isValid) {
        showAlert('Please select a drug for all inventory items or provide a name for unavailable drugs.', 'warning');
        return;
    }
    if (payload.available_drugs.length === 0 && payload.external_drugs.length === 0) {
        showAlert('Please add at least one medication to prescribe.', 'info');
        return;
    }

    submitBtn.disabled = true;
    spinner.classList.remove('d-none');

    fetch("{% url 'prescribe_multiple' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('drugPrescriptionModal')).hide();
            showAlert(data.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(data.error || 'An unknown error occurred.', 'danger');
        }
    })
    .catch(error => showAlert('A network error occurred. Please try again.', 'danger'))
    .finally(() => {
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    });
}



// REPLACED: showAlert now uses the central modal
function showAlert(message, type) {
    const modalHeader = document.getElementById('messageModalHeader');
    const modalTitle = document.getElementById('messageModalLabel');
    document.getElementById('messageModalBody').textContent = message;

    modalHeader.className = 'modal-header text-white'; // Reset class

    switch (type) {
        case 'success':
            modalTitle.textContent = 'Success';
            modalHeader.classList.add('bg-success');
            break;
        case 'danger':
            modalTitle.textContent = 'Error';
            modalHeader.classList.add('bg-danger');
            break;
        case 'warning':
            modalTitle.textContent = 'Warning';
            modalHeader.classList.add('bg-warning');
            break;
        default:
            modalTitle.textContent = 'Information';
            modalHeader.classList.add('bg-info');
            break;
    }
    messageModal.show();
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
    }
});
</script>
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmationModalBody">
        Are you sure you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white" id="messageModalHeader">
        <h5 class="modal-title" id="messageModalLabel">Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="allergyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set/Update Patient Allergies</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="allergyForm">
                    <p class="text-muted">List all known allergies, each on a new line. If none, leave it blank.</p>
                    <textarea id="allergyDetailsText" name="details" class="form-control" rows="5"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAllergy()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}