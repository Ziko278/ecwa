{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Doctor Dashboard - Dr. {{ consultant.staff.first_name }} {{ consultant.staff.last_name }}
                    <a title="Refresh" href="{% url 'doctor_dashboard' %}" class="btn btn-sm btn-info text-white float-end"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                </h4>
                <p class="card-description">
                    Specialization: {{ consultant.specialization.name|title }} | Room: {{ consultant.assigned_room|default:"Not Assigned" }}
                </p>
                {% include 'admin_site/partials/error.html' %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column: Today's Statistics & Quick Actions -->
    <div class="col-lg-4 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Today's Summary</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="card text-center bg-primary">
                            <div class="card-body py-2">
                                <h6 class="text-white">{{ today_stats.total_queue|default:0 }}</h6>
                                <small class="text-white">My Queue</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center bg-success">
                            <div class="card-body py-2">
                                <h6 class="text-white">{{ today_stats.completed|default:0 }}</h6>
                                <small class="text-white">Completed</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <div class="card text-center bg-warning">
                            <div class="card-body py-2">
                                <h6 class="text-white">{{ today_stats.waiting|default:0 }}</h6>
                                <small class="text-white">Waiting</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center bg-info">
                            <div class="card-body py-2">
                                <h6 class="text-white">{{ today_stats.in_consultation|default:0 }}</h6>
                                <small class="text-white">In Progress</small>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="card-title">Quick Actions</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="callNextPatient()">
                        <i class="bi bi-person-check"></i> Call Next Patient
                    </button>
                    <button class="btn btn-primary" onclick="viewConsultationHistory()">
                        <i class="bi bi-clock-history"></i> View History
                    </button>

                </div>

                <hr class="my-4">

                <h5 class="card-title">Current Status</h5>
                {% if current_consultation %}
                    <div class="alert alert-info">
                        <strong>Currently with:</strong><br>
                        {{ current_consultation.queue_entry.patient|title }}<br>
                        <small>Queue #{{ current_consultation.queue_entry.queue_number }}</small><br>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-warning" onclick="pauseConsultation({{ current_consultation.id }})">
                                <i class="bi bi-pause"></i> Pause
                            </button>
                            <button class="btn btn-sm btn-success" onclick="completeConsultation({{ current_consultation.id }})">
                                <i class="bi bi-check"></i> Complete
                            </button>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-check-circle"></i> Ready for next patient
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Patient Queue -->
    <div class="col-lg-8 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">My Patient Queue</h5>
                 <div class="my-3">
                    <input type="text" id="queueSearchInput" class="form-control" placeholder="ðŸ” Search by patient name or ID...">
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Patient</th>
                                <th>Status</th>
                                <th>Chief Complaint</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for queue in my_queue %}
                            <tr data-queue-id="{{ queue.id }}" class="queue-row">

                                <td>
                                    <div>
                                        <strong>{{ queue.patient|title }}</strong>
                                        <small class="text-muted d-block">ID: {{ queue.patient.card_number|upper }}</small>
                                        <small class="text-muted d-block">{{ queue.patient.age }} yrs, {{ queue.patient.gender|title }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if queue.status == 'vitals_done' %}
                                        <span class="badge bg-primary">Ready</span>
                                    {% elif queue.status == 'with_doctor' %}
                                        <span class="badge bg-info">In Progress</span>
                                    {% elif queue.status == 'consultation_paused' %}
                                        <span class="badge bg-warning">Paused</span>
                                    {% elif queue.status == 'consultation_completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        {{ queue.status }}
                                    {% endif %}
                                </td>

                                <td>
                                    {% if queue.vitals %}
                                        <small>{{ queue.vitals.chief_complaint|truncatechars:50 }}</small>
                                    {% else %}
                                        <small class="">Not recorded</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-sm" role="group">
                                        {% if queue.status == 'vitals_done' %}
                                            <button class="btn btn-sm btn-success" onclick="startConsultation({{ queue.id }})">
                                                <i class="bi bi-play"></i> Start
                                            </button>
                                        {% elif queue.status == 'with_doctor' or queue.status == 'consultation_completed' %}
                                            <button class="btn btn-sm btn-primary" onclick="openConsultation({{ queue.consultation.id }})">
                                                <i class="bi bi-file-medical"></i> Open
                                            </button>
                                            {% if queue.status == 'with_doctor' %} {# Keep pause button only for active sessions #}
                                            <button class="btn btn-sm btn-warning" onclick="pauseConsultation({{ queue.consultation.id }})">
                                                <i class="bi bi-pause"></i>
                                            </button>
                                            {% endif %}
                                        {% elif queue.status == 'consultation_paused' %}
                                            <button class="btn btn-sm btn-info" onclick="resumeConsultation({{ queue.consultation.id }})">
                                                <i class="bi bi-play"></i> Resume
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <h5 class="text-muted">No Patients in Your Queue</h5>
                                    <p class="text-muted">Patients will appear here once they're assigned to you.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Consultations -->
<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Completed Consultations (Today)</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Diagnosis</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consultation in recent_consultations %}
                            <tr>
                                <td>{{ consultation.created_at|date:"M d, H:i" }}</td>
                                <td>
                                    <strong>{{ consultation.queue_entry.patient|title }}</strong>
                                    <small class="text-muted d-block">{{ consultation.queue_entry.patient.patient_id }}</small>
                                </td>
                                <td>{{ consultation.diagnosis|truncatechars:50|default:"Not recorded" }}</td>
                                <td>
                                    {% if consultation.completed_at %}
                                        {{ consultation.created_at|timesince:consultation.completed_at }}
                                    {% else %}
                                        <span class="text-warning">In progress</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewConsultationDetail({{ consultation.id }})">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-3">
                                    <span class="text-muted">No recent consultations</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- START: NEW MODAL LOGIC ---
let confirmationModal, messageModal;
let confirmCallback = () => {};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap modals
    confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    messageModal = new bootstrap.Modal(document.getElementById('messageModal'));

    // Set up a single click listener for the confirm button
    document.getElementById('confirmButton').addEventListener('click', function() {
        if (typeof confirmCallback === 'function') {
            confirmCallback();
        }
        confirmationModal.hide();
    });

    document.getElementById('queueSearchInput').addEventListener('input', filterQueueTable);
    scrollToFirstActionablePatient();
});

/**
 * Shows a confirmation modal and sets a callback for the confirm action.
 * @param {string} message The question to ask the user.
 * @param {function} callback The function to execute if the user confirms.
 */
function showConfirmationModal(message, callback) {
    document.getElementById('confirmationModalBody').textContent = message;
    confirmCallback = callback;
    confirmationModal.show();
}

/**
 * Replaces the old alert system with a central modal.
 * @param {string} message The message to display.
 * @param {string} type The type of message (e.g., 'success', 'danger', 'info').
 */
function showAlert(message, type) {
    const modalHeader = document.getElementById('messageModalHeader');
    const modalTitle = document.getElementById('messageModalLabel');
    document.getElementById('messageModalBody').textContent = message;

    // Reset header class
    modalHeader.className = 'modal-header text-white';

    switch (type) {
        case 'success':
            modalTitle.textContent = 'Success';
            modalHeader.classList.add('bg-success');
            break;
        case 'danger':
            modalTitle.textContent = 'Error';
            modalHeader.classList.add('bg-danger');
            break;
        case 'warning':
            modalTitle.textContent = 'Warning';
            modalHeader.classList.add('bg-warning');
            break;
        default:
            modalTitle.textContent = 'Information';
            modalHeader.classList.add('bg-info');
            break;
    }
    messageModal.show();
}
// --- END: NEW MODAL LOGIC ---


// Call next patient
function callNextPatient() {
    fetch('/portal/consultation/ajax/call-next-patient/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            if (data.consultation_id) {
                // Using a timeout to allow the user to read the success message before redirecting
                setTimeout(() => {
                   window.location.href = `/portal/consultation/consultation/${data.consultation_id}/`;
                }, 1500);
            } else {
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            showAlert(data.error || 'No patients available', 'warning');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
}

/**
 * NEW: Filters the patient queue table based on user input.
 */
function filterQueueTable() {
    const filter = document.getElementById('queueSearchInput').value.toLowerCase();
    const tableBody = document.querySelector('.table-responsive tbody');
    const tableRows = tableBody.querySelectorAll('tr.queue-row');
    let visibleRows = 0;

    tableRows.forEach(row => {
        const patientCell = row.cells[0]; // First cell contains name and ID
        if (patientCell) {
            const cellText = patientCell.textContent || patientCell.innerText;

            if (cellText.toLowerCase().includes(filter)) {
                row.style.display = ""; // Show the row
                visibleRows++;
            } else {
                row.style.display = "none"; // Hide the row
            }
        }
    });

    // Handle the "No Results" message
    let noResultsRow = tableBody.querySelector('.no-results');
    if (noResultsRow) {
        noResultsRow.remove();
    }
    if (visibleRows === 0 && tableRows.length > 0) {
        noResultsRow = tableBody.insertRow();
        noResultsRow.className = 'no-results';
        const cell = noResultsRow.insertCell();
        cell.colSpan = 4; // Match the number of columns in your table
        cell.className = 'text-center text-muted py-4';
        cell.textContent = 'No matching patients found.';
    }
}

/**
 * NEW: Scrolls the view to the first patient who is not yet completed.
 */
function scrollToFirstActionablePatient() {
    const tableRows = document.querySelectorAll('.table-responsive tbody tr.queue-row');
    for (const row of tableRows) {
        const statusBadge = row.cells[1]?.querySelector('.badge');
        // Find the first patient whose status is NOT "Completed"
        if (statusBadge && statusBadge.textContent.trim().toLowerCase() !== 'completed') {
            row.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            // Add a temporary highlight for better visibility
            row.classList.add('table-info');
            setTimeout(() => {
                row.classList.remove('table-info');
            }, 3000);
            break; // Stop after finding and scrolling to the first one
        }
    }
}

// Start consultation
function startConsultation(queueId) {
    fetch(`/portal/consultation/ajax/start-consultation/${queueId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/portal/consultation/consultation/${data.consultation_id}/`;
        } else {
            showAlert(data.error || 'Failed to start consultation', 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
}

// Open existing consultation
function openConsultation(consultationId) {
    window.location.href = `/portal/consultation/consultation/${consultationId}/`;
}

// Pause consultation - NOW USES MODAL
function pauseConsultation(consultationId) {
    const message = 'Are you sure you want to pause this consultation?';
    showConfirmationModal(message, () => {
        fetch(`/portal/consultation/ajax/pause-consultation/${consultationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Consultation paused.', 'info');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.error || 'Failed to pause consultation', 'danger');
            }
        })
        .catch(error => showAlert('An unexpected error occurred.', 'danger'));
    });
}

// Resume consultation
function resumeConsultation(consultationId) {
    fetch(`/portal/consultation/ajax/resume-consultation/${consultationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/portal/consultation/consultation/${consultationId}/`;
        } else {
            showAlert(data.error || 'Failed to resume consultation', 'danger');
        }
    })
    .catch(error => showAlert('An unexpected error occurred.', 'danger'));
}

// Complete consultation - NOW USES MODAL
function completeConsultation(consultationId) {
    const message = 'Are you sure you want to complete this consultation?';
    showConfirmationModal(message, () => {
        fetch(`/portal/consultation/ajax/complete-consultation/${consultationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Consultation completed successfully.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.error || 'Failed to complete consultation', 'danger');
            }
        })
        .catch(error => showAlert('An unexpected error occurred.', 'danger'));
    });
}

// Other functions
function viewConsultationHistory() {
    window.location.href = '/portal/consultation/consultations/history/';
}

function createNewConsultation() {
    window.location.href = '/portal/consultation/consultation/new/';
}

function viewConsultationDetail(consultationId) {
    window.location.href = `/portal/consultation/consultation/${consultationId}/view/`;
}

function viewPatientProfile(patientId) {
    window.open(`/patient/${patientId}/detail/`, '_blank');
}

// Utility function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmationModalBody">
        Are you sure you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white" id="messageModalHeader">
        <h5 class="modal-title" id="messageModalLabel">Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}