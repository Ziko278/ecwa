<!-- laboratory/entry.html -->
{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Laboratory - Patient Verification</h4>
            <p class="card-description">
                Enter patient card number to access their lab test records
            </p>

            <!-- Error Container -->
            <div id="error-container" style="display: none;">
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="mdi mdi-alert-circle me-2"></i>
                    <span id="error-message"></span>
                    <button type="button" class="btn-close ms-auto" onclick="hideError()"></button>
                </div>
            </div>

            <!-- Patient Verification Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Patient Verification</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="card-number-input">Patient Card Number <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" id="card-number-input" class="form-control"
                                           placeholder="Enter patient card number..." autocomplete="off" required>
                                    <button type="button" id="verify-patient-btn" class="btn btn-primary">
                                        <i class="mdi mdi-account-search me-1"></i>Verify Patient
                                    </button>
                                </div>
                                <small class="text-muted">Enter the patient's card number to verify their details and access lab tests.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Details Section (Hidden initially) -->
            <div id="patient-details-section" class="card mb-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="mdi mdi-check-circle me-2"></i>Patient Verified
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div id="patient-info"></div>
                        </div>
                        <div class="col-md-4">
                            <div id="test-summary"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-4 d-flex gap-3">
                        <button type="button" id="view-tests-btn" class="btn btn-info">
                            <i class="mdi mdi-flask me-2"></i>View Lab Tests
                        </button>
                        <button type="button" id="new-test-btn" class="btn btn-success">
                            <i class="mdi mdi-plus-circle me-2"></i>Order New Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const cardNumberInput = document.getElementById('card-number-input');
    const verifyPatientBtn = document.getElementById('verify-patient-btn');
    const patientDetailsSection = document.getElementById('patient-details-section');
    const viewTestsBtn = document.getElementById('view-tests-btn');
    const newTestBtn = document.getElementById('new-test-btn');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');

    // Global variables
    let currentPatient = null;

    // Error handling functions
    function showError(message) {
        errorMessage.innerHTML = `<strong>${message}</strong>`;
        errorContainer.style.display = 'block';
        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    window.hideError = function() {
        errorContainer.style.display = 'none';
    }

    // Patient verification
    verifyPatientBtn.addEventListener('click', function() {
        const cardNumber = cardNumberInput.value.trim();
        if (!cardNumber) {
            showError('Please enter a patient card number');
            return;
        }

        verifyPatientBtn.disabled = true;
        verifyPatientBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin me-1"></i>Verifying...';

        fetch(`{% url 'verify_lab_patient_ajax' %}?card_number=${encodeURIComponent(cardNumber)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentPatient = data.patient;
                    displayPatientInfo(data.patient, data.test_counts);
                    hideError();
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error verifying patient. Please try again.');
            })
            .finally(() => {
                verifyPatientBtn.disabled = false;
                verifyPatientBtn.innerHTML = '<i class="mdi mdi-account-search me-1"></i>Verify Patient';
            });
    });

    // Enter key support for card number input
    cardNumberInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyPatientBtn.click();
        }
    });

    function displayPatientInfo(patient, testCounts) {
        // Display patient information
        document.getElementById('patient-info').innerHTML = `
            <h6 class="mb-2">${patient.full_name}</h6>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Card Number:</strong> ${patient.patient_id}</p>
                    <p class="mb-1"><strong>Phone:</strong> ${patient.phone}</p>
                    <p class="mb-1"><strong>Age:</strong> ${patient.age || 'Not specified'}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Gender:</strong> ${patient.gender}</p>
                    <p class="mb-1"><strong>Address:</strong> ${patient.address}</p>
                </div>
            </div>
        `;

        // Display test summary
        document.getElementById('test-summary').innerHTML = `
            <h6 class="mb-2">Test Summary</h6>
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>Total Tests:</span>
                    <span class="badge bg-primary">${testCounts.total}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>Pending Payment:</span>
                    <span class="badge bg-warning">${testCounts.pending}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>Paid:</span>
                    <span class="badge bg-info">${testCounts.paid}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>Processing:</span>
                    <span class="badge bg-secondary">${testCounts.processing}</span>
                </div>
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span>Completed:</span>
                    <span class="badge bg-success">${testCounts.completed}</span>
                </div>
            </div>
        `;

        // Show patient details section
        patientDetailsSection.style.display = 'block';
        patientDetailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Set up action buttons
        viewTestsBtn.onclick = function() {
            window.location.href = `{% url 'patient_lab_tests' patient_id=0 %}`.replace('0', currentPatient.id);
        };

        newTestBtn.onclick = function() {
            window.location.href = `{% url 'lab_order_create' patient_id=0 %}`.replace('0', currentPatient.id);
        };
    }

    // Auto focus on card number input
    cardNumberInput.focus();
});
</script>
{% endblock %}