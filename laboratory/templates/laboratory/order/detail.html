{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}

{% block 'main' %}
<div class="pagetitle">
    <h1>Lab Order Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'lab_order_list' %}">Lab Orders</a></li>
            <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
    </nav>
</div>

<section class="section profile">
    <div class="row">
        <div class="col-xl-8">
            <div class="card">
                <div class="card-body pt-3">
                    <ul class="nav nav-tabs nav-tabs-bordered">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#order-overview">Overview</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payment-sample-details">Payment & Sample</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#processing-results">Processing & Result</button>
                        </li>
                    </ul>

                    <div class="tab-content pt-2">
                        <div class="tab-pane fade show active profile-overview" id="order-overview">
                            <h5 class="card-title">Order Summary</h5>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Test Name</div>
                                <div class="col-lg-9 col-md-8">{{ order.template.name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Test Category</div>
                                <div class="col-lg-9 col-md-8">{{ order.template.category.name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Order Number</div>
                                <div class="col-lg-9 col-md-8">{{ order.order_number }}</div>
                            </div>
                             <div class="row">
                                <div class="col-lg-3 col-md-4 label">Status</div>
                                <div class="col-lg-9 col-md-8">
                                    <span class="badge bg-{% if order.status == 'pending' %}warning text-dark{% elif order.status == 'paid' %}info text-dark{% elif order.status == 'collected' %}secondary{% elif order.status == 'processing' %}dark{% elif order.status == 'completed' %}success{% else %}light text-dark{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Order Source</div>
                                <div class="col-lg-9 col-md-8">{{ order.get_source_display }} </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Ordered At</div>
                                <div class="col-lg-9 col-md-8">{{ order.ordered_at|date:"d M Y, h:i A" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Ordered By</div>
                                <div class="col-lg-9 col-md-8">
                                    {% if order.ordered_by %}
                                        {{order.ordered_by.user_staff_profile.staff|title|default:order.ordered_by.username }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade pt-3" id="payment-sample-details">
                            <h5 class="card-title">Payment Information</h5>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Amount Charged</div>
                                <div class="col-lg-9 col-md-8">â‚¦{{ order.amount_charged|intcomma }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Payment Status</div>
                                <div class="col-lg-9 col-md-8">
                                    {% if order.payment_status %}
                                        <span class="badge bg-success">Paid</span>
                                    {% else %}
                                        <span class="badge bg-danger">Not Paid</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if order.payment_date %}
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Payment Date</div>
                                <div class="col-lg-9 col-md-8">{{ order.payment_date|date:"d M Y, h:i A" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Payment Processed By</div>
                                <div class="col-lg-9 col-md-8">{{ order.payment_by.get_full_name|default:order.payment_by.username }}</div>
                            </div>
                            {% endif %}

                            <h5 class="card-title mt-4">Sample Information</h5>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Required Sample Type</div>
                                <div class="col-lg-9 col-md-8">{{ order.template.get_sample_type_display }}</div>
                            </div>
                            {% if order.template.sample_volume %}
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Required Volume</div>
                                <div class="col-lg-9 col-md-8">{{ order.template.sample_volume }}</div>
                            </div>
                            {% endif %}
                             {% if order.sample_collected_at %}
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Sample Collected At</div>
                                <div class="col-lg-9 col-md-8">{{ order.sample_collected_at|date:"d M Y, h:i A" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Sample Collected By</div>
                                <div class="col-lg-9 col-md-8">{{ order.sample_collected_by.user_staff_profile.staff|default:order.sample_collected_by.username }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Sample Label</div>
                                <div class="col-lg-9 col-md-8">{{ order.sample_label }}</div>
                            </div>
                            {% else %}
                            <div class="alert alert-info mt-3">Sample has not been collected yet.</div>
                            {% endif %}
                        </div>

                        <div class="tab-pane fade pt-3" id="processing-results">
                            {% if order.special_instructions %}
                            <h5 class="card-title">Special Instructions</h5>
                            <p>{{ order.special_instructions }}</p>
                            {% endif %}

                            <h5 class="card-title mt-4">Processing Details</h5>
                            {% if order.processed_at %}
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Processed At</div>
                                <div class="col-lg-9 col-md-8">{{ order.processed_at|date:"d M Y, h:i A" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3 col-md-4 label">Processed By</div>
                                <div class="col-lg-9 col-md-8">{{ order.processed_by.user_staff_profile.staff|title|default:order.processed_by.username }}</div>
                            </div>
                            {% else %}
                            <div class="alert alert-secondary">This test has not been processed yet.</div>
                            {% endif %}

                            <h5 class="card-title mt-4">Result Status</h5>
                            {% if order.result %}
                                <div class="alert alert-success">
                                    Results are available for this test order.
                                    <a href="{% url 'lab_result_detail' order.result.id %}" class="alert-link">Click here to view.</a>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">Results have not been entered for this test order yet.</div>
                            {% endif %}


                        </div>
                    </div></div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <i class="bi bi-person-circle" style="font-size: 64px;"></i>
                    <h5 class="mt-2">{{ order.patient|title }}</h5>
                    <h6 class="text-muted">{{ order.patient.card_number }}</h6>
                    <div class="mt-2">
                        <a href="{% url 'patient_lab_tests' order.patient.id %}" class="btn btn-sm btn-outline-primary">View All Patient's Tests</a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Actions</h5>

                    {% if order.status == 'pending' %}
                    <a href="{% url 'patient_lab_tests' order.patient.id %}" class="btn btn-warning w-100 mb-2">
                        <i class="bi bi-credit-card me-1"></i> Go to Pay
                    </a>
                    <p class="small text-muted">Navigate to the patient's page to process payment for this order.</p>
                    {% elif order.status == 'paid' %}
                    <a href="{% url 'patient_lab_tests' order.patient.id %}" class="btn btn-info w-100 mb-2">
                        <i class="bi bi-eyedropper me-1"></i> Collect Sample
                    </a>
                    <p class="small text-muted">Navigate to the patient's page to log sample collection.</p>
                    {% elif order.status == 'collected' %}
                     <a href="{% url 'lab_result_create' %}?order_id={{ order.id }}" class="btn btn-dark w-100 mb-2">
                        <i class="bi bi-keyboard me-1"></i> Input Results
                    </a>
                    <p class="small text-muted">Proceed to the result entry page for this order.</p>
                    {% elif order.status == 'completed' %}
                     <a href="{% url 'lab_result_detail' order.result.id %}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-file-earmark-check me-1"></i> View Final Result
                    </a>
                    <p class="small text-muted">The result for this test is available.</p>
                    {% else %}
                    <div class="alert alert-light">No primary actions available for this status.</div>
                    {% endif %}

                    <hr>
                    <button type="button" class="btn btn-light w-100" data-bs-toggle="modal" data-bs-target="#referralModal">
                        <i class="bi bi-printer me-1"></i> Print Referral
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Referral Modal -->
<div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="referralModalLabel">Laboratory Test Referral</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="referralForm">
                    <div class="mb-3">
                        <label for="referralTitle" class="form-label">Referral Title</label>
                        <input type="text" class="form-control" id="referralTitle" value="LABORATORY TEST REFERRAL">
                    </div>
                    <div class="mb-3">
                        <label for="referralContent" class="form-label">Referral Details</label>
                        <textarea class="form-control" id="referralContent" rows="15" style="font-family: monospace;">Date: {{ order.ordered_at|date:"d M Y" }}

TO: RECEIVING LABORATORY
FROM: {{ lab_setting.lab_name|upper }}

PATIENT REFERRAL FOR LABORATORY TESTING

Patient Information:
- Name: {{ order.patient|title }}
- Gender: {{ order.patient.gender|title }}

Referring Physician: {{ order.ordered_by.user_staff_profile.staff|title|default:order.ordered_by.username }}

Test(s) Requested:
- {{ order.template.name }} ({{ order.template.category.name }})

Special Instructions:
{% if order.special_instructions %}{{ order.special_instructions }}{% else %}[Please include relevant clinical history, current medications, and reason for testing]{% endif %}

Contact Information:
{% if lab_setting.mobile %}- Phone: {{ lab_setting.mobile }}{% endif %}
{% if lab_setting.email %}- Email: {{ lab_setting.email|lower }}{% endif %}

Thank you for your cooperation.

Signature: _________________________
{{ request.user.user_staff_profile.staff|title|default:order.ordered_by.username }}
Date: {{ order.ordered_at|date:"d M Y" }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="printReferral()">
                    <i class="bi bi-printer me-1"></i> Print Referral
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function printReferral() {
    const title = document.getElementById('referralTitle').value;
    const content = document.getElementById('referralContent').value;

    // Create a new window for printing
    const printWindow = window.open('', '_blank', 'width=800,height=600');

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    font-size: 12pt;
                    line-height: 1.4;
                    margin: 1in;
                    color: #000;
                }
                h1 {
                    text-align: center;
                    font-size: 16pt;
                    font-weight: bold;
                    margin-bottom: 20px;
                    text-decoration: underline;
                }
                .content {
                    white-space: pre-line;
                }
                @media print {
                    body {
                        margin: 0.5in;
                    }
                }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <div class="content">${content}</div>
        </body>
        </html>
    `);

    printWindow.document.close();

    // Wait for the content to load, then print
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };

    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('referralModal'));
    modal.hide();
}
</script>

{% endblock %}