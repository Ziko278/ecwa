<!-- laboratory/result/dashboard.html -->
{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}

{% block 'main' %}
<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="card-title mb-0">Lab Results Dashboard</h4>
                <p class="card-description mb-0">Manage test results and verification</p>
            </div>
            <div>
                <a href="{% url 'lab_result_index' %}" class="btn btn-info">
                    <i class="mdi mdi-view-list me-2"></i>All Results
                </a>
                <a href="{% url 'lab_entry' %}" class="btn btn-secondary ms-2">
                    <i class="mdi mdi-arrow-left me-2"></i>Back to Lab Entry
                </a>
            </div>
        </div>

        <div class="card-body">
            <!-- Notification Toast -->
            <div id="notification-toast" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055; display: none;">
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i id="toast-icon" class="mdi me-2"></i>
                        <strong id="toast-title" class="me-auto">Notification</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body" id="toast-body"></div>
                </div>
            </div>

            <!-- Status Summary Cards -->
            <div class="row mb-4">
                <div class="col-3">
                    <div class="card bg-warning text-white h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                            <h5 class="mb-1 fs-4">{{ status_counts.collected }}</h5>
                            <small class="text-nowrap">Awaiting Results</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                            <h5 class="mb-1 fs-4">{{ status_counts.processing }}</h5>
                            <small class="text-nowrap">In Progress</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                            <h5 class="mb-1 fs-4">{{ status_counts.completed }}</h5>
                            <small class="text-nowrap">Completed</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-danger text-white h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                            <h5 class="mb-1 fs-4">{{ unverified_count }}</h5>
                            <small class="text-nowrap">Need Verification</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <select id="status-filter" class="form-control">
                        <option value="">All Statuses</option>
                        {% for status_code, status_name in status_choices %}
                            {% if status_code in 'collected,processing,completed' %}
                                <option value="{{ status_code }}" {% if current_status == status_code %}selected{% endif %}>
                                    {{ status_name }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" id="search-input" class="form-control" placeholder="Search patient, order number, test..." value="{{ search_query }}">
                        <button class="btn btn-outline-secondary" type="button" id="search-btn">
                            <i class="mdi mdi-magnify"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-5 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="refreshPage()">
                            <i class="mdi mdi-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            {% if not orders %}
                <div class="text-center py-5">
                    <i class="mdi mdi-clipboard-text-outline" style="font-size: 4rem; color: #ccc;"></i>
                    <h5 class="mt-3 text-muted">No Orders Found</h5>
                    <p class="text-muted">No lab orders are currently ready for result entry.</p>
                </div>
            {% else %}
                {% for order in orders %}
                    <div class="card mb-3 border-left-{% if order.status == 'collected' %}warning{% elif order.status == 'processing' %}info{% elif order.status == 'completed' %}success{% endif %}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="mb-1">{{ order.template.name }}</h6>
                                    <small class="text-muted">{{ order.template.category.name }}</small>
                                </div>

                                <div class="col-md-2">
                                    <strong>{{ order.patient.full_name }}</strong>
                                    <br><small class="text-muted">{{ order.patient.card_number }}</small>
                                </div>

                                <div class="col-md-2">
                                    <span class="badge badge-secondary">{{ order.order_number }}</span>
                                    {% if order.sample_label %}
                                        <br><small class="text-muted">{{ order.sample_label }}</small>
                                    {% endif %}
                                </div>

                                <div class="col-md-2">
                                    <span class="badge badge-{% if order.status == 'collected' %}warning{% elif order.status == 'processing' %}info{% elif order.status == 'completed' %}success{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                    <br><small class="text-muted">{{ order.sample_collected_at|date:"M d, H:i" }}</small>
                                </div>

                                <div class="col-md-3">
                                    {% if order.status == 'collected' %}
                                        <button type="button" class="btn btn-sm btn-warning process-btn me-2"
                                                data-order-id="{{ order.id }}" data-test-name="{{ order.template.name }}">
                                            <i class="mdi mdi-play me-1"></i>Start Processing
                                        </button>
                                        <a href="{% url 'lab_result_create_for_order' order_id=order.id %}" class="btn btn-sm btn-primary">
                                            <i class="mdi mdi-clipboard-text me-1"></i>Enter Results
                                        </a>
                                    {% elif order.status == 'processing' %}
                                        {% if order.result %}
                                            <a href="{% url 'lab_result_detail' pk=order.result.id %}" class="btn btn-sm btn-info me-2">
                                                <i class="mdi mdi-eye me-1"></i>View Results
                                            </a>
                                            {% if not order.result.is_verified %}
                                                <a href="{% url 'lab_result_edit' pk=order.result.id %}" class="btn btn-sm btn-warning">
                                                    <i class="mdi mdi-pencil me-1"></i>Edit
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            <a href="{% url 'lab_result_create_for_order' order_id=order.id %}" class="btn btn-sm btn-primary">
                                                <i class="mdi mdi-clipboard-text me-1"></i>Enter Results
                                            </a>
                                        {% endif %}
                                    {% elif order.status == 'completed' %}
                                        <a href="{% url 'lab_result_detail' pk=order.result.id %}" class="btn btn-sm btn-success me-2">
                                            <i class="mdi mdi-eye me-1"></i>View Results
                                        </a>
                                        {% if not order.result.is_verified %}
                                            <button type="button" class="btn btn-sm btn-outline-success verify-btn"
                                                    data-result-id="{{ order.result.id }}" data-test-name="{{ order.template.name }}">
                                                <i class="mdi mdi-check-circle me-1"></i>Verify
                                            </button>
                                        {% else %}
                                            <span class="badge badge-success">
                                                <i class="mdi mdi-check-circle me-1"></i>Verified
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- Pagination -->
                {% if is_paginated %}
                    <nav aria-label="Results pagination">
                        <ul class="pagination justify-content-center mt-4">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verify Lab Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="verification-form">
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Test Name</label>
                        <input type="text" id="verify-test-name" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="pathologist-comments">Pathologist Comments (Optional)</label>
                        <textarea id="pathologist-comments" class="form-control" rows="3" placeholder="Enter any additional comments or observations..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="mdi mdi-check-circle me-2"></i>Verify Result
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Enhanced styling */
.toast-container {
    z-index: 1055;
}

.toast {
    min-width: 300px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.toast.success {
    border-left: 4px solid #28a745;
}

.toast.error {
    border-left: 4px solid #dc3545;
}

.card .border-left-warning {
    border-left: 4px solid #ffc107 !important;
}

.card .border-left-info {
    border-left: 4px solid #17a2b8 !important;
}

.card .border-left-success {
    border-left: 4px solid #28a745 !important;
}

.card:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.btn-loading {
    position: relative;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: button-loading-spinner 1s ease infinite;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
}

@keyframes button-loading-spinner {
    from { transform: rotate(0turn); }
    to { transform: rotate(1turn); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('status-filter');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const processBtns = document.querySelectorAll('.process-btn');
    const verifyBtns = document.querySelectorAll('.verify-btn');
    const verificationModal = new bootstrap.Modal(document.getElementById('verificationModal'));
    const verificationForm = document.getElementById('verification-form');

    let currentResultId = null;

    // Notification system
    function showNotification(message, type = 'info', autoReload = false) {
        const toastContainer = document.getElementById('notification-toast');
        const toast = toastContainer.querySelector('.toast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        const toastIcon = document.getElementById('toast-icon');

        toastBody.textContent = message;

        toast.className = 'toast ' + type;
        if (type === 'success') {
            toastTitle.textContent = 'Success';
            toastIcon.className = 'mdi mdi-check-circle me-2 text-success';
        } else if (type === 'error') {
            toastTitle.textContent = 'Error';
            toastIcon.className = 'mdi mdi-alert-circle me-2 text-danger';
        } else {
            toastTitle.textContent = 'Info';
            toastIcon.className = 'mdi mdi-information me-2 text-info';
        }

        toastContainer.style.display = 'block';
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        bsToast.show();

        if (autoReload && type === 'success') {
            setTimeout(() => location.reload(), 5000);
        }

        toast.addEventListener('hidden.bs.toast', function() {
            if (autoReload && type === 'success') {
                location.reload();
            }
            toastContainer.style.display = 'none';
        });
    }

    // Filter and search functionality
    function applyFilters() {
        const status = statusFilter.value;
        const search = searchInput.value;
        const url = new URL(window.location);

        if (status) {
            url.searchParams.set('status', status);
        } else {
            url.searchParams.delete('status');
        }

        if (search) {
            url.searchParams.set('search', search);
        } else {
            url.searchParams.delete('search');
        }

        window.location.href = url.toString();
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }

    if (searchBtn) {
        searchBtn.addEventListener('click', applyFilters);
    }

    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    }

    // Process order to start result entry
    processBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const testName = this.dataset.testName;

            if (!confirm(`Start processing results for ${testName}?`)) {
                return;
            }

            this.classList.add('btn-loading');
            this.disabled = true;

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch(`/laboratory/orders/${orderId}/process-for-results/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                this.classList.remove('btn-loading');
                this.disabled = false;

                if (data.success) {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        showNotification(data.message, 'success', true);
                    }
                } else {
                    showNotification(data.error || 'Processing failed', 'error');
                }
            })
            .catch(error => {
                this.classList.remove('btn-loading');
                this.disabled = false;
                console.error('Error:', error);
                showNotification('An error occurred while processing order', 'error');
            });
        });
    });

    // Verify results
    verifyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentResultId = this.dataset.resultId;
            const testName = this.dataset.testName;

            document.getElementById('verify-test-name').value = testName;
            document.getElementById('pathologist-comments').value = '';

            verificationModal.show();
        });
    });

    // Verification form submission
    if (verificationForm) {
        verificationForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const pathologistComments = document.getElementById('pathologist-comments').value.trim();
            const submitBtn = this.querySelector('button[type="submit"]');

            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('pathologist_comments', pathologistComments);

            fetch(`/laboratory/results/${currentResultId}/verify/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;

                if (data.success) {
                    verificationModal.hide();
                    showNotification(data.message, 'success', true);
                } else {
                    showNotification(data.error || 'Verification failed', 'error');
                }
            })
            .catch(error => {
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
                console.error('Error:', error);
                showNotification('An error occurred while verifying result', 'error');
            });
        });
    }
});

function refreshPage() {
    location.reload();
}
</script>
{% endblock %}