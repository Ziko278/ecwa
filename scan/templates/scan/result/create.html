{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    {% if order %}
                        Enter Scan Results - {{ order.template.name }}
                    {% else %}
                        Select Scan Order for Result Entry
                    {% endif %}
                </h4>
                {% if order %}
                    <p class="card-description mb-0">
                        Patient: {{ patient|title }} | Order: {{ order.order_number }}
                    </p>
                {% endif %}
            </div>

            <div class="card-body">
                {% if not order %}
                    <div class="mb-4">
                        <h5>Select Scan Order</h5>
                        {% if available_orders %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Patient</th>
                                            <th>Scan Type</th>
                                            <th>Order Number</th>
                                            <th>Scheduled Date</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for available_order in available_orders %}
                                        <tr>
                                            <td>{{ available_order.patient|title }}</td>
                                            <td>{{ available_order.template.name }}</td>
                                            <td>{{ available_order.order_number }}</td>
                                            <td>{{ available_order.scheduled_date|date:"M d, Y H:i"|default:"-" }}</td>
                                            <td>
                                                <span class="badge bg-{% if available_order.status == 'in_progress' %}warning{% elif available_order.status == 'completed' %}success{% else %}info{% endif %}">
                                                    {{ available_order.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'scan_result_create_for_order' order_id=available_order.id %}"
                                                   class="btn btn-sm btn-primary">
                                                    Enter Results
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="mdi mdi-radiobox-blank" style="font-size: 3rem; color: #ccc;"></i>
                                <h6 class="mt-3 text-muted">No Scan Orders Available</h6>
                                <p class="text-muted">No scan orders are ready for result entry.</p>
                                <a href="{% url 'scan_result_dashboard' %}" class="btn btn-primary">
                                    Back to Dashboard
                                </a>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <form method="post" enctype="multipart/form-data" id="result-form">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light h-100">
                                    <div class="card-body p-3">
                                        <h6>Patient Information</h6>
                                        <p class="mb-1"><strong>Name:</strong> {{ patient|title }}</p>
                                        <p class="mb-1"><strong>Card Number:</strong> {{ patient.card_number|upper }}</p>
                                        <p class="mb-0"><strong>Age/Sex:</strong> {{ patient.age|default:"N/A" }} / {{ patient.get_gender_display|default:"N/A" }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light h-100">
                                    <div class="card-body p-3">
                                        <h6>Scan Information</h6>
                                        <p class="mb-1"><strong>Scan Type:</strong> {{ order.template.name }}</p>
                                        <p class="mb-1"><strong>Category:</strong> {{ order.template.category.name }}</p>
                                        <p class="mb-0"><strong>Performed:</strong> {{ order.scan_completed_at|date:"M d, Y H:i"|default:"In Progress" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if measurements %}
                        <div class="mb-4">
                            <h5 class="mb-3">Measured Parameters</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 25%;">Parameter</th>
                                            <th style="width: 20%;">Measured Value</th>
                                            <th style="width: 15%;">Unit</th>
                                            <th style="width: 20%;">Normal Range</th>
                                            <th style="width: 20%;">Comments</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for measurement in measurements %}
                                        <tr>
                                            <td>
                                                <strong>{{ measurement.name }}</strong>
                                                <br><small class="text-muted">{{ measurement.code }}</small>
                                            </td>
                                            <td>
                                                {% if measurement.type == 'numeric' %}
                                                    <input type="number" name="measurement_{{ measurement.name|slugify }}" class="form-control" step="0.01" placeholder="Enter value">
                                                {% elif measurement.type == 'select' %}
                                                    <select name="measurement_{{ measurement.name|slugify }}" class="form-control">
                                                        <option value="">Select...</option>
                                                        {% for option in measurement.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}
                                                    </select>
                                                {% elif measurement.type == 'boolean' %}
                                                    <select name="measurement_{{ measurement.name|slugify }}" class="form-control">
                                                        <option value="">Select...</option>
                                                        <option value="Normal">Normal</option>
                                                        <option value="Abnormal">Abnormal</option>
                                                    </select>
                                                {% else %}
                                                    <input type="text" name="measurement_{{ measurement.name|slugify }}" class="form-control" placeholder="Enter value">
                                                {% endif %}
                                            </td>
                                            <td><small class="text-muted">{{ measurement.unit|default:"-" }}</small></td>
                                            <td>
                                                {% if measurement.normal_range %}<small class="text-muted">{% if measurement.normal_range.min %}{{ measurement.normal_range.min }}{% endif %}{% if measurement.normal_range.min and measurement.normal_range.max %} - {% endif %}{% if measurement.normal_range.max %}{{ measurement.normal_range.max }}{% endif %}</small>{% else %}<small class="text-muted">-</small>{% endif %}
                                            </td>
                                            <td><input type="text" name="measurement_{{ measurement.name|slugify }}_comment" class="form-control form-control-sm" placeholder="Optional comment"></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        {% if template.expected_images %}
                        <div class="mb-4">
                            <h5 class="mb-3"><b>Expected Images</b></h5>
                            <div class="row">
                                {% for image in template.expected_images %}
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <input type="file" name="expected_image_{{ forloop.counter0 }}" class="form-control" accept="image/*" {% if image.required %} required {% endif %} />
                                        <input type="hidden" name="expected_image_view_{{ forloop.counter0 }}" value="{{ image.view }}" />
                                        <small class="form-text text-muted">
                                            {{ image.description|upper }} ({{ image.view|upper }})
                                            {% if image.required %}<span class="text-danger"> *required</span>{% endif %}
                                        </small>
                                    </div><br />
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}


                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="findings" class="form-label">Clinical Findings</label>
                                    <p class="text-muted small">A detailed, objective account of everything observed on the scan (the "evidence").</p>
                                    <textarea name="findings" id="findings" class="form-control" rows="10"
                                              placeholder="Describe the primary scan findings..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="impression" class="form-label">Clinical Impression</label>
                                    <p class="text-muted small">The synthesis and interpretation of the findings; the diagnosis or conclusion (the "verdict").</p>
                                    <textarea name="impression" id="impression" class="form-control" rows="8"
                                              placeholder="Enter clinical impression or diagnosis..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="recommendations" class="form-label">Recommendations</label>
                                    <p class="text-muted small">Actionable advice and next steps for the referring physician.</p>
                                    <textarea name="recommendations" id="recommendations" class="form-control" rows="6"
                                              placeholder="Enter follow-up recommendations..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="technician_comments" class="form-label">Technician Comments</label>
                                    <p class="text-muted small">Internal notes from the scan technician regarding the procedure or image quality.</p>
                                    <textarea name="technician_comments" id="technician_comments"
                                              class="form-control" rows="4"
                                              placeholder="Enter technical notes or observations..."></textarea>
                                </div>
                            </div>
                        </div>


                        <div class="d-flex justify-content-between">
                            <a href="{% url 'scan_result_dashboard' %}" class="btn btn-secondary">
                                <i class="mdi mdi-arrow-left me-2"></i>Back to Dashboard
                            </a>
                            <div>
                                <button type="submit" class="btn btn-success">
                                    <i class="mdi mdi-content-save me-2"></i>Save Results
                                </button>
                            </div>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        {% if order %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Scan Information</h5>
                    <p><strong>Category:</strong> {{ template.category.name }}</p>
                    <p><strong>Duration:</strong> {{ template.estimated_duration|default:"Not specified" }}</p>
                    <p><strong>Equipment:</strong> {{ template.equipment_required|default:"Standard equipment" }}</p>
                    <p><strong>Price:</strong> ₦{{ template.price|floatformat:2 }}</p>
                    {% if template.preparation_required %}
                        <div class="alert alert-info p-2 mt-3"><small><strong>Preparation Required:</strong> Yes</small></div>
                    {% endif %}
                </div>
            </div>

            {% if template.expected_images %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Expected Images</h5>
                    <ul class="list-unstyled mb-0">
                        {% for img in template.expected_images %}
                        <li class="mb-2">
                            <span class="text-{% if img.required %}primary{% else %}secondary{% endif %} me-2">{{ img.view }}</span>
                            <small>{{ img.description }}</small>
                            {% if img.required %}<small class="text-danger">(Required)</small>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Actions</h5>
                    <div class="d-grid gap-2">
                        <a href="{% url 'patient_scan_orders' patient_id=patient.id %}" class="btn btn-outline-primary">
                            <i class="mdi mdi-account"></i> View Patient Scans
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="previewReport()">
                            <i class="mdi mdi-printer"></i> Preview Report
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
.table td { vertical-align: middle; }
.badge { font-size: 0.75em; }
.alert { border-radius: 0.375rem; }
/* TinyMCE customization to remove the "Powered by Tiny" branding */
.tox-tinymce-aux { display: none !important; }
</style>


<script>
// This function now needs to get content from the TinyMCE editors
function validateForm() {
    // Use tinymce.get() to read content. The 'text' format strips all HTML for validation.
    const findings = tinymce.get('findings').getContent({ format: 'text' }).trim();
    const impression = tinymce.get('impression').getContent({ format: 'text' }).trim();

    if (!findings && !impression) {
        alert('Please enter either Clinical Findings or Clinical Impression before saving.');
        return false;
    }
    return true; // Keep it simple; more complex validation can be added
}

// This function also needs to get the HTML content from the TinyMCE editors
function previewReport() {
    const findings = tinymce.get('findings').getContent();
    const impression = tinymce.get('impression').getContent();
    const recommendations = tinymce.get('recommendations').getContent();

    if (!findings && !impression) {
        alert('Please enter some findings or impression to preview the report.');
        return;
    }

    const previewWindow = window.open('', '_blank', 'width=800,height=600');
    previewWindow.document.write(`
        <html>
        <head>
            <title>Scan Report Preview</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 2rem; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                .section { margin-bottom: 20px; }
                .label { font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h2>Scan Report Preview</h2>
                    <p class="lead">{{ order.template.name }} - {{ patient|title }}</p>
                </div>
                <div class="section">
                    <div class="label">Clinical Findings:</div>
                    <div class="content">${findings || '<p class="text-muted"><i>Not provided.</i></p>'}</div>
                </div>
                <div class="section">
                    <div class="label">Clinical Impression:</div>
                    <div class="content">${impression || '<p class="text-muted"><i>Not provided.</i></p>'}</div>
                </div>
                <div class="section">
                    <div class="label">Recommendations:</div>
                    <div class="content">${recommendations || '<p class="text-muted"><i>Not provided.</i></p>'}</div>
                </div>
            </div>
        </body>
        </html>
    `);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize TinyMCE on the specified textareas
    tinymce.init({
        selector: '#findings, #impression, #recommendations',
        plugins: 'lists advlist autoresize link table',
        toolbar: 'undo redo | blocks | bold italic underline | bullist numlist | alignleft aligncenter alignright | table',
        menubar: false,
        statusbar: true,
        height: 350,
        autoresize_bottom_margin: 20,
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }'
    });

    // Attach validation to the form's submit event
    const form = document.getElementById('result-form');
    if (form) {
        form.addEventListener('submit', function(event) {
            // Important: Trigger save on TinyMCE editors to update the underlying textarea
            tinymce.triggerSave();

            if (!validateForm()) {
                event.preventDefault(); // Stop form submission if validation fails
            }
        });
    }
});

function showUploadImagesButton(resultId) {
    const uploadBtn = document.getElementById('upload-images-btn');
    if (uploadBtn) {
        uploadBtn.href = uploadBtn.href.replace('/0/', `/${resultId}/`);
        uploadBtn.style.display = 'block';
    }
}
</script>
{% endblock %}