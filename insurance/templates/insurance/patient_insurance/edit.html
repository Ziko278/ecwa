{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<div class="container-fluid">

    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-edit me-2"></i>Edit Patient Insurance Policy: {{ policy.policy_number }}
            </h4>
            <div>
                <a href="{% url 'patient_insurance_detail' pk=policy.pk %}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>Back to Details
                </a>
                <a href="{% url 'patient_insurance_list' %}" class="btn btn-info">
                    <i class="fas fa-list me-1"></i>All Policies
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="post" id="patientInsuranceForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Patient</label>
                        <div class="form-control-plaintext bg-light p-3 rounded border">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-circle text-primary me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <strong>{{ current_patient.first_name }} {{ current_patient.middle_name }} {{ current_patient.last_name }}</strong><br>
                                    <small class="text-muted">Card Number: {{ current_patient.card_number }}</small>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="patient" name="patient" value="{{ policy.patient.pk }}">
                        <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Patient cannot be changed after policy creation</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="hmo" class="form-label">HMO Provider <span class="text-danger">*</span></label>
                        <select class="form-select" id="hmo" name="hmo" required
                                data-plans-url="{% url 'get_hmo_coverage_plans' hmo_id=0 %}">
                            <option value="">Select HMO</option>
                            {% for hmo in hmos %}
                                <option value="{{ hmo.pk }}" {% if policy.hmo.pk == hmo.pk %}selected{% endif %}>
                                    {{ hmo.name }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.hmo.errors %}<div class="text-danger">{{ form.hmo.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="coverage_plan" class="form-label">Coverage Plan <span class="text-danger">*</span></label>
                        <select class="form-select" id="coverage_plan" name="coverage_plan" required disabled
                                data-details-url="{% url 'get_coverage_plan_details' plan_id=0 %}">
                            <option value="">Loading plans...</option>
                        </select>
                        {% if form.coverage_plan.errors %}<div class="text-danger">{{ form.coverage_plan.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="policy_number" class="form-label">Policy Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="policy_number" name="policy_number" value="{{ policy.policy_number }}" required>
                        {% if form.policy_number.errors %}<div class="text-danger">{{ form.policy_number.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="enrollee_id" class="form-label">Enrollee ID</label>
                        <input type="text" class="form-control" id="enrollee_id" name="enrollee_id" value="{{ policy.enrollee_id|default:'' }}">
                        {% if form.enrollee_id.errors %}<div class="text-danger">{{ form.enrollee_id.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="valid_from" class="form-label">Valid From <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="valid_from" name="valid_from" value="{{ policy.valid_from|date:'Y-m-d' }}" required>
                        {% if form.valid_from.errors %}<div class="text-danger">{{ form.valid_from.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="valid_to" class="form-label">Valid To <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="valid_to" name="valid_to" value="{{ policy.valid_to|date:'Y-m-d' }}" required>
                        {% if form.valid_to.errors %}<div class="text-danger">{{ form.valid_to.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_active" name="is_active" {% if policy.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="is_active">Is Active</label>
                    {% if form.is_active.errors %}<div class="text-danger">{{ form.is_active.errors }}</div>{% endif %}
                </div>

                <hr>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_verified" name="is_verified" {% if policy.is_verified %}checked{% endif %} disabled>
                    <label class="form-check-label" for="is_verified">Verified (Only if required by plan)</label>
                    <small id="verificationHelp" class="form-text text-muted d-block mt-1">
                        This will be enabled if the selected coverage plan requires verification.
                    </small>
                    {% if form.is_verified.errors %}<div class="text-danger">{{ form.is_verified.errors }}</div>{% endif %}
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3">{{ policy.notes|default:'' }}</textarea>
                    {% if form.notes.errors %}<div class="text-danger">{{ form.notes.errors }}</div>{% endif %}
                </div>

                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = getCookie('csrftoken');

    const hmoSelect = document.getElementById('hmo');
    const coveragePlanSelect = document.getElementById('coverage_plan');
    const isVerifiedCheckbox = document.getElementById('is_verified');
    const verificationHelpText = document.getElementById('verificationHelp');

    // Store initial values from the server
    const initialHMOValue = "{{ policy.hmo.pk }}";
    const initialCoveragePlanValue = "{{ policy.coverage_plan.pk }}";
    const initialIsVerified = {{ policy.is_verified|yesno:"true,false" }};

    // --- Toast Notification Handler ---
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    // --- Utility function to get CSRF token ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Function to reset verification fields ---
    function resetVerificationFields() {
        if (!initialIsVerified) {
            isVerifiedCheckbox.checked = false;
        }
        isVerifiedCheckbox.disabled = true;
        verificationHelpText.textContent = 'This will be enabled if the selected coverage plan requires verification.';
        verificationHelpText.classList.remove('text-success', 'text-warning');
        verificationHelpText.classList.add('text-muted');
    }

    // --- Handle HMO selection change to load coverage plans ---
    hmoSelect.addEventListener('change', async function() {
        const hmoId = this.value;
        const shouldPreserveSelection = (hmoId == initialHMOValue);

        coveragePlanSelect.innerHTML = '<option value="">Loading plans...</option>';
        coveragePlanSelect.disabled = true;

        if (!shouldPreserveSelection) {
            resetVerificationFields();
        }

        if (hmoId) {
            try {
                const baseUrlTemplate = hmoSelect.dataset.plansUrl;
                const url = baseUrlTemplate.replace('0', hmoId);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                coveragePlanSelect.innerHTML = '<option value="">Select Coverage Plan</option>';
                if (data.plans && data.plans.length > 0) {
                    data.plans.forEach(plan => {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.textContent = plan.name;
                        if (shouldPreserveSelection && plan.id == initialCoveragePlanValue) {
                            option.selected = true;
                        }
                        coveragePlanSelect.appendChild(option);
                    });
                    coveragePlanSelect.disabled = false;

                    if (shouldPreserveSelection && coveragePlanSelect.value == initialCoveragePlanValue) {
                         coveragePlanSelect.dispatchEvent(new Event('change'));
                    }
                } else {
                    coveragePlanSelect.innerHTML = '<option value="">No plans found for this HMO</option>';
                }
            } catch (error) {
                console.error('Error fetching coverage plans:', error);
                showToast('Failed to load coverage plans. Please try again.', 'danger');
                coveragePlanSelect.innerHTML = '<option value="">Error loading plans</option>';
            }
        } else {
            coveragePlanSelect.innerHTML = '<option value="">Select Coverage Plan</option>';
        }
    });

    // --- Handle Coverage Plan selection change for verification logic ---
    coveragePlanSelect.addEventListener('change', async function() {
        const planId = this.value;

        if (planId) {
            try {
                const baseUrlTemplate = coveragePlanSelect.dataset.detailsUrl;
                const url = baseUrlTemplate.replace('0', planId);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.require_verification) {
                    isVerifiedCheckbox.disabled = false;
                    verificationHelpText.textContent = 'This plan requires verification. Check the box if verified.';
                    verificationHelpText.classList.remove('text-muted');
                    verificationHelpText.classList.add('text-warning');
                } else {
                    isVerifiedCheckbox.checked = false;
                    isVerifiedCheckbox.disabled = true;
                    verificationHelpText.textContent = 'This plan does NOT require upfront verification.';
                    verificationHelpText.classList.remove('text-warning');
                    verificationHelpText.classList.add('text-muted');
                }
            } catch (error) {
                console.error('Error fetching plan details:', error);
                showToast('Failed to load plan verification status. Please try again.', 'danger');
            }
        } else {
             resetVerificationFields();
        }
    });

    // --- Initial setup on page load ---
    if (initialHMOValue) {
        hmoSelect.dispatchEvent(new Event('change'));
    } else {
        resetVerificationFields();
    }
});
</script>
{% endblock %}