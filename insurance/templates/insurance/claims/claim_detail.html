{% extends 'admin_site/layout.html' %}
{% load static humanize %}

{% block 'main' %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="bi bi-file-invoice-dollar me-2"></i>
            Claim Summary: <span class="text-primary">{{ summary.summary_number }}</span>
        </h4>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success" id="processAllBtn"
                    {% if summary.status == 'approved' %}disabled{% endif %}>
                <i class="bi bi-check-double me-2"></i>Process All Claims
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#downloadModal">
                <i class="bi bi-download me-2"></i>Download PDF
            </button>
            <a href="{% url 'insurance_claim_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <!-- Messages -->
    <div id="alertContainer"></div>

    <!-- Summary Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Summary Information</h5>
            <span class="badge fs-6
                {% if summary.status == 'pending' %}bg-warning
                {% elif summary.status == 'processing' %}bg-info
                {% elif summary.status == 'approved' %}bg-success
                {% elif summary.status == 'rejected' %}bg-danger
                {% elif summary.status == 'partially_approved' %}bg-warning
                {% else %}bg-secondary{% endif %}">
                {{ summary.get_status_display }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-5">Patient:</dt>
                        <dd class="col-sm-7">{{ summary.patient|title }}</dd>

                        <dt class="col-sm-5">HMO:</dt>
                        <dd class="col-sm-7">{{ summary.patient_insurance.hmo.name }}</dd>

                        <dt class="col-sm-5">Policy Number:</dt>
                        <dd class="col-sm-7">{{ summary.patient_insurance.policy_number }}</dd>

                        <dt class="col-sm-5">Source:</dt>
                        <dd class="col-sm-7">{{ summary.source_display }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-5">Total Amount:</dt>
                        <dd class="col-sm-7 fw-bold">₦{{ summary.total_amount|floatformat:2|intcomma }}</dd>

                        <dt class="col-sm-5">Covered Amount:</dt>
                        <dd class="col-sm-7 text-success fw-bold">₦{{ summary.total_covered_amount|floatformat:2|intcomma }}</dd>

                        <dt class="col-sm-5">Patient Amount:</dt>
                        <dd class="col-sm-7 text-danger fw-bold">₦{{ summary.total_patient_amount|floatformat:2|intcomma }}</dd>

                        {% if summary.total_approved_amount %}
                        <dt class="col-sm-5">Approved Amount:</dt>
                        <dd class="col-sm-7 text-primary fw-bold">₦{{ summary.total_approved_amount|floatformat:2|intcomma }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnosis Section -->
    {% if consultation %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-stethoscope me-2"></i>Clinical Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary mb-3">Diagnosis</h6>

                    {% if consultation.primary_diagnosis %}
                    <div class="mb-3">
                        <strong>Primary Diagnosis:</strong>
                        <p class="mb-0">{{ consultation.primary_diagnosis.name }}</p>

                    </div>
                    {% endif %}

                    {% if consultation.secondary_diagnoses.exists %}
                    <div class="mb-3">
                        <strong>Secondary Diagnoses:</strong>
                        <ul class="mb-0">
                            {% for diag in consultation.secondary_diagnoses.all %}
                            <li>
                                {{ diag.name }}
                                {% if diag.icd_code %}
                                <small class="text-muted">({{ diag.icd_code }})</small>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if consultation.other_diagnosis_text %}
                    <div class="mb-3">
                        <strong>Other Diagnosis:</strong>
                        <p class="mb-0">{{ consultation.other_diagnosis_text }}</p>
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <h6 class="text-primary mb-3">Clinical Assessment</h6>
                    {% if consultation.assessment %}
                    <div class="border rounded p-3 bg-light">
                        {{ consultation.assessment|safe }}
                    </div>
                    {% else %}
                    <p class="text-muted">No assessment recorded</p>
                    {% endif %}
                </div>
            </div>

            {% if consultation.chief_complaint %}
            <div class="row mt-3">
                <div class="col-12">
                    <h6 class="text-primary mb-2">Chief Complaint</h6>
                    <p>{{ consultation.chief_complaint }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Claims Processing Form -->
    <form id="claimsProcessingForm">
        {% csrf_token %}

        <!-- Drug Claims Section -->
        {% if drug_claims %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-pills me-2"></i>Drug Claims ({{ drug_claims.count }})
                </h5>
                <button type="button" class="btn btn-sm btn-success process-group-btn"
                        data-claim-type="drug">
                    <i class="bi bi-check me-1"></i>Process All Drugs
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Drug</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <th>Covered</th>
                                <th>Patient</th>
                                <th>Approve Amount</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in drug_claims %}
                            <tr class="claim-row" data-claim-id="{{ claim.id }}" data-claim-status="{{ claim.status }}">
                                <td>
                                    {% if claim.content_object %}
                                        {{ claim.content_object.drug.brand_name|default:claim.content_object.drug.formulation }}
                                    {% else %}
                                        <em class="text-muted">Drug info unavailable</em>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if claim.content_object %}
                                        {{ claim.content_object.quantity_ordered }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>₦{{ claim.total_amount|floatformat:2 }}</td>
                                <td class="text-success">₦{{ claim.covered_amount|floatformat:2 }}</td>
                                <td class="text-danger">₦{{ claim.patient_amount|floatformat:2 }}</td>
                                <td>
                                    <input type="number" step="0.01" min="0" max="{{ claim.total_amount }}"
                                           class="form-control form-control-sm approve-amount-input"
                                           name="approved_amount_{{ claim.id }}"
                                           value="{{ claim.approved_amount|default:claim.covered_amount }}"
                                           {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="pending_{{ claim.id }}" value="pending"
                                               {% if claim.status == 'pending' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-warning" for="pending_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-clock"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="approve_{{ claim.id }}" value="approve"
                                               {% if claim.status == 'approved' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-success" for="approve_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-check"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="decline_{{ claim.id }}" value="decline"
                                               {% if claim.status == 'rejected' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-danger" for="decline_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-x"></i>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if claim.status == 'pending' %}bg-warning
                                        {% elif claim.status == 'approved' %}bg-success
                                        {% elif claim.status == 'rejected' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ claim.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if claim.status not in 'approved,rejected,paid' %}
                                    <button type="button" class="btn btn-sm btn-primary process-single-btn"
                                            data-claim-id="{{ claim.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if claim.status == 'rejected' and claim.rejection_reason %}
                            <tr>
                                <td colspan="9" class="bg-light">
                                    <small><strong>Rejection Reason:</strong> {{ claim.rejection_reason }}</small>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

<!-- CONTINUATION FROM PART 1 -->

        <!-- Lab Claims Section -->
        {% if lab_claims %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-flask me-2"></i>Laboratory Claims ({{ lab_claims.count }})
                </h5>
                <button type="button" class="btn btn-sm btn-success process-group-btn"
                        data-claim-type="laboratory">
                    <i class="bi bi-check me-1"></i>Process All Labs
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Test Name</th>
                                <th>Total</th>
                                <th>Covered</th>
                                <th>Patient</th>
                                <th>Approve Amount</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in lab_claims %}
                            <tr class="claim-row" data-claim-id="{{ claim.id }}" data-claim-status="{{ claim.status }}">
                                <td>
                                    {% if claim.content_object %}
                                        {{ claim.content_object.template.name }}
                                    {% else %}
                                        <em class="text-muted">Test info unavailable</em>
                                    {% endif %}
                                </td>
                                <td>₦{{ claim.total_amount|floatformat:2 }}</td>
                                <td class="text-success">₦{{ claim.covered_amount|floatformat:2 }}</td>
                                <td class="text-danger">₦{{ claim.patient_amount|floatformat:2 }}</td>
                                <td>
                                    <input type="number" step="0.01" min="0" max="{{ claim.total_amount }}"
                                           class="form-control form-control-sm approve-amount-input"
                                           name="approved_amount_{{ claim.id }}"
                                           value="{{ claim.approved_amount|default:claim.covered_amount }}"
                                           {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="pending_lab_{{ claim.id }}" value="pending"
                                               {% if claim.status == 'pending' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-warning" for="pending_lab_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-clock"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="approve_lab_{{ claim.id }}" value="approve"
                                               {% if claim.status == 'approved' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-success" for="approve_lab_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-check"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="decline_lab_{{ claim.id }}" value="decline"
                                               {% if claim.status == 'rejected' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-danger" for="decline_lab_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-x"></i>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if claim.status == 'pending' %}bg-warning
                                        {% elif claim.status == 'approved' %}bg-success
                                        {% elif claim.status == 'rejected' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ claim.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if claim.status not in 'approved,rejected,paid' %}
                                    <button type="button" class="btn btn-sm btn-primary process-single-btn"
                                            data-claim-id="{{ claim.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if claim.status == 'rejected' and claim.rejection_reason %}
                            <tr>
                                <td colspan="8" class="bg-light">
                                    <small><strong>Rejection Reason:</strong> {{ claim.rejection_reason }}</small>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Scan Claims Section -->
        {% if scan_claims %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-x-ray me-2"></i>Radiology/Scan Claims ({{ scan_claims.count }})
                </h5>
                <button type="button" class="btn btn-sm btn-success process-group-btn"
                        data-claim-type="scan">
                    <i class="bi bi-check me-1"></i>Process All Scans
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Scan Type</th>
                                <th>Total</th>
                                <th>Covered</th>
                                <th>Patient</th>
                                <th>Approve Amount</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in scan_claims %}
                            <tr class="claim-row" data-claim-id="{{ claim.id }}" data-claim-status="{{ claim.status }}">
                                <td>
                                    {% if claim.content_object %}
                                        {{ claim.content_object.template.name }}
                                    {% else %}
                                        <em class="text-muted">Scan info unavailable</em>
                                    {% endif %}
                                </td>
                                <td>₦{{ claim.total_amount|floatformat:2 }}</td>
                                <td class="text-success">₦{{ claim.covered_amount|floatformat:2 }}</td>
                                <td class="text-danger">₦{{ claim.patient_amount|floatformat:2 }}</td>
                                <td>
                                    <input type="number" step="0.01" min="0" max="{{ claim.total_amount }}"
                                           class="form-control form-control-sm approve-amount-input"
                                           name="approved_amount_{{ claim.id }}"
                                           value="{{ claim.approved_amount|default:claim.covered_amount }}"
                                           {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="pending_scan_{{ claim.id }}" value="pending"
                                               {% if claim.status == 'pending' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-warning" for="pending_scan_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-clock"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="approve_scan_{{ claim.id }}" value="approve"
                                               {% if claim.status == 'approved' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-success" for="approve_scan_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-check"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="decline_scan_{{ claim.id }}" value="decline"
                                               {% if claim.status == 'rejected' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-danger" for="decline_scan_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-x"></i>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if claim.status == 'pending' %}bg-warning
                                        {% elif claim.status == 'approved' %}bg-success
                                        {% elif claim.status == 'rejected' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ claim.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if claim.status not in 'approved,rejected,paid' %}
                                    <button type="button" class="btn btn-sm btn-primary process-single-btn"
                                            data-claim-id="{{ claim.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if claim.status == 'rejected' and claim.rejection_reason %}
                            <tr>
                                <td colspan="8" class="bg-light">
                                    <small><strong>Rejection Reason:</strong> {{ claim.rejection_reason }}</small>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Surgery Claims Section -->
        {% if surgery_claims %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-user-md me-2"></i>Surgery Claims ({{ surgery_claims.count }})
                </h5>
                <button type="button" class="btn btn-sm btn-success process-group-btn"
                        data-claim-type="surgery">
                    <i class="bi bi-check me-1"></i>Process All Surgeries
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Surgery Type</th>
                                <th>Total</th>
                                <th>Covered</th>
                                <th>Patient</th>
                                <th>Approve Amount</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in surgery_claims %}
                            <tr class="claim-row" data-claim-id="{{ claim.id }}" data-claim-status="{{ claim.status }}">
                                <td>
                                    {% if claim.content_object %}
                                        {{ claim.content_object.surgery_type.name }}
                                    {% else %}
                                        <em class="text-muted">Surgery info unavailable</em>
                                    {% endif %}
                                </td>
                                <td>₦{{ claim.total_amount|floatformat:2 }}</td>
                                <td class="text-success">₦{{ claim.covered_amount|floatformat:2 }}</td>
                                <td class="text-danger">₦{{ claim.patient_amount|floatformat:2 }}</td>
                                <td>
                                    <input type="number" step="0.01" min="0" max="{{ claim.total_amount }}"
                                           class="form-control form-control-sm approve-amount-input"
                                           name="approved_amount_{{ claim.id }}"
                                           value="{{ claim.approved_amount|default:claim.covered_amount }}"
                                           {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="pending_surg_{{ claim.id }}" value="pending"
                                               {% if claim.status == 'pending' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-warning" for="pending_surg_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-clock"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="approve_surg_{{ claim.id }}" value="approve"
                                               {% if claim.status == 'approved' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-success" for="approve_surg_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-check"></i>
                                        </label>

                                        <input type="radio" class="btn-check" name="action_{{ claim.id }}"
                                               id="decline_surg_{{ claim.id }}" value="decline"
                                               {% if claim.status == 'rejected' %}checked{% endif %}
                                               {% if claim.status in 'approved,rejected,paid' %}disabled{% endif %}>
                                        <label class="btn btn-outline-danger" for="decline_surg_{{ claim.id }}"
                                               {% if claim.status in 'approved,rejected,paid' %}style="opacity: 0.5;"{% endif %}>
                                            <i class="bi bi-x"></i>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if claim.status == 'pending' %}bg-warning
                                        {% elif claim.status == 'approved' %}bg-success
                                        {% elif claim.status == 'rejected' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ claim.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if claim.status not in 'approved,rejected,paid' %}
                                    <button type="button" class="btn btn-sm btn-primary process-single-btn"
                                            data-claim-id="{{ claim.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if claim.status == 'rejected' and claim.rejection_reason %}
                            <tr>
                                <td colspan="8" class="bg-light">
                                    <small><strong>Rejection Reason:</strong> {{ claim.rejection_reason }}</small>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </form>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionReasonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rejection Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="rejectionReasonText" class="form-control" rows="4"
                          placeholder="Enter reason for declining this claim..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejection">Confirm Decline</button>
            </div>
        </div>
    </div>
</div>

<!-- Download PDF Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download Claim Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'download_claim_pdf' pk=summary.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <h6>Select sections to include:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_consultation"
                               id="includeConsultation" checked>
                        <label class="form-check-label" for="includeConsultation">
                            Consultation Details & Diagnosis
                        </label>
                    </div>
                    {% if drug_claims %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_drugs"
                               id="includeDrugs" checked>
                        <label class="form-check-label" for="includeDrugs">
                            Drug Claims ({{ drug_claims.count }})
                        </label>
                    </div>
                    {% endif %}
                    {% if lab_claims %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_labs"
                               id="includeLabs" checked>
                        <label class="form-check-label" for="includeLabs">
                            Laboratory Claims ({{ lab_claims.count }})
                        </label>
                    </div>
                    {% endif %}
                    {% if scan_claims %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_scans"
                               id="includeScans" checked>
                        <label class="form-check-label" for="includeScans">
                            Scan Claims ({{ scan_claims.count }})
                        </label>
                    </div>
                    {% endif %}
                    {% if surgery_claims %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_surgeries"
                               id="includeSurgeries" checked>
                        <label class="form-check-label" for="includeSurgeries">
                            Surgery Claims ({{ surgery_claims.count }})
                        </label>
                    </div>
                    {% endif %}

                    <hr>
                    <h6>Display options:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_status"
                               id="showStatus" checked>
                        <label class="form-check-label" for="showStatus">
                            Show claim status
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_amounts"
                               id="showAmounts" checked>
                        <label class="form-check-label" for="showAmounts">
                            Show approval amounts
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-download me-2"></i>Download PDF
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let currentClaimId = null;
    let currentAction = null;

    // Show alert function
    function showAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('alertContainer').appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Process single claim
    document.querySelectorAll('.process-single-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const claimId = this.dataset.claimId;
            const action = document.querySelector(`input[name="action_${claimId}"]:checked`).value;

            if (action === 'decline') {
                // Show rejection modal
                currentClaimId = claimId;
                currentAction = 'decline';
                document.getElementById('rejectionReasonText').value = '';
                new bootstrap.Modal(document.getElementById('rejectionReasonModal')).show();
            } else {
                processClaim(claimId, action);
            }
        });
    });

    // Confirm rejection
    document.getElementById('confirmRejection').addEventListener('click', function() {
        const reason = document.getElementById('rejectionReasonText').value.trim();
        if (!reason) {
            alert('Please enter a rejection reason');
            return;
        }

        processClaim(currentClaimId, 'decline', reason);
        bootstrap.Modal.getInstance(document.getElementById('rejectionReasonModal')).hide();
    });

    // Process claim function
    function processClaim(claimId, action, rejectionReason = '') {
        const approvedAmount = document.querySelector(`input[name="approved_amount_${claimId}"]`).value;

        const formData = new FormData();
        formData.append('action', action);
        formData.append('approved_amount', approvedAmount);
        formData.append('rejection_reason', rejectionReason);

        fetch(`/portal/insurance/claim/${claimId}/process-single/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.error || 'Failed to process claim', 'danger');
            }
        })
        .catch(error => {
            showAlert('An error occurred', 'danger');
            console.error('Error:', error);
        });
    }

    // Process group button
    document.querySelectorAll('.process-group-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const claimType = this.dataset.claimType;
            if (confirm(`Process all ${claimType} claims?`)) {
                processGroup(claimType);
            }
        });
    });

    // Process all button
    document.getElementById('processAllBtn')?.addEventListener('click', function() {
        if (confirm('Process all pending claims?')) {
            processAll();
        }
    });

    function processGroup(claimType) {
    const rows = document.querySelectorAll(`.claim-row`);
    const formData = new FormData();
    let hasData = false;

    rows.forEach(row => {
        const claimId = row.dataset.claimId;
        const claimStatus = row.dataset.claimStatus;

        // Skip if already processed
        if (['approved', 'rejected', 'paid'].includes(claimStatus)) {
            return;
        }

        // Get the claim type from the parent card
        const card = row.closest('.card');
        const groupBtn = card.querySelector('.process-group-btn');
        if (groupBtn && groupBtn.dataset.claimType === claimType) {
            const action = document.querySelector(`input[name="action_${claimId}"]:checked`)?.value;
            const approvedAmount = document.querySelector(`input[name="approved_amount_${claimId}"]`)?.value;

            if (action && action !== 'pending') {
                formData.append(`action_${claimId}`, action);
                formData.append(`approved_amount_${claimId}`, approvedAmount || '0');
                if (action === 'decline') {
                    formData.append(`rejection_reason_${claimId}`, 'Bulk rejection');
                }
                hasData = true;
            }
        }
    });

    if (!hasData) {
        showAlert('No claims to process', 'warning');
        return;
    }

    formData.append('claim_type', claimType);

    const summaryId = '{{ summary.id }}';
    fetch(`/portal/insurance/claims/${summaryId}/process-group/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error || 'Failed to process claims', 'danger');
        }
    })
    .catch(error => {
        showAlert('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

function processAll() {
    const rows = document.querySelectorAll('.claim-row');
    const formData = new FormData();
    let hasData = false;

    rows.forEach(row => {
        const claimId = row.dataset.claimId;
        const claimStatus = row.dataset.claimStatus;

        // Skip if already processed
        if (['approved', 'rejected', 'paid'].includes(claimStatus)) {
            return;
        }

        const action = document.querySelector(`input[name="action_${claimId}"]:checked`)?.value;
        const approvedAmount = document.querySelector(`input[name="approved_amount_${claimId}"]`)?.value;

        if (action && action !== 'pending') {
            formData.append(`action_${claimId}`, action);
            formData.append(`approved_amount_${claimId}`, approvedAmount || '0');
            if (action === 'decline') {
                formData.append(`rejection_reason_${claimId}`, 'Bulk rejection');
            }
            hasData = true;
        }
    });

    if (!hasData) {
        showAlert('No claims to process', 'warning');
        return;
    }

    const summaryId = '{{ summary.id }}';
    fetch(`/portal/insurance/claims/${summaryId}/process-all/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error || 'Failed to process claims', 'danger');
        }
    })
    .catch(error => {
        showAlert('An error occurred', 'danger');
        console.error('Error:', error);
    });
}
});
</script>

{% endblock %}