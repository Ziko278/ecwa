{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
<style>
    /* --- Styles for Drug Search (New Feature) --- */
    #drug-search-results {
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        z-index: 999;
        width: calc(100% - 2rem); /* Match input width */
        max-height: 250px;
        overflow-y: auto;
    }
    .search-result-item {
        padding: 10px;
        cursor: pointer;
    }
    .search-result-item:hover {
        background-color: #f0f0f0;
    }
    .search-result-item small {
        display: block;
        color: #6c757d;
    }
    /* --- End New Styles --- */

    .card-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    .patient-info-card {
        border-left: 4px solid #28a745;
    }
    .wallet-balance {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
    }
    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    .service-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .service-header {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ready-to-dispense { background-color: #d4edda; }
    .unpaid-orders { background-color: #f8d7da; }

    .item-row {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .item-row:last-child {
        border-bottom: none;
    }
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .quantity-input {
        width: 80px;
        text-align: center;
    }
    .hidden {
        display: none;
    }
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        position: relative;
    }
    .step.active {
        background: #007bff;
        color: white;
    }
    .step.completed {
        background: #28a745;
        color: white;
    }
    .step::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 100%;
        width: 20px;
        height: 2px;
        background: #dee2e6;
        transform: translateY(-50%);
    }
    .step:last-child::after {
        display: none;
    }
    .action-section {
        background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
</style>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-pills"></i> Drug Dispensing System
                        </h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-indicator">
            <div class="step active" id="step-1">1</div>
            <div class="step" id="step-2">2</div>
        </div>

        <div id="patient-verification-section">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-search"></i> Verify Patient</h5>
                        </div>
                        <div class="card-body">
                            <form id="patient-verification-form">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="card_number" class="form-label">Patient Card Number</label>
                                    <input type="text" class="form-control form-control-lg"
                                           id="card_number" name="card_number"
                                           placeholder="Enter patient card number" required>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-search"></i> Verify Patient
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dispensing-section" class="hidden">
            <div class="row">
                <div class="col-md-4">
                    <div class="card patient-info-card mb-3">
                        <div class="card-header">
                            <h5><i class="fas fa-user"></i> Patient Information</h5>
                        </div>
                        <div class="card-body" id="patient-info">
                            </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h5><i class="fas fa-wallet"></i> Wallet Balance</h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="wallet-balance" id="wallet-balance">₦0.00</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-plus-circle"></i> Add New Drug Sale</h5>
                        </div>
                        <div class="card-body">
                            <form id="add-drug-form">
                                <div class="mb-3 position-relative">
                                    <label for="drug-search" class="form-label">Search Drug</label>
                                    <input type="text" id="drug-search" class="form-control" placeholder="Type to search for a drug...">
                                    <div id="drug-search-results"></div>
                                </div>
                                <input type="hidden" id="selected-drug-id">
                                <div class="mb-3">
                                    <label for="sale-quantity" class="form-label">Quantity</label>
                                    <input type="number" id="sale-quantity" class="form-control" min="1" value="1">
                                </div>
                                <button type="button" class="btn btn-primary w-100" id="add-drug-btn" disabled>
                                    <i class="fas fa-cart-plus"></i> Add to Order
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <!-- Insurance Warning Alert -->
                    <div id="insurance-warning-alert" style="display: none;"></div>
                    <div id="ready-to-dispense-section"></div>

                    <div id="unpaid-orders-section"></div>

                    <div class="action-section" id="action-section" style="display: none;">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 id="action-summary">No actions selected</h5>
                                <small id="action-details"></small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light btn-lg" id="process-action-btn" onclick="processActions()">
                                    <i class="fas fa-check"></i> Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3">Processing... Please wait.</div>
      </div>
    </div>
  </div>
</div>

    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalTitle">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let patientData = null;
        let drugOrders = null;
        let walletBalance = 0;
        let selectedActions = [];
        let notificationModal; // <-- Modal instance variable
        let loadingModal;
        // track items that failed stock validation (optional)
        let _stockValidationErrors = {}; // orderId -> message

        // ---- Page Ready Function ----
        $(document).ready(function() {
            // Initialize the notification modal instance
             notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

            $('#patient-verification-form').on('submit', function(e) {
                e.preventDefault();
                const cardNumber = $('#card_number').val().trim();
                if (!cardNumber) {
                    showNotificationModal("Please enter a card number.", "Validation Error", true);
                    return;
                }
                verifyPatient(cardNumber);
            });

            // --- Event Listeners for New Drug Sale Feature ---
            $('#drug-search').on('keyup', function() {
                const query = $(this).val();
                if (query.length < 2) {
                    $('#drug-search-results').hide();
                    return;
                }
                $.ajax({
                    url: "{% url 'ajax_search_drugs' %}",
                    data: { 'q': query },
                    success: function(data) {
                        let resultsHtml = '';
                        if (data.drugs && data.drugs.length > 0) {
                            data.drugs.forEach(drug => {
                                let isPrescription = drug.is_prescription_only ? `<span class="badge bg-danger">Rx Only</span>` : `<span class="badge bg-success">OTC</span>`;
                                resultsHtml += `
                                    <div class="search-result-item" data-id="${drug.id}" data-name="${drug.brand_name || drug.formulation}" data-is-prescription="${drug.is_prescription_only}">
                                        <strong>${drug.brand_name || drug.formulation}</strong> ${isPrescription}
                                        <small>Generic: ${drug.generic_name} | Price: ₦${drug.price}</small>
                                    </div>
                                `;
                            });
                        } else {
                            resultsHtml = '<div class="p-2 text-muted">No drugs found.</div>';
                        }
                        $('#drug-search-results').html(resultsHtml).show();
                    }
                });
            });

            $(document).on('click', '.search-result-item', function() {
                const drugId = $(this).data('id');
                const drugName = $(this).data('name');
                const isPrescription = $(this).data('is-prescription');

                if (isPrescription) {
                    showNotificationModal(`'${drugName}' is a prescription-only drug and cannot be sold directly.`, "Sale Restricted", true);
                    $('#add-drug-btn').prop('disabled', true);
                    return;
                }

                $('#selected-drug-id').val(drugId);
                $('#drug-search').val(drugName);
                $('#drug-search-results').hide();
                $('#add-drug-btn').prop('disabled', false);
            });

            $('#add-drug-btn').on('click', function() {
                const drugId = $('#selected-drug-id').val();
                const quantity = $('#sale-quantity').val();

                if (!drugId || !quantity || quantity < 1) {
                    showNotificationModal("Please select a valid drug and quantity.", "Input Error", true);
                    return;
                }

                //showLoading();

                $.ajax({
                    url: "{% url 'pharmacy_create_order_ajax' %}",
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        patient_id: patientData.id,
                        drug_id: drugId,
                        quantity: quantity,
                        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                    }),
                    headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
                    success: function(response) {
                        hideLoading();
                        showNotificationModal(response.message, "Success");
                        // Clear the form and refresh the patient's order list
                        $('#add-drug-form')[0].reset();
                        $('#selected-drug-id').val('');
                        $('#add-drug-btn').prop('disabled', true);
                        verifyPatient(patientData.card_number);
                    },
                    error: function(xhr) {
                        hideLoading();
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An unknown error occurred.";
                        showNotificationModal(errorMsg, "Error Creating Order", true);
                    }
                });
            });

            // Hide search results if clicked outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#drug-search-results, #drug-search').length) {
                    $('#drug-search-results').hide();
                }
            });

            // --- New: Delegated handlers for dispense validations ---
            // When a dispense checkbox is toggled
            $(document).on('change', '.dispense-checkbox', function() {
                const orderId = $(this).val();
                const checked = $(this).is(':checked');
                const qtyInput = $(`.dispense-qty[data-order-id="${orderId}"]`);
                if (checked) {
                    const ok = validateDispenseSelection(orderId);
                    if (!ok) {
                        // if validation failed, uncheck and update summary
                        $(this).prop('checked', false);
                    }
                }
                updateActionSummary();
            });

            // When a dispense qty is changed
            $(document).on('change', '.dispense-qty', function() {
                const orderId = $(this).data('order-id');
                // if corresponding checkbox is checked, validate immediately
                const checkbox = $(`.dispense-checkbox[value="${orderId}"]`);
                if (checkbox.is(':checked')) {
                    const ok = validateDispenseSelection(orderId);
                    if (!ok) {
                        // unchecked inside validation, update qty back to available max if possible
                        // handled in validateDispenseSelection
                    }
                }
                updateActionSummary();
            });
        });

        // --- Core Functions ----

        function verifyPatient(cardNumber) {
            //showLoading();
            // REMOVED MOCK DATA. This is the only part that runs now.
            $.ajax({
                url: "{% url 'pharmacy_verify_patient_ajax' %}",
                method: 'GET',
                data: { card_number: cardNumber },
                success: function(response) {

                    hideLoading();

                    if (response.success) {
                        patientData = response.patient;
                        drugOrders = response.drug_orders;
                        walletBalance = response.wallet.balance;

                        displayPatientInfo(response);
                        displayDrugOrders(response.drug_orders);

                        $('#step-1').removeClass('active').addClass('completed');
                        $('#step-2').addClass('active');
                        $('#patient-verification-section').addClass('hidden');
                        $('#dispensing-section').removeClass('hidden');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    const response = xhr.responseJSON;
                    showNotificationModal(response.error || 'Error verifying patient', "Verification Failed", true);
                }
            });
        }

        function displayPatientInfo(data) {
                const patient = data.patient;

                // Build insurance info HTML
                let insuranceHtml = '';
                if (data.insurance && data.insurance.has_active) {
                    insuranceHtml = `
                        <p class="mb-1">
                            <strong>Insurance:</strong>
                            <span class="badge bg-success">
                                <i class="fas fa-shield-alt"></i> ${data.insurance.hmo_name}
                            </span>
                        </p>
                        <p class="mb-1"><strong>Plan:</strong> ${data.insurance.plan_name}</p>
                    `;
                } else {
                    insuranceHtml = `
                        <p class="mb-1">
                            <strong>Insurance:</strong>
                            <span class="badge bg-secondary">No Active Coverage</span>
                        </p>
                    `;
                }

                $('#patient-info').html(`
                    <h5>${patient.full_name}</h5>
                    <p class="mb-1"><strong>Card Number:</strong> ${patient.card_number}</p>
                    <p class="mb-1"><strong>Phone:</strong> ${patient.phone || 'N/A'}</p>
                    <p class="mb-1"><strong>Age:</strong> ${patient.age || 'N/A'}</p>
                    <p class="mb-1"><strong>Gender:</strong> ${patient.gender || 'N/A'}</p>
                    <hr>
                    ${insuranceHtml}
                `);
                $('#wallet-balance').text(data.wallet.formatted_balance);

                // Show insurance warning if there are pending claims
                if (data.pending_claims_count > 0) {
                    $('#insurance-warning-alert').html(`
                        <div class="alert alert-warning border-start border-warning border-4 mb-3" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>⚠️ ${data.pending_claims_count} Pending Insurance Claim${data.pending_claims_count > 1 ? 's' : ''}</strong>
                            <p class="mb-0 mt-2">
                                <small>Some orders have pending insurance claims. Patient will pay <strong>full amount</strong>
                                until claims are approved by the insurance department.</small>
                            </p>
                        </div>
                    `).show();
                } else {
                    $('#insurance-warning-alert').hide();
                }
            }

        function displayDrugOrders(orders) {
            // FIX: Clear existing content to prevent duplication
            $('#ready-to-dispense-section').empty();
            $('#unpaid-orders-section').empty();

            // Ready to Dispense Section
            if (orders.ready_to_dispense.length > 0) {
                $('#ready-to-dispense-section').html(createDispenseSection(orders.ready_to_dispense));
            }

            // Unpaid Orders Section
            if (orders.unpaid_orders.length > 0) {
                $('#unpaid-orders-section').html(createUnpaidSection(orders.unpaid_orders));
            }

            // No Orders Message
            if (orders.ready_to_dispense.length === 0 && orders.unpaid_orders.length === 0) {
                $('#ready-to-dispense-section').html(`
                    <div class="card mt-2">
                        <div class="card-body text-center text-muted py-4">
                            <i class="fas fa-pills fa-3x mb-3"></i>
                            <h5>No Pending Drug Orders Found</h5>
                            <p>This patient has no orders awaiting payment or dispensing.</p>
                        </div>
                    </div>
                `);
            }
            updateActionSummary();
        }

        function createDispenseSection(orders) {
            let html = `
                <div class="card service-card">
                    <div class="service-header ready-to-dispense">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-check-circle text-success"></i> Ready to Dispense
                            </h6>
                            <small>Paid orders ready for dispensing</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="selectAllDispense()">
                                Select All
                            </button>
                        </div>
                    </div>
            `;
            orders.forEach(order => {
                const statusBadge = order.status === 'paid' ?
                    '<span class="badge bg-success status-badge">Paid</span>' :
                    '<span class="badge bg-warning text-dark status-badge">Partially Dispensed</span>';

                const maxQuantity = order.remaining_quantity;
                // store_qty: backend provided as 'quantity_left' (string). parse to number
                const storeQty = parseFloat(order.quantity_left) || 0;
                alert(storeQty)

                // If storeQty is less than remaining, show inline small warning and mark data attribute
                const stockWarning = storeQty < maxQuantity ? `<br><small class="text-danger">Only ${storeQty} unit(s) in stock. You must reduce the qty or restock.</small>` : '';

                html += `
                    <div class="item-row">
                        <div class="form-check">
                            <input class="form-check-input dispense-checkbox" type="checkbox"
                                   value="${order.id}"
                                   data-type="dispense"
                                   data-store-qty="${storeQty}">
                            <label class="form-check-label">
                                <strong>${order.drug_name}</strong>
                                ${statusBadge}
                                <br>
                                <small class="text-muted">
                                    Order: ${order.order_number} | ${order.dosage_instructions}
                                </small>
                                <br>
                                <small class="text-muted">
                                    Ordered: ${order.quantity_ordered} |
                                    Dispensed: ${order.quantity_dispensed} |
                                    Remaining: ${order.remaining_quantity}
                                    <br>
                                    ${order.dosage_instructions || order.duration ? ` | Dosage: ${order.dosage_instructions || ''} for ${order.duration || ''}`.trim() : ''}
                                </small>
                                ${order.notes ? `<br><small class="text-muted">Note: ${order.notes}</small>` : ''}

                                ${stockWarning}
                            </label>
                        </div>
                        <div class="quantity-controls">
                            <label class="form-label small mb-0">Qty:</label>
                            <input type="number" class="form-control form-control-sm quantity-input dispense-qty"
                                   data-order-id="${order.id}"
                                   min="1" max="${maxQuantity}"
                                   value="${Math.min(maxQuantity, storeQty) > 0 ? Math.min(maxQuantity, storeQty) : 1}">
                            <small class="text-muted">/ ${maxQuantity}</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function createUnpaidSection(orders) {
            let html = `
                <div class="card service-card mt-3">
                    <div class="service-header unpaid-orders">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-circle text-danger"></i> Unpaid Orders
                            </h6>
                            <small>Orders pending payment from wallet</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="selectAllPayment()">
                                Select All
                            </button>
                        </div>
                    </div>
            `;

            orders.forEach(order => {
                // Determine if there's insurance coverage
                const hasApprovedClaim = order.has_approved_claim || false;
                const hasPendingClaim = order.has_pending_claim || false;
                const baseAmount = order.base_amount || order.total_amount;
                const patientAmount = order.patient_amount || order.total_amount;

                // Build claim badge
                let claimBadge = '';
                if (hasApprovedClaim) {
                    claimBadge = `<span class="badge bg-success ms-2">
                        <i class="fas fa-check-circle"></i> Claim Approved: ${order.claim_number}
                    </span>`;
                } else if (hasPendingClaim) {
                    claimBadge = `<span class="badge bg-warning text-dark ms-2">
                        <i class="fas fa-clock"></i> Pending Claim: ${order.pending_claim_number}
                    </span>`;
                }

                // Show strikethrough base amount if different from patient amount
                let priceHtml = '';
                if (baseAmount !== patientAmount && (hasApprovedClaim || order.covered_amount > 0)) {
                    priceHtml = `
                        <div class="text-end">
                            <div><small class="text-danger text-decoration-line-through">₦${parseFloat(baseAmount).toLocaleString()}</small></div>
                            <div class="fw-bold text-success">₦${parseFloat(patientAmount).toLocaleString()}</div>
                            <small class="text-muted">@ ₦${order.price_per_unit}/unit</small>
                        </div>
                    `;
                } else {
                    priceHtml = `
                        <div class="text-end">
                            <div class="fw-bold">₦${parseFloat(patientAmount).toLocaleString()}</div>
                            <small class="text-muted">@ ₦${order.price_per_unit}/unit</small>
                        </div>
                    `;
                }

                html += `
                    <div class="item-row">
                        <div class="form-check">
                            <input class="form-check-input payment-checkbox" type="checkbox"
                                   value="${order.id}" data-type="payment"
                                   data-amount="${patientAmount}" onchange="updateActionSummary()">
                            <label class="form-check-label">
                                <strong>${order.drug_name}</strong>
                                <span class="badge bg-danger status-badge">Unpaid</span>
                                ${claimBadge}
                                <br>
                                <small class="text-muted">
                                    Order: ${order.order_number} | Qty: ${order.quantity_ordered}
                                    <br>
                                    ${order.dosage_instructions || order.duration ? ` | Dosage: ${order.dosage_instructions || ''} for ${order.duration || ''}`.trim() : ''}
                                </small>
                                ${order.notes ? `<br><small class="text-muted">Note: ${order.notes}</small>` : ''}
                                <br>
                                <small class="text-muted">
                                    ${order.dosage_instructions}
                                </small>
                            </label>
                        </div>
                        ${priceHtml}
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function selectAllDispense() {
            const checkboxes = $('.dispense-checkbox');
            const allChecked = checkboxes.length > 0 && checkboxes.filter(':checked').length === checkboxes.length;

            // If selecting all, validate each item first; if any fails, do not check that one
            checkboxes.each(function() {
                const $cb = $(this);
                const orderId = $cb.val();
                if (!allChecked) {
                    // try to check
                    const ok = validateDispenseSelection(orderId, $cb);
                    if (ok) $cb.prop('checked', true);
                    else $cb.prop('checked', false);
                } else {
                    // uncheck all
                    $cb.prop('checked', false);
                }
            });

            updateActionSummary();
        }

        function selectAllPayment() {
            const checkboxes = $('.payment-checkbox');
            const allChecked = checkboxes.length > 0 && checkboxes.filter(':checked').length === checkboxes.length;
            checkboxes.prop('checked', !allChecked);
            updateActionSummary();
        }

        function updateActionSummary() {
            const dispenseItems = $('.dispense-checkbox:checked');
            const paymentItems = $('.payment-checkbox:checked');
            let paymentTotal = 0;

            paymentItems.each(function() {
                paymentTotal += parseFloat($(this).data('amount'));
            });

            let summary = '';
            let details = '';
            let showActions = false;

            if (dispenseItems.length > 0) {
                summary += `Dispense ${dispenseItems.length} item(s)`;
                showActions = true;
            }

            if (paymentItems.length > 0) {
                if (summary) summary += ' and ';
                summary += `Pay for ${paymentItems.length} item(s)`;
                details = `Payment Total: ₦${paymentTotal.toLocaleString()}`;
                showActions = true;

                if (paymentTotal > walletBalance) {
                    const shortfall = paymentTotal - walletBalance;
                    details += ` <span class="badge bg-warning text-dark">Insufficient Funds (Short by ₦${shortfall.toLocaleString()})</span>`;
                    $('#process-action-btn').prop('disabled', true).html('<i class="fas fa-times"></i> Insufficient Funds');
                } else {
                    $('#process-action-btn').prop('disabled', false).html('<i class="fas fa-check"></i> Process Actions');
                }
            } else if (dispenseItems.length > 0) {
                 $('#process-action-btn').prop('disabled', false).html('<i class="fas fa-check"></i> Process Actions');
            }

            if (!showActions) {
                summary = 'No actions selected';
                $('#action-section').slideUp();
            } else {
                $('#action-summary').text(summary);
                $('#action-details').html(details);
                $('#action-section').slideDown();
            }
        }

        // Validate a single dispense selection (orderId). If $checkbox param passed use it,
        // otherwise find the checkbox in DOM. Returns true if OK, false if invalid.
        function validateDispenseSelection(orderId, $checkbox) {
            if (!$checkbox) $checkbox = $(`.dispense-checkbox[value="${orderId}"]`);
            const $qtyInput = $(`.dispense-qty[data-order-id="${orderId}"]`);
            if ($checkbox.length === 0 || $qtyInput.length === 0) return true;

            const storeQty = parseFloat($checkbox.data('store-qty')) || 0;
            let requestedQty = parseFloat($qtyInput.val()) || 0;

            // If requested qty is 0 or NaN, set to 1 minimal
            if (!requestedQty || requestedQty < 1) {
                requestedQty = 1;
                $qtyInput.val('1');
            }

            // If the requestedQty exceeds the remaining allowed (max attr), cap to max
            const maxAllowed = parseFloat($qtyInput.attr('max')) || requestedQty;
            if (requestedQty > maxAllowed) {
                // cap it
                requestedQty = maxAllowed;
                $qtyInput.val(maxAllowed);
            }

            // Now check against storeQty
            if (requestedQty > storeQty) {
                // show modal telling them to uncheck or stock
                const drugLabel = $checkbox.closest('.item-row').find('strong').first().text().trim();
                const message = `
                    <div>
                        <p><strong>${drugLabel}</strong> has insufficient stock.</p>
                        <p>Requested: <strong>${requestedQty}</strong> unit(s)</p>
                        <p>Available in store: <strong>${storeQty}</strong> unit(s)</p>
                        <hr>
                        <p>Please either:</p>
                        <ul style="text-align:left;">
                            <li>Uncheck this item to skip dispensing it now, or</li>
                            <li>Stock the drug in inventory and try again.</li>
                        </ul>
                    </div>
                `;
                showNotificationModal(message, "Insufficient Stock", true);

                // Uncheck the box to prevent processing
                $checkbox.prop('checked', false);
                // Optionally set the qty input to the available storeQty (but keep it editable)
                if (storeQty >= 1) $qtyInput.val(Math.min(maxAllowed, storeQty));
                _stockValidationErrors[orderId] = `Insufficient stock: requested ${requestedQty}, available ${storeQty}`;
                return false;
            } else {
                // no error
                if (_stockValidationErrors[orderId]) delete _stockValidationErrors[orderId];
                return true;
            }
        }

        // Validate all selected dispense items before processing; returns {ok: boolean, problems: []}
        function validateAllBeforeProcess() {
            const problems = [];
            $('.dispense-checkbox:checked').each(function() {
                const orderId = $(this).val();
                const ok = validateDispenseSelection(orderId, $(this));
                if (!ok) {
                    problems.push(orderId);
                }
            });
            return { ok: problems.length === 0, problems };
        }

        function processActions() {
            // final validation before sending
            const validation = validateAllBeforeProcess();
            if (!validation.ok) {
                showNotificationModal("One or more selected dispense items have insufficient stock. Please uncheck them or restock before proceeding.", "Cannot Process", true);
                return;
            }

            const dispenseItems = [];
            const paymentItems = [];

            $('.dispense-checkbox:checked').each(function() {
                const orderId = $(this).val();
                const quantity = $(`.dispense-qty[data-order-id="${orderId}"]`).val();
                dispenseItems.push({
                    order_id: orderId,
                    quantity: parseFloat(quantity)
                });
            });

            $('.payment-checkbox:checked').each(function() {
                paymentItems.push($(this).val());
            });

            if (dispenseItems.length === 0 && paymentItems.length === 0) {
                showNotificationModal('Please select at least one action to process.', "No Action Selected", true);
                return;
            }

            //showLoading();

            $.ajax({
                url: "{% url 'pharmacy_process_dispense' %}",
                method: 'POST',
                data: {
                    patient_id: patientData.id,
                    dispense_items: JSON.stringify(dispenseItems),
                    payment_items: JSON.stringify(paymentItems),
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    hideLoading();
                    if (response.success) {
                        showNotificationModal(response.message, "Actions Processed");
                        // Refresh the patient data to show updated lists
                        verifyPatient(patientData.card_number);
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    const response = xhr.responseJSON;
                    showNotificationModal(response.error || 'Error processing actions', "Processing Failed", true);
                }
            });
        }

        function resetToStart() {
            $('#patient-verification-form')[0].reset();
            $('.step').removeClass('active completed');
            $('#step-1').addClass('active');
            $('#dispensing-section').addClass('hidden');
            $('#patient-verification-section').removeClass('hidden');
            $('#action-section').hide();
            patientData = null;
            drugOrders = null;
        }

        // --- Modal & Loading Helper Functions ---
      function showLoading() {
        if (loadingModal) loadingModal.show();
    }

function hideLoading() {
    if (loadingModal) {
        loadingModal.hide();

        // Force clean-up in case Bootstrap backdrop hangs
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    }
}


        function showNotificationModal(message, title = 'Notification', isError = false) {
            const titleElement = document.getElementById('notificationModalTitle');
            document.getElementById('notificationModalBody').innerHTML = message;
            titleElement.textContent = title;
            if (isError) {
                titleElement.classList.remove('text-success');
                titleElement.classList.add('text-danger');
            } else {
                titleElement.classList.remove('text-danger');
                titleElement.classList.add('text-success');
            }
            notificationModal.show();
        }
    </script>
{% endblock %}
