{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="col-lg-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">ACTIONS:
        <span class="card-description">Hover an Icon to reveal its function</span>
      </h4>

      <!-- Edit Drug Formulation -->
      <a title="Edit Drug Formulation" href="{% url 'drug_formulation_edit' formulation.pk %}" class="btn btn-warning">
        <i class="bi bi-pencil-square"></i>
      </a>

      <!-- Delete Drug Formulation -->
      <a title="Delete Drug Formulation" href="{% url 'drug_formulation_delete' formulation.pk %}" class="btn btn-danger">
        <i class="bi bi-trash"></i>
      </a>

      <a onclick="window.history.back()" title="Go Back" style="float:right" class="btn btn-info text-white"><i class="bi bi-arrow-left"></i></a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body pt-3">
        <ul class="nav nav-tabs nav-tabs-bordered">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#formulation-details">Formulation Details</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#products">Products ({{ product_count }})</a></li>
        </ul>

        <div class="tab-content pt-2">
          <!-- Formulation Details Tab -->
          <div class="tab-pane fade show active profile-overview" id="formulation-details">
            <h5 class="card-title">Overview</h5>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Generic Drug</div>
              <div class="col-lg-8 col-md-8">
                {% if formulation.generic_drug %}
                    <a href="{% url 'generic_drug_detail' formulation.generic_drug.pk %}">
                        {{ formulation.generic_drug.generic_name|title }}
                    </a>
                {% else %}
                    ---
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Form Type</div>
              <div class="col-lg-8 col-md-8">{{ formulation.get_form_type_display }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Strength</div>
              <div class="col-lg-8 col-md-8">{{ formulation.strength }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Status</div>
              <div class="col-lg-8 col-md-8">
                {% if formulation.status == 'active' %}
                  <span class="badge bg-success">{{ formulation.status|upper }}</span>
                {% else %}
                  <span class="badge bg-danger">{{ formulation.status|upper }}</span>
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Created At</div>
              <div class="col-lg-8 col-md-8">{{ formulation.created_at|date:"F d, Y P" }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Last Updated</div>
              <div class="col-lg-8 col-md-8">{{ formulation.updated_at|date:"F d, Y P" }}</div>
            </div>
          </div>

          <!-- Products Tab -->
          <div class="tab-pane fade profile-overview" id="products">
            <h5 class="card-title">Drug Products with this Formulation</h5>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Brand Name</th>
                  <th>SKU</th>
                  <th>Manufacturer</th>
                  <th>Total Qty</th>
                  <th>Status</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{% if product.brand_name %}{{ product.brand_name|title }}{% else %}---{% endif %}</td>
                  <td>{{ product.sku|upper }}</td>
                  <td>{{ product.manufacturer.name|title }}</td>
                  <td>{{ product.total_quantity|floatformat:0|intcomma }}</td>
                  <td>
                    {% if product.is_active %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <a title="View Product" href="{% url 'drug_detail' product.id %}" class="btn btn-primary btn-sm"><i class="bi bi-eye"></i></a>
                    <a title="Edit Product" href="{% url 'drug_edit' product.id %}" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square"></i></a>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center">No active drug products found for this formulation.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div><!-- End Tab Content -->

      </div>
    </div>
  </div>
</div>
{% endblock %}
