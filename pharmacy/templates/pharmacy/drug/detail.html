{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="col-lg-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">ACTIONS:
        <span class="card-description">Hover an Icon to reveal its function</span>
      </h4>

      <!-- Edit Drug Product -->
      <a title="Edit Drug Product" href="{% url 'drug_edit' drug.pk %}" class="btn btn-warning">
        <i class="bi bi-pencil-square"></i>
      </a>

      <!-- Delete Drug Product -->
      <a title="Delete Drug Product" href="{% url 'drug_delete' drug.pk %}" class="btn btn-danger">
        <i class="bi bi-trash"></i>
      </a>
        <button type="button" class="btn btn-info"
            data-bs-toggle="modal" data-bs-target="#stockOutModal{{ stock.pk }}"
            title="Stock Out"><i class="bi bi-box-arrow-up"></i></button>

      <a onclick="window.history.back()" title="Go Back" style="float:right" class="btn btn-info text-white"><i class="bi bi-arrow-left"></i></a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body pt-3">
        <ul class="nav nav-tabs nav-tabs-bordered">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#drug-details">Drug Details</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-levels">Stock Levels & Alerts</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-movements">Stock Movements</a></li>
        </ul>

        <div class="tab-content pt-2">
          <!-- Drug Details Tab -->
          <div class="tab-pane fade show active profile-overview" id="drug-details">
            <h5 class="card-title">Product Information</h5>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Generic Name</div>
              <div class="col-lg-8 col-md-8">
                {% if drug.formulation.generic_drug %}
                    <a href="{% url 'generic_drug_detail' drug.formulation.generic_drug.pk %}">
                        {{ drug.formulation.generic_drug.generic_name|title }}
                    </a>
                {% else %}
                    ---
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Formulation</div>
              <div class="col-lg-8 col-md-8">
                {% if drug.formulation %}
                    <a href="{% url 'drug_formulation_detail' drug.formulation.pk %}">
                        {{ drug.formulation.strength }} {{ drug.formulation.get_form_type_display }}
                    </a>
                {% else %}
                    ---
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Brand Name</div>
              <div class="col-lg-8 col-md-8">{% if drug.brand_name %}{{ drug.brand_name|title }}{% else %}---{% endif %}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">SKU</div>
              <div class="col-lg-8 col-md-8">{{ drug.sku|upper }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Manufacturer</div>
              <div class="col-lg-8 col-md-8">
                {% if drug.manufacturer %}
                    <a href="{% url 'manufacturer_index' %}?search_term={{ drug.manufacturer.name }}">
                        {{ drug.manufacturer.name|title }}
                    </a>
                {% else %}
                    ---
                {% endif %}
              </div>
            </div>

              <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Selling Price</div>
              <div class="col-lg-8 col-md-8">
                  ₦{{ drug.selling_price|floatformat:2|intcomma }}
              </div>
            </div>

              <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Pack Size</div>
              <div class="col-lg-8 col-md-8">
                {{ drug.pack_size }}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Is Active</div>
              <div class="col-lg-8 col-md-8">
                {% if drug.is_active %}
                  <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Yes</span>
                {% else %}
                  <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i> No</span>
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Created At</div>
              <div class="col-lg-8 col-md-8">{{ drug.created_at|date:"F d, Y P" }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Last Updated</div>
              <div class="col-lg-8 col-md-8">{{ drug.updated_at|date:"F d, Y P" }}</div>
            </div>
          </div>

          <!-- Stock Levels Tab -->
          <div class="tab-pane fade profile-overview" id="stock-levels">
            <h5 class="card-title">Current Stock & Minimum Levels</h5>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Quantity in Store</div>
              <div class="col-lg-8 col-md-8">{{ drug.store_quantity|floatformat:0|intcomma }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Quantity in Pharmacy</div>
              <div class="col-lg-8 col-md-8">{{ drug.pharmacy_quantity|floatformat:0|intcomma }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Total Quantity</div>
              <div class="col-lg-8 col-md-8">
                {% if drug.is_low_stock %}
                    <span class="badge bg-warning">Low Stock: {{ drug.total_quantity|floatformat:0|intcomma }}</span>
                {% else %}
                    {{ drug.total_quantity|floatformat:0|intcomma }}
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Minimum Stock Level</div>
              <div class="col-lg-8 col-md-8">{{ drug.minimum_stock_level|intcomma }}</div>
            </div>

            <hr class="my-3">


          </div>

          <!-- Stock Movements Tab -->
          <div class="tab-pane fade profile-overview" id="stock-movements">
            <h5 class="card-title">Stock Entries (Purchases)</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Batch</th>
                            <th>Qty Bought</th>
                            <th>Qty Left</th>
                            <th>Cost Price</th>
                            <th>Selling Price</th>
                            <th>Expiry Date</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Date Added</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in stock_entries %}
                        <tr>
                            <td>{% if entry.batch %}{{ entry.batch.name|upper }}{% else %}N/A{% endif %}</td>
                            <td>{{ entry.quantity_bought|floatformat:0|intcomma }}</td>
                            <td>{{ entry.quantity_left|floatformat:0|intcomma }}</td>
                            <td>₦{{ entry.unit_cost_price|floatformat:2|intcomma }}</td>
                            <td>₦{{ entry.selling_price|floatformat:2|intcomma }}</td>
                            <td>{% if entry.expiry_date %}{{ entry.expiry_date|date:"M d, Y" }}{% else %}N/A{% endif %}</td>
                            <td>{{ entry.get_location_display }}</td>
                            <td>
                                {% if entry.status == 'active' %}
                                    <span class="badge bg-success">Active</span>
                                {% elif entry.status == 'expired' %}
                                    <span class="badge bg-danger">Expired</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ entry.status|title }}</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.date_added|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="9" class="text-center">No stock entries found for this drug.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h5 class="card-title mt-4">Recent Stock Outs</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Quantity</th>
                            <th>Reason</th>
                            <th>Worth</th>
                            <th>Date</th>
                            <th>By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for so in stock_outs %}
                        <tr>
                            <td>{{ so.quantity|floatformat:0|intcomma }}</td>
                            <td>{{ so.get_reason_display }}</td>
                            <td>₦{{ so.worth|floatformat:2|intcomma }}</td>
                            <td>{{ so.created_at|date:"M d, Y H:i" }}</td>
                            <td>{% if so.created_by %}{{ so.created_by.get_full_name|default:so.created_by.username|title }}{% else %}N/A{% endif %}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center">No recent stock outs found for this drug.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h5 class="card-title mt-4">Recent Transfers (Store <i class="bi bi-arrow-right"></i> Pharmacy)</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Quantity</th>
                            <th>Date</th>
                            <th>By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transfer in transfers %}
                        <tr>
                            <td>{{ transfer.quantity|floatformat:0|intcomma }}</td>
                            <td>{{ transfer.transferred_at|date:"M d, Y H:i" }}</td>
                            <td>{% if transfer.transferred_by %}{{ transfer.transferred_by.get_full_name|default:transfer.transferred_by.username|title }}{% else %}N/A{% endif %}</td>
                            <td>{% if transfer.notes %}{{ transfer.notes }}{% else %}---{% endif %}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">No recent transfers found for this drug.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
          </div>

        </div><!-- End Tab Content -->

      </div>
    </div>
  </div>
</div>

{# Stock Out Modal for each stock item #}
    <div class="modal fade" id="stockOutModal{{ stock.pk }}" tabindex="-1" aria-labelledby="stockOutModalLabel{{ stock.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="post" class="p-3" action="{% url 'drug_stock_out' drug.pk %}">
                    <h4 class="card-title">Stock Out {{ drug|title }}</h4>

                    {% csrf_token %}

                    <div class="form-group mb-3">
                        <label for="location">Stock Out From:</label>
                        <select name="location" id="location" class="form-control" required>
                            <option value="store">Store/Warehouse ({{ drug.store_quantity }} available)</option>
                            <option value="pharmacy">Pharmacy Counter ({{ drug.pharmacy_quantity }} available)</option>
                        </select>

                    </div>


                    <div class="form-group mb-3">
                        <label for="quantity_to_reduce">Quantity to Reduce:</label>
                        <input type="number" name="quantity_to_reduce" id="quantity_to_reduce"
                               class="form-control" step="0.01" min="0.01" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="reason">Reason:</label>
                        <select name="reason" required id="reason" class="form-control">
                            <option value=""></option>
                            <option value="expired">Expired</option>
                            <option value="damaged">Damaged/Spoilt</option>
                            <option value="return">Return to Supplier</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="remark">Remark (Optional):</label>
                        <textarea name="remark" id="remark" class="form-control" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Reduce Stock</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
