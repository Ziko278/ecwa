{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Edit Drug Product: {{ drug.brand_name|default:drug.formulation.generic_drug.generic_name|title }}</h4>
            <p class="card-description">
                Use the form below to update the drug product details.
            </p>
            {% include 'admin_site/partials/error.html' %}

            <form class="forms-sample" method="post" action="{% url 'drug_edit' drug.pk %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="formulation-search-input">Search Drug Formulation<span style="color:red"><b>*</b></span></label>
                            <input type="text" id="formulation-search-input" class="form-control" placeholder="Type to search formulations..." autocomplete="off">
                            <small class="text-muted">Search by generic name, form type, or strength.</small>
                        </div>
                        <div class="form-group mb-3">
                            <label for="id_formulation" class="d-block">Select Formulation<span style="color:red"><b>*</b></span></label>
                            <select name="formulation" id="id_formulation" class="form-control" required>
                                <option value="">--- Select a drug formulation ---</option>
                                {% for formulation in formulation_list %}
                                <option
                                    value="{{ formulation.pk }}"
                                    data-generic-name="{{ formulation.generic_drug.generic_name|lower }}"
                                    data-form-type="{{ formulation.form_type|lower }}"
                                    data-strength="{{ formulation.strength|lower }}"
                                >
                                    {{ formulation.generic_drug.generic_name|title }} {{ formulation.strength }} {{ formulation.get_form_type_display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="manufacturer-search-input">Search Manufacturer<span style="color:red"><b>*</b></span></label>
                            <input type="text" id="manufacturer-search-input" class="form-control" placeholder="Type to search manufacturers..." autocomplete="off">
                            <small class="text-muted">Search by manufacturer name or country.</small>
                        </div>
                        <div class="form-group mb-3">
                            <label for="id_manufacturer" class="d-block">Select Manufacturer<span style="color:red"><b>*</b></span></label>
                            <select name="manufacturer" id="id_manufacturer" class="form-control">
                                <option value="">--- Select a manufacturer ---</option>
                                {% for manufacturer in manufacturer_list %}
                                <option
                                    value="{{ manufacturer.pk }}"
                                    data-name="{{ manufacturer.name|lower }}"
                                    data-country="{{ manufacturer.country|lower|default:'' }}"
                                >
                                    {{ manufacturer.name|title }} {% if manufacturer.country %}({{ manufacturer.country|title }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.brand_name }}
                            <label for="id_brand_name">Brand Name</label>
                            <small class="text-muted">Optional commercial name for the drug.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.sku }}
                            <label for="id_sku">SKU (Stock Keeping Unit)<span style="color:red"><b>*</b></span></label>
                        </div>
                    </div>
                </div>

                <!-- Removed store_quantity and pharmacy_quantity from here -->

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.selling_price }}
                            <label for="id_minimum_stock_level">Selling Price</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.minimum_stock_level }}
                            <label for="id_minimum_stock_level">Minimum Stock Level</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            {{ form.pack_size }}
                            <label for="id_pack_size">Pack Size</label>
                        </div>
                    </div>
                    <div class="col-md-6 mt-3">
                        <div class="form-check form-switch mb-3">
                            {{ form.is_active }}
                            <label class="form-check-label" for="id_is_active">Is Active</label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary me-2">Save Changes</button>
                    <a href="{% url 'drug_detail' drug.pk %}" class="btn btn-light">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Formulation Search ---
    const formulationSearchInput = document.getElementById('formulation-search-input');
    const formulationSelectElement = document.getElementById('id_formulation');
    const allFormulationOptions = Array.from(formulationSelectElement.options); // Keep a copy of all options

    // Get current drug's formulation PK for pre-selection
    const currentFormulationPk = "{{ drug.formulation.pk|default:'' }}";

    function renderFormulationOptions(filteredOptions, selectedPk = null) {
        formulationSelectElement.innerHTML = ''; // Clear existing options

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- Select a drug formulation ---';
        formulationSelectElement.appendChild(defaultOption);

        if (filteredOptions.length === 0) {
            const noResultsOption = document.createElement('option');
            noResultsOption.value = '';
            noResultsOption.textContent = 'No formulations found';
            noResultsOption.disabled = true;
            formulationSelectElement.appendChild(noResultsOption);
            return;
        }
        
        filteredOptions.forEach(option => {
            const clonedOption = option.cloneNode(true);
            if (selectedPk && String(option.value) === String(selectedPk)) {
                clonedOption.selected = true;
            }
            formulationSelectElement.appendChild(clonedOption);
        });
    }

    // Initial render for formulations
    renderFormulationOptions(allFormulationOptions.slice(1), currentFormulationPk); // Exclude the first (placeholder) option from allFormulationOptions

    formulationSearchInput.addEventListener('input', function (event) {
        const searchText = event.target.value.toLowerCase();
        
        const filteredFormulations = allFormulationOptions.slice(1).filter(option => { // Exclude placeholder from filtering
            const genericName = option.dataset.genericName;
            const formType = option.dataset.formType;
            const strength = option.dataset.strength;
            
            return genericName.includes(searchText) || formType.includes(searchText) || strength.includes(searchText);
        });
        
        renderFormulationOptions(filteredFormulations, currentFormulationPk);
    });

    // --- Manufacturer Search ---
    const manufacturerSearchInput = document.getElementById('manufacturer-search-input');
    const manufacturerSelectElement = document.getElementById('id_manufacturer');
    const allManufacturerOptions = Array.from(manufacturerSelectElement.options); // Keep a copy of all options

    // Get current drug's manufacturer PK for pre-selection
    const currentManufacturerPk = "{{ drug.manufacturer.pk|default:'' }}";

    function renderManufacturerOptions(filteredOptions, selectedPk = null) {
        manufacturerSelectElement.innerHTML = ''; // Clear existing options

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- Select a manufacturer ---';
        manufacturerSelectElement.appendChild(defaultOption);

        if (filteredOptions.length === 0) {
            const noResultsOption = document.createElement('option');
            noResultsOption.value = '';
            noResultsOption.textContent = 'No manufacturers found';
            noResultsOption.disabled = true;
            manufacturerSelectElement.appendChild(noResultsOption);
            return;
        }

        filteredOptions.forEach(option => {
            const clonedOption = option.cloneNode(true);
            if (selectedPk && String(option.value) === String(selectedPk)) {
                clonedOption.selected = true;
            }
            manufacturerSelectElement.appendChild(clonedOption);
        });
    }

    // Initial render for manufacturers
    renderManufacturerOptions(allManufacturerOptions.slice(1), currentManufacturerPk); // Exclude the first (placeholder) option from allManufacturerOptions

    manufacturerSearchInput.addEventListener('input', function (event) {
        const searchText = event.target.value.toLowerCase();
        
        const filteredManufacturers = allManufacturerOptions.slice(1).filter(option => { // Exclude placeholder from filtering
            const name = option.dataset.name;
            const country = option.dataset.country;
            
            return name.includes(searchText) || country.includes(searchText);
        });
        
        renderManufacturerOptions(filteredManufacturers, currentManufacturerPk);
    });
});
</script>

{% endblock %}
