{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<style>
    .report-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 24px;
        margin-bottom: 20px;
    }
    .report-header {
        border-bottom: 2px solid #4472C4;
        padding-bottom: 16px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .controls-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        gap: 12px;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary { background: #4472C4; color: white; }
    .btn-success { background: #28a745; color: white; }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
    }
    .data-table th {
        background: #4472C4;
        color: white;
        padding: 12px;
        text-align: left;
    }
    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }
    .data-table tbody tr:hover {
        background: #f8f9fa;
    }
</style>

<div class="report-container">
    <div class="report-header">
        <div>
            <h2>Bio Data Report</h2>
            <p style="color: #666; margin: 0;">Patient demographic information</p>
        </div>
        <a href="{% url 'reports_hub' %}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Back to Reports
        </a>
    </div>

    <div class="controls-bar">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-funnel"></i> Filters
        </button>
        <button type="button" class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel"></i> Export to Excel
        </button>
    </div>

    <p><strong>Total Patients:</strong> {{ total_count }}</p>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Card Number</th>
                    <th>Full Name</th>
                    <th>Phone</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>Address</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td>{{ patient.card_number }}</td>
                    <td>{{ patient }}</td>
                    <td>{{ patient.mobile|default:"-" }}</td>
                    <td>{{ patient.get_gender_display }}</td>
                    <td>{{ patient.age|default:"-" }}</td>
                    <td>{{ patient.address|default:"-"|truncatechars:40 }}</td>
                    <td>
                        <a href="{% url 'patient_detail' patient.id %}" class="btn btn-sm btn-primary">View</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">No patients found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Previous</a>
            </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get" id="filterForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name_search.label_tag }}
                            {{ form.name_search }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.gender.label_tag }}
                            {{ form.gender }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.state.label_tag }}
                            {{ form.state }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.lga.label_tag }}
                            {{ form.lga }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.age_min.label_tag }}
                            {{ form.age_min }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.age_max.label_tag }}
                            {{ form.age_max }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.address_search.label_tag }}
                            {{ form.address_search }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.marital_status.label_tag }}
                            {{ form.marital_status }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.religion.label_tag }}
                            {{ form.religion }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.per_page.label_tag }}
                            {{ form.per_page }}
                        </div>
                    </div>

                    <hr>
                    <h6>Export Fields</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="full_name" checked>
                                <label class="form-check-label">Full Name</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="card_number" checked>
                                <label class="form-check-label">Card Number</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="mobile" checked>
                                <label class="form-check-label">Phone</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="email">
                                <label class="form-check-label">Email</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="address" checked>
                                <label class="form-check-label">Address</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="gender">
                                <label class="form-check-label">Gender</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="age">
                                <label class="form-check-label">Age</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="marital_status">
                                <label class="form-check-label">Marital Status</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="religion">
                                <label class="form-check-label">Religion</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="state">
                                <label class="form-check-label">State</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="export_fields" value="lga">
                                <label class="form-check-label">LGA</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function exportToExcel() {
    const form = document.getElementById('filterForm');
    const url = new URL('{% url "biodata_report_export" %}', window.location.origin);
    const formData = new FormData(form);

    formData.forEach((value, key) => {
        url.searchParams.append(key, value);
    });

    window.location.href = url.toString();
}
</script>
{% endblock %}