{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}
{% block 'main' %}

<div class="col-12">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="card-title mb-0">Edit Quotation</h4>
                    <small class="text-muted">Number: {{ form.instance.quotation_number }}</small>
                </div>
                <a href="{% url 'quotation_detail' form.instance.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Detail View
                </a>
            </div>

            {% include 'admin_site/partials/error.html' %}

            <div class="row">
                <!-- Left Column: Quotation Form -->
                <div class="col-md-5">
                    <form method="POST" action="">
                        {% csrf_token %}
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Quotation Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.title.id_for_label }}" class="form-label">Title <span class="text-danger">*</span></label>
                                        {{ form.title }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.department.id_for_label }}" class="form-label">Department <span class="text-danger">*</span></label>
                                        {{ form.department }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                                        {{ form.category }}
                                    </div>
                                    <div class="col-md-12">
                                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                        {{ form.description }}
                                    </div>
                                    {{ form.requested_by }} {# Hidden field #}
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="submit" name="save_and_continue" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Right Column: Quotation Items -->
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Quotation Items</h5>
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                <i class="bi bi-plus-circle"></i> Add Item
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Qty</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-table-body">
                                        <!-- Items will be loaded here by JavaScript -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="3" class="text-end">Grand Total:</th>
                                            <th id="grand-total" colspan="2">₦0.00</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-item-form">
                    <div class="mb-3">
                        <label for="add-description" class="form-label">Description <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="add-description" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add-quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="add-quantity" value="1" min="1" step="any" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add-unit-price" class="form-label">Unit Price (₦) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="add-unit-price" min="0" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-item-btn">Save Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-item-form">
                    <input type="hidden" id="edit-item-id">
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-description" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="edit-quantity" min="1" step="any" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-unit-price" class="form-label">Unit Price (₦) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="edit-unit-price" min="0" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="update-item-btn">Update Item</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quotationId = {{ form.instance.pk }};
    const itemsTableBody = document.getElementById('items-table-body');
    const grandTotalEl = document.getElementById('grand-total');
    const csrfToken = '{{ csrf_token }}';

    const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));
    const editItemModal = new bootstrap.Modal(document.getElementById('editItemModal'));

    // --- UTILITY FUNCTIONS ---
    function formatCurrency(num) {
        return '₦' + parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- API CALLS ---
    async function fetchItems() {
        try {
            const response = await fetch(`{% url 'quotation_items_get_ajax' 0 %}`.replace('0', quotationId));
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            renderItems(data.items);
        } catch (error) {
            console.error('Error fetching items:', error);
            itemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Could not load items.</td></tr>';
        }
    }

    async function saveItem() {
        const description = document.getElementById('add-description').value;
        const quantity = document.getElementById('add-quantity').value;
        const unit_price = document.getElementById('add-unit-price').value;

        if (!description || !quantity || !unit_price) {
            alert('Please fill all required fields.');
            return;
        }

        const formData = new FormData();
        formData.append('description', description);
        formData.append('quantity', quantity);
        formData.append('unit_price', unit_price);

        try {
            const response = await fetch(`{% url 'quotation_item_create_ajax' 0 %}`.replace('0', quotationId), {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                fetchItems();
                addItemModal.hide();
                document.getElementById('add-item-form').reset();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        } catch (error) {
            console.error('Error saving item:', error);
            alert('An error occurred while saving the item.');
        }
    }

    async function updateItem() {
        const itemId = document.getElementById('edit-item-id').value;
        const description = document.getElementById('edit-description').value;
        const quantity = document.getElementById('edit-quantity').value;
        const unit_price = document.getElementById('edit-unit-price').value;

        if (!description || !quantity || !unit_price) {
            alert('Please fill all required fields.');
            return;
        }

        const formData = new FormData();
        formData.append('description', description);
        formData.append('quantity', quantity);
        formData.append('unit_price', unit_price);

        try {
            const response = await fetch(`{% url 'quotation_item_update_ajax' 0 %}`.replace('0', itemId), {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                fetchItems();
                editItemModal.hide();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        } catch (error) {
            console.error('Error updating item:', error);
            alert('An error occurred while updating the item.');
        }
    }
    
    async function deleteItem(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        try {
            const response = await fetch(`{% url 'quotation_item_delete_ajax' 0 %}`.replace('0', itemId), {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            });
            const data = await response.json();
            if (data.success) {
                fetchItems();
            } else {
                alert('Error deleting item.');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('An error occurred while deleting the item.');
        }
    }

    // --- RENDERING ---
    function renderItems(items) {
        itemsTableBody.innerHTML = '';
        let grandTotal = 0;

        if (items.length === 0) {
            itemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No items have been added to this quotation yet.</td></tr>';
        } else {
            items.forEach(item => {
                const row = document.createElement('tr');
                grandTotal += parseFloat(item.total_price);
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unit_price)}</td>
                    <td>${formatCurrency(item.total_price)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${item.id}" data-description="${item.description}" data-quantity="${item.quantity}" data-price="${item.unit_price}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                itemsTableBody.appendChild(row);
            });
        }
        grandTotalEl.textContent = formatCurrency(grandTotal);
    }

    // --- EVENT LISTENERS ---
    document.getElementById('save-item-btn').addEventListener('click', saveItem);
    document.getElementById('update-item-btn').addEventListener('click', updateItem);

    itemsTableBody.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');

        if (editBtn) {
            document.getElementById('edit-item-id').value = editBtn.dataset.id;
            document.getElementById('edit-description').value = editBtn.dataset.description;
            document.getElementById('edit-quantity').value = editBtn.dataset.quantity;
            document.getElementById('edit-unit-price').value = editBtn.dataset.price;
            editItemModal.show();
        }

        if (deleteBtn) {
            deleteItem(deleteBtn.dataset.id);
        }
    });

    // --- INITIAL LOAD ---
    fetchItems();
});
</script>

{% endblock %}

