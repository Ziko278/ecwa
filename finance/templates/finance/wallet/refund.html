{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}
{% block 'main' %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h4><i class="fas fa-undo"></i> Refund Paid Items for {{ patient }}
                 <a onclick="window.history.back()" style="float:right" class="btn btn-danger btn-sm">Back</a>
</h4>
        </div>
        <div class="card-body">
            <div id="feedback-area" class="mb-3"></div>

            <form id="refund-form" method="POST">
                {% csrf_token %}

                {% if items %}
                <p class="text-muted">Select items that were paid for but not consumed or completed. Estimated refund will be calculated on submission.</p>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="refundTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all" checked></th>
                                <th>Type</th>
                                <th>Item/Service Name</th>
                                <th>Current Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_items[]" value="{{ item.ref }}" class="item-checkbox" checked>
                                </td>
                                <td>{{ item.type }}</td>
                                <td>{{ item.name }}</td>
                                <td><span class="badge bg-warning">{{ item.status }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-info btn-lg" id="btn-submit">
                        <i class="fas fa-money-check-alt"></i> Process Refund to Wallet
                    </button>
                </div>
                {% else %}
                <div class="alert alert-success">
                    No items found that are currently paid but eligible for a refund.
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const $form = $('#refund-form');
    const $btn = $('#btn-submit');
    const $feedbackArea = $('#feedback-area');
    const originalText = $btn.html();

    $('#select-all').on('change', function() {
        $('.item-checkbox').prop('checked', $(this).is(':checked'));
    });

    // --- CORRECTED AJAX SUBMISSION HANDLER ---
    $form.on('submit', function(e) {

        // CRITICAL: Stop the default browser form submission
        e.preventDefault();

        if ($('.item-checkbox:checked').length === 0) {
            $feedbackArea.html('<div class="alert alert-warning">Please select at least one item to refund.</div>');
            return;
        }

        $feedbackArea.empty();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: $form.serialize(),
            success: function(response) {
                // 1. Display non-blocking success message
                $feedbackArea.html(`
                    <div class="alert alert-success">
                        <strong>Success!</strong> ${response.message}
                        <br>New Balance: â‚¦${response.new_balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                `);

                // 2. Force client-side redirection
                if (response.redirect_url) {
                    setTimeout(() => {
                        window.location.href = response.redirect_url;
                    }, 1500); // 1.5 seconds delay
                }
                // Do not re-enable button as page will redirect
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                let errorMsg = response ? response.error : 'An unknown error occurred.';

                $feedbackArea.html(`<div class="alert alert-danger">Refund Failed: ${errorMsg}</div>`);
                $btn.html(originalText).prop('disabled', false);
            }
        });
    });
    // --- END CORRECTED HANDLER ---
});
</script>
{% endblock %}