{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}

{% block 'main' %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-danger text-white">
            <h4><i class="fas fa-sign-out-alt"></i> Wallet Withdrawal for {{ patient }}
             <a onclick="window.history.back()" style="float:right" class="btn btn-danger btn-sm">Back</a> </h4>
        </div>
        <div class="card-body">
            <div id="feedback-area" class="mb-3"></div>

            <div class="alert alert-info">
                <strong>Current Wallet Balance:</strong> 
                <span class="h4">₦{{ wallet_balance|floatformat:2|intcomma }}</span>
            </div>

            <form id="withdrawal-form" method="POST">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="amount" class="form-label">Amount to Withdraw (₦)</label>
                    <input type="number" step="0.01" min="0.01" max="{{ wallet_balance }}" 
                           class="form-control form-control-lg" id="amount" name="amount" required>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" id="notes" name="notes"></textarea>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-danger btn-lg" id="btn-submit">
                        <i class="fas fa-money-bill-alt"></i> Process Withdrawal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

// In finance/wallet/withdrawal.html
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#withdrawal-form').on('submit', function(e) {
        e.preventDefault();
        const $form = $(this);
        const $btn = $('#btn-submit');
        const originalText = $btn.html();
        const $feedbackArea = $('#feedback-area'); // Target the feedback area

        $feedbackArea.empty();

        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: $form.serialize(),
            success: function(response) {
                // *** CORRECTED SUCCESS HANDLING ***

                // 1. Display success message in the HTML feedback area
                $feedbackArea.html(`
                    <div class="alert alert-success">
                        <strong>Success!</strong> ${response.message}
                        <br>New Balance: ₦${response.new_balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                `);

                // 2. Schedule the redirect after a short delay (e.g., 1.5 seconds)
                if (response.redirect_url) {
                    setTimeout(() => {
                        window.location.href = response.redirect_url;
                    }, 1500);
                } else {
                    // Fallback to reload if redirect URL is somehow missing
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
                // Do not re-enable the button or change text here, as the page is redirecting.
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                let errorMsg = response ? response.error : 'An unknown error occurred.';

                if (response && response.formatted_shortfall) {
                    errorMsg = `Withdrawal Failed: Insufficient balance. Shortfall: ${response.formatted_shortfall}.`;
                }

                $feedbackArea.html(`<div class="alert alert-danger">${errorMsg}</div>`);

                // Re-enable button on error
                $btn.html(originalText).prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}