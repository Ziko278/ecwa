{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}

{% block 'main' %}
<style>
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .patient-info-card {
            border-left: 4px solid #28a745;
        }
        .wallet-balance {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        .pending-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #dc3545;
        }
        .service-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .service-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .service-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-row {
            padding: 8px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .amount-display {
            font-weight: bold;
            color: #495057;
        }
        .insurance-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
        }
        .total-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            position: relative;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background: #dee2e6;
            transform: translateY(-50%);
        }
        .step:last-child::after {
            display: none;
        }

        /* --- Styles for the new Success Modal --- */
        #success-modal .modal-header {
            background-color: #28a745;
            color: white;
            border-bottom: none;
        }
        #success-modal .modal-title {
            font-weight: bold;
        }
        #success-modal .success-icon {
            font-size: 3rem;
            color: #28a745;
        }
        #success-modal .modal-footer {
            border-top: none;
        }
    .pending-claim-warning {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 10px 15px;
    margin-bottom: 15px;
    border-radius: 4px;
}

.claim-badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 12px;
    margin-left: 5px;
}

.claim-approved {
    background-color: #d4edda;
    color: #155724;
}

.claim-pending {
    background-color: #fff3cd;
    color: #856404;
}
    </style>

<style>
    /* Keep all existing styles from your original template */
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .patient-info-card {
        border-left: 4px solid #28a745;
    }
    .wallet-balance {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
    }
    /* ... all other existing styles ... */

    /* NEW: Payment breakdown styles */
    .payment-breakdown-card {
        border: 2px solid #17a2b8;
        border-radius: 8px;
        background: #f8f9fa;
    }
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
    }
    .breakdown-row:last-child {
        border-bottom: none;
        background: #e9ecef;
        font-weight: bold;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-money-bill-wave"></i> Make Payment
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1">1</div>
        <div class="step" id="step-2">2</div>
        <div class="step" id="step-3">3</div>
    </div>

    <!-- Step 1: Patient Verification -->
    <div id="patient-verification-section">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> Verify Patient</h5>
                    </div>
                    <div class="card-body">
                        <form id="patient-verification-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="card_number" class="form-label">Patient Card Number</label>
                                <input type="text" class="form-control form-control-lg"
                                       id="card_number" name="card_number"
                                       placeholder="Enter patient card number" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-search"></i> Verify Patient
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Patient Details & Pending Payments -->
    <div id="patient-details-section" class="hidden">
        <div class="row">
            <!-- Patient Info -->
            <div class="col-md-4">
                <div class="card patient-info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Patient Information</h5>
                    </div>
                    <div class="card-body" id="patient-info">
                        <!-- Patient details will be loaded here -->
                    </div>
                </div>

                <!-- Wallet Balance -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-wallet"></i> Current Wallet Balance</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="wallet-balance" id="wallet-balance">₦0.00</div>
                        <small class="text-muted">Available for use</small>
                    </div>
                </div>
            </div>

            <!-- Pending Payments -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list"></i> Pending Payments (Last 30 Days)</h5>
                        <small class="text-light">Select items to pay for</small>
                    </div>
                    <div class="card-body" id="pending-payments-section">
                        <!-- Pending payments will be loaded here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3 d-flex justify-content-between">
<!--                    <button class="btn btn-outline-primary" onclick="goToWalletFunding()">-->
<!--                        <i class="fas fa-wallet"></i> Fund Wallet Only-->
<!--                    </button>-->
                    <button class="btn btn-success btn-lg" onclick="proceedToPayment()">
                        <i class="fas fa-arrow-right"></i> Proceed to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Direct Payment -->
    <div id="payment-section" class="hidden">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card"></i> Payment Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="payment-form">
                            {% csrf_token %}
                            <input type="hidden" id="patient_id" name="patient_id">
                            <input type="hidden" id="selected_items_data" name="selected_items_data">

                            <!-- Payment Breakdown -->
                            <div class="payment-breakdown-card mb-4">
                                <div class="p-3 bg-info text-white">
                                    <h6 class="mb-0">Payment Summary</h6>
                                </div>
                                <div class="breakdown-row">
                                    <span>Total Amount Due:</span>
                                    <strong id="total-amount-display">₦0.00</strong>
                                </div>
                                <div class="breakdown-row" id="wallet-usage-row">
                                    <span>
                                        <input type="checkbox" id="use_wallet" name="use_wallet" checked>
                                        <label for="use_wallet" class="ms-2">Use Wallet Balance</label>
                                    </span>
                                    <strong class="text-success" id="wallet-amount-display">- ₦0.00</strong>
                                </div>
                                <div class="breakdown-row">
                                    <span>Amount to Pay Now:</span>
                                    <strong class="text-primary" id="remaining-amount-display">₦0.00</strong>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-4">
                                <label for="payment_method" class="form-label">Payment Method</label>
                                <select class="form-control form-control-lg" id="payment_method" name="payment_method" required>
                                    <option value="cash">CASH</option>
                                    <option value="transfer">BANK TRANSFER</option>
                                    <option value="card">CARD (POS)</option>
                                </select>
                            </div>

                            <!-- Amount Confirmation -->
                            <div class="mb-4">
                                <label for="direct_amount" class="form-label">Amount to Pay (₦)</label>
                                <input type="number" class="form-control form-control-lg"
                                       id="direct_amount" name="direct_amount"
                                       step="0.01" readonly required>
                                <small class="text-muted">This amount will be paid via <span id="method-text">CASH</span></small>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="goBackToDetails()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="submit" class="btn btn-success btn-lg" id="submit-payment">
                                    <i class="fas fa-check-circle"></i> Complete Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="success-modal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel"><i class="fas fa-check-circle"></i> Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="success-icon mb-3">
                    <i class="fas fa-check-circle"></i>
                </div>
                <p class="lead" id="success-message-text"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" id="modal-ok-button">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let patientData = null;
    let pendingPayments = null;
    let selectedItems = {
        drugs: [],
        labs: [],
        scans: [],
        services: []
    };
    let walletBalance = 0;

    const processPaymentUrl = "{% url 'process_direct_payment' %}";

    $(document).ready(function() {
        // Auto-open logic if patient is provided
        {% if patient %}
        const AUTO_PATIENT_ID = "{{ patient.id }}";
        walletBalance = {{ patient.wallet.amount|default:0 }};
        populatePatientFromServer();
        $('#step-1').removeClass('active').addClass('completed');
        $('#step-2').addClass('active');
        $('#patient-verification-section').addClass('hidden');
        $('#patient-details-section').removeClass('hidden');
        {% endif %}

        // Patient verification form
        $('#patient-verification-form').on('submit', function(e) {
            e.preventDefault();
            const cardNumber = $('#card_number').val().trim();
            if (!cardNumber) {
                alert('Please enter a card number');
                return;
            }
            verifyPatient(cardNumber);
        });

        // Payment form
        $('#payment-form').on('submit', function(e) {
            e.preventDefault();
            processPayment();
        });

        // Wallet checkbox change
        $('#use_wallet').on('change', function() {
            updatePaymentBreakdown();
        });

        // Payment method change
        $('#payment_method').on('change', function() {
            $('#method-text').text($(this).find('option:selected').text());
        });
    });

    function formatCurrency(amount) {
        if (typeof amount === 'number') {
            return '₦' + amount.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return '₦0.00';
    }

    function verifyPatient(cardNumber) {
        $('#patient-verification-form button').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm"></span> Verifying...');

        $.ajax({
            url: "{% url 'finance_verify_patient_ajax' %}",
            method: 'GET',
            data: { card_number: cardNumber },
            success: function(response) {
                $('#patient-verification-form button').prop('disabled', false)
                    .html('<i class="fas fa-search"></i> Verify Patient');

                if (response.success) {
                    patientData = response.patient;
                    pendingPayments = response.pending_payments;
                    walletBalance = response.wallet.balance;

                    displayPatientInfo(response);
                    displayPendingPayments(response.pending_payments);

                    // Move to step 2
                    $('#step-1').removeClass('active').addClass('completed');
                    $('#step-2').addClass('active');
                    $('#patient-verification-section').addClass('hidden');
                    $('#patient-details-section').removeClass('hidden');

                    $('#patient_id').val(response.patient.id);
                }
            },
            error: function(xhr) {
                $('#patient-verification-form button').prop('disabled', false)
                    .html('<i class="fas fa-search"></i> Verify Patient');
                const response = xhr.responseJSON;
                alert(response.error || 'Error verifying patient');
            }
        });
    }

    function displayPatientInfo(data) {
        const patient = data.patient;
        const insurance = data.insurance;

        let insuranceInfo = '';
        if (insurance.has_insurance) {
            insuranceInfo = `
                <div class="mt-2">
                    <span class="badge bg-success insurance-badge">
                        <i class="fas fa-shield-alt"></i> Insured
                    </span>
                    <small class="d-block text-muted mt-1">
                        ${insurance.hmo_name} - ${insurance.plan_name}
                    </small>
                </div>
            `;
        }

        $('#patient-info').html(`
            <h5>${patient.full_name}</h5>
            <p class="mb-1"><strong>Card Number:</strong> ${patient.card_number}</p>
            <p class="mb-1"><strong>Phone:</strong> ${patient.phone}</p>
            <p class="mb-1"><strong>Age:</strong> ${patient.age}</p>
            <p class="mb-1"><strong>Gender:</strong> ${patient.gender}</p>
            ${insuranceInfo}
        `);

        $('#wallet-balance').text(data.wallet.formatted_balance);
    }

    function displayPendingPayments(payments) {
        let html = '';

        // Check for pending claims
        let pendingClaimsCount = 0;
        ['drugs', 'labs', 'scans', 'services'].forEach(category => {
            if (payments[category] && payments[category].items) {
                pendingClaimsCount += payments[category].items.filter(
                    item => item.has_pending_claim
                ).length;
            }
        });

        if (pendingClaimsCount > 0) {
            html += `
                <div class="pending-claim-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>⚠️ ${pendingClaimsCount} Pending Insurance Claim(s)</strong>
                    <p class="mb-0 mt-1">
                        <small>Some items have pending insurance claims. Patient will pay full amount
                        until claims are approved.</small>
                    </p>
                </div>
            `;
        }

        if (payments.drugs.count > 0) {
            html += createServiceSection('Medications', 'drugs', payments.drugs, 'fas fa-pills', '#17a2b8');
        }

        if (payments.labs.count > 0) {
            html += createServiceSection('Laboratory Tests', 'labs', payments.labs, 'fas fa-vial', '#28a745');
        }

        if (payments.scans.count > 0) {
            html += createServiceSection('Scans/Radiology', 'scans', payments.scans, 'fas fa-x-ray', '#dc3545');
        }

        if (payments.services.count > 0) {
            html += createServiceSection('Services & Items', 'services', payments.services, 'fas fa-hand-holding-medical', '#fd7e14');
        }

        if (html === '') {
            html = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <h5>No pending payments found</h5>
                    <p>This patient has no pending payments in the last 30 days.</p>
                </div>
            `;
        }

        $('#pending-payments-section').html(html);
        updateSelectedItems();
    }

    function createServiceSection(title, type, data, icon, color) {
        let itemsHtml = '';

        data.items.forEach(item => {
            const orderRef = item.order_number || `Trans. ID: ${item.id}`;
            const insuranceDiscount = item.base_amount - item.patient_amount;
            const hasDiscount = insuranceDiscount > 0.01;

            itemsHtml += `
                <div class="item-row">
                    <div class="form-check">
                        <input class="form-check-input item-checkbox" type="checkbox"
                               value="${item.id}" data-type="${type}"
                               data-amount="${item.patient_amount}" checked>
                        <label class="form-check-label">
                            <strong>${item.name}</strong>
                            ${item.quantity && item.quantity !== 1 ? `<small class="text-muted"> (Qty: ${item.quantity})</small>` : ''}
                            <br>
                            <small class="text-muted">
                                ${orderRef} | Date: ${item.ordered_date}
                            </small>
                            ${item.has_approved_claim ? `
                                <br><small class="text-success">
                                    <i class="fas fa-check-circle"></i> Claim Approved: ${item.claim_number}
                                </small>
                            ` : item.has_pending_claim ? `
                                <br><small class="text-warning">
                                    <i class="fas fa-clock"></i> Pending Claim: ${item.pending_claim_number}
                                </small>
                            ` : ''}
                        </label>
                    </div>
                    <div class="text-end">
                        ${hasDiscount ? `
                            <div class="text-muted">
                                <small><s>${formatCurrency(item.base_amount)}</s></small>
                            </div>
                        ` : ''}
                        <div class="amount-display">${formatCurrency(item.patient_amount)}</div>
                    </div>
                </div>
            `;
        });

        return `
            <div class="service-card">
                <div class="service-header">
                    <div>
                        <h6 class="mb-0">
                            <i class="${icon}" style="color: ${color}"></i> ${title}
                        </h6>
                        <small class="text-muted">${data.count} item(s)</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="toggleAllItems('${type}')">
                            Toggle All
                        </button>
                    </div>
                </div>
                ${itemsHtml}
            </div>
        `;
    }

    $(document).on('change', '.item-checkbox', function() {
        updateSelectedItems();
    });

    function toggleAllItems(type) {
        const checkboxes = $(`.item-checkbox[data-type="${type}"]`);
        const allChecked = checkboxes.filter(':checked').length === checkboxes.length;
        checkboxes.prop('checked', !allChecked);
        updateSelectedItems();
    }

    function updateSelectedItems() {
        selectedItems = { drugs: [], labs: [], scans: [], services: [] };
        let total = 0;

        $('.item-checkbox:checked').each(function() {
            const type = $(this).data('type');
            const id = $(this).val();
            const amount = parseFloat($(this).data('amount'));

            if (selectedItems.hasOwnProperty(type)) {
                selectedItems[type].push(id);
            }
            total += amount;
        });

        return total;
    }

    function proceedToPayment() {
        const totalAmount = updateSelectedItems();

        //if (totalAmount === 0) {
        //    alert('Please select at least one item to pay for');
        //    return;
        //}

        // Move to step 3
        $('#step-2').removeClass('active').addClass('completed');
        $('#step-3').addClass('active');
        $('#patient-details-section').addClass('hidden');
        $('#payment-section').removeClass('hidden');

        // Update payment breakdown
        $('#total-amount-display').text(formatCurrency(totalAmount));
        updatePaymentBreakdown();
    }

    function updatePaymentBreakdown() {
        const totalAmount = parseFloat($('#total-amount-display').text().replace(/[^\d.-]/g, ''));
        const useWallet = $('#use_wallet').is(':checked');

        let walletUsed = 0;
        if (useWallet && walletBalance > 0) {
            walletUsed = Math.min(walletBalance, totalAmount);
        }

        const remaining = totalAmount - walletUsed;

        $('#wallet-amount-display').text('- ' + formatCurrency(walletUsed));
        $('#remaining-amount-display').text(formatCurrency(remaining));
        $('#direct_amount').val(remaining.toFixed(2));

        // Show/hide wallet row based on balance
        if (walletBalance > 0) {
            $('#wallet-usage-row').show();
        } else {
            $('#wallet-usage-row').hide();
            $('#use_wallet').prop('checked', false);
        }
    }

    function goBackToDetails() {
        $('#step-3').removeClass('active');
        $('#step-2').addClass('active').removeClass('completed');
        $('#payment-section').addClass('hidden');
        $('#patient-details-section').removeClass('hidden');
    }

    function goToWalletFunding() {
        const patientId = $('#patient_id').val();
        if (patientId) {
            window.location.href = "{% url 'wallet_funding_only' %}?patient=" + patientId;
        }
    }

    function processPayment() {
        const formData = new FormData($('#payment-form')[0]);

        // Add selected items
        Object.keys(selectedItems).forEach(type => {
            selectedItems[type].forEach(id => {
                formData.append('selected_items[]', id);
                formData.append('selected_types[]', type);
            });
        });

        // Add wallet usage flag
        formData.set('use_wallet', $('#use_wallet').is(':checked'));

        $('#submit-payment').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm"></span> Processing...');

        $.ajax({
            url: processPaymentUrl,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#success-message-text').text(response.message);
                    const successModal = new bootstrap.Modal(document.getElementById('success-modal'));
                    successModal.show();

                    $('#modal-ok-button').off('click').on('click', function() {
                        if (response.redirect_url) {
                            window.location.href = response.redirect_url;
                        } else {
                            successModal.hide();
                            resetForm();
                        }
                    });
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert(response.error || 'Error processing payment');
            },
            complete: function() {
                $('#submit-payment').prop('disabled', false)
                    .html('<i class="fas fa-check-circle"></i> Complete Payment');
            }
        });
    }

    function resetForm() {
        $('#patient-verification-form')[0].reset();
        $('#payment-form')[0].reset();
        $('.step').removeClass('active completed');
        $('#step-1').addClass('active');
        $('#patient-details-section, #payment-section').addClass('hidden');
        $('#patient-verification-section').removeClass('hidden');
        patientData = null;
        pendingPayments = null;
        selectedItems = { drugs: [], labs: [], scans: [], services: [] };
    }

    // Auto-populate function for server-provided patient
    function populatePatientFromServer() {
        {% if patient %}
        const serverData = {
            patient: {
                id: "{{ patient.id }}",
                full_name: "{{ patient.full_name|escapejs }}",
                card_number: "{{ patient.card_number|escapejs }}",
                phone: "{{ patient.phone|escapejs }}",
                age: "{{ patient.age|default:''|escapejs }}",
                gender: "{{ patient.gender|default:''|escapejs }}"
            },
            wallet: {
                balance: {{ patient.wallet.amount|default:0 }},
                formatted_balance: formatCurrency({{ patient.wallet.amount|default:0 }})
            },
            insurance: {
                has_insurance: false
            }
        };

        displayPatientInfo(serverData);
        $('#patient_id').val(serverData.patient.id);

        // Fetch pending payments
        verifyPatient("{{ patient.card_number|escapejs }}");
        {% endif %}
    }
</script>

{% endblock %}