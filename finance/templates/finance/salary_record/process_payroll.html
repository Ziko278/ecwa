{% extends 'admin_site/layout.html' %}
{% load humanize %}
{% block 'main' %}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    .paysheet-row input[type="number"] {
        max-width: 120px;
    }
    .paysheet-row input[type="text"] {
        max-width: 180px;
    }
    tfoot td {
        font-weight: bold;
        font-size: 1.1rem;
    }
    .paid-row {
        background-color: #f0f0f0; /* Light grey for paid rows */
        opacity: 0.8;
    }
    .paid-row input, .paid-row select {
        pointer-events: none; /* Make inputs unclickable */
    }
</style>

<div class="col-12">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Process Payroll
                <a href="{% url 'export_payroll_to_excel' year=year month=month %}" class="btn btn-primary">Export Excel</a>
            </h5>

            <!-- Filter Form -->
            <div class="card mb-4" style="background-color: #f8f9fa;">
                <div class="card-body py-3">
                    <form method="get" class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label small">Year</label>
                            <select name="year" class="form-select">
                                {% for y in years %}
                                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">Month</label>
                            <select name="month" class="form-select">
                                {% for num, name in months %}
                                <option value="{{ num }}" {% if num == month %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i> Load Paysheet</button>
                        </div>
                    </form>
                </div>
            </div>

            <form method="POST">
                {% csrf_token %}
                {{ formset.management_form }}
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 3%;"><input type="checkbox" id="select-all" title="Select All"></th>
                                <th>Staff</th>
                                <th class="text-end">Gross Salary</th>
                                <th class="text-end">Bonus</th>
                                <th class="text-end">Other Deductions</th>
                                <th class="text-end">Net Salary</th>
                                <th class="text-end">Amount Paid</th>
                                <th>Notes</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset %}
                            <tr class="paysheet-row" data-paid="{{ form.instance.is_paid|yesno:'true,false' }}">
                                {{ form.id }}
                                <td class="text-center">
                                    <input type="checkbox" name="mark_as_paid" value="{{ form.instance.id }}" class="pay-checkbox" {% if form.instance.is_paid %}disabled{% endif %}>
                                </td>
                                <td>
                                    {{ form.instance.staff|title }}
                                    <small class="d-block text-muted">{{ form.instance.staff.staff_id }}</small>
                                </td>
                                <td class="text-end gross-salary" data-base-basic="{{ form.instance.basic_salary }}" data-base-gross="{{ form.instance.gross_salary }}">
                                    {{ form.instance.gross_salary|intcomma }}
                                </td>
                                <td>{{ form.bonus }}</td>
                                <td>{{ form.other_deductions }}</td>
                                <td class="text-end net-salary fw-bold">{{ form.instance.net_salary|intcomma }}</td>
                                <td>{{ form.amount_paid }}</td>
                                <td>{{ form.notes }}</td>
                                <td class="text-center">
                                    {% if form.instance.is_paid %}
                                        <span class="badge bg-success">Paid</span>
                                    {% elif form.instance.amount_paid > 0 %}
                                        <span class="badge bg-info">Partially Paid</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="text-end">Grand Totals:</td>
                                <td class="text-end" id="total-gross"></td>
                                <td class="text-end" id="total-bonus"></td>
                                <td class="text-end" id="total-deductions"></td>
                                <td class="text-end" id="total-net"></td>
                                <td class="text-end" id="total-paid"></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save All Changes</button>
                    <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to mark all selected records as PAID?')"><i class="bi bi-cash-coin"></i> Mark Selected as Paid</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function formatCurrency(num) {
        return 'â‚¦' + parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function calculateRow(row) {
        const gross = parseFloat(row.querySelector('.gross-salary').dataset.baseGross) || 0;
        const bonus = parseFloat(row.querySelector('input[name$="-bonus"]').value) || 0;
        const otherDeductions = parseFloat(row.querySelector('input[name$="-other_deductions"]').value) || 0;
        
        // This calculation does not include tax/pension as they are fixed from the structure.
        // We recalculate net salary based on the editable fields.
        const baseNet = (parseFloat(row.querySelector('.gross-salary').dataset.baseGross) || 0) 
                      - (parseFloat(row.dataset.tax) || 0) 
                      - (parseFloat(row.dataset.pension) || 0);

        const finalNet = baseNet + bonus - otherDeductions;
        row.querySelector('.net-salary').textContent = finalNet.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
        
        calculateTotals();
    }

    function calculateTotals() {
        let totalGross = 0, totalBonus = 0, totalDeductions = 0, totalNet = 0, totalPaid = 0;
        document.querySelectorAll('.paysheet-row').forEach(row => {
            const baseGross = parseFloat(row.querySelector('.gross-salary').dataset.baseGross) || 0;
            const bonus = parseFloat(row.querySelector('input[name$="-bonus"]').value) || 0;
            const otherDeductions = parseFloat(row.querySelector('input[name$="-other_deductions"]').value) || 0;

            totalGross += baseGross;
            totalBonus += bonus;
            totalDeductions += otherDeductions;
            
            // Re-fetch fixed deductions for accuracy
            const tax = parseFloat(row.querySelector('input[name$="-tax_amount"]')?.value || 0);
            const pension = parseFloat(row.querySelector('input[name$="-pension_amount"]')?.value || 0);

            totalNet += (baseGross + bonus) - (tax + pension + otherDeductions);
            totalPaid += parseFloat(row.querySelector('input[name$="-amount_paid"]').value) || 0;
        });

        document.getElementById('total-gross').textContent = formatCurrency(totalGross);
        document.getElementById('total-bonus').textContent = formatCurrency(totalBonus);
        document.getElementById('total-deductions').textContent = formatCurrency(totalDeductions);
        document.getElementById('total-net').textContent = formatCurrency(totalNet);
        document.getElementById('total-paid').textContent = formatCurrency(totalPaid);
    }

    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('input', (e) => calculateRow(e.target.closest('.paysheet-row')));
    });
    
    document.querySelectorAll('.paysheet-row').forEach(row => {
        if (row.dataset.paid === 'true') {
            row.classList.add('paid-row');
            row.querySelectorAll('input, select').forEach(el => {
                if (el.type !== 'checkbox') el.readOnly = true;
            });
        }
    });

    document.getElementById('select-all').addEventListener('change', function(e) {
        document.querySelectorAll('.pay-checkbox').forEach(cb => {
            if (!cb.disabled) {
                cb.checked = e.target.checked;
            }
        });
    });

    calculateTotals(); // Initial calculation
});
</script>
{% endblock %}
