{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}

<div class="col-12">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="card-title mb-0">Create Individual Salary Record</h4>
                <a href="{% url 'salary_record_index' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>

            {% include 'admin_site/partials/error.html' %}

            <form method="POST" action="">
                {% csrf_token %}
                <div class="row">
                    <!-- Left Column: Form Inputs -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Record Details</h5>
                            </div>
                            <div class="card-body">
                                <div id="auto-fill-error" class="alert alert-danger" style="display:none;"></div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.staff.id_for_label }}" class="form-label">Staff Member <span class="text-danger">*</span></label>
                                        {{ form.staff }}
                                        <small class="form-text text-muted">Select a staff member to auto-populate their salary structure.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.year.id_for_label }}" class="form-label">Year <span class="text-danger">*</span></label>
                                        {{ form.year }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.month.id_for_label }}" class="form-label">Month <span class="text-danger">*</span></label>
                                        {{ form.month }}
                                    </div>

                                    <h6 class="mt-3 text-primary">Auto-populated from Salary Structure</h6>
                                    <hr>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.basic_salary.id_for_label }}" class="form-label">Basic Salary (₦)</label>
                                        {{ form.basic_salary }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.housing_allowance.id_for_label }}" class="form-label">Housing Allowance (₦)</label>
                                        {{ form.housing_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.transport_allowance.id_for_label }}" class="form-label">Transport Allowance (₦)</label>
                                        {{ form.transport_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.medical_allowance.id_for_label }}" class="form-label">Medical Allowance (₦)</label>
                                        {{ form.medical_allowance }}
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.other_allowances.id_for_label }}" class="form-label">Other Allowances (₦)</label>
                                        {{ form.other_allowances }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tax_amount.id_for_label }}" class="form-label">Tax Amount (₦)</label>
                                        {{ form.tax_amount }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.pension_amount.id_for_label }}" class="form-label">Pension Amount (₦)</label>
                                        {{ form.pension_amount }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Summary & Actions -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gross Salary:</span>
                                    <strong id="summary-gross">₦0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Total Deductions:</span>
                                    <strong id="summary-deductions" class="text-danger">₦0.00</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between h4">
                                    <strong>Net Salary:</strong>
                                    <strong id="summary-net" class="text-success">₦0.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" name="save" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> Save Salary Record
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const staffSelect = document.getElementById('{{ form.staff.id_for_label }}');
    const errorDiv = document.getElementById('auto-fill-error');

    const fieldsToUpdate = [
        'basic_salary', 'housing_allowance', 'transport_allowance', 
        'medical_allowance', 'other_allowances', 'tax_amount', 'pension_amount'
    ];

    const grossEl = document.getElementById('summary-gross');
    const deductionsEl = document.getElementById('summary-deductions');
    const netEl = document.getElementById('summary-net');

    function formatCurrency(num) {
        return '₦' + parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function clearFields() {
        fieldsToUpdate.forEach(fieldName => {
            const el = document.getElementById(`id_${fieldName}`);
            if (el) el.value = '0.00';
        });
        grossEl.textContent = formatCurrency(0);
        deductionsEl.textContent = formatCurrency(0);
        netEl.textContent = formatCurrency(0);
        errorDiv.style.display = 'none';
    }

    async function fetchSalaryStructure(staffId) {
        if (!staffId) {
            clearFields();
            return;
        }

        try {
            const url = `{% url 'get_staff_salary_structure_ajax' 0 %}`.replace('0', staffId);
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                const data = result.data;
                errorDiv.style.display = 'none';
                
                // Populate form fields
                fieldsToUpdate.forEach(fieldName => {
                    const el = document.getElementById(`id_${fieldName}`);
                    if (el && data[fieldName]) {
                        el.value = parseFloat(data[fieldName]).toFixed(2);
                    }
                });

                // Update summary
                grossEl.textContent = formatCurrency(data.gross_salary || 0);
                const totalDeductions = (parseFloat(data.tax_amount) || 0) + (parseFloat(data.pension_amount) || 0);
                deductionsEl.textContent = formatCurrency(totalDeductions);
                netEl.textContent = formatCurrency(data.net_salary || 0);

            } else {
                clearFields();
                errorDiv.textContent = result.error;
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            clearFields();
            errorDiv.textContent = 'An error occurred while fetching salary data.';
            errorDiv.style.display = 'block';
            console.error('Fetch Error:', error);
        }
    }

    staffSelect.addEventListener('change', (event) => {
        fetchSalaryStructure(event.target.value);
    });
});
</script>

{% endblock %}
