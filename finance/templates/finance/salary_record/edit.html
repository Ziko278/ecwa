{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}

<div class="col-12">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="card-title mb-0">Edit Salary Record</h4>
                    <small class="text-muted">For: {{ form.instance.staff|title }} ({{ form.instance.get_month_display }}/{{ form.instance.year }})</small>
                </div>
                <a href="{% url 'salary_record_detail' form.instance.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Detail
                </a>
            </div>

            {% include 'admin_site/partials/error.html' %}

            <form method="POST" action="">
                {% csrf_token %}
                <div class="row">
                    <!-- Left Column: Form Inputs -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Record Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.staff.id_for_label }}" class="form-label">Staff Member</label>
                                        {{ form.staff }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.year.id_for_label }}" class="form-label">Year <span class="text-danger">*</span></label>
                                        {{ form.year }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.month.id_for_label }}" class="form-label">Month <span class="text-danger">*</span></label>
                                        {{ form.month }}
                                    </div>

                                    <h6 class="mt-3">Earnings & Deductions</h6>
                                    <hr>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.basic_salary.id_for_label }}" class="form-label">Basic Salary (₦)</label>
                                        {{ form.basic_salary }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.housing_allowance.id_for_label }}" class="form-label">Housing Allowance (₦)</label>
                                        {{ form.housing_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.transport_allowance.id_for_label }}" class="form-label">Transport Allowance (₦)</label>
                                        {{ form.transport_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.medical_allowance.id_for_label }}" class="form-label">Medical Allowance (₦)</label>
                                        {{ form.medical_allowance }}
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.other_allowances.id_for_label }}" class="form-label">Other Allowances (₦)</label>
                                        {{ form.other_allowances }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tax_amount.id_for_label }}" class="form-label">Tax Amount (₦)</label>
                                        {{ form.tax_amount }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.pension_amount.id_for_label }}" class="form-label">Pension Amount (₦)</label>
                                        {{ form.pension_amount }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Summary & Actions -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gross Salary:</span>
                                    <strong id="summary-gross">₦0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Total Deductions:</span>
                                    <strong id="summary-deductions" class="text-danger">₦0.00</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between h4">
                                    <strong>Net Salary:</strong>
                                    <strong id="summary-net" class="text-success">₦0.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" name="save" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const salaryInputs = [
        'id_basic_salary', 'id_housing_allowance', 'id_transport_allowance', 
        'id_medical_allowance', 'id_other_allowances', 'id_tax_amount', 'id_pension_amount'
    ];

    const grossEl = document.getElementById('summary-gross');
    const deductionsEl = document.getElementById('summary-deductions');
    const netEl = document.getElementById('summary-net');

    // Disable the staff selection dropdown
    const staffSelect = document.getElementById('{{ form.staff.id_for_label }}');
    if (staffSelect) {
        staffSelect.disabled = true;
    }

    function formatCurrency(num) {
        return '₦' + parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function calculateSalary() {
        const basic = parseFloat(document.getElementById('id_basic_salary').value) || 0;
        const housing = parseFloat(document.getElementById('id_housing_allowance').value) || 0;
        const transport = parseFloat(document.getElementById('id_transport_allowance').value) || 0;
        const medical = parseFloat(document.getElementById('id_medical_allowance').value) || 0;
        const others = parseFloat(document.getElementById('id_other_allowances').value) || 0;
        const tax = parseFloat(document.getElementById('id_tax_amount').value) || 0;
        const pension = parseFloat(document.getElementById('id_pension_amount').value) || 0;

        const gross = basic + housing + transport + medical + others;
        const totalDeductions = tax + pension;
        const net = gross - totalDeductions;

        grossEl.textContent = formatCurrency(gross);
        deductionsEl.textContent = formatCurrency(totalDeductions);
        netEl.textContent = formatCurrency(net);
    }

    salaryInputs.forEach(id => {
        const inputEl = document.getElementById(id);
        if (inputEl) {
            inputEl.addEventListener('input', calculateSalary);
        }
    });

    // Initial calculation on page load
    calculateSalary();
});
</script>

{% endblock %}
