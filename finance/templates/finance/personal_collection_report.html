{% extends 'admin_site/layout.html' %}
{% load static humanize %}
{% block 'main' %}
<style>
.report-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 24px;
    margin-bottom: 20px;
}
.report-header {
    border-bottom: 2px solid #4472C4;
    padding-bottom: 16px;
    margin-bottom: 24px;
}
.filters-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 24px;
}
.form-group {
    margin-bottom: 16px;
}
.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}
.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}
.btn-primary {
    background: #4472C4;
    color: white;
}
.btn-success {
    background: #28a745;
    color: white;
}
.btn-info {
    background: #17a2b8;
    color: white;
}
.controls-bar {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 20px;
}
.summary-card {
    background: linear-gradient(135deg, #4472C4 0%, #365a99 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 16px;
}
.summary-card h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    font-weight: 500;
    opacity: 0.9;
}
.summary-card .value {
    font-size: 32px;
    font-weight: 700;
}
.summary-card.danger {
    background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%);
}
.summary-card.success {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
}
.data-list {
    list-style: none;
    padding: 0;
}
.data-list li {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #e0e0e0;
}
.data-list li:last-child {
    border-bottom: none;
}
.data-list li.total {
    font-weight: 700;
    font-size: 1.1em;
    background: #f8f9fa;
    padding: 16px;
    margin-top: 8px;
    border-radius: 4px;
    border: 2px solid #4472C4;
}
.section-title {
    font-size: 18px;
    font-weight: 700;
    color: #4472C4;
    margin-top: 32px;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #4472C4;
}
</style>

<div class="report-container">
    <div class="report-header">
        <h2>Personal Collection Report</h2>
        <p style="color: #666; margin: 0;">Financial activity for {{ staff.get_full_name|default:staff.username }}</p>
    </div>

    <div class="filters-section">
        <form method="get" id="reportForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="form-group">
                    <label for="from_date">From Date</label>
                    <input type="date" name="from_date" id="from_date" class="form-control" value="{{ from_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="to_date">To Date</label>
                    <input type="date" name="to_date" id="to_date" class="form-control" value="{{ to_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="staff_id">Staff Member</label>
                    <select name="staff_id" id="staff_id" class="form-control">
                        <option value="">Me ({{ request.user.username }})</option>
                        {% for s in all_staff %}
                        <option value="{{ s.id }}" {% if staff.id == s.id %}selected{% endif %}>
                            {{ s.get_full_name|default:s.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </div>
        </form>
    </div>

    <div class="controls-bar">
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-info" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="summary-card">
            <h3>Total Collections</h3>
            <p class="value">₦{{ total_collections|floatformat:2|intcomma }}</p>
        </div>
        <div class="summary-card danger">
            <h3>Total Cash Out</h3>
            <p class="value">₦{{ total_cash_out|floatformat:2|intcomma }}</p>
        </div>
        <div class="summary-card success">
            <h3>Net to Remit (Cash)</h3>
            <p class="value">₦{{ net_cash_to_remit|floatformat:2|intcomma }}</p>
        </div>
    </div>

    <!-- Income Breakdown -->
    <div class="section-title">Income Breakdown</div>
    <ul class="data-list">
        <li><span>Card (Registration)</span> <span>₦{{ card_total|floatformat:2|intcomma }}</span></li>
        <li><span>Consultation</span> <span>₦{{ cons_total|floatformat:2|intcomma }}</span></li>
        <li><span>Laboratory</span> <span>₦{{ lab_total|floatformat:2|intcomma }}</span></li>
        <li><span>Drugs</span> <span>₦{{ drugs_total|floatformat:2|intcomma }}</span></li>
        <li><span>Scan/Imaging</span> <span>₦{{ scan_total|floatformat:2|intcomma }}</span></li>

        {% for service in service_breakdown %}
        <li><span>{{ service.name }}</span> <span>₦{{ service.amount|floatformat:2|intcomma }}</span></li>
        {% endfor %}

        <li><span>Surgery</span> <span>₦{{ surgery_total|floatformat:2|intcomma }}</span></li>

        {% for other in other_breakdown %}
        <li><span>{{ other.name }}</span> <span>₦{{ other.amount|floatformat:2|intcomma }}</span></li>
        {% endfor %}

        <li class="total"><span>TOTAL COLLECTIONS</span> <span>₦{{ total_collections|floatformat:2|intcomma }}</span></li>
    </ul>

    <!-- Cash Out -->
    <div class="section-title">Cash Out</div>
    <ul class="data-list">
        <li><span>Expenses (Cash Paid)</span> <span>₦{{ cash_expenses|floatformat:2|intcomma }}</span></li>
        <li><span>Wallet Withdrawals (Refunds)</span> <span>₦{{ wallet_withdrawals|floatformat:2|intcomma }}</span></li>
        <li class="total"><span>TOTAL CASH OUT</span> <span>₦{{ total_cash_out|floatformat:2|intcomma }}</span></li>
    </ul>

    <!-- Remittance Breakdown -->
    <div class="section-title">Remittance Calculation</div>
    <ul class="data-list">
        <li><span>Cash Collections</span> <span>₦{{ cash_collections|floatformat:2|intcomma }}</span></li>
        <li><span>Transfer Collections</span> <span>₦{{ transfer_collections|floatformat:2|intcomma }}</span></li>
        <li><span>Less: Cash Expenses</span> <span>-₦{{ cash_expenses|floatformat:2|intcomma }}</span></li>
        <li><span>Less: Wallet Withdrawals</span> <span>-₦{{ wallet_withdrawals|floatformat:2|intcomma }}</span></li>
        <li><span>Less: Previous Remittances (Cash)</span> <span>-₦{{ previous_cash_remitted|floatformat:2|intcomma }}</span></li>
        <li class="total" style="background: #d4edda; border-color: #28a745;">
            <span>NET CASH TO REMIT</span>
            <span>₦{{ net_cash_to_remit|floatformat:2|intcomma }}</span>
        </li>
    </ul>
</div>

<script>
function getParams() {
    const fromDate = document.getElementById('from_date').value;
    const toDate = document.getElementById('to_date').value;
    const staffId = document.getElementById('staff_id').value;
    
    return new URLSearchParams({
        from_date: fromDate,
        to_date: toDate,
        staff_id: staffId
    });
}

function exportToExcel() {
    const params = getParams();
    window.location.href = `{% url 'personal_collection_export_excel' %}?${params.toString()}`;
}

function exportToPDF() {
    const params = getParams();
    window.location.href = `{% url 'personal_collection_export_pdf' %}?${params.toString()}`;
}
</script>
{% endblock %}
