{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h4><i class="fas fa-money-check-alt"></i> Finance — Payment Selection</h4>
    </div>
    <div class="card-body">
      <div id="verify-section" class="mb-4">
        <form id="patient-verify-form" class="row g-2">
          {% csrf_token %}
          <div class="col-md-8">
            <label class="form-label">Patient Card Number</label>
            <input id="card_number" name="card_number" class="form-control form-control-lg" placeholder="Enter patient card number" required>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" id="btn-verify" class="btn btn-primary w-100">
              <i class="fas fa-search"></i> Verify Patient
            </button>
          </div>
        </form>
      </div>

      <div id="options-section" class="hidden">
        <div id="patient-summary" class="mb-3">
          </div>

        <div class="card mb-3">
          <div class="card-body">
            <h5>Select Action</h5>

            {# --- NEW: Admission and Surgery Funding --- #}
            <div class="form-check mt-2">
              <input class="form-check-input payment-option" type="radio" name="payment_type" id="opt_admission" value="admission">
              <label class="form-check-label" for="opt_admission">
                Admission / Surgery Funding <span id="admission-count" class="badge bg-success">0</span>
              </label>
              <div class="small text-muted ms-4" id="admission-info">Make a deposit for an ongoing admission or surgery</div>
            </div>

            <hr>
            <h5 class="mt-3">Pay Pending Bills</h5>

            <div class="form-check mt-2">
              <input class="form-check-input payment-option" type="radio" name="payment_type" id="opt_drug" value="drug">
              <label class="form-check-label" for="opt_drug">
                Medications (Pharmacy) <span id="drug-count" class="badge bg-info">0</span>
              </label>
              <div class="small text-muted ms-4" id="drug-info"></div>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input payment-option" type="radio" name="payment_type" id="opt_lab" value="lab">
              <label class="form-check-label" for="opt_lab">
                Laboratory Tests <span id="lab-count" class="badge bg-info">0</span>
              </label>
              <div class="small text-muted ms-4" id="lab-info"></div>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input payment-option" type="radio" name="payment_type" id="opt_scan" value="scan">
              <label class="form-check-label" for="opt_scan">
                Scans / Radiology <span id="scan-count" class="badge bg-info">0</span>
              </label>
              <div class="small text-muted ms-4" id="scan-info"></div>
            </div>

            {# --- NEW: Service/Item Payment Option --- #}
            <div class="form-check mt-2">
              <input class="form-check-input payment-option" type="radio" name="payment_type" id="opt_service" value="service">
              <label class="form-check-label" for="opt_service">
                Services & Items <span id="service-count" class="badge bg-info">0</span>
              </label>
              <div class="small text-muted ms-4" id="service-info"></div>
            </div>

          </div>
        </div>

        <div class="d-flex justify-content-between">
          <div id="selected-summary" class="align-self-center text-muted">Select an option to proceed</div>
          <div>
            <button id="btn-back" class="btn btn-secondary me-2">Back</button>
            <button id="btn-proceed" class="btn btn-success" disabled>Proceed</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
(function($){
  const verifyUrl = "{% url 'finance_verify_patient_ajax' %}";

  // 1. ADD NEW URL TARGET
  // NOTE: You must have a URL named 'finance_service_patient_payment' defined in your urls.py
  const targetUrls = {
    admission: "{% url 'finance_admission_funding' 0 %}",
    drug: "{% url 'finance_pharmacy_patient_payment' 0 %}",
    lab: "{% url 'finance_laboratory_patient_payment' 0 %}",
    scan: "{% url 'finance_scan_patient_payment' 0 %}",
    service: "{% url 'finance_service_patient_payment' 0 %}" // NEW URL
  };

  let currentPatient = null;
  let pending = null;

  function resetOptions() {
    $('#options-section').addClass('hidden');
    $('#patient-summary').empty();
    $('#drug-count').text('0'); $('#drug-info').text('');
    $('#lab-count').text('0'); $('#lab-info').text('');
    $('#scan-count').text('0'); $('#scan-info').text('');
    // 2. CLEAR SERVICE/ITEM ELEMENTS
    $('#service-count').text('0'); $('#service-info').text('');
    $('#admission-count').text('0');
    $('#selected-summary').text('Select an option to proceed');
    $('#btn-proceed').prop('disabled', true);
    $('input.payment-option').prop('checked', false);
    currentPatient = null;
    pending = null;
  }

  function formatCurrency(amount) {
      return `₦${Number(amount).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
  }

  function showOptionsFromResponse(resp) {
    currentPatient = resp.patient;
    pending = resp.pending_payments || {};

    $('#patient-summary').html(`
      <div class="alert alert-success">
        <h5>${resp.patient.full_name}</h5>
        <div class="small text-muted">Card: ${resp.patient.card_number}</div>
        <div class="mt-2"><strong>Wallet:</strong> ${resp.wallet.formatted_balance}</div>
        ${resp.insurance.has_insurance ? `<div class="small text-info mt-1">Insured: ${resp.insurance.hmo_name} (${resp.insurance.policy_number})</div>` : ''}
      </div>
    `);

    const drugs = pending.drugs || {count:0, total:0};
    const labs  = pending.labs  || {count:0, total:0};
    const scans = pending.scans || {count:0, total:0};
    // 3. GET SERVICE/ITEM DATA
    const services = pending.services || {count:0, total:0};
    const admissions = pending.admissions || {count:0};
    const surgeries = pending.surgeries || {count:0};
    const totalActiveInpatient = admissions.count + surgeries.count;

    $('#drug-count').text(drugs.count || 0);
    $('#drug-info').text(drugs.count ? `Total: ${formatCurrency(drugs.total)}` : 'No pending medication orders');

    $('#lab-count').text(labs.count || 0);
    $('#lab-info').text(labs.count ? `Total: ${formatCurrency(labs.total)}` : 'No pending lab tests');

    $('#scan-count').text(scans.count || 0);
    $('#scan-info').text(scans.count ? `Total: ${formatCurrency(scans.total)}` : 'No pending scans');

    // 3. UPDATE SERVICE/ITEM COUNTS AND TOTALS
    $('#service-count').text(services.count || 0);
    $('#service-info').text(services.count ? `Total: ${formatCurrency(services.total)}` : 'No pending service/item payments');

    // Update admission/surgery counts
    $('#admission-count').text(totalActiveInpatient);

    $('#options-section').removeClass('hidden');

    $('input.payment-option').off('change').on('change', function(){
      if ($(this).is(':checked')) {
        const val = $(this).val();
        handleOptionSelected(val);
      }
    });
  }

  function handleOptionSelected(type) {
    $('#btn-proceed').prop('disabled', true);
    $('#selected-summary').text('');

    const counts = {
      drug: (pending.drugs && pending.drugs.count) || 0,
      lab: (pending.labs && pending.labs.count) || 0,
      scan: (pending.scans && pending.scans.count) || 0,
      // 4. ADD SERVICE/ITEM COUNT
      service: (pending.services && pending.services.count) || 0,
      admission: ((pending.admissions && pending.admissions.count) || 0) + ((pending.surgeries && pending.surgeries.count) || 0),
    };

    if (type === 'admission') {
        if (counts.admission > 0) {
            $('#selected-summary').text(`Patient has ${counts.admission} active admission/surgery. Proceed to view details and make a deposit.`);
            $('#btn-proceed').prop('disabled', false);
        } else {
            $('#selected-summary').text('This patient has no active admissions or surgeries.');
            $('#btn-proceed').prop('disabled', false); // Allow funding even if count is zero
        }
    // 4. ADD SERVICE/ITEM LOGIC
    } else if (type === 'service') {
        if (counts.service > 0) {
            let total = pending.services.total || 0;
            $('#selected-summary').text(`${counts.service} item(s) selected — Total: ${formatCurrency(total)}`);
            $('#btn-proceed').prop('disabled', false);
        } else {
            $('#selected-summary').text('No payable services/items for the selected type. Please choose another option.');
            // Allow user to proceed, e.g., to create a new ServiceTransaction if necessary,
            // though typically payment screen relies on existing pending transactions.
            $('#btn-proceed').prop('disabled', true);
        }
    }
    // 4. Update existing logic for drug/lab/scan
    else if (counts[type] && counts[type] > 0) {
      let totals = {
        drug: pending.drugs.total || 0,
        lab: pending.labs.total || 0,
        scan: pending.scans.total || 0
      };
      $('#selected-summary').text(`${counts[type]} item(s) selected — Total: ${formatCurrency(totals[type])}`);
      $('#btn-proceed').prop('disabled', false);
    } else {
      $('#selected-summary').text('No payable items for the selected type. Please choose another option.');
      $('#btn-proceed').prop('disabled', true);
    }
  }

  // Form submit -> verify via AJAX
  $('#patient-verify-form').on('submit', function(e){
    e.preventDefault();
    const card = $('#card_number').val().trim();
    if (!card) return;

    $('#btn-verify').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Verifying...');
    resetOptions();

    $.get(verifyUrl, {card_number: card})
      .done(function(data){
        if (data && data.success) {
          showOptionsFromResponse(data);
        } else {
          alert(data.error || 'Patient not found');
        }
      })
      .fail(function(xhr) {
        let err = (xhr.responseJSON && xhr.responseJSON.error) || 'Error verifying patient. Check server logs.';
        alert(err);
      })
      .always(function() {
        $('#btn-verify').prop('disabled', false).html('<i class="fas fa-search"></i> Verify Patient');
      });
  });

  // Back button
  $('#btn-back').on('click', function(){
    resetOptions();
    $('#card_number').val('').focus();
  });

  // Proceed button
  $('#btn-proceed').on('click', function(){
    const selected = $('input.payment-option:checked').val();
    if (!selected || !currentPatient || !currentPatient.id) return;
    const templateUrl = targetUrls[selected];
    if (!templateUrl) return;

    // Replace placeholder '/0' with the actual patient ID
    const dest = templateUrl.replace('/0', '/' + String(currentPatient.id));
    window.location.href = dest;
  });

  // Focus on card number input on page load
  $(document).ready(function(){
    $('#card_number').focus();
  });

})(jQuery);
</script>

<style>
.hidden { display: none !important; }
.badge { font-size: 0.75em; }
.form-check { padding: 0.75rem; border: 1px solid #e3e6f0; border-radius: 0.35rem; margin-bottom: 0.5rem; }
.form-check:hover { background-color: #f8f9fc; cursor: pointer;}
.form-check-input:checked + .form-check-label { font-weight: 500; }
#selected-summary { font-size: 0.9rem; }
.alert-success { border-left: 4px solid #1cc88a; }
</style>
{% endblock %}