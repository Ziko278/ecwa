{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}
<style>
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .customer-info-card {
        border-left: 4px solid #28a745;
    }
    .wallet-balance {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
    }
    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    .service-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .service-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .item-row {
        padding: 8px 15px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .item-row:last-child {
        border-bottom: none;
    }
    .amount-display {
        font-weight: bold;
        color: #495057;
    }
    .total-section {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .hidden {
        display: none;
    }
    .payment-breakdown-card {
        border: 2px solid #17a2b8;
        border-radius: 8px;
        background: #f8f9fa;
    }
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
    }
    .breakdown-row:last-child {
        border-bottom: none;
        background: #e9ecef;
        font-weight: bold;
    }
    .cart-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .quantity-control {
        display: flex;
        align-items: center;
    }
    .quantity-control button {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 1px solid #ccc;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .quantity-control input {
        width: 50px;
        text-align: center;
        border: none;
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        height: 30px;
    }
    .pending-claim-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .claim-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 5px;
    }
    .claim-approved {
        background-color: #d4edda;
        color: #155724;
    }
    .claim-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    .customer-verification {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-shopping-cart"></i> Direct Sales
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Verification -->
    <div class="customer-verification">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="customer_type" id="registered_patient" value="patient" checked>
                    <label class="form-check-label" for="registered_patient">
                        Registered Patient
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="customer_type" id="walk_in_customer" value="walkin">
                    <label class="form-check-label" for="walk_in_customer">
                        Walk-in Customer
                    </label>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row g-2">
                    <!-- Registered Patient Form -->
                    <div id="registered-patient-form" class="col-12">
                        <div class="input-group">
                            <input type="text" class="form-control" id="card_number" placeholder="Enter patient card number">
                            <button class="btn btn-primary" type="button" id="verify-patient-btn">
                                <i class="fas fa-search"></i> Verify
                            </button>
                        </div>
                    </div>

                    <!-- Walk-in Customer Form -->
                    <div id="walk-in-customer-form" class="col-12 hidden">
                        <div class="input-group">
                            <input type="text" class="form-control" id="customer_name" placeholder="Enter customer name">
                            <button class="btn btn-primary" type="button" id="verify-walkin-btn">
                                <i class="fas fa-user-plus"></i> Continue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Info Display -->
    <div id="customer-info-section" class="hidden">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card customer-info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-check"></i> Customer Details</h5>
                    </div>
                    <div class="card-body" id="customer-info">
                        <!-- Customer details will be loaded here -->
                    </div>
                </div>

                <!-- Wallet Balance (for registered patients only) -->
                <div id="wallet-balance-card" class="card mt-3 hidden">
                    <div class="card-header">
                        <h5><i class="fas fa-wallet"></i> Current Wallet Balance</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="wallet-balance" id="wallet-balance">₦0.00</div>
                        <small class="text-muted">Available for use</small>
                    </div>
                </div>
            </div>

            <div class="col-md-8" >
                <!-- Action Buttons - MOVED TO TOP -->
                <div class="card mb-3">
                    <div class="card-body" style="padding-top:20px">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#drugModal">
                                <i class="fas fa-pills"></i> Add Drug
                            </button>
                            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#labModal">
                                <i class="fas fa-vial"></i> Add Lab Test
                            </button>
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#scanModal">
                                <i class="fas fa-x-ray"></i> Add Scan
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#serviceModal">
                                <i class="fas fa-hand-holding-medical"></i> Add Service
                            </button>
                            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#itemModal">
                                <i class="fas fa-box"></i> Add Item
                            </button>

                        </div>
                    </div>
                </div>

                <!-- Pending Orders -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list"></i> Pending Orders (Last 30 Days)</h5>
                        <small class="text-light">Select items to pay for</small>
                    </div>
                    <div class="card-body" id="pending-orders-section">
                        <!-- Pending orders will be loaded here -->
                    </div>
                </div>

                <!-- Proceed to Payment Button -->
                <div class="card mt-3" style="padding-top:20px">
                    <div class="card-body text-center">
                        <button class="btn btn-success btn-lg" id="proceed-to-payment-btn" disabled>
                            <i class="fas fa-arrow-right"></i> Proceed to Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Section -->
    <div id="payment-section" class="hidden">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card"></i> Payment Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="payment-form">
                            {% csrf_token %}

                            <!-- Payment Breakdown -->
                            <div class="payment-breakdown-card mb-4">
                                <div class="p-3 bg-info text-white">
                                    <h6 class="mb-0">Payment Summary</h6>
                                </div>
                                <div class="breakdown-row">
                                    <span>Total Amount Due:</span>
                                    <strong id="total-amount-display">₦0.00</strong>
                                </div>
                                <div class="breakdown-row" id="wallet-usage-row">
                                    <span>
                                        <input type="checkbox" id="use_wallet" name="use_wallet" checked>
                                        <label for="use_wallet" class="ms-2">Use Wallet Balance</label>
                                    </span>
                                    <strong class="text-success" id="wallet-amount-display">- ₦0.00</strong>
                                </div>
                                <div class="breakdown-row">
                                    <span>Amount to Pay Now:</span>
                                    <strong class="text-primary" id="remaining-amount-display">₦0.00</strong>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-4">
                                <label for="payment_method" class="form-label">Payment Method</label>
                                <select class="form-select form-control-lg" id="payment_method" name="payment_method" required>
                                    <option value="cash">CASH</option>
                                    <option value="transfer">BANK TRANSFER</option>
                                    <option value="card">CARD (POS)</option>
                                </select>
                            </div>

                            <!-- Amount Confirmation -->
                            <div class="mb-4">
                                <label for="direct_amount" class="form-label">Amount to Pay (₦)</label>
                                <input type="number" class="form-control form-control-lg"
                                       id="direct_amount" name="direct_amount"
                                       step="0.01" readonly required>
                                <small class="text-muted">This amount will be paid via <span id="method-text">CASH</span></small>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="back-to-orders-btn">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="submit" class="btn btn-success btn-lg" id="submit-payment">
                                    <i class="fas fa-check-circle"></i> Complete Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drug Modal -->
<div class="modal fade" id="drugModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Drug</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="drug-search" class="form-label">Search Drug</label>
                    <input type="text" class="form-control" id="drug-search" placeholder="Start typing drug name...">
                    <div id="drug-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="drug-details" class="hidden">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="selected-drug-name"></h6>
                            <p class="mb-1">Price: ₦<span id="selected-drug-price"></span></p>
                            <p class="mb-1">Stock: <span id="selected-drug-stock"></span></p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="drug-quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="drug-quantity" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="drug-dosage" class="form-label">Dosage Instructions</label>
                            <input type="text" class="form-control" id="drug-dosage" placeholder="e.g., 1 tablet twice daily">
                        </div>
                        <div class="mb-3">
                            <label for="drug-duration" class="form-label">Duration</label>
                            <input type="text" class="form-control" id="drug-duration" placeholder="e.g., 7 days">
                        </div>
                        <div class="mb-3">
                            <label for="drug-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="drug-notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-drug-btn" disabled>Add to Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Lab Modal -->
<div class="modal fade" id="labModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Lab Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="lab-search" class="form-label">Search Lab Test</label>
                    <input type="text" class="form-control" id="lab-search" placeholder="Start typing test name...">
                    <div id="lab-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="lab-details" class="hidden">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="selected-lab-name"></h6>
                            <p class="mb-1">Price: ₦<span id="selected-lab-price"></span></p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="lab-instructions" class="form-label">Special Instructions</label>
                            <textarea class="form-control" id="lab-instructions" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-lab-btn" disabled>Add to Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Scan Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="scan-search" class="form-label">Search Scan</label>
                    <input type="text" class="form-control" id="scan-search" placeholder="Start typing scan name...">
                    <div id="scan-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="scan-details" class="hidden">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="selected-scan-name"></h6>
                            <p class="mb-1">Price: ₦<span id="selected-scan-price"></span></p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="scan-indication" class="form-label">Clinical Indication</label>
                            <textarea class="form-control" id="scan-indication" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-scan-btn" disabled>Add to Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="service-search" class="form-label">Search Service</label>
                    <input type="text" class="form-control" id="service-search" placeholder="Start typing service name...">
                    <div id="service-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="service-details" class="hidden">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="selected-service-name"></h6>
                            <p class="mb-1">Price: ₦<span id="selected-service-price"></span></p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="service-quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="service-quantity" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="service-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="service-notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-service-btn" disabled>Add to Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Item Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="item-search" class="form-label">Search Item</label>
                    <input type="text" class="form-control" id="item-search" placeholder="Start typing item name...">
                    <div id="item-search-results" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="item-details" class="hidden">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="selected-item-name"></h6>
                            <p class="mb-1">Price: ₦<span id="selected-item-price"></span></p>
                            <p class="mb-1">Stock: <span id="selected-item-stock"></span></p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="item-quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="item-quantity" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="item-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="item-notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-item-btn" disabled>Add to Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="success-modal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel"><i class="fas fa-check-circle"></i> Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="success-icon mb-3">
                    <i class="fas fa-check-circle"></i>
                </div>
                <p class="lead" id="success-message-text"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" id="modal-ok-button">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="error-modal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel"><i class="fas fa-exclamation-triangle"></i> Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="error-message-text"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let customerData = null;
    let selectedPendingItems = {
        drugs: [],
        labs: [],
        scans: [],
        services: []
    };
    let cartItems = [];
    let walletBalance = 0;

    const verifyCustomerUrl = "{% url 'verify_customer_for_sales' %}";
    const addOrderItemUrl = "{% url 'add_order_item_ajax' %}";
    const processPaymentUrl = "{% url 'process_direct_sales_payment' %}";
    const drugSearchUrl = "/portal/consultation/ajax/search-drugs/";
    const labSearchUrl = "{% url 'ajax_lab_templates_search' %}";
    const scanSearchUrl = "{% url 'ajax_imaging_templates_search' %}";
    const serviceSearchUrl = "{% url 'ajax_search_services' %}";
    const itemSearchUrl = "{% url 'ajax_search_service_items' %}";

    $(document).ready(function() {
        // Customer type selection
        $('input[name="customer_type"]').on('change', function() {
            const selectedType = $(this).val();

            if (selectedType === 'patient') {
                $('#registered-patient-form').removeClass('hidden');
                $('#walk-in-customer-form').addClass('hidden');
                $('#customer_name').val(''); // Clear walk-in name
            } else {
                $('#registered-patient-form').addClass('hidden');
                $('#walk-in-customer-form').removeClass('hidden');
                $('#card_number').val(''); // Clear card number
            }

            // Reset customer data and UI
            resetCustomer();
        });

        // Patient verification
        $('#verify-patient-btn').on('click', function() {
            const cardNumber = $('#card_number').val().trim();
            if (!cardNumber) {
                showErrorModal('Please enter a card number');
                return;
            }

            // Ensure patient mode is selected
            if ($('input[name="customer_type"]:checked').val() !== 'patient') {
                showErrorModal('Please select "Registered Patient" mode first');
                return;
            }

            verifyCustomer('patient', { card_number: cardNumber });
        });

        // Walk-in verification
        $('#verify-walkin-btn').on('click', function() {
            const customerName = $('#customer_name').val().trim();
            if (!customerName) {
                showErrorModal('Please enter a customer name');
                return;
            }

            // Ensure walk-in mode is selected
            if ($('input[name="customer_type"]:checked').val() !== 'walkin') {
                showErrorModal('Please select "Walk-in Customer" mode first');
                return;
            }

            verifyCustomer('walkin', { name: customerName });
        });

        // Payment form
        $('#payment-form').on('submit', function(e) {
            e.preventDefault();
            processPayment();
        });

        // Wallet checkbox change
        $('#use_wallet').on('change', function() {
            updatePaymentBreakdown();
        });

        // Payment method change
        $('#payment_method').on('change', function() {
            $('#method-text').text($(this).find('option:selected').text());
        });

        // Modal search functionality
        setupDrugSearch();
        setupModalSearch('lab', labSearchUrl);
        setupModalSearch('scan', scanSearchUrl);
        setupModalSearch('service', serviceSearchUrl);
        setupModalSearch('item', itemSearchUrl);

        // Add buttons
        $('#add-drug-btn').on('click', function() {
            addOrderItem('drug');
        });
        $('#add-lab-btn').on('click', function() {
            addOrderItem('lab');
        });
        $('#add-scan-btn').on('click', function() {
            addOrderItem('scan');
        });
        $('#add-service-btn').on('click', function() {
            addOrderItem('service');
        });
        $('#add-item-btn').on('click', function() {
            addOrderItem('item');
        });

        // Proceed to payment
        $('#proceed-to-payment-btn').on('click', function() {
            proceedToPayment();
        });

        // Back to orders
        $('#back-to-orders-btn').on('click', function() {
            $('#payment-section').addClass('hidden');
            $('#customer-info-section').removeClass('hidden');
        });

        // Enter key in search inputs
        $('#card_number, #customer_name').on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                if ($(this).attr('id') === 'card_number') {
                    $('#verify-patient-btn').click();
                } else {
                    $('#verify-walkin-btn').click();
                }
            }
        });
    });

    function showErrorModal(message) {
        $('#error-message-text').text(message);
        const errorModal = new bootstrap.Modal(document.getElementById('error-modal'));
        errorModal.show();
    }

    function formatCurrency(amount) {
        if (typeof amount === 'number') {
            return '₦' + amount.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return '₦0.00';
    }

    function verifyCustomer(type, data) {
        $.ajax({
            url: verifyCustomerUrl,
            method: 'GET',
            data: { type: type, ...data },
            success: function(response) {
                if (response.success) {
                    customerData = response;
                    walletBalance = response.wallet.balance;

                    displayCustomerInfo(response);
                    displayPendingOrders(response.pending_orders);

                    $('#customer-info-section').removeClass('hidden');
                } else {
                    showErrorModal(response.error || 'Error verifying customer');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showErrorModal(response.error || 'Error verifying customer');
            }
        });
    }

    function displayCustomerInfo(data) {
        if (data.customer_type === 'patient') {
            const patient = data.patient;
            $('#customer-info').html(`
                <h5>${patient.full_name}</h5>
                <p class="mb-1"><strong>Card Number:</strong> ${patient.card_number}</p>
                <p class="mb-1"><strong>Phone:</strong> ${patient.phone}</p>
                <p class="mb-1"><strong>Age:</strong> ${patient.age}</p>
                <p class="mb-1"><strong>Gender:</strong> ${patient.gender}</p>
            `);

            $('#wallet-balance').text(data.wallet.formatted_balance);
            $('#wallet-balance-card').removeClass('hidden');
            $('#patient_id').val(patient.id);
            $('#customer_name').val('');
        } else {
            $('#customer-info').html(`
                <h5>${data.customer_name}</h5>
                <p class="mb-1"><strong>Type:</strong> Walk-in Customer</p>
            `);

            $('#wallet-balance-card').addClass('hidden');
            $('#patient_id').val('');
            $('#customer_name').val(data.customer_name);
        }

        $('#customer_type').val(data.customer_type);
    }

    function displayPendingOrders(pendingOrders) {
        let html = '';

        // Check for pending claims
        let pendingClaimsCount = 0;
        ['drugs', 'labs', 'scans', 'services'].forEach(category => {
            if (pendingOrders[category]) {
                pendingClaimsCount += pendingOrders[category].filter(
                    item => item.has_pending_claim
                ).length;
            }
        });

        if (pendingClaimsCount > 0) {
            html += `
                <div class="pending-claim-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>⚠️ ${pendingClaimsCount} Pending Insurance Claim(s)</strong>
                    <p class="mb-0 mt-1">
                        <small>Some items have pending insurance claims. Patient will pay full amount
                        until claims are approved.</small>
                    </p>
                </div>
            `;
        }

        if (pendingOrders.drugs && pendingOrders.drugs.length > 0) {
            html += createServiceSection('Medications', 'drugs', pendingOrders.drugs, 'fas fa-pills', '#17a2b8');
        }

        if (pendingOrders.labs && pendingOrders.labs.length > 0) {
            html += createServiceSection('Laboratory Tests', 'labs', pendingOrders.labs, 'fas fa-vial', '#28a745');
        }

        if (pendingOrders.scans && pendingOrders.scans.length > 0) {
            html += createServiceSection('Scans/Radiology', 'scans', pendingOrders.scans, 'fas fa-x-ray', '#dc3545');
        }

        if (pendingOrders.services && pendingOrders.services.length > 0) {
            html += createServiceSection('Services & Items', 'services', pendingOrders.services, 'fas fa-hand-holding-medical', '#fd7e14');
        }

        if (html === '') {
            html = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <h5>No pending orders found</h5>
                    <p>This customer has no pending orders in the last 30 days.</p>
                </div>
            `;
        }

        $('#pending-orders-section').html(html);
        updateSelectedItems();
    }

    function createServiceSection(title, type, data, icon, color) {
        let itemsHtml = '';

        data.forEach(item => {
            const orderRef = item.order_number || `ID: ${item.id}`;
            const insuranceDiscount = item.base_amount - item.amount;
            const hasDiscount = insuranceDiscount > 0.01;

            itemsHtml += `
                <div class="item-row">
                    <div class="form-check">
                        <input class="form-check-input item-checkbox" type="checkbox"
                               value="${item.id}" data-type="${type}"
                               data-amount="${item.amount}" checked>
                        <label class="form-check-label">
                            <strong>${item.name}</strong>
                            ${item.quantity && item.quantity !== 1 ? `<small class="text-muted"> (Qty: ${item.quantity})</small>` : ''}
                            <br>
                            <small class="text-muted">
                                ${orderRef} | Date: ${item.ordered_date || item.created_date}
                            </small>
                            ${item.has_approved_claim ? `
                                <br><small class="text-success">
                                    <i class="fas fa-check-circle"></i> Claim Approved: ${item.claim_number}
                                </small>
                            ` : item.has_pending_claim ? `
                                <br><small class="text-warning">
                                    <i class="fas fa-clock"></i> Pending Claim: ${item.pending_claim_number}
                                </small>
                            ` : ''}
                        </label>
                    </div>
                    <div class="text-end">
                        ${hasDiscount ? `
                            <div class="text-muted">
                                <small><s>${formatCurrency(item.base_amount)}</s></small>
                            </div>
                        ` : ''}
                        <div class="amount-display">${formatCurrency(item.amount)}</div>
                    </div>
                </div>
            `;
        });

        return `
            <div class="service-card">
                <div class="service-header">
                    <div>
                        <h6 class="mb-0">
                            <i class="${icon}" style="color: ${color}"></i> ${title}
                        </h6>
                        <small class="text-muted">${data.length} item(s)</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="toggleAllItems('${type}')">
                            Toggle All
                        </button>
                    </div>
                </div>
                ${itemsHtml}
            </div>
        `;
    }

    $(document).on('change', '.item-checkbox', function() {
        updateSelectedItems();
    });

    function createCartSection(title, type, data, icon, color) {
        let itemsHtml = '';

        data.forEach((item, index) => {
            itemsHtml += `
                <div class="item-row">
                    <div class="form-check">
                        <input class="form-check-input cart-item-checkbox" type="checkbox"
                               value="${index}" data-type="${type}"
                               data-amount="${item.amount}" checked disabled>
                        <label class="form-check-label">
                            <strong>${item.name}</strong>
                            ${item.quantity && item.quantity !== 1 ? `<small class="text-muted"> (Qty: ${item.quantity})</small>` : ''}
                        </label>
                    </div>
                    <div class="text-end">
                        <div class="amount-display">${formatCurrency(item.amount)}</div>
                        <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeCartItem(${index})">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            `;
        });

        return `
            <div class="service-card">
                <div class="service-header">
                    <div>
                        <h6 class="mb-0">
                            <i class="${icon}" style="color: ${color}"></i> ${title}
                        </h6>
                        <small class="text-muted">${data.length} item(s)</small>
                    </div>
                </div>
                ${itemsHtml}
            </div>
        `;
    }

    function removeCartItem(index) {
        if (confirm('Remove this item from cart?')) {
            cartItems.splice(index, 1);
            updateCartDisplay();
        }
    }

    function showSuccessToast(message, hasInsuranceInfo = false, insuranceMessage = '') {
        if (hasInsuranceInfo) {
            // Show modal for insurance-related messages
            showInsuranceInfoModal(message, insuranceMessage);
        }
        // For non-insurance messages, just silently succeed (no alert, no toast)
    }

    function showInsuranceInfoModal(message, insuranceMessage) {
        const modalBody = `
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle"></i> <strong>${message}</strong>
            </div>
            <div class="alert alert-warning">
                <i class="fas fa-shield-alt"></i> <strong>Insurance Information:</strong>
                <p class="mb-0 mt-2">${insuranceMessage}</p>
            </div>
        `;

        $('#messageModalBody').html(modalBody);
        $('#messageModalLabel').text('Order Added');
        $('#messageModalHeader').removeClass().addClass('modal-header bg-info text-white');

        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        modal.show();
    }

    function toggleAllItems(type) {
        const checkboxes = $(`.item-checkbox[data-type="${type}"]`);
        const allChecked = checkboxes.filter(':checked').length === checkboxes.length;
        checkboxes.prop('checked', !allChecked);
        updateSelectedItems();
    }

    function updateSelectedItems() {
        selectedPendingItems = { drugs: [], labs: [], scans: [], services: [] };

        $('.item-checkbox:checked').each(function() {
            const type = $(this).data('type');
            const id = $(this).val();

            if (selectedPendingItems.hasOwnProperty(type)) {
                selectedPendingItems[type].push(id);
            }
        });

        // Update proceed button state
        const hasSelectedItems = Object.values(selectedPendingItems).some(arr => arr.length > 0) || cartItems.length > 0;
        $('#proceed-to-payment-btn').prop('disabled', !hasSelectedItems);
    }

    function setupModalSearch(type, searchUrl) {
        const searchInput = $(`#${type}-search`);
        const resultsContainer = $(`#${type}-search-results`);
        let searchTimeout;

        searchInput.on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val().trim();

            if (query.length < 2) {
                resultsContainer.hide().empty();
                return;
            }

            searchTimeout = setTimeout(() => {
                $.ajax({
                    url: searchUrl,
                    method: 'GET',
                    data: { q: query },
                    success: function(response) {
                        resultsContainer.empty();

                        if (response.templates && response.templates.length > 0) {
                            response.templates.forEach(item => {
                                const resultItem = $('<a>')
                                    .addClass('list-group-item list-group-item-action')
                                    .html(`
                                        ${item.name} - ₦${item.price}
                                        ${item.stock !== undefined ? `<small class="text-muted"> (Stock: ${item.stock})</small>` : ''}
                                    `)
                                    .attr('href', '#')
                                    .data('item', item);

                                resultsContainer.append(resultItem);
                            });
                            resultsContainer.show();
                        } else {
                            resultsContainer.html('<span class="list-group-item">No results found</span>');
                            resultsContainer.show();
                        }
                    },
                    error: function() {
                        resultsContainer.html('<span class="list-group-item">Error loading results</span>');
                        resultsContainer.show();
                    }
                });
            }, 300);
        });

        // Handle item selection
        resultsContainer.on('click', 'a', function(e) {
            e.preventDefault();
            const item = $(this).data('item');
            selectModalItem(type, item);
        });

        // Hide results when clicking outside
        $(document).on('click', function(e) {
            if (!searchInput.is(e.target) && !resultsContainer.is(e.target) && resultsContainer.has(e.target).length === 0) {
                resultsContainer.hide();
            }
        });
    }

    function selectDrug(drug) {
        // Hide search results
        $('#drug-search-results').hide().empty();

        // Update selected drug details
        const displayName = `${drug.brand_name || drug.generic_name} (${drug.formulation})`;
        $('#selected-drug-name').text(displayName);
        $('#selected-drug-price').text(drug.selling_price);
        $('#selected-drug-stock').text(drug.pharmacy_quantity);

        // Show details section
        $('#drug-details').removeClass('hidden');

        // Enable add button
        $('#add-drug-btn').prop('disabled', false);

        // Store selected drug data
        $('#drug-details').data('selected-item', drug);
    }

    function setupDrugSearch() {
        const searchInput = $('#drug-search');
        const resultsContainer = $('#drug-search-results');
        let searchTimeout;

        searchInput.on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val().trim();

            if (query.length < 2) {
                resultsContainer.hide().empty();
                return;
            }

            searchTimeout = setTimeout(() => {
                $.ajax({
                    url: drugSearchUrl,
                    method: 'GET',
                    data: { q: query },
                    success: function(response) {
                        resultsContainer.empty();

                        if (response.drugs && response.drugs.length > 0) {
                            response.drugs.forEach(drug => {
                                const displayName = `${drug.brand_name || drug.generic_name} (${drug.formulation}) - Stock: ${drug.pharmacy_quantity}`;

                                const resultItem = $('<a>')
                                    .addClass('list-group-item list-group-item-action')
                                    .text(displayName)
                                    .attr('href', '#')
                                    .data('drug', drug);

                                resultsContainer.append(resultItem);
                            });
                            resultsContainer.show();
                        } else {
                            resultsContainer.html('<span class="list-group-item">No drugs found</span>');
                            resultsContainer.show();
                        }
                    },
                    error: function() {
                        resultsContainer.html('<span class="list-group-item">Error loading drugs</span>');
                        resultsContainer.show();
                    }
                });
            }, 300);
        });

        // Handle drug selection
        resultsContainer.on('click', 'a', function(e) {
            e.preventDefault();
            const drug = $(this).data('drug');
            selectDrug(drug);
        });

        // Hide results when clicking outside
        $(document).on('click', function(e) {
            if (!searchInput.is(e.target) && !resultsContainer.is(e.target) && resultsContainer.has(e.target).length === 0) {
                resultsContainer.hide();
            }
        });
    }

    function selectModalItem(type, item) {
        // Hide search results
        $(`#${type}-search-results`).hide().empty();

        // Update selected item details
        $(`#selected-${type}-name`).text(item.name);
        $(`#selected-${type}-price`).text(item.price);

        if (item.stock !== undefined) {
            $(`#selected-${type}-stock`).text(item.stock);
        }

        // Show details section
        $(`#${type}-details`).removeClass('hidden');

        // Enable add button
        $(`#add-${type}-btn`).prop('disabled', false);

        // Store selected item data
        $(`#${type}-details`).data('selected-item', item);
    }

    function addOrderItem(type) {
        const detailsSection = $(`#${type}-details`);
        const selectedItem = detailsSection.data('selected-item');

        if (!selectedItem) {
            showErrorModal('Please select an item first');
            return;
        }

        const data = {
            customer_type: customerData.customer_type,
            item_type: type,
            item_id: selectedItem.id
        };

        if (customerData.customer_type === 'patient') {
            data.patient_id = customerData.patient.id;
        } else {
            data.customer_name = customerData.customer_name;
        }

        // Add type-specific data
        if (type === 'drug') {
            const quantity = parseInt($('#drug-quantity').val());
            if (!quantity || quantity < 1) {
                showErrorModal('Please enter a valid quantity');
                return;
            }
            data.quantity = quantity;
            data.dosage = $('#drug-dosage').val().trim();
            data.duration = $('#drug-duration').val().trim();
            data.notes = $('#drug-notes').val().trim();
        } else if (type === 'lab') {
            data.instructions = $('#lab-instructions').val().trim();
        } else if (type === 'scan') {
            data.indication = $('#scan-indication').val().trim();
        } else if (type === 'service') {
            const quantity = parseInt($('#service-quantity').val());
            if (!quantity || quantity < 1) {
                showErrorModal('Please enter a valid quantity');
                return;
            }
            data.quantity = quantity;
            data.notes = $('#service-notes').val().trim();
        } else if (type === 'item') {
            const quantity = parseInt($('#item-quantity').val());
            if (!quantity || quantity < 1) {
                showErrorModal('Please enter a valid quantity');
                return;
            }
            data.quantity = quantity;
            data.notes = $('#item-notes').val().trim();
        }

        // Show loading state
        const addBtn = $(`#add-${type}-btn`);
        const originalText = addBtn.html();
        addBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Adding...');

        $.ajax({
            url: addOrderItemUrl,
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            success: function(response) {
                if (response.success) {
                    // Close modal
                    $(`#${type}Modal`).modal('hide');

                    // Reset modal
                    resetModal(type);

                    // For registered patients, add to pending list
                    if (customerData.customer_type === 'patient') {
                        addOrderToPendingList(type, response.order);

                        // Show insurance info modal if applicable
                        const order = response.order;
                        if (order.has_pending_claim || order.has_approved_claim) {
                            let insuranceMsg = '';
                            if (order.has_pending_claim) {
                                insuranceMsg = `A pending insurance claim (${order.pending_claim_number}) exists for this item. Patient will pay full amount until claim is approved.`;
                            } else if (order.has_approved_claim) {
                                insuranceMsg = `An approved insurance claim (${order.claim_number}) exists for this item. Discounted amount will be charged.`;
                            }
                            showSuccessToast(response.message || 'Item added successfully', true, insuranceMsg);
                        }
                        // For items without insurance, no notification needed
                    } else {
                        // For walk-ins, add to cart (no notification needed)
                        cartItems.push(response.order);
                        updateCartDisplay();
                    }
                } else {
                    showErrorModal(response.error || 'Error adding item');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showErrorModal(response?.error || 'Error adding item');
            },
            complete: function() {
                addBtn.prop('disabled', false).html(originalText);
            }
        });
    }

    function addOrderToPendingList(type, order) {
        // Find the appropriate section
        const sectionMap = {
            'drug': 'drugs',
            'lab': 'labs',
            'scan': 'scans',
            'service': 'services',
            'item': 'services'
        };

        const section = sectionMap[type];
        if (!section) return;

        // Create new item row
        const orderRef = order.order_number || `ID: ${order.id}`;
        const insuranceDiscount = order.base_amount - order.amount;
        const hasDiscount = insuranceDiscount > 0.01;

        const newItem = $(`
            <div class="item-row">
                <div class="form-check">
                    <input class="form-check-input item-checkbox" type="checkbox"
                           value="${order.id}" data-type="${section}"
                           data-amount="${order.amount}" checked>
                    <label class="form-check-label">
                        <strong>${order.name}</strong>
                        ${order.quantity && order.quantity !== 1 ? `<small class="text-muted"> (Qty: ${order.quantity})</small>` : ''}
                        <br>
                        <small class="text-muted">
                            ${orderRef} | Date: ${new Date().toISOString().split('T')[0]}
                        </small>
                        ${order.has_pending_claim ? `
                            <br><small class="text-warning">
                                <i class="fas fa-clock"></i> Pending Claim: ${order.pending_claim_number}
                            </small>
                        ` : ''}
                    </label>
                </div>
                <div class="text-end">
                    ${hasDiscount ? `
                        <div class="text-muted">
                            <small><s>${formatCurrency(order.base_amount)}</s></small>
                        </div>
                    ` : ''}
                    <div class="amount-display">${formatCurrency(order.amount)}</div>
                </div>
            </div>
        `);

        // Find the service card and append the new item
        const serviceCard = $(`.service-card:has(.item-checkbox[data-type="${section}"])`);
        if (serviceCard.length > 0) {
            serviceCard.find('.item-row:last').after(newItem);
        } else {
            // If no section exists, create one
            const iconMap = {
                'drugs': 'fas fa-pills',
                'labs': 'fas fa-vial',
                'scans': 'fas fa-x-ray',
                'services': 'fas fa-hand-holding-medical'
            };

            const colorMap = {
                'drugs': '#17a2b8',
                'labs': '#28a745',
                'scans': '#dc3545',
                'services': '#fd7e14'
            };

            const titleMap = {
                'drugs': 'Medications',
                'labs': 'Laboratory Tests',
                'scans': 'Scans/Radiology',
                'services': 'Services & Items'
            };

            const newSection = $(`
                <div class="service-card">
                    <div class="service-header">
                        <div>
                            <h6 class="mb-0">
                                <i class="${iconMap[section]}" style="color: ${colorMap[section]}"></i> ${titleMap[section]}
                            </h6>
                            <small class="text-muted">1 item(s)</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="toggleAllItems('${section}')">
                                Toggle All
                            </button>
                        </div>
                    </div>
                    ${newItem.prop('outerHTML')}
                </div>
            `);

            $('#pending-orders-section').append(newSection);
        }

        // Update selected items
        updateSelectedItems();
    }

    function updateCartDisplay() {
        if (cartItems.length === 0) {
            $('#pending-orders-section').html(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <h5>Cart is empty</h5>
                    <p>Add items using the buttons above.</p>
                </div>
            `);
            updateSelectedItems();
            return;
        }

        // Group cart items by type
        const groupedItems = {
            drugs: [],
            labs: [],
            scans: [],
            services: []
        };

        cartItems.forEach(item => {
            const type = item.item_type;
            if (type === 'drug') {
                groupedItems.drugs.push(item);
            } else if (type === 'lab') {
                groupedItems.labs.push(item);
            } else if (type === 'scan') {
                groupedItems.scans.push(item);
            } else if (type === 'service' || type === 'item') {
                groupedItems.services.push(item);
            }
        });

        // Build display HTML
        let html = '';

        if (groupedItems.drugs.length > 0) {
            html += createCartSection('Medications', 'drugs', groupedItems.drugs, 'fas fa-pills', '#17a2b8');
        }

        if (groupedItems.labs.length > 0) {
            html += createCartSection('Laboratory Tests', 'labs', groupedItems.labs, 'fas fa-vial', '#28a745');
        }

        if (groupedItems.scans.length > 0) {
            html += createCartSection('Scans/Radiology', 'scans', groupedItems.scans, 'fas fa-x-ray', '#dc3545');
        }

        if (groupedItems.services.length > 0) {
            html += createCartSection('Services & Items', 'services', groupedItems.services, 'fas fa-hand-holding-medical', '#fd7e14');
        }

        $('#pending-orders-section').html(html);
        updateSelectedItems();
    }

    function resetModal(type) {
        // Clear search
        $(`#${type}-search`).val('');

        // Hide details
        $(`#${type}-details`).addClass('hidden');

        // Clear form fields
        $(`#${type}-details input, #${type}-details textarea`).val('');

        // Disable add button
        $(`#add-${type}-btn`).prop('disabled', true);

        // Clear selected item data
        $(`#${type}-details`).removeData('selected-item');
    }

    function proceedToPayment() {
        if (!customerData) {
            showErrorModal('Please verify customer information first');
            return;
        }

        // Check if there are items to pay for
        const hasSelectedItems = Object.values(selectedPendingItems).some(arr => arr.length > 0) || cartItems.length > 0;

        if (!hasSelectedItems) {
            showErrorModal('Please select at least one item to pay for');
            return;
        }

        // Move to payment section
        $('#customer-info-section').addClass('hidden');
        $('#payment-section').removeClass('hidden');

        // Update payment breakdown
        updatePaymentBreakdown();
    }

    function updatePaymentBreakdown() {
        let totalAmount = 0;

        // Calculate total from selected pending items
        $('.item-checkbox:checked').each(function() {
            totalAmount += parseFloat($(this).data('amount'));
        });

        // Add cart items for walk-ins
        cartItems.forEach(item => {
            totalAmount += item.amount;
        });

        const useWallet = $('#use_wallet').is(':checked');

        let walletUsed = 0;
        if (useWallet && walletBalance > 0 && customerData && customerData.customer_type === 'patient') {
            walletUsed = Math.min(walletBalance, totalAmount);
        }

        const remaining = totalAmount - walletUsed;

        $('#total-amount-display').text(formatCurrency(totalAmount));
        $('#wallet-amount-display').text('- ' + formatCurrency(walletUsed));
        $('#remaining-amount-display').text(formatCurrency(remaining));
        $('#direct_amount').val(remaining.toFixed(2));

        // Show/hide wallet row based on customer type and balance
        if (customerData && customerData.customer_type === 'patient' && walletBalance > 0) {
            $('#wallet-usage-row').show();
        } else {
            $('#wallet-usage-row').hide();
            $('#use_wallet').prop('checked', false);
        }
    }

    function processPayment() {
        if (!customerData) {
            showErrorModal('Please verify customer information first');
            return;
        }

        // Prepare JSON payload
        const payload = {
            customer_type: customerData.customer_type,
            payment_method: $('#payment_method').val(),
            use_wallet: $('#use_wallet').is(':checked'),
            selected_pending: selectedPendingItems,
            cart_items: cartItems
        };

        // Add customer-specific data
        if (customerData.customer_type === 'patient') {
            payload.patient_id = customerData.patient.id;
        } else {
            payload.customer_name = customerData.customer_name;
        }

        $('#submit-payment').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm"></span> Processing...');

        $.ajax({
            url: processPaymentUrl,
            method: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            success: function(response) {
                if (response.success) {
                    // Show success message briefly
                    $('#success-message-text').text(response.message);
                    const successModal = new bootstrap.Modal(document.getElementById('success-modal'));
                    successModal.show();

                    // Redirect after 2 seconds
                    setTimeout(function() {
                        if (response.transaction_id) {
                            window.location.href = `/portal/finance/transactions/${response.transaction_id}/`;
                        } else {
                            // Fallback to transactions list if no ID
                            window.location.href = '/portal/finance/transactions/';
                        }
                    }, 2000);
                } else {
                    showErrorModal(response.error || 'Error processing payment');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showErrorModal(response?.error || 'Error processing payment');
            },
            complete: function() {
                $('#submit-payment').prop('disabled', false)
                    .html('<i class="fas fa-check-circle"></i> Complete Payment');
            }
        });
    }

    function resetCustomer() {
        // Clear customer data
        customerData = null;
        walletBalance = 0;
        selectedPendingItems = { drugs: [], labs: [], scans: [], services: [] };
        cartItems = [];

        // Hide sections
        $('#customer-info-section').addClass('hidden');
        $('#payment-section').addClass('hidden');
        $('#wallet-balance-card').addClass('hidden');

        // Clear input fields
        $('#card_number').val('');
        $('#customer_name').val('');

        // Clear customer info display
        $('#customer-info').empty();
        $('#pending-orders-section').empty();

        // Disable proceed button
        $('#proceed-to-payment-btn').prop('disabled', true);

        // Clear hidden form fields
        $('#customer_type').val('');
        $('#patient_id').val('');
    }

    function resetAll() {
        resetCustomer();
        selectedPendingItems = { drugs: [], labs: [], scans: [], services: [] };
        cartItems = [];
        $('#pending-orders-section').empty();
        $('.item-checkbox').prop('checked', false);
        $('#proceed-to-payment-btn').prop('disabled', true);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}