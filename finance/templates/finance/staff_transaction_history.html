{% extends 'admin_site/layout.html' %}
{% load static humanize %}
{% block 'main' %}
<style>
.report-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 24px;
    margin-bottom: 20px;
}
.report-header {
    border-bottom: 2px solid #4472C4;
    padding-bottom: 16px;
    margin-bottom: 24px;
}
.filters-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 24px;
}
.form-group {
    margin-bottom: 16px;
}
.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}
.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
}
.btn-primary {
    background: #4472C4;
    color: white;
}
.btn-success {
    background: #28a745;
    color: white;
}
.btn-info {
    background: #17a2b8;
    color: white;
}
.controls-bar {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 20px;
}
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.summary-card {
    background: linear-gradient(135deg, #4472C4 0%, #365a99 100%);
    color: white;
    padding: 16px;
    border-radius: 8px;
}
.summary-card h4 {
    margin: 0 0 8px 0;
    font-size: 12px;
    opacity: 0.9;
}
.summary-card .count {
    font-size: 28px;
    font-weight: 700;
}
.summary-card .amount {
    font-size: 14px;
    margin-top: 4px;
    opacity: 0.9;
}
.section-title {
    font-size: 18px;
    font-weight: 700;
    color: #4472C4;
    margin-top: 32px;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #4472C4;
}
.transaction-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
}
.transaction-table th {
    background: #4472C4;
    color: white;
    padding: 10px;
    text-align: left;
    font-size: 11px;
}
.transaction-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #e0e0e0;
    font-size: 12px;
}
.transaction-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}
.table-responsive {
    overflow-x: auto;
}
</style>

<div class="report-container">
    <div class="report-header">
        <h2>Staff Transaction History</h2>
        <p style="color: #666; margin: 0;">Detailed transaction log for {{ staff.get_full_name|default:staff.username }}</p>
    </div>

    <div class="filters-section">
        <form method="get" id="reportForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="form-group">
                    <label for="from_date">From Date</label>
                    <input type="date" name="from_date" id="from_date" class="form-control" value="{{ from_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="to_date">To Date</label>
                    <input type="date" name="to_date" id="to_date" class="form-control" value="{{ to_date|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="staff_id">Staff Member</label>
                    <select name="staff_id" id="staff_id" class="form-control">
                        <option value="">Me ({{ request.user.username }})</option>
                        {% for s in all_staff %}
                        <option value="{{ s.id }}" {% if staff.id == s.id %}selected{% endif %}>
                            {{ s.get_full_name|default:s.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </div>
        </form>
    </div>

    <div class="controls-bar">
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-info" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <h4>Registrations</h4>
            <div class="count">{{ summary.total_registrations }}</div>
            <div class="amount">₦{{ summary.total_reg_amount|floatformat:2|intcomma }}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
            <h4>Transactions</h4>
            <div class="count">{{ summary.total_transactions }}</div>
            <div class="amount">₦{{ summary.total_transaction_amount|floatformat:2|intcomma }}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%);">
            <h4>Expenses</h4>
            <div class="count">{{ summary.total_expenses }}</div>
            <div class="amount">₦{{ summary.total_expense_amount|floatformat:2|intcomma }}</div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">
            <h4>Withdrawals</h4>
            <div class="count">{{ summary.total_withdrawals }}</div>
            <div class="amount">₦{{ summary.total_withdrawal_amount|floatformat:2|intcomma }}</div>
        </div>
    </div>

    <!-- Registrations -->
    {% if registrations %}
    <div class="section-title">Registrations</div>
    <div class="table-responsive">
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Patient Name</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in registrations %}
                <tr>
                    <td>{{ reg.transaction_id }}</td>
                    <td>{{ reg.full_name }}</td>
                    <td>₦{{ reg.amount|floatformat:2|intcomma }}</td>
                    <td>{{ reg.payment_method|upper }}</td>
                    <td>{{ reg.date|date:"Y-m-d" }}</td>
                    <td>{{ reg.registration_status|upper }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Patient Transactions -->
    {% if patient_transactions %}
    <div class="section-title">Patient Transactions</div>
    <div class="table-responsive">
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Patient</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for trans in patient_transactions %}
                <tr>
                    <td>{{ trans.transaction_id }}</td>
                    <td>{{ trans.patient.first_name }} {{ trans.patient.last_name }}</td>
                    <td>{{ trans.get_transaction_type_display }}</td>
                    <td>₦{{ trans.direct_payment_amount|floatformat:2|intcomma }}</td>
                    <td>{{ trans.payment_method|upper }}</td>
                    <td>{{ trans.date|date:"Y-m-d" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Expenses -->
    {% if expenses %}
    <div class="section-title">Expenses</div>
    <div class="table-responsive">
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Expense Number</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in expenses %}
                <tr>
                    <td>{{ exp.expense_number }}</td>
                    <td>{{ exp.title }}</td>
                    <td>{{ exp.category.name }}</td>
                    <td>₦{{ exp.amount|floatformat:2|intcomma }}</td>
                    <td>{{ exp.payment_method|upper }}</td>
                    <td>{{ exp.date|date:"Y-m-d" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Withdrawals -->
    {% if withdrawals %}
    <div class="section-title">Wallet Withdrawals</div>
    <div class="table-responsive">
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for withdrawal in withdrawals %}
                <tr>
                    <td>{{ withdrawal.patient.first_name }} {{ withdrawal.patient.last_name }}</td>
                    <td>₦{{ withdrawal.amount|floatformat:2|intcomma }}</td>
                    <td>{{ withdrawal.withdrawal_date|date:"Y-m-d H:i" }}</td>
                    <td>{{ withdrawal.notes|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if not registrations and not patient_transactions and not expenses and not withdrawals %}
    <div style="text-align: center; padding: 60px 20px; color: #999;">
        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
        <p>No transactions found for the selected period.</p>
    </div>
    {% endif %}
</div>

<script>
function getParams() {
    const fromDate = document.getElementById('from_date').value;
    const toDate = document.getElementById('to_date').value;
    const staffId = document.getElementById('staff_id').value;

    return new URLSearchParams({
        from_date: fromDate,
        to_date: toDate,
        staff_id: staffId
    });
}

function exportToExcel() {
    const params = getParams();
    window.location.href = `{% url 'staff_history_export_excel' %}?${params.toString()}`;
}

function exportToPDF() {
    const params = getParams();
    window.location.href = `{% url 'staff_history_export_pdf' %}?${params.toString()}`;
}
</script>
{% endblock %}