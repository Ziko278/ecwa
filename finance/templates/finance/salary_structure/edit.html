{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}

<div class="col-12">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="card-title mb-0">Edit Salary Structure</h4>
                    <small class="text-muted">For: {{ form.instance.staff|title }}</small>
                </div>
                <a href="{% url 'salary_structure_detail' form.instance.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Detail
                </a>
            </div>

            {% include 'admin_site/partials/error.html' %}

            <form method="POST" action="">
                {% csrf_token %}
                <div class="row">
                    <!-- Left Column: Form Inputs -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Salary Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Staff Member</label>
                                        <!-- Display the name in a disabled input for UI purposes -->
                                        <input type="text" class="form-control" value="{{ form.instance.staff|title }}" disabled readonly>
                                        <!-- Include the actual field as a hidden input to ensure it's submitted -->
                                        {{ form.staff.as_hidden }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.effective_from.id_for_label }}" class="form-label">Effective From <span class="text-danger">*</span></label>
                                        {{ form.effective_from }}
                                    </div>

                                    <h6 class="mt-3">Earnings</h6>
                                    <hr>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.basic_salary.id_for_label }}" class="form-label">Basic Salary (₦) <span class="text-danger">*</span></label>
                                        {{ form.basic_salary }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.housing_allowance.id_for_label }}" class="form-label">Housing Allowance (₦)</label>
                                        {{ form.housing_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.transport_allowance.id_for_label }}" class="form-label">Transport Allowance (₦)</label>
                                        {{ form.transport_allowance }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.medical_allowance.id_for_label }}" class="form-label">Medical Allowance (₦)</label>
                                        {{ form.medical_allowance }}
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.other_allowances.id_for_label }}" class="form-label">Other Allowances (₦)</label>
                                        {{ form.other_allowances }}
                                    </div>

                                    <h6 class="mt-3">Deduction Rates</h6>
                                    <hr>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tax_rate.id_for_label }}" class="form-label">Tax Rate (%)</label>
                                        {{ form.tax_rate }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.pension_rate.id_for_label }}" class="form-label">Pension Rate (%)</label>
                                        {{ form.pension_rate }}
                                    </div>

                                    <div class="col-12 mt-3">
                                         <div class="form-check">
                                            {{ form.is_active }}
                                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                                Set as Active Salary Structure
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Summary & Actions -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Live Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gross Salary:</span>
                                    <strong id="summary-gross">₦0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Tax Amount:</span>
                                    <strong id="summary-tax" class="text-danger">₦0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Pension Amount:</span>
                                    <strong id="summary-pension" class="text-danger">₦0.00</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between h4">
                                    <strong>Net Salary:</strong>
                                    <strong id="summary-net" class="text-success">₦0.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" name="save" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const salaryInputs = [
        'id_basic_salary', 'id_housing_allowance', 'id_transport_allowance',
        'id_medical_allowance', 'id_other_allowances', 'id_tax_rate', 'id_pension_rate'
    ];

    const grossEl = document.getElementById('summary-gross');
    const taxEl = document.getElementById('summary-tax');
    const pensionEl = document.getElementById('summary-pension');
    const netEl = document.getElementById('summary-net');

    function formatCurrency(num) {
        return '₦' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function calculateSalary() {
        // Earnings
        const basic = parseFloat(document.getElementById('id_basic_salary').value) || 0;
        const housing = parseFloat(document.getElementById('id_housing_allowance').value) || 0;
        const transport = parseFloat(document.getElementById('id_transport_allowance').value) || 0;
        const medical = parseFloat(document.getElementById('id_medical_allowance').value) || 0;
        const others = parseFloat(document.getElementById('id_other_allowances').value) || 0;

        // Deduction Rates
        const taxRate = parseFloat(document.getElementById('id_tax_rate').value) || 0;
        const pensionRate = parseFloat(document.getElementById('id_pension_rate').value) || 0;

        // Calculations mimicking the model's logic
        const gross = basic + housing + transport + medical + others;
        const taxAmount = gross * (taxRate / 100);
        const pensionAmount = basic * (pensionRate / 100);
        const net = gross - taxAmount - pensionAmount;

        // Update the summary display
        grossEl.textContent = formatCurrency(gross);
        taxEl.textContent = formatCurrency(taxAmount);
        pensionEl.textContent = formatCurrency(pensionAmount);
        netEl.textContent = formatCurrency(net);
    }

    salaryInputs.forEach(id => {
        const inputEl = document.getElementById(id);
        if (inputEl) {
            inputEl.addEventListener('input', calculateSalary);
        }
    });

    // Initial calculation on page load
    calculateSalary();
});
</script>

{% endblock %}

