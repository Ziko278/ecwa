{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="pagetitle">
    <h1>Surgery Type Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inpatient_dashboard' %}">Inpatient</a></li>
            <li class="breadcrumb-item"><a href="{% url 'surgery_type_index' %}">Surgery Types</a></li>
            <li class="breadcrumb-item active">{{ surgery_type.name }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <!-- Left column for details -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <i class="bi bi-activity display-1 text-primary"></i>
                    <h2>{{ surgery_type.name }}</h2>
                    <h3>{{ surgery_type.get_category_display }}</h3>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Procedure Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Surgeon Fee</strong>
                            <span>₦{{ surgery_type.base_surgeon_fee|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Anesthesia Fee</strong>
                            <span>₦{{ surgery_type.base_anesthesia_fee|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Facility Fee</strong>
                            <span>₦{{ surgery_type.base_facility_fee|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Total Base Fee</strong>
                            <span class="fw-bold">₦{{ surgery_type.total_base_fee|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Est. Duration</strong>
                            <span>{{ surgery_type.estimated_duration_hours|default:"N/A" }} hrs</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Typical Stay</strong>
                            <span>{{ surgery_type.typical_stay_days|default:"N/A" }} days</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Requires ICU?</strong>
                            <span>{% if surgery_type.requires_icu %}Yes{% else %}No{% endif %}</span>
                        </li>
                    </ul>
                     <a href="{% url 'surgery_type_edit' surgery_type.pk %}" class="btn btn-primary w-100 mt-3">Edit Details</a>
                </div>
            </div>
        </div>

        <!-- Right column for package management -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body pt-3">
                    <!-- Bordered Tabs -->
                    <ul class="nav nav-tabs nav-tabs-bordered">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#drugs-tab">Included Drugs</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#labs-tab">Included Lab Tests</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#scans-tab">Included Scans</button>
                        </li>
                    </ul>

                    <div class="tab-content pt-2">
                        <!-- Drugs Tab Pane -->
                        <div class="tab-pane fade show active" id="drugs-tab">
                            {% include './partials/package_drug.html' %}
                        </div>

                        <!-- Labs Tab Pane -->
                        <div class="tab-pane fade" id="labs-tab">
                            {% include './partials/package_lab.html' %}
                        </div>

                        <!-- Scans Tab Pane -->
                        <div class="tab-pane fade" id="scans-tab">
                            {% include './partials/package_scan.html' %}
                        </div>
                    </div><!-- End Bordered Tabs -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reusable Modals -->
<!-- Information Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Notification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="infoModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        Are you sure you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>


<!-- Include jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    const csrfToken = "{{ csrf_token }}";
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // Reusable modal functions
    function showInfoModal(title, message, isError = false) {
        const modalTitle = $('#infoModalLabel');
        modalTitle.text(title);
        $('#infoModalBody').text(message);
        if (isError) {
            modalTitle.addClass('text-danger').removeClass('text-success');
        } else {
            modalTitle.addClass('text-success').removeClass('text-danger');
        }
        infoModal.show();
    }

    function showConfirmModal(title, message, onConfirm) {
        $('#confirmModalLabel').text(title);
        $('#confirmModalBody').text(message);
        $('#confirmModalBtn').off('click').on('click', function() {
            onConfirm();
            confirmModal.hide();
        });
        confirmModal.show();
    }


    // Generic function to handle adding items to the package
    function addItem(type, data, url, tableBodyId, emptyRowId) {
        $.post(url, data)
            .done(function(response) {
                if (response.success) {
                    const item = response[type];
                    const newRow = `
                        <tr id="${type}-${item.id}">
                            <td>${item.name}</td>
                            ${type === 'drug' ? '<td>' + item.quantity + '</td>' : ''}
                            <td>${item.timing || 'N/A'}</td>
                            <td>${item.is_optional ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="btn btn-danger btn-sm remove-item-btn" data-type="${type}" data-id="${item.id}">Remove</button>
                            </td>
                        </tr>`;
                    $('#' + tableBodyId).append(newRow);
                    $('#' + emptyRowId).hide();
                    $(`#add${type.charAt(0).toUpperCase() + type.slice(1)}Modal`).modal('hide'); // e.g. #addDrugModal
                    showInfoModal('Success', response.message);
                } else {
                    showInfoModal('Error', response.error, true);
                }
            })
            .fail(function() {
                showInfoModal('Server Error', 'An unexpected server error occurred.', true);
            });
    }

    // Generic function to handle removing items from the package
    $(document).on('click', '.remove-item-btn', function() {
        const type = $(this).data('type');
        const itemId = $(this).data('id');
        const removeUrl = `/portal/inpatient/surgery-types/{{ surgery_type.pk }}/remove-${type}/${itemId}/`;
        const tableBodyId = `${type}s-table-body`;
        const emptyRowId = `no-${type}s-row`;

        const confirmationCallback = function() {
            $.post(removeUrl, { csrfmiddlewaretoken: csrfToken })
                .done(function(response) {
                    if (response.success) {
                        $(`#${type}-${itemId}`).remove();
                        if ($('#' + tableBodyId).children('tr').length === 1 && $('#' + tableBodyId).find('tr[id^="no-"]').length > 0) {
                            $('#' + emptyRowId).show();
                        }
                        showInfoModal('Success', response.message);
                    } else {
                        showInfoModal('Error', response.error, true);
                    }
                })
                .fail(function() {
                    showInfoModal('Server Error', 'An unexpected error occurred.', true);
                });
        };

        showConfirmModal('Confirm Deletion', `Are you sure you want to remove this ${type}?`, confirmationCallback);
    });

    // Handle Drug Add
    $('#add-drug-form').on('submit', function(e) {
        e.preventDefault();
        const data = {
            drug_id: $('#drug-search-id').val(),
            quantity: $('#drug-quantity').val(),
            timing: $('#drug-timing').val(),
            is_optional: $('#drug-is-optional').is(':checked'),
            csrfmiddlewaretoken: csrfToken
        };
        if (!data.drug_id) {
            showInfoModal('Validation Error', 'Please search and select a drug.', true);
            return;
        }
        addItem('drug', data, $(this).attr('action'), 'drugs-table-body', 'no-drugs-row');
    });

    // Handle Lab Add
     $('#add-lab-form').on('submit', function(e) {
        e.preventDefault();
        const data = {
            lab_id: $('#lab-search-id').val(),
            timing: $('#lab-timing').val(),
            is_optional: $('#lab-is-optional').is(':checked'),
            csrfmiddlewaretoken: csrfToken
        };
        if (!data.lab_id) {
            showInfoModal('Validation Error', 'Please search and select a lab test.', true);
            return;
        }
        addItem('lab', data, $(this).attr('action'), 'labs-table-body', 'no-labs-row');
    });

    // Handle Scan Add
     $('#add-scan-form').on('submit', function(e) {
        e.preventDefault();
        const data = {
            scan_id: $('#scan-search-id').val(),
            timing: $('#scan-timing').val(),
            is_optional: $('#scan-is-optional').is(':checked'),
            csrfmiddlewaretoken: csrfToken
        };
        if (!data.scan_id) {
            showInfoModal('Validation Error', 'Please search and select a scan.', true);
            return;
        }
        addItem('scan', data, $(this).attr('action'), 'scans-table-body', 'no-scans-row');
    });

    // Generic search functionality
    function setupSearch(inputId, resultsId, url) {
        $('#' + inputId).on('keyup', function() {
            const query = $(this).val();
            const resultsContainer = $('#' + resultsId);
            if (query.length < 2) {
                resultsContainer.hide();
                return;
            }
            $.get(url, { q: query }, function(data) {
                resultsContainer.empty().show();
                if (data.results && data.results.length > 0) {
                    data.results.forEach(function(item) {
                        resultsContainer.append(`<a href="#" class="list-group-item list-group-item-action" data-id="${item.id}" data-name="${item.name}">${item.name}</a>`);
                    });
                } else {
                    resultsContainer.append('<span class="list-group-item">No results found</span>');
                }
            });
        });

        // Handle result selection
        $(document).on('click', '#' + resultsId + ' a', function(e) {
            e.preventDefault();
            const selectedId = $(this).data('id');
            const selectedName = $(this).data('name');
            const searchInput = $('#' + inputId);
            const hiddenIdInput = $('#' + inputId.replace('-search', '-search-id')); // e.g. drug-search -> drug-search-id

            searchInput.val(selectedName);
            hiddenIdInput.val(selectedId);
            $('#' + resultsId).hide();
        });
    }

    // Initialize searches
    setupSearch('drug-search', 'drug-search-results', "{% url 'search_drugs_for_surgery' %}");
    setupSearch('lab-search', 'lab-search-results', "{% url 'search_lab_tests_for_surgery' %}");
    setupSearch('scan-search', 'scan-search-results', "{% url 'search_scans_for_surgery' %}");

    // Hide results when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.search-wrapper').length) {
            $('.search-results').hide();
        }
    });
});
</script>

<style>
.search-wrapper {
    position: relative;
}
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1055; /* Higher than modal's z-index */
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    background-color: #fff;
}
</style>

{% endblock %}

