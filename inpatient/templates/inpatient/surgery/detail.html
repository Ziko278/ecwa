{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="pagetitle">
    <h1>Surgery Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inpatient_dashboard' %}">Inpatient</a></li>
            <li class="breadcrumb-item"><a href="{% url 'surgery_index' %}">Surgeries</a></li>
            <li class="breadcrumb-item active">{{ surgery.surgery_number }}</li>
        </ol>
    </nav>
</div><section class="section profile">
    <div class="row">
        <div class="col-xl-4">
            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <h2>{{ surgery.patient|title }}</h2>
                    <h3>Card No: {{ surgery.patient.card_number|upper }}</h3>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Surgery Info</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><strong>Surgery No.</strong><span>{{ surgery.surgery_number }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Procedure</strong><span>{{ surgery.surgery_type.name }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Scheduled On</strong><span>{{ surgery.scheduled_date|date:"d M, Y P" }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Surgeon</strong><span>{{ surgery.surgeon_name|default:"N/A" }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Total Cost</strong><span class="fw-bold">â‚¦{{ surgery.total_surgery_cost|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Status</strong>
                            {% if surgery.status == 'scheduled' %}<span class="badge bg-primary">Scheduled</span>
                            {% elif surgery.status == 'completed' %}<span class="badge bg-success">Completed</span>
                            {% elif surgery.status == 'in_progress' %}<span class="badge bg-info">In Progress</span>
                            {% elif surgery.status == 'cancelled' %}<span class="badge bg-danger">Cancelled</span>
                            {% else %}<span class="badge bg-secondary">{{ surgery.get_status_display }}</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <div class="card">
                <div class="card-body pt-3">
                    <ul class="nav nav-tabs nav-tabs-bordered">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-tab">Overview</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#drugs-tab">Drug Orders</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#labs-tab">Lab Orders</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#imaging-tab">Imaging Orders</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-2">
                        <div class="tab-pane fade show active" id="overview-tab">
                             <h5 class="card-title">Surgery Overview</h5>
                             <p>Details about the surgery, surgeon's notes, etc.</p>
                        </div>
                        <div class="tab-pane fade" id="drugs-tab">
                             <div class="d-flex justify-content-between align-items-center my-3">
                                <h5 class="card-title mb-0">Prescribed Medications</h5>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#drugPrescriptionModal">
                                    <i class="bi bi-plus-circle"></i> Add Prescriptions
                                </button>
                            </div>
                            </div>
                        <div class="tab-pane fade" id="labs-tab">
                            <div class="d-flex justify-content-between align-items-center my-3">
                                <h5 class="card-title mb-0">Lab Tests Ordered</h5>
                                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#labTestModal">
                                    <i class="bi bi-plus-circle"></i> Order Lab Tests
                                </button>
                            </div>
                            </div>
                        <div class="tab-pane fade" id="imaging-tab">
                             <div class="d-flex justify-content-between align-items-center my-3">
                                <h5 class="card-title mb-0">Imaging Ordered</h5>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#scanModal">
                                    <i class="bi bi-plus-circle"></i> Order Imaging
                                </button>
                            </div>
                            </div>
                    </div></div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="drugPrescriptionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prescribe Medications for Surgery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="prescription-list"></div>
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-drug-btn">
                        <i class="bi bi-plus-circle"></i> Add Drug from Inventory
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="add-external-drug-btn">
                        <i class="bi bi-journal-plus"></i> Add Unavailable Drug
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-prescriptions-btn">Submit Prescriptions</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="labTestModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Lab Tests for Surgery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="testCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in lab_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="lab-test-list"></div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-lab-test-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Test
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="submit-lab-orders-btn">Order Tests</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Imaging for Surgery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Filter by Category (Optional)</label>
                    <select class="form-select" id="imagingCategoryFilter">
                        <option value="">Search all categories...</option>
                        {% for category in scan_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div id="imaging-list"></div>
                <button type="button" class="btn btn-sm btn-outline-warning mt-2" id="add-imaging-btn">
                    <i class="bi bi-plus-circle"></i> Add Another Image Request
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submit-imaging-orders-btn">Order Imaging</button>
            </div>
        </div>
    </div>
</div>

<template id="available-drug-template">
    <div class="card prescription-row mb-3" data-type="available">
        <div class="card-body">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-md-12 position-relative">
                    <label class="form-label">Search Drug</label>
                    <input type="text" class="form-control drug-search-input" placeholder="Start typing drug name..." required>
                    <input type="hidden" class="drug-id-input" name="drug_id">
                    <input type="hidden" class="drug-pack-size-input" name="pack_size" value="1">
                    <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-md-5">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 2 tablets twice daily" required>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 7 days or 1 week">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantity (Packs)</label>
                    <input type="number" class="form-control quantity-input" name="quantity" placeholder="Auto" min="1" required>
                </div>
            </div>
             <div class="row g-2 mt-2">
                <div class="col-md-12">
                     <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="Additional instructions...">
                </div>
            </div>
        </div>
    </div>
</template>

<template id="external-drug-template">
    <div class="card prescription-row mb-3" data-type="external">
        <div class="card-body bg-light">
             <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" onclick="removeDrugForm(this)" aria-label="Remove"></button>
            </div>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Drug Name</label>
                    <input type="text" class="form-control drug-name-input" name="drug_name" placeholder="Enter drug name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Dosage Instructions</label>
                    <input type="text" class="form-control dosage-input" name="dosage" placeholder="e.g., 1 tablet once daily">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Duration</label>
                    <input type="text" class="form-control duration-input" name="duration" placeholder="e.g., 10 days">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantity</label>
                    <input type="text" class="form-control quantity-input" name="quantity" placeholder="e.g., 1 Bottle" required>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-12">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control notes-input" name="notes" placeholder="e.g., Purchase from external pharmacy">
                </div>
            </div>
        </div>
    </div>
</template>

<template id="lab-test-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for a lab test...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control instructions-input" name="special_instructions" placeholder="Clinical indication (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<template id="imaging-row-template">
    <div class="row g-2 align-items-center mb-3 order-row">
        <div class="col-md-6 position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for an imaging request...">
            <input type="hidden" class="template-id-input" name="template_id">
            <div class="search-results list-group position-absolute w-100" style="z-index: 1060;"></div>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control indication-input" name="clinical_indication" placeholder="Clinical indication (optional)">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.order-row').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="infoModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const surgeryId = {{ surgery.id }};
    const patientId = {{ surgery.patient.id }};
    const csrfToken = "{{ csrf_token }}";

    // --- MAIN INITIALIZER ---
    initializeAllModals();

    // --- NOTIFICATION HELPER ---
    function showNotification(message, type = 'success') {
        const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
        const modalLabel = document.getElementById('infoModalLabel');
        modalLabel.textContent = (type === 'success') ? 'Success' : 'Error';
        modalLabel.classList.toggle('text-danger', type !== 'success');
        document.getElementById('infoModalBody').textContent = message;
        infoModal.show();
    }

    // --- INITIALIZATION LOGIC ---
    function initializeAllModals() {
        // Prescription Modal Setup
        const drugModalEl = document.getElementById('drugPrescriptionModal');
        if (drugModalEl) {
            drugModalEl.addEventListener('show.bs.modal', () => {
                document.getElementById('prescription-list').innerHTML = '';
                addDrugForm();
            });
            const addDrugBtn = document.getElementById('add-drug-btn');
            if(addDrugBtn) addDrugBtn.addEventListener('click', addDrugForm);

            const addExternalDrugBtn = document.getElementById('add-external-drug-btn');
            if(addExternalDrugBtn) addExternalDrugBtn.addEventListener('click', addExternalDrugForm);

            const submitPrescriptionsBtn = document.getElementById('submit-prescriptions-btn');
            if(submitPrescriptionsBtn) submitPrescriptionsBtn.addEventListener('click', () => submitPrescriptions(drugModalEl));
        }

        // Lab Test Modal Setup
        const labModalEl = document.getElementById('labTestModal');
        if (labModalEl) {
            labModalEl.addEventListener('show.bs.modal', () => {
                document.getElementById('lab-test-list').innerHTML = '';
                addOrderForm('lab');
            });
            const addLabTestBtn = document.getElementById('add-lab-test-btn');
            if(addLabTestBtn) addLabTestBtn.addEventListener('click', () => addOrderForm('lab'));

            const submitLabOrdersBtn = document.getElementById('submit-lab-orders-btn');
            if(submitLabOrdersBtn) submitLabOrdersBtn.addEventListener('click', () => submitOrders('lab', labModalEl));
        }

        // Imaging Modal Setup
        const scanModalEl = document.getElementById('scanModal');
        if (scanModalEl) {
            scanModalEl.addEventListener('show.bs.modal', () => {
                document.getElementById('imaging-list').innerHTML = '';
                addOrderForm('imaging');
            });
            const addImagingBtn = document.getElementById('add-imaging-btn');
            if(addImagingBtn) addImagingBtn.addEventListener('click', () => addOrderForm('imaging'));

            const submitImagingOrdersBtn = document.getElementById('submit-imaging-orders-btn');
            if(submitImagingOrdersBtn) submitImagingOrdersBtn.addEventListener('click', () => submitOrders('imaging', scanModalEl));
        }
    }

    // --- DYNAMIC FORM MANAGEMENT ---
    function addDrugForm() {
        const template = document.getElementById('available-drug-template');
        const list = document.getElementById('prescription-list');
        const clone = template.content.cloneNode(true);
        const formRow = clone.querySelector('.prescription-row');
        list.appendChild(clone);
        formRow.querySelector('.drug-search-input').addEventListener('input', (e) => handleDrugSearch(e.target));
        formRow.querySelector('.dosage-input').addEventListener('input', () => calculateQuantity(formRow));
        formRow.querySelector('.duration-input').addEventListener('input', () => calculateQuantity(formRow));
    }

    function addExternalDrugForm() {
        const template = document.getElementById('external-drug-template');
        document.getElementById('prescription-list').appendChild(template.content.cloneNode(true));
    }

    function addOrderForm(type) {
        const isLab = type === 'lab';
        const template = document.getElementById(isLab ? 'lab-test-row-template' : 'imaging-row-template');
        const list = document.getElementById(isLab ? 'lab-test-list' : 'imaging-list');
        const clone = template.content.cloneNode(true);
        list.appendChild(clone);
        clone.querySelector('.search-input').addEventListener('input', (e) => handleOrderSearch(e.target, type));
    }

    window.removeDrugForm = function(buttonEl) {
        buttonEl.closest('.prescription-row').remove();
    };

    // --- SEARCH & CALCULATION LOGIC ---
    function handleDrugSearch(inputEl) {
        const query = inputEl.value;
        const resultsContainer = inputEl.parentElement.querySelector('.search-results');
        if (query.length < 2) { resultsContainer.innerHTML = ''; return; }

        fetch(`{% url 'search_drugs_for_surgery' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(drug => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.textContent = `${drug.name} (Stock: ${drug.quantity})`;
                        item.addEventListener('click', e => {
                            e.preventDefault();
                            const formRow = inputEl.closest('.prescription-row');
                            formRow.querySelector('.drug-search-input').value = drug.name;
                            formRow.querySelector('.drug-id-input').value = drug.id;
                            formRow.querySelector('.drug-pack-size-input').value = drug.pack_size || 1;
                            resultsContainer.innerHTML = '';
                            calculateQuantity(formRow);
                        });
                        resultsContainer.appendChild(item);
                    });
                } else {
                    resultsContainer.innerHTML = '<span class="list-group-item">No drugs found</span>';
                }
            });
    }

    function handleOrderSearch(inputEl, type) {
        const query = inputEl.value;
        const resultsContainer = inputEl.parentElement.querySelector('.search-results');
        const isLab = type === 'lab';
        const categoryId = document.getElementById(isLab ? 'testCategoryFilter' : 'imagingCategoryFilter').value;
        const searchUrl = isLab ? "{% url 'ajax_lab_templates_search' %}" : "{% url 'ajax_imaging_templates_search' %}";

        if (query.length < 2) { resultsContainer.innerHTML = ''; return; }

        fetch(`${searchUrl}?q=${encodeURIComponent(query)}&category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach(template => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.textContent = `${template.name} - â‚¦${template.price}`;
                        item.addEventListener('click', e => {
                            e.preventDefault();
                            const formRow = inputEl.closest('.order-row');
                            formRow.querySelector('.search-input').value = template.name;
                            formRow.querySelector('.template-id-input').value = template.id;
                            resultsContainer.innerHTML = '';
                        });
                        resultsContainer.appendChild(item);
                    });
                } else {
                    resultsContainer.innerHTML = '<span class="list-group-item">No results found</span>';
                }
            });
    }

    function calculateQuantity(formRowEl) {
        const dosageText = formRowEl.querySelector('.dosage-input').value.toLowerCase();
        const durationText = formRowEl.querySelector('.duration-input').value.toLowerCase();
        const packSize = parseInt(formRowEl.querySelector('.drug-pack-size-input')?.value || '1') || 1;
        const quantityInput = formRowEl.querySelector('.quantity-input');
        if (!quantityInput) return;
        let dailyDose = 0, durationDays = 0;
        const doseMatch = dosageText.match(/^(\d+(\.\d+)?)/);
        if (doseMatch) {
            const dose = parseFloat(doseMatch[1]);
            let frequency = 1;
            if (dosageText.includes('twice') || dosageText.includes('bd')) frequency = 2;
            else if (dosageText.includes('thrice') || dosageText.includes('tds')) frequency = 3;
            else if (dosageText.includes('four times')) frequency = 4;
            const timesMatch = dosageText.match(/(\d+)\s*time/);
            if (timesMatch) frequency = parseInt(timesMatch[1]);
            const slashMatch = dosageText.match(/\//g);
            if (slashMatch) frequency = slashMatch.length + 1;
            dailyDose = dose * frequency;
        }
        const durationMatch = durationText.match(/^(\d+)/);
        if (durationMatch) {
            const num = parseInt(durationMatch[1]);
            if (durationText.includes('week') || durationText.includes('w')) durationDays = num * 7;
            else if (durationText.includes('month') || durationText.includes('m')) durationDays = num * 30;
            else durationDays = num;
        }
        if (dailyDose > 0 && durationDays > 0) {
            const totalUnits = dailyDose * durationDays;
            quantityInput.value = Math.ceil(totalUnits / packSize);
        }
    }

    // --- SUBMISSION LOGIC ---
    function submitData(url, payload, modalEl) {
        const submitBtn = modalEl.querySelector('.modal-footer button[type="button"]:last-child');
        if(submitBtn) submitBtn.disabled = true;
        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(modalEl).hide();
                showNotification(data.message);
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showNotification(data.error || 'An unknown error occurred.', 'error');
            }
        })
        .catch(error => showNotification('A network error occurred.', 'error'))
        .finally(() => {
            if(submitBtn) submitBtn.disabled = false;
        });
    }

    function submitPrescriptions(modalEl) {
        const payload = { patient_id: patientId, surgery_id: surgeryId, available_drugs: [], external_drugs: [] };
        let isValid = true;
        document.querySelectorAll('#prescription-list .prescription-row').forEach(form => {
            form.querySelectorAll('input[required]').forEach(input => input.classList.remove('is-invalid'));
            if (form.dataset.type === 'available') {
                const drugId = form.querySelector('.drug-id-input').value;
                if (!drugId) { isValid = false; form.querySelector('.drug-search-input').classList.add('is-invalid'); }
                payload.available_drugs.push({
                    drug_id: drugId,
                    dosage: form.querySelector('.dosage-input').value,
                    duration: form.querySelector('.duration-input').value,
                    quantity: form.querySelector('.quantity-input').value,
                    notes: form.querySelector('.notes-input').value
                });
            } else { // external
                const drugName = form.querySelector('.drug-name-input').value;
                if (!drugName) { isValid = false; form.querySelector('.drug-name-input').classList.add('is-invalid'); }
                payload.external_drugs.push({
                    drug_name: drugName,
                    dosage: form.querySelector('.dosage-input').value,
                    duration: form.querySelector('.duration-input').value,
                    quantity: form.querySelector('.quantity-input').value,
                    notes: form.querySelector('.notes-input').value
                });
            }
        });
        if (!isValid) { showNotification('Please complete all required fields.', 'error'); return; }
        if (payload.available_drugs.length === 0 && payload.external_drugs.length === 0) { showNotification('Please add at least one medication.', 'error'); return; }
        submitData("{% url 'surgery_prescribe_multiple' %}", payload, modalEl);
    }

    function submitOrders(type, modalEl) {
        const isLab = type === 'lab';
        const listId = isLab ? 'lab-test-list' : 'imaging-list';
        const submitUrl = isLab ? "{% url 'surgery_order_multiple_labs' %}" : "{% url 'surgery_order_multiple_imaging' %}";
        const payload = { patient_id: patientId, surgery_id: surgeryId, orders: [] };
        let isValid = true;
        document.getElementById(listId).querySelectorAll('.order-row').forEach(row => {
            row.querySelector('.search-input').classList.remove('is-invalid');
            const templateId = row.querySelector('.template-id-input').value;
            if (!templateId) { isValid = false; row.querySelector('.search-input').classList.add('is-invalid'); return; }
            const orderData = { template_id: templateId };
            orderData[isLab ? 'instructions' : 'indication'] = row.querySelector(isLab ? '.instructions-input' : '.indication-input').value;
            payload.orders.push(orderData);
        });
        if (!isValid) { showNotification(`Please select a valid ${type} for all rows.`, 'error'); return; }
        if (payload.orders.length === 0) { showNotification(`Please add at least one ${type} order.`, 'error'); return; }
        submitData(submitUrl, payload, modalEl);
    }
});
</script>

<style>
    /* Positions the search results dropdown relative to its container */
    .position-relative {
        position: relative;
    }

    /* Styles for the search results container */
    .search-results {
        position: absolute;
        top: 100%; /* Positions it right below the input field */
        left: 0;
        right: 0;
        z-index: 1055; /* Ensures it appears above other elements */
        display: none; /* Hidden by default */
        max-height: 200px; /* Limits height and adds a scrollbar if needed */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-top: none;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}