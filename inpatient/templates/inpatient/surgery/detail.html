{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="pagetitle">
    <h1>Surgery Details</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inpatient_dashboard' %}">Inpatient</a></li>
            <li class="breadcrumb-item"><a href="{% url 'surgery_index' %}">Surgeries</a></li>
            <li class="breadcrumb-item active">{{ surgery.surgery_number }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section profile">
    <div class="row">
        <!-- Left column for patient & surgery details -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                    <h2>{{ surgery.patient|title }}</h2>
                    <h3>Card No: {{ surgery.patient.card_number|upper }}</h3>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Surgery Info</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><strong>Surgery No.</strong><span>{{ surgery.surgery_number }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Procedure</strong><span>{{ surgery.surgery_type.name }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Scheduled On</strong><span>{{ surgery.scheduled_date|date:"d M, Y P" }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Surgeon</strong><span>{{ surgery.surgeon_name|default:"N/A" }}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Total Cost</strong><span class="fw-bold">â‚¦{{ surgery.total_surgery_cost|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Status</strong>
                            {% if surgery.status == 'scheduled' %}<span class="badge bg-primary">Scheduled</span>
                            {% elif surgery.status == 'completed' %}<span class="badge bg-success">Completed</span>
                            {% elif surgery.status == 'in_progress' %}<span class="badge bg-info">In Progress</span>
                            {% elif surgery.status == 'cancelled' %}<span class="badge bg-danger">Cancelled</span>
                            {% else %}<span class="badge bg-secondary">{{ surgery.get_status_display }}</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right column for tabs -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-body pt-3">
                    <!-- Bordered Tabs -->
                    <ul class="nav nav-tabs nav-tabs-bordered">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-tab">Overview</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#drugs-tab">Drug Orders</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#labs-tab">Lab Orders</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#scans-tab">Scan Orders</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-2">
                        <!-- Overview & Update Tab -->
                        <div class="tab-pane fade show active" id="overview-tab">
                            {% include './partials/detail_overview.html' %}
                        </div>
                        <!-- Drug Orders Tab -->
                        <div class="tab-pane fade" id="drugs-tab">
                             {% include './partials/detail_orders_drug.html' %}
                        </div>
                        <!-- Lab Orders Tab -->
                        <div class="tab-pane fade" id="labs-tab">
                             {% include './partials/detail_orders_lab.html' %}
                        </div>
                        <!-- Scan Orders Tab -->
                        <div class="tab-pane fade" id="scans-tab">
                             {% include './partials/detail_orders_scan.html' %}
                        </div>
                    </div><!-- End Bordered Tabs -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reusable Modals -->
<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="infoModalLabel">Notification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="infoModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmModalLabel">Confirm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button></div></div></div></div>

<!-- Include jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const csrfToken = "{{ csrf_token }}";
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // --- Modal Helpers ---
    function showInfo(title, message, isError = false) {
        $('#infoModalLabel').text(title).toggleClass('text-danger', isError).toggleClass('text-success', !isError);
        $('#infoModalBody').text(message);
        infoModal.show();
    }
    function showConfirm(title, message, onConfirm) {
        $('#confirmModalLabel').text(title);
        $('#confirmModalBody').text(message);
        $('#confirmModalBtn').off('click').on('click', () => { onConfirm(); confirmModal.hide(); });
        confirmModal.show();
    }

    // --- Generic Add Service Function ---
    function handleAddService(formId, modalId) {
        $(formId).on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const hiddenIdInput = form.find('input[type=hidden][name=service_id]');
            if (!hiddenIdInput.val()) {
                showInfo('Validation Error', 'Please search and select an item.', true);
                return;
            }
            $.post(form.attr('action'), form.serialize())
                .done(response => {
                    if (response.success) {
                        showInfo('Success', response.message);
                        $(modalId).modal('hide');
                        // Simple reload to show new item.
                        setTimeout(() => location.reload(), 1500);
                    } else { showInfo('Error', response.error, true); }
                })
                .fail(() => showInfo('Server Error', 'An unexpected error occurred.', true));
        });
    }

    // --- Generic Remove Service Function ---
    $(document).on('click', '.remove-order-btn', function() {
        const btn = $(this);
        const url = btn.data('url');
        const type = btn.data('type');
        showConfirm('Confirm Removal', 'Are you sure you want to remove this order?', () => {
            $.post(url, { csrfmiddlewaretoken: csrfToken, service_type: type })
                .done(response => {
                    if (response.success) {
                        showInfo('Success', response.message);
                        setTimeout(() => location.reload(), 1500);
                    } else { showInfo('Error', response.error, true); }
                })
                .fail(() => showInfo('Server Error', 'An unexpected error occurred.', true));
        });
    });

    // --- Generic Search Functionality ---
    function setupSearch(inputId, resultsId, url) {
        const searchInput = $(inputId);
        const resultsContainer = $(resultsId);
        const hiddenIdInput = $(inputId + '-id'); // Assumes hidden input has '-id' suffix
        searchInput.on('keyup', function() {
            const query = $(this).val();
            if (query.length < 2) { resultsContainer.hide(); return; }
            $.get(url, { q: query }, data => {
                resultsContainer.empty().show();
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => resultsContainer.append(`<a href="#" class="list-group-item list-group-item-action" data-id="${item.id}" data-name="${item.name}">${item.name}</a>`));
                } else { resultsContainer.append('<span class="list-group-item">No results found</span>'); }
            });
        });
        resultsContainer.on('click', 'a', function(e) {
            e.preventDefault();
            searchInput.val($(this).data('name'));
            hiddenIdInput.val($(this).data('id'));
            resultsContainer.hide();
        });
    }

    // --- Initialize Handlers ---
    handleAddService('#add-drug-order-form', '#addDrugOrderModal');
    handleAddService('#add-lab-order-form', '#addLabOrderModal');
    handleAddService('#add-scan-order-form', '#addScanOrderModal');
    setupSearch('#drug-order-search', '#drug-order-search-results', "{% url 'search_drugs_for_surgery' %}");
    setupSearch('#lab-order-search', '#lab-order-search-results', "{% url 'search_lab_tests_for_surgery' %}");
    setupSearch('#scan-order-search', '#scan-order-search-results', "{% url 'search_scans_for_surgery' %}");

    // Hide search results when clicking outside
    $(document).on('click', e => {
        if (!$(e.target).closest('.search-wrapper').length) { $('.search-results').hide(); }
    });
});
</script>
<style>
.search-wrapper { position: relative; }
.search-results {
    position: absolute; top: 100%; left: 0; right: 0; z-index: 1055;
    max-height: 200px; overflow-y: auto; border: 1px solid #ddd; background-color: #fff;
}
</style>
{% endblock %}

