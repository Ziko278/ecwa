{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="col-lg-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">ACTIONS:
        <span class="card-description">Hover an Icon to reveal its function</span>
      </h4>

      <a title="Edit Item Details" href="{% url 'service_item_edit' item.pk %}" class="btn btn-warning">
        <i class="bi bi-pencil-square"></i>
      </a>

      <a title="Delete Item" href="{% url 'service_item_delete' item.pk %}" class="btn btn-danger">
        <i class="bi bi-trash"></i>
      </a>

      <button type="button" class="btn btn-info"
          data-bs-toggle="modal" data-bs-target="#stockOutModal"
          title="Stock Out / Adjustment"><i class="bi bi-box-arrow-up"></i> Stock Out
      </button>

      <a onclick="window.history.back()" title="Go Back" style="float:right" class="btn btn-secondary text-white"><i class="bi bi-arrow-left"></i></a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body pt-3">
        <ul class="nav nav-tabs nav-tabs-bordered">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#item-details">Item Details</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-levels">Stock Levels & Alerts</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-movements">Stock Movements</a></li>
        </ul>

        <div class="tab-content pt-2">
          <div class="tab-pane fade show active profile-overview" id="item-details">
            <h5 class="card-title">Item Information</h5>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Item Name</div>
              <div class="col-lg-8 col-md-8">{{ item.name|title }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Category</div>
              <div class="col-lg-8 col-md-8">{{ item.category.name }}</div>
            </div>
             <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Unit of Measure</div>
              <div class="col-lg-8 col-md-8">{{ item.get_unit_of_measure_display }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Description</div>
              <div class="col-lg-8 col-md-8">{{ item.description|default:"---" }}</div>
            </div>

            <h5 class="card-title">Pricing</h5>
             <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Cost Price</div>
              <div class="col-lg-8 col-md-8">₦{{ item.cost_price|floatformat:2|intcomma }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Selling Price</div>
              <div class="col-lg-8 col-md-8">₦{{ item.price|floatformat:2|intcomma }}</div>
            </div>

            <h5 class="card-title">Status & Timestamps</h5>
             <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Is Active</div>
              <div class="col-lg-8 col-md-8">
                {% if item.is_active %}
                  <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Yes</span>
                {% else %}
                  <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i> No</span>
                {% endif %}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Created At</div>
              <div class="col-lg-8 col-md-8">{{ item.created_at|date:"F d, Y P" }}</div>
            </div>
          </div>

          <div class="tab-pane fade profile-overview" id="stock-levels">
            <h5 class="card-title">Current Stock & Minimum Levels</h5>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Current Quantity in Stock</div>
              <div class="col-lg-8 col-md-8 fs-4 fw-bold
                {% if item.is_low_stock and item.stock_quantity > 0 %} text-warning
                {% elif item.stock_quantity == 0 %} text-danger {% endif %}">
                {{ item.stock_quantity|floatformat:0|intcomma }}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Minimum Stock Level</div>
              <div class="col-lg-8 col-md-8">{{ item.minimum_stock_level|intcomma }}</div>
            </div>
             <div class="row mb-2">
              <div class="col-lg-4 col-md-4 label fw-bold">Stock Status</div>
              <div class="col-lg-8 col-md-8">
                {% if item.stock_quantity == 0 %}
                    <span class="badge bg-danger fs-6">Out of Stock</span>
                {% elif item.is_low_stock %}
                    <span class="badge bg-warning text-dark fs-6">Low Stock</span>
                {% else %}
                    <span class="badge bg-success fs-6">In Stock</span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="tab-pane fade profile-overview" id="stock-movements">
            <h5 class="card-title">Recent Stock Movements</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Previous Stock</th>
                            <th>New Stock</th>
                            <th>Performed By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movement in stock_movements %}
                        <tr>
                            <td>{{ movement.created_at|date:"M d, Y H:i" }}</td>
                            <td>
                                <span class="badge
                                    {% if movement.movement_type == 'stock_in' or movement.movement_type == 'return' %} bg-success
                                    {% elif movement.movement_type == 'stock_out' or movement.movement_type == 'sale' or movement.movement_type == 'expired' %} bg-danger
                                    {% else %} bg-secondary {% endif %}">
                                    {{ movement.get_movement_type_display }}
                                </span>
                            </td>
                            <td class="fw-bold {% if movement.quantity > 0 %} text-success {% else %} text-danger {% endif %}">
                                {{ movement.quantity|intcomma }}
                            </td>
                            <td>{{ movement.previous_stock|intcomma }}</td>
                            <td>{{ movement.new_stock|intcomma }}</td>
                             <td>
                                 {% if movement.created_by.user_staff_profile %}
                                        {{ movement.created_by.user_staff_profile.staff|title }}
                                    {% else %}
                                        {{ movement.created_by|title }}
                                    {% endif %}
                             </td>
                            <td>{{ movement.notes|default:"---" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center">No stock movements found for this item.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
          </div>

        </div></div>
    </div>
  </div>
</div>

{# Stock Out/Adjustment Modal #}
<div class="modal fade" id="stockOutModal" tabindex="-1" aria-labelledby="stockOutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" class="p-3" action="{% url 'manage_stock' item.pk %}">
                {% csrf_token %}

                {# FIX #2: Add a hidden input to tell the form which item this is for. #}
                <input type="hidden" name="service_item" value="{{ item.pk }}">

                <div class="modal-header">
                    <h5 class="modal-title" id="stockOutModalLabel">Stock Out / Adjustment for {{ item.name|title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Current Stock: <strong>{{ item.stock_quantity|intcomma }}</strong></p>

                    <div class="form-floating mb-3">
                        <select name="movement_type" id="movement_type" class="form-select" required>
                            <option value="stock_out">Stock Out (Manual Removal)</option>
                            <option value="expired">Expired / Damaged</option>
                            <option value="adjustment">Stock Adjustment (Correction)</option>
                        </select>
                        <label for="movement_type">Reason for Stock Out</label>
                    </div>

                    <div class="form-floating mb-3">
                        {# FIX #1: Add the 'max' attribute for browser-side validation. #}
                        <input type="number" name="quantity" id="quantity" class="form-control" min="1" max="{{ item.stock_quantity }}" required>
                        <label for="quantity">Quantity to Remove</label>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea name="notes" id="notes" class="form-control" rows="3" placeholder="Notes"></textarea>
                        <label for="notes">Notes / Remarks (Optional)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}