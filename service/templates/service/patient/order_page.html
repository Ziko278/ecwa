{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<style>
    /* Styles are borrowed and adapted from your dispense.html sample for consistency */
    .search-results-container { position: absolute; background-color: white; border: 1px solid #ddd; border-top: none; z-index: 999; width: 100%; max-height: 250px; overflow-y: auto; }
    .search-result-item { padding: 10px; cursor: pointer; }
    .search-result-item:hover { background-color: #f0f0f0; }
    .search-result-item small { display: block; color: #6c757d; }
    .patient-info-card { border-left: 4px solid #0d6efd; }
    .wallet-balance { font-size: 1.5rem; font-weight: bold; color: #198754; }
    .order-card { border: 1px solid #dee2e6; margin-bottom: 15px; }
    .order-header { padding: 10px 15px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
    .header-payment { background-color: #fff3cd; }
    .header-action { background-color: #d1ecf1; }
    .order-row { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .order-row:last-child { border-bottom: none; }
    .quantity-controls { display: flex; align-items: center; gap: 10px; }
    .quantity-input { width: 70px; text-align: center; }
    .action-summary-bar { background: #343a40; color: white; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .hidden { display: none; }
    .step { width: 40px; height: 40px; border-radius: 50%; background: #dee2e6; color: #6c757d; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .step.active { background: #0d6efd; color: white; }
    .step.completed { background: #198754; color: white; }
</style>

<div class="container-fluid mt-4">
    <div class="step-indicator d-flex justify-content-center mb-4">
        <div class="step active" id="step-1">1</div>
        <div style="border-top: 2px solid #dee2e6; flex-grow: 1; margin: 20px 0;"></div>
        <div class="step" id="step-2">2</div>
    </div>

    <div id="patient-verification-section">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white"><h5><i class="bi bi-person-check-fill"></i> Verify Patient</h5></div>
                    <div class="card-body">
                        <form id="patient-verification-form">
                            <div class="mb-3"><label for="card_number" class="form-label">Patient Card Number</label><input type="text" class="form-control form-control-lg" id="card_number" name="card_number" required></div>
                            <button type="submit" class="btn btn-primary btn-lg w-100"><i class="bi bi-search"></i> Verify Patient</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-interface-section" class="hidden">
        <div class="row">
            <div class="col-md-4">
                <div class="card patient-info-card mb-3"><div class="card-body" id="patient-info"></div></div>
                <div class="card mb-3"><div class="card-body text-center"><h6 class="text-muted">Wallet Balance</h6><div class="wallet-balance" id="wallet-balance"></div></div></div>
                <div class="card">
                    <div class="card-header bg-light"><h6><i class="bi bi-plus-circle"></i> Add New Service / Item</h6></div>
                    <div class="card-body">
                        <form id="add-item-form">
                            <div class="mb-3 position-relative">
                                <label for="item-search" class="form-label">Search</label>
                                <input type="text" id="item-search" class="form-control" placeholder="Search for service or item...">
                                <div class="search-results-container" id="search-results" style="display: none;"></div>
                            </div>
                            <input type="hidden" id="selected-item-id"><input type="hidden" id="selected-item-type">
                            <div class="mb-3"><label for="item-quantity" class="form-label">Quantity</label><input type="number" id="item-quantity" class="form-control" min="1" value="1"></div>
                            <button type="button" class="btn btn-success w-100" id="add-to-bill-btn" disabled><i class="bi bi-cart-plus"></i> Add to Bill</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div id="pending-payment-section"></div>
                <div id="pending-action-section"></div>
                <div id="no-orders-message" class="hidden"></div>
                <div class="action-summary-bar hidden" id="action-summary-bar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h5 id="action-summary-text" class="mb-0"></h5><small id="action-details-text" class="text-white-50"></small></div>
                        <button class="btn btn-light btn-lg" id="process-actions-btn"><i class="bi bi-check-circle"></i> Process</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="notificationModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="notificationModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center py-4"><div class="spinner-border text-primary"></div><div class="mt-3">Processing...</div></div></div></div></div>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Global State ---
    let patientData = null;
    let walletBalance = 0;
    const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('patient-verification-form').addEventListener('submit', function(e) {
            e.preventDefault();
            verifyPatient(document.getElementById('card_number').value.trim());
        });

        document.getElementById('item-search').addEventListener('keyup', handleSearch);
        document.getElementById('add-to-bill-btn').addEventListener('click', handleAddToBill);
        document.getElementById('process-actions-btn').addEventListener('click', processActions);
    });

    // --- Core Functions ---
    function verifyPatient(cardNumber) {
        if (!cardNumber) { showNotification('Please enter a card number.', 'Error', true); return; }
        //loadingModal.show();
        fetch(`{% url 'ajax_verify_patient_orders' %}?card_number=${cardNumber}`)
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                if (data.error) { throw new Error(data.error); }
                patientData = data.patient;
                walletBalance = data.wallet.balance;
                renderPatientInfo(data.patient, data.wallet);
                renderOrderLists(data.orders);
                document.getElementById('patient-verification-section').classList.add('hidden');
                document.getElementById('main-interface-section').classList.remove('hidden');
                document.getElementById('step-1').classList.replace('active', 'completed');
                document.getElementById('step-2').classList.add('active');
            })
            .catch(error => {
                loadingModal.hide();
                showNotification(error.message, 'Verification Failed', true);
            });
    }

    function renderPatientInfo(patient, wallet) {
        document.getElementById('patient-info').innerHTML = `<h5>${patient.full_name}</h5><p class="mb-1 small">Card Number: <strong>${patient.card_number}</strong></p>`;
        document.getElementById('wallet-balance').textContent = wallet.formatted_balance;
    }

    function renderOrderLists(orders) {
        const paymentSection = document.getElementById('pending-payment-section');
        const actionSection = document.getElementById('pending-action-section');
        const noOrdersMsg = document.getElementById('no-orders-message');

        paymentSection.innerHTML = createOrderCard('Pending Payment', 'header-payment', 'bi-credit-card', orders.pending_payment, buildPaymentRow);
        actionSection.innerHTML = createOrderCard('Pending Action', 'header-action', 'bi-box-arrow-in-right', orders.pending_action, buildActionRow);

        if (!orders.pending_payment.length && !orders.pending_action.length) {
            noOrdersMsg.innerHTML = `<div class="card mt-2"><div class="card-body text-center text-muted py-5"><i class="bi bi-cart-x fs-1 mb-3"></i><h5>No Pending Orders Found</h5></div></div>`;
            noOrdersMsg.classList.remove('hidden');
        } else {
            noOrdersMsg.classList.add('hidden');
        }
        updateActionSummary();
    }

    function createOrderCard(title, headerClass, icon, items, rowBuilder) {
        if (!items.length) return '';
        let rowsHtml = items.map(rowBuilder).join('');
        return `
            <div class="card order-card">
                <div class="order-header ${headerClass}">
                    <h6><i class="bi ${icon}"></i> ${title}</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAll(this, '${headerClass}')">Select All</button>
                </div>
                ${rowsHtml}
            </div>
        `;
    }

    function buildPaymentRow(item) {
        const icon = item.is_item ? 'bi-box-seam' : 'bi-file-medical';
        return `
            <div class="order-row">
                <div class="form-check"><input class="form-check-input action-checkbox header-payment" type="checkbox" value="${item.id}" data-type="payment" data-amount="${item.balance_due}" onchange="updateActionSummary()">
                    <label class="form-check-label"><i class="bi ${icon}"></i> <strong>${item.name}</strong><br><small class="text-muted">Status: ${item.status}</small></label>
                </div>
                <div class="text-end"><strong>₦${item.balance_due.toLocaleString()}</strong></div>
            </div>
        `;
    }

    function buildActionRow(item) {
        const icon = item.is_item ? 'bi-box-seam' : 'bi-file-medical';
        let actionControl = '';
        if (item.is_item && item.quantity_remaining > 0) {
            actionControl = `
                <div class="quantity-controls">
                    <label class="form-label small mb-0">Collect:</label>
                    <input type="number" class="form-control form-control-sm quantity-input dispense-qty" data-order-id="${item.id}" min="1" max="${item.quantity_remaining}" value="${item.quantity_remaining}" onchange="updateActionSummary()">
                </div>
            `;
        } else if (item.has_results && !item.has_result_entry) {
            actionControl = `<a href="/portal/service/results/create/?transaction_id=${item.id}" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-pencil-square"></i> Enter Result</a>`;
        } else if (item.has_results && item.has_result_entry) {
            actionControl = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> Result Entered</span>`;
        }
        return `
            <div class="order-row">
                <div class="form-check">
                    <input class="form-check-input action-checkbox header-action" type="checkbox" value="${item.id}" data-type="dispense" onchange="updateActionSummary()" ${!item.is_item ? 'disabled' : ''}>
                    <label class="form-check-label"><i class="bi ${icon}"></i> <strong>${item.name}</strong><br>
                        <small class="text-muted">Ordered: ${item.quantity}, Dispensed: ${item.quantity_dispensed}, Remaining: ${item.quantity_remaining}</small>
                    </label>
                </div>
                ${actionControl}
            </div>
        `;
    }

    function handleSearch(event) { /* ... JS for search ... */ }
    function handleAddToBill() { /* ... JS for adding to bill ... */ }
    function updateActionSummary() { /* ... JS for updating summary bar ... */ }
    function processActions() { /* ... JS for processing payments and dispensing ... */ }
    function selectAll(btn, groupClass) { /* ... JS for select all ... */ }
    function showNotification(message, title = 'Notification', isError = false) { /* ... JS for showing modal ... */ }

    // --- Full JS implementations ---
    function handleSearch(event) {
        const query = event.target.value;
        const resultsContainer = document.getElementById('search-results');
        if (query.length < 2) { resultsContainer.style.display = 'none'; return; }

        fetch(`{% url 'ajax_search_all' %}?q=${query}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                if (data.results.length) {
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.innerHTML = `<strong>${item.name}</strong> (${item.type})<small>Price: ₦${item.price} | Stock: ${item.stock}</small>`;
                        div.onclick = () => selectItem(item);
                        resultsContainer.appendChild(div);
                    });
                } else {
                    resultsContainer.innerHTML = '<div class="p-2 text-muted">No results found.</div>';
                }
                resultsContainer.style.display = 'block';
            });
    }

    function selectItem(item) {
        document.getElementById('item-search').value = item.name;
        document.getElementById('selected-item-id').value = item.type === 'item' ? `item_${item.id}` : `service_${item.id}`;
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('add-to-bill-btn').disabled = false;
        document.getElementById('item-quantity').disabled = item.type === 'service';
    }

    function handleAddToBill() {
        const selectedId = document.getElementById('selected-item-id').value;
        const quantity = document.getElementById('item-quantity').value;
        if (!selectedId) { showNotification('Please select an item from the search results.', 'Error', true); return; }

        const [type, id] = selectedId.split('_');
        const payload = {
            patient_id: patientData.id,
            quantity: type === 'service' ? 1 : quantity,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        };
        if (type === 'service') payload.service_id = id;
        else payload.service_item_id = id;

        //loadingModal.show();
        fetch('{% url "ajax_add_new_transaction" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if (data.error) { throw new Error(data.error); }
            showNotification(data.message, 'Success');
            document.getElementById('add-item-form').reset();
            document.getElementById('add-to-bill-btn').disabled = true;
            verifyPatient(patientData.card_number); // Refresh list
        }).catch(err => {
            loadingModal.hide();
            showNotification(err.message, 'Error', true);
        });
    }

    function updateActionSummary() {
        const paymentItems = document.querySelectorAll('.action-checkbox[data-type="payment"]:checked');
        const dispenseItems = document.querySelectorAll('.action-checkbox[data-type="dispense"]:checked');
        let paymentTotal = 0;
        paymentItems.forEach(item => paymentTotal += parseFloat(item.dataset.amount));

        const summaryBar = document.getElementById('action-summary-bar');
        if (!paymentItems.length && !dispenseItems.length) {
            summaryBar.classList.add('hidden');
            return;
        }

        let summaryText = [];
        if (paymentItems.length) summaryText.push(`Pay for ${paymentItems.length} item(s)`);
        if (dispenseItems.length) summaryText.push(`Collect ${dispenseItems.length} item(s)`);
        document.getElementById('action-summary-text').textContent = summaryText.join(' & ');

        let detailsText = '';
        if (paymentTotal > 0) {
            detailsText = `Total Due: ₦${paymentTotal.toLocaleString()}`;
            if (paymentTotal > walletBalance) {
                detailsText += ` <span class="badge bg-danger">Insufficient Funds</span>`;
                document.getElementById('process-actions-btn').disabled = true;
            } else {
                document.getElementById('process-actions-btn').disabled = false;
            }
        } else {
            document.getElementById('process-actions-btn').disabled = !dispenseItems.length;
        }
        document.getElementById('action-details-text').innerHTML = detailsText;
        summaryBar.classList.remove('hidden');
    }

    // In your order_page.html script block

    async function processActions() {
        //loadingModal.show();
        try {
            const payment_ids = Array.from(document.querySelectorAll('.action-checkbox[data-type="payment"]:checked')).map(cb => cb.value);
            const dispense_items = Array.from(document.querySelectorAll('.action-checkbox[data-type="dispense"]:checked')).map(cb => ({
                transaction_id: cb.value,
                quantity: document.querySelector(`.dispense-qty[data-order-id="${cb.value}"]`).value
            }));

            let messages = [];

            // Step 1: Process Payments (this part is unchanged)
            if (payment_ids.length > 0) {
                const paymentResponse = await fetch('{% url "ajax_process_bulk_payments" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({ patient_id: patientData.id, transaction_ids: payment_ids })
                });
                const paymentResult = await paymentResponse.json();
                if (paymentResult.error) throw new Error(paymentResult.error);
                messages.push(paymentResult.message);
            }

            // --- THIS IS THE CHANGE ---
            // Step 2: Process all dispensing in a single request
            if (dispense_items.length > 0) {
                const dispenseResponse = await fetch('{% url "ajax_process_bulk_dispense" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify({ dispense_items: dispense_items }) // Send the whole list
                });
                const dispenseResult = await dispenseResponse.json();
                if (dispenseResult.error) throw new Error(dispenseResult.error);
                messages.push(dispenseResult.message);
    }

            showNotification(messages.join(' ') || 'Actions completed.', 'Success');
        } catch (err) {
            showNotification(err.message, 'Error', true);
        } finally {
            // Step 3: Always refresh the patient's data
            verifyPatient(patientData.card_number);
        }
    }

    function selectAll(btn, groupClass) {
        const checkboxes = document.querySelectorAll(`.${groupClass}`);
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
        updateActionSummary();
    }
    
    function showNotification(message, title = 'Notification', isError = false) {
        document.getElementById('notificationModalTitle').textContent = title;
        document.getElementById('notificationModalBody').innerHTML = message;
        document.getElementById('notificationModalTitle').className = `modal-title ${isError ? 'text-danger' : 'text-success'}`;
        notificationModal.show();
    }
</script>
{% endblock %}