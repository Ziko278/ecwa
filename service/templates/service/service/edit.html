{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}

<div class="pagetitle">
    <h1>Edit Service</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item">Services</li>
            <li class="breadcrumb-item"><a href="{% url 'service_list' %}">Services & Procedures</a></li>
            <li class="breadcrumb-item active">Edit</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Editing: {{ service.name }}</h5>
                    <p>Modify the details of the service below.</p>

                    {% include 'admin_site/partials/error.html' %}

                    <form method="post" id="serviceForm">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    {{ form.name }}
                                    <label for="{{ form.name.id_for_label }}">Service Name <span class="text-danger">*</span></label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    {{ form.category }}
                                    <label for="{{ form.category.id_for_label }}">Category <span class="text-danger">*</span></label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            {{ form.price }}
                            <label for="{{ form.price.id_for_label }}">Default Price</label>
                        </div>

                        <div class="form-floating mb-3">
                            {{ form.description }}
                            <label for="{{ form.description.id_for_label }}">Description</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            {{ form.has_results }}
                            <label class="form-check-label" for="{{ form.has_results.id_for_label }}">Does this service produce results?</label>
                        </div>

                        <!-- Result Template Builder (Dynamic) -->
                        <div class="mb-4" id="resultTemplateBuilder" style="display: none;">
                            <h6 class="mb-3">Result Template Fields</h6>
                            <div class="card border-light">
                                <div class="card-body pt-3">
                                    <div id="fieldsContainer">
                                        <!-- Fields will be added here dynamically -->
                                    </div>
                                    <button type="button" class="btn btn-success btn-sm" id="addFieldBtn">
                                        <i class="bi bi-plus"></i> Add Field
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden input for the actual JSON data -->
                        {{ form.result_template }}

                        <div class="form-check form-switch mb-3">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Is Active?</label>
                        </div>

                        <div class="text-end">
                            <a href="{% url 'service_list' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Service</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Field Template for JSON Builder (Hidden) -->
<template id="fieldTemplate">
    <div class="field-item border rounded p-3 mb-3 bg-light">
        <div class="row align-items-center">
            <div class="col-md-5">
                <div class="form-floating mb-2">
                    <input type="text" class="form-control field-name" placeholder="Field Name">
                    <label>Field Name *</label>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-floating mb-2">
                    <select class="form-control field-type">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="options">Options (Select)</option>
                    </select>
                    <label>Field Type</label>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-danger btn-sm remove-field-btn">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <!-- Options textarea -->
        <div class="options-field" style="display: none;">
            <div class="form-floating mt-2">
                <textarea class="form-control field-options" rows="3" placeholder="Enter each option on a new line"></textarea>
                <label>Options (one per line)</label>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hasResultsCheckbox = document.getElementById('{{ form.has_results.id_for_label }}');
    const resultTemplateBuilder = document.getElementById('resultTemplateBuilder');
    const fieldsContainer = document.getElementById('fieldsContainer');
    const addFieldBtn = document.getElementById('addFieldBtn');
    const fieldTemplate = document.getElementById('fieldTemplate');
    const hiddenInput = document.getElementById('id_result_template');

    // Hide the default textarea for the JSON field
    if (hiddenInput) {
        hiddenInput.style.display = 'none';
    }

    // Toggle builder visibility based on checkbox
    hasResultsCheckbox.addEventListener('change', function() {
        resultTemplateBuilder.style.display = this.checked ? 'block' : 'none';
        if (this.checked && fieldsContainer.children.length === 0) {
            addField(); // Add one field by default when shown
        }
    });

    // Add field function
    function addField() {
        const clone = fieldTemplate.content.cloneNode(true);
        fieldsContainer.appendChild(clone);
        const newField = fieldsContainer.lastElementChild;
        attachFieldEvents(newField);
        updateJSON();
    }

    // Attach events to a field item
    function attachFieldEvents(fieldItem) {
        fieldItem.querySelector('.remove-field-btn').addEventListener('click', () => {
            fieldItem.remove();
            updateJSON();
        });

        const typeSelect = fieldItem.querySelector('.field-type');
        const optionsField = fieldItem.querySelector('.options-field');
        typeSelect.addEventListener('change', () => {
            optionsField.style.display = typeSelect.value === 'options' ? 'block' : 'none';
            updateJSON();
        });

        const inputs = fieldItem.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', updateJSON);
            input.addEventListener('change', updateJSON);
        });
    }

    // Update hidden JSON input
    function updateJSON() {
        const fields = [];
        const fieldItems = fieldsContainer.querySelectorAll('.field-item');

        fieldItems.forEach(item => {
            const name = item.querySelector('.field-name').value.trim();
            const type = item.querySelector('.field-type').value;

            if (!name) return; // Skip if no name

            const field = {
                name: name,
                type: type,
            };

            if (type === 'options') {
                const optionsText = item.querySelector('.field-options').value.trim();
                if (optionsText) {
                    field.options = optionsText.split('\n').map(opt => opt.trim()).filter(Boolean);
                }
            }
            fields.push(field);
        });

        hiddenInput.value = JSON.stringify({ fields: fields }, null, 2);
    }

    // Load existing data from hidden input
    function loadExistingData() {
        try {
            // Ensure we handle the case where the hidden input is empty or invalid
            const initialValue = hiddenInput.value.trim();
            if (!initialValue) {
                return;
            }
            const data = JSON.parse(initialValue);
            
            if (data.fields && data.fields.length > 0) {
                hasResultsCheckbox.checked = true;
                resultTemplateBuilder.style.display = 'block';

                data.fields.forEach(field => {
                    addField();
                    const newItem = fieldsContainer.lastElementChild;
                    newItem.querySelector('.field-name').value = field.name || '';
                    newItem.querySelector('.field-type').value = field.type || 'text';
                    if (field.type === 'options' && field.options) {
                        newItem.querySelector('.field-options').value = field.options.join('\n');
                        newItem.querySelector('.options-field').style.display = 'block';
                    }
                });
            }
        } catch (e) {
            console.error("Could not load existing result template JSON.", e);
        }
    }

    // --- Init ---
    addFieldBtn.addEventListener('click', addField);
    loadExistingData(); // Run on page load to populate the form

    // Initial check
    if (hasResultsCheckbox.checked) {
       resultTemplateBuilder.style.display = 'block';
    }

});
</script>

{% endblock %}
